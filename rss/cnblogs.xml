<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="css/feed.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:media="http://search.yahoo.com/mrss/" xmlns:og="http://ogp.me/ns#">
<channel>
<atom:link rel="self" href="http://192.168.1.4/fivefilters/makefulltextfeed.php?url=feed.cnblogs.com%2Fblog%2Fsitehome%2Frss&amp;max=10&amp;links=preserve&amp;exc=" />
<atom:link rel="alternate" title="Source URL" href="http://feed.cnblogs.com/blog/sitehome/rss" />
<atom:link rel="related" title="Subscribe to feed" href="http://www.subtome.com/#/subscribe?feeds=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dfeed.cnblogs.com%252Fblog%252Fsitehome%252Frss%26max%3D10%26links%3Dpreserve%26exc%3D&amp;back=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dfeed.cnblogs.com%252Fblog%252Fsitehome%252Frss%26max%3D10%26links%3Dpreserve%26exc%3D" />
<title>博客园_首页</title>
<link></link>
<description>代码改变世界</description>
<item>
<title>【学习笔记】剖析MVVM框架，简单实现Vue数据双向绑定 - 唐吉sir</title>
<link>http://www.cnblogs.com/youma/p/10436373.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/youma/p/10436373.html</guid>
<description>&lt;h2&gt;前言：&lt;/h2&gt;
&lt;p&gt;学习前端也有半年多了，个人的学习欲望还比较强烈，很喜欢那种新知识在自己的演练下一点点实现的过程。最近一直在学vue框架，像网上大佬说的，入门容易深究难。不管是跟着开发文档学还是视频教程，按步骤操作总是最肤浅，想要把这门功课做好毕竟得下足功夫。因此，特意花了好几天时间阅读相关技术博客和源码，简单实现了一个数据双向绑定的vue框架，希望能让各位有点启发...&lt;/p&gt;
&lt;h3&gt;1.什么是MVVM&lt;/h3&gt;
&lt;p&gt;MVVM即modle-view-viewmole,MVVM最早由微软提出来，在前端页面中，把Model用纯JavaScript对象表示，View负责显示，两者做到了最大限度的分离。把Model和View关联起来的就是ViewModel。ViewModel负责把Model的数据同步到View显示出来，还负责把View的修改同步回Model。&lt;/p&gt;
&lt;h3&gt;2.数据的双向绑定&lt;/h3&gt;
&lt;p&gt;在vue框架中，通过控制台或者Vue Devtools修改data里的一些属性时会看到页面也会更新，而在页面修改数据时，data里的属性值也会发生改变。我们就把这种model和view同步显示称为是双向绑定。其实单向绑定原理也差不多，视图改变data更新通过事件监听就能轻松实现了,重点都在希望data改变视图也发生改变，而这就是我们下面要讲的原理。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/900566/201902/900566-20190226164938065-1313226582.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;h3&gt;3.vue数据双向绑定原理&lt;/h3&gt;
&lt;h4&gt; 3.1 Object.defineProperty()方法&lt;/h4&gt;
&lt;p&gt;首先要知道的是vue的数据绑定通过数据劫持配合发布订阅者模式实现的，那么什么是数据劫持呢？我们可以在控制台看一下它的初始化对象是什么样的：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
 let vm = &lt;span&gt;new&lt;/span&gt;&lt;span&gt; Vue({
        el:&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;#app&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
        data:{
            obj:{
                a:&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;
            }
        },
        created() {
            console.log(&lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.obj)
        },
    })&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/900566/201902/900566-20190226144125490-774173122.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;




&lt;p&gt;可以看到属性a分别对应着一个get 和set方法，这里引申出Object.defineProperty()方法&lt;span&gt;，传递三个参数，obj(要在其上定义属性的对象)、prop(&lt;span&gt;要定义或修改的属性的名称&lt;/span&gt;)、descriptor(&lt;span&gt;将被定义或修改的属性描述符&lt;/span&gt;)。&lt;/span&gt;该方法更多信息参考：&lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty&quot; target=&quot;_blank&quot;&gt;参考更多用法&lt;/a&gt;，着重强调一下get和set这两个属性描述键值。&lt;/p&gt;
&lt;div&gt;
&lt;div&gt;
&lt;ul&gt;&lt;li&gt;get 存取描述符的可选键值，一个给属性提供 getter 的方法，如果没有 getter 则为 undefined。当访问该属性时，该方法会被执行，方法执行时没有参数传入，但是会传入this对象（由于继承关系，这里的this并不一定是定义该属性的对象）。&lt;/li&gt;
&lt;/ul&gt;&lt;/div&gt;
&lt;div&gt;
&lt;ul&gt;&lt;li&gt;set 存取描述符的可选键值，一个给属性提供 setter 的方法，如果没有 setter 则为 undefined。当属性值修改时，触发执行该方法。该方法将接受唯一参数，即该属性新的参数值。&lt;/li&gt;
&lt;/ul&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;span&gt;&lt;span&gt;平常我们在打印一个对象属性时会这样做：&lt;/span&gt;&lt;/span&gt; &lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;var&lt;/span&gt; obj =&lt;span&gt; {
   name:&quot;tnagj&quot;&lt;/span&gt;&lt;span&gt;
}
console.log(obj.name)  //tangj&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt; 如果我们想要在输出的同时监听obj的属性值，并且输出的是tangjSir呢？这时候我们的set和get属性就起到了很好的作用&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
 &lt;span&gt;var&lt;/span&gt; obj =&lt;span&gt;{};
 &lt;/span&gt;&lt;span&gt;var&lt;/span&gt; name = ''&lt;span&gt;;
 Object.defineProperty(obj,&lt;/span&gt;'name'&lt;span&gt;,{
     set:&lt;/span&gt;&lt;span&gt;function&lt;/span&gt;&lt;span&gt;(value){
         name &lt;/span&gt;=&lt;span&gt; value
         console.log(&lt;/span&gt;'我叫：' +&lt;span&gt; name)
     },
     get:&lt;/span&gt;&lt;span&gt;function&lt;/span&gt;&lt;span&gt;(){
        console.log(name &lt;/span&gt;+ 'Sir'&lt;span&gt;)
     }
 })
 obj.name &lt;/span&gt;= 'tangj';  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;我叫tangj&lt;/span&gt;
 obj.name;         &lt;span&gt;//&lt;/span&gt;&lt;span&gt;tangjSir&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;首先我们定义了一个obj空对象以及name空属性，再用一个Object.defineProperty()方法来判断obj.name的访问情况，如果是读值则调用get函数，如果是赋值则调用set函数。在这两个函数里面我们分别对输出的内容作了更改，因此在get方法调用时打印tangjSir，在set方法调用时打印我叫tangj。&lt;/p&gt;
&lt;p&gt;其实这就是vue数据绑定的监听原理，我们能通过这个简单实现MVVM双向绑定。&lt;/p&gt;
&lt;h4&gt;3.2 MVVM双向绑定分析 &lt;/h4&gt;
&lt;p&gt;view的变化，比如input值改变我们很容易就能知道通过input事件反应到data中，数据绑定的关键在于怎样让data更新view。首先我们要知道数据什么时候变的，上文提过可以用Object.defineProperty()的set属性描述键值来监听这个变化，当数据改变时就调用set方法。&lt;/p&gt;
&lt;p&gt;那么我们可以设置一个监听器Observe，用来监听所有的属性，当属性变化的时候就需要告诉订阅者Watcher看是否需要更新。因为订阅者是有很多个，所以我们需要有一个消息订阅器Dep来专门收集这些订阅者，然后在监听器Observer和订阅者Watcher之间进行统一管理的。当然我们还需要有一个指令解析器Compile，对每个节点元素进行扫描和解析，将相关指令对应初始化成一个订阅者Watcher，并替换模板数据或者绑定相应的函数，此时当订阅者Watcher接收到相应属性的变化，就会执行对应的更新函数，从而更新视图。所以，我们大致可以把整个过程拆分成五个部分，MVVM.html，MVVM.js，compile.js，observer.js，watcher.js，我们在MVVM.js中创建所需要的实例，在.html文件中引入这些js文件，这样拆分更容易理解也更好维护。&lt;/p&gt;
&lt;h3&gt;4.分步拆分&lt;/h3&gt;
&lt;h4&gt;4.1 MVVM.JS&lt;/h4&gt;
&lt;p&gt;为了和Vue保持一致，我们向MVVM.js传入一个空对象options，并让vm.$el = options.el，vm.$data = options.data，如果能取到vm.$el再进行编译和监听&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
&lt;span&gt;class MVVM {
       constructor(options){    
       &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.$el = options.el, &lt;span&gt;//&lt;/span&gt;&lt;span&gt;把东西挂载在实例上&lt;/span&gt;
       &lt;span&gt;this&lt;/span&gt;.$data =&lt;span&gt; options.data      
        &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;(&lt;span&gt;this&lt;/span&gt;.$el){    &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 如果有要编译的就开始编译            &lt;/span&gt;
            &lt;span&gt;new&lt;/span&gt; Observer(&lt;span&gt;this&lt;/span&gt;.$data); &lt;span&gt;//&lt;/span&gt;&lt;span&gt;数据劫持，就是把对象的所有属性改成get和set方法&lt;/span&gt;
            &lt;span&gt;new&lt;/span&gt; Compile(&lt;span&gt;this&lt;/span&gt;.$el,&lt;span&gt;this&lt;/span&gt;);&lt;span&gt;//&lt;/span&gt;&lt;span&gt;用数据和元素进行编译&lt;/span&gt;
&lt;span&gt;        }      
   }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;4.2  Compile.js&lt;/h4&gt;
&lt;p&gt;编译的时候有一个问题需要注意，如果直接操作DOM元素会特别消耗性能，所以我们希望先把DOM元素都放在内存中即文档碎片，待编译完成再把文档碎片放进真实的元素中&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;class Complie{
   constructor(el,vm){
       &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.el = &lt;span&gt;this&lt;/span&gt;.isElementNode(el)?&lt;span&gt;el:document.querySelector(el);
       &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.vm =&lt;span&gt; vm;
       &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;(&lt;span&gt;this&lt;/span&gt;.el){&lt;span&gt;//&lt;/span&gt;&lt;span&gt;如果这个元素能获取到，我们才开始编译                   &lt;/span&gt;
           let fragment = &lt;span&gt;this&lt;/span&gt;.nodeToFragment(&lt;span&gt;this&lt;/span&gt;.el); &lt;span&gt;//&lt;/span&gt;&lt;span&gt;1.先把真实的DOM移入到内存中，fragment            &lt;/span&gt;
           &lt;span&gt;this&lt;/span&gt;.compile(fragment); &lt;span&gt;//&lt;/span&gt;&lt;span&gt;2.编译=&amp;gt;提取想要的元素节点v-modle 和文本节点{{}}          &lt;/span&gt;
           &lt;span&gt;this&lt;/span&gt;.el.appendChild(fragment) &lt;span&gt;//&lt;/span&gt;&lt;span&gt;3.把编译好的fragment塞回页面&lt;/span&gt;
&lt;span&gt;       }
       nodeToFragment(el){   &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;需要el元素放到内存中&lt;/span&gt;
       let fragment =&lt;span&gt; document.createDocumentFragment();
       let Child;
       &lt;/span&gt;&lt;span&gt;while&lt;/span&gt;(Child =&lt;span&gt; el.firstChild){
           fragment.appendChild(Child);
       }
       &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; fragment;
    }
  }&lt;br/&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;接下来我们要判断需要编译的是元素节点还是文档节点，还记得Vue中有很多很有用的指令吗？比如&quot;v-modle&quot;、&quot;v-for&quot;等，所以我们还要判断元素节点内是否包含指令，如果是指令，它应该包含一些特殊的方法&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;40&quot;&gt;
&lt;pre&gt;
&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; 省略.... &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;&lt;span&gt;
    isElementNode(node){  &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;是不是元素节点&lt;/span&gt;
        &lt;span&gt;return&lt;/span&gt; node.nodeType === 1&lt;span&gt;;
    }   
    isDirective(name){   &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;是不是指令&lt;/span&gt;
        &lt;span&gt;return&lt;/span&gt; name.includes('v-'&lt;span&gt;)
    }
 compileElement(node){
          &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;带v-modle &lt;/span&gt;
          let attrs =&lt;span&gt; node.attributes;
          Array.from(attrs).forEach(
              attr &lt;/span&gt;=&amp;gt;&lt;span&gt;{
                 let attrName &lt;/span&gt;=&lt;span&gt; attr.name;
                 &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;(&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.isDirective(attrName)){
                   &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 取到对应的值放到节点中&lt;/span&gt;
                   let expr =&lt;span&gt; attr.value;                       
                   &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; node vm.$data expr&lt;/span&gt;
                   let [,type] = attrName.split('-')  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;解构赋值&lt;/span&gt;
                   CompileUtil[type](node,&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.vm,expr)
                 }
              }
          )
    }
    compileText(node){
         &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 带{{}}&lt;/span&gt;
         let expr = node.textContent; &lt;span&gt;//&lt;/span&gt;&lt;span&gt;取文本的内容&lt;/span&gt;
         let reg = /\{\{([^}]+)\}\}/g  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;全局匹配&lt;/span&gt;
         &lt;span&gt;if&lt;/span&gt;&lt;span&gt;(reg.test(expr)){
             &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; node this.vm.$data expr&lt;/span&gt;
             CompileUtil['text'](node,&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.vm,expr)
         }
    }
    compile(fragment){  &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;需要递归，拿到的childNodes只是第一层&lt;/span&gt;
        let childNodes =&lt;span&gt; fragment.childNodes;       
        Array.from(childNodes).forEach(
            node&lt;/span&gt;=&amp;gt;&lt;span&gt;{
                &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;(&lt;span&gt;this&lt;/span&gt;.isElementNode(node)){  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;是元素节点，还需要递归检查&lt;/span&gt;
                    &lt;span&gt;this&lt;/span&gt;.compileElement(node)  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;编译元素&lt;/span&gt;
                    &lt;span&gt;this&lt;/span&gt;.compile(node)  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;箭头函数this指向上一层的实例&lt;/span&gt;
                }&lt;span&gt;else&lt;/span&gt;{             &lt;span&gt;//&lt;/span&gt;&lt;span&gt;文本节点&lt;/span&gt;
                    &lt;span&gt;this&lt;/span&gt;.compileText(node)  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;编译文本&lt;/span&gt;
&lt;span&gt;                }
            }
        )
    }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;根据获取的节点类型不同，执行不同的方法，我们可把这些方法统一都放到一个对象里面去&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;56&quot;&gt;
&lt;pre&gt;
CompileUtil =&lt;span&gt; {
    getVal(vm,expr){  &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;获取实例上的数据   &lt;/span&gt;
        expr = expr.split('.'); &lt;span&gt;//&lt;/span&gt;&lt;span&gt;如果遇到vm.$data[a.a]，希望先拿到vm.$data[a]             &lt;/span&gt;
        &lt;span&gt;return&lt;/span&gt;  expr.reduce((prev,next)=&amp;gt;&lt;span&gt;{  
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; prev[next]
        },vm.$data)      
    },    
    getTextVal(vm,expr){  &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;获取编译文本以后的结果&lt;/span&gt;
            &lt;span&gt;return&lt;/span&gt; expr.replace(/\{\{([^}]+)\}\}/g,(...arguments)=&amp;gt;&lt;span&gt;{  
                &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;this&lt;/span&gt;.getVal(vm,arguments[1&lt;span&gt;]);
        })       
    },
    text(node,vm,expr){       &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 文本处理        &lt;/span&gt;
       let updateFn = &lt;span&gt;this&lt;/span&gt;.updater['textUpdater'&lt;span&gt;];     &lt;/span&gt;
       let value = &lt;span&gt;this&lt;/span&gt;&lt;span&gt;.getTextVal(vm,expr);     &lt;/span&gt;&lt;span&gt;     
       updateFn &lt;/span&gt;&amp;amp;&amp;amp;&lt;span&gt; updateFn(node,value);      
    },  
    modle(node,vm,expr){   &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 输入框处理&lt;/span&gt;
        let updateFn = &lt;span&gt;this&lt;/span&gt;.updater['modleUpdater'&lt;span&gt;]        &lt;/span&gt;&lt;span&gt;
        updateFn &lt;/span&gt;&amp;amp;&amp;amp; updateFn(node,&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.getVal(vm,expr))
    },
    updater:{
        textUpdater(ndoe,value){
             ndoe.textContent &lt;/span&gt;= value &lt;span&gt;//&lt;/span&gt;&lt;span&gt;文本更新&lt;/span&gt;
&lt;span&gt;        },        
        modleUpdater(node,value){
             node.value &lt;/span&gt;=&lt;span&gt; value  
        }
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;4.3 Oberver.js&lt;/h4&gt;
&lt;p&gt;编译的时候我们还需要一个监听者，当数据变化调用get和set方法&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;45&quot;&gt;
&lt;pre&gt;
&lt;span&gt;class Observer{
    constructor(data){
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.observer(data)
    }
    observer(data){       &lt;/span&gt;
        &lt;span&gt;if&lt;/span&gt;(!data || &lt;span&gt;typeof&lt;/span&gt; data !== 'object') &lt;span&gt;return&lt;/span&gt;&lt;span&gt;;
         Object.keys(data).forEach(key &lt;/span&gt;=&amp;gt;&lt;span&gt;{
             &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.defineReactive(data,key,data[key]);
             &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.observer(data[key])
         })         
    }
    defineReactive(obj,key,value){
        let that &lt;/span&gt;= &lt;span&gt;this&lt;/span&gt;&lt;span&gt;;      &lt;/span&gt;
&lt;span&gt;        Object.defineProperty(obj,key,{
            enumerable:&lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;span&gt;,         
            configurable:&lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;span&gt;,
            get(){                           
               Dep.target &lt;/span&gt;&amp;amp;&amp;amp;&lt;span&gt; dep.addSub(Dep.target);            
                &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; value;
            },
            set(newvalue){
                &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;(value === newvalue) &lt;span&gt;return&lt;/span&gt;&lt;span&gt;;              
                that.observer(newvalue);  &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;如果新值是对象，继续劫持&lt;/span&gt;
                value =&lt;span&gt; newvalue;&lt;/span&gt;
&lt;span&gt;            },
        })
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;4.4 Watcher订阅者和Dep监听器&lt;/h4&gt;
&lt;p&gt;前面已经实现了监听和编译，但是怎么样才能让它们之间进行通信呢，也就是当监听到变化了怎么通知呢？这里就用到了发布订阅模式。默认观察者watcher有一个update方法，它会更新数据。Dep里面创建一个数组，把观察者都放在这个数组里面，当监听到变化，一个个调用监听者update方法。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;42&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt; Watcher.js&lt;/span&gt;&lt;span&gt;
//&lt;/span&gt;&lt;span&gt;观察者的目的就是给需要变化的那个元素增加一个观察者，当数据变化后执行对应的方法&lt;/span&gt;
&lt;span&gt;class Watcher{
    constructor(vm,expr,cb){
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.vm =&lt;span&gt; vm;
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.expr =&lt;span&gt; expr;        
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.cb =&lt;span&gt; cb;
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;先获取老的值&lt;/span&gt;
        &lt;span&gt;this&lt;/span&gt;.value = &lt;span&gt;this&lt;/span&gt;&lt;span&gt;.get()       
    }
    getVal(vm,expr){  &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;获取实例上的数据   &lt;/span&gt;
        expr = expr.split('.'); &lt;span&gt;//&lt;/span&gt;&lt;span&gt;如果遇到vm.$data[a.a]，希望先拿到vm.$data[a]        &lt;/span&gt;
        &lt;span&gt;//&lt;/span&gt;&lt;span&gt; console.log(expr)&lt;/span&gt;
        &lt;span&gt;return&lt;/span&gt;  expr.reduce((prev,next)=&amp;gt;&lt;span&gt;{  
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; prev[next]
        },vm.$data)      
    }
    get(){
        Dep.target &lt;/span&gt;= &lt;span&gt;this&lt;/span&gt;;  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;缓存自己&lt;/span&gt;
        let value = &lt;span&gt;this&lt;/span&gt;.getVal(&lt;span&gt;this&lt;/span&gt;.vm,&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.expr);    
        Dep.target &lt;/span&gt;= &lt;span&gt;null&lt;/span&gt;; &lt;span&gt;//&lt;/span&gt;&lt;span&gt;释放自己     &lt;/span&gt;
        &lt;span&gt;return&lt;/span&gt;&lt;span&gt; value;
    }
    update(){
        let newValue &lt;/span&gt;= &lt;span&gt;this&lt;/span&gt;.getVal(&lt;span&gt;this&lt;/span&gt;.vm,&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.expr);       
        let oldValue &lt;/span&gt;= &lt;span&gt;this&lt;/span&gt;&lt;span&gt;.value;
        &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;(newValue !=&lt;span&gt; oldValue){
            &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.cb(newValue);
        }
    }
}
&lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Dep.js&lt;/span&gt;
&lt;span&gt;class Dep{
    constructor(){
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;订阅的数组&lt;/span&gt;
        &lt;span&gt;this&lt;/span&gt;.subs =&lt;span&gt; []
    }
    addSub(watcher){
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.subs.push(watcher)
    }
    notify(){
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.subs.forEach(watcher =&amp;gt;&lt;span&gt;{
            watcher.update()
        })
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;watcher逻辑： 当创建watcher实例的时候，先拿到这个值，数据变化又拿到一个新值，如果新值和老值不一样，那么调用callback，实现更新；&lt;/p&gt;
&lt;p&gt;dep逻辑：创建数组把观察者放在这个数组里，当监听到变化，执行watcher.update()&lt;/p&gt;
&lt;p&gt;我们再它们分别添加到Observer和compile中&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;56&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt; complie.js&lt;/span&gt;&lt;span&gt;
//&lt;/span&gt;&lt;span&gt; 省略....&lt;/span&gt;
text(node,vm,expr){       &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 文本处理        &lt;/span&gt;
       let updateFn = &lt;span&gt;this&lt;/span&gt;.updater['textUpdater'&lt;span&gt;];       
       &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;{{message.a}} =&amp;gt; tangj&lt;/span&gt;
       let value = &lt;span&gt;this&lt;/span&gt;&lt;span&gt;.getTextVal(vm,expr);
       expr.replace(&lt;/span&gt;/\{\{([^}]+)\}\}/g,(...arguments)=&amp;gt;&lt;span&gt;{
           &lt;/span&gt;&lt;span&gt;new&lt;/span&gt; Watcher(vm,arguments[1],(newVaule)=&amp;gt;&lt;span&gt;{
               &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 如果数据变化，文本节点需要重新获取依赖的属性更新文本的的内容&lt;/span&gt;
               updateFn &amp;amp;&amp;amp; updateFn(node,&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.getTextVal(vm,expr));
           })
    })              
       updateFn &lt;/span&gt;&amp;amp;&amp;amp;&lt;span&gt; updateFn(node,value);      
    },  
    modle(node,vm,expr){   &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 输入框处理&lt;/span&gt;
        let updateFn = &lt;span&gt;this&lt;/span&gt;.updater['modleUpdater'&lt;span&gt;]
         &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 'message.a' =&amp;gt; [message.a] vm.$data['message'].a&lt;/span&gt;
         &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 这里应该加一个监控，数据变化，调用这个watch的cb&lt;/span&gt;
         &lt;span&gt;new&lt;/span&gt; Watcher(vm,expr,(newVaule)=&amp;gt;&lt;span&gt;{
             &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;当值变化后将调用cb，将新的值传递过来&lt;/span&gt;
            updateFn &amp;amp;&amp;amp; updateFn(node,&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.getVal(vm,expr))
         });
         node.addEventListener(&lt;/span&gt;'input',(e)=&amp;gt;&lt;span&gt;{
             let newVaule &lt;/span&gt;=&lt;span&gt; e.target.value;
             &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.setVal(vm,expr,newVaule)
         })
        updateFn &lt;/span&gt;&amp;amp;&amp;amp; updateFn(node,&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.getVal(vm,expr))
    }
&lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 省略...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;45&quot;&gt;
&lt;pre&gt;
&lt;span&gt;// observer.js&lt;br/&gt;class Observer{
    constructor(data){
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.observer(data)
    }
    observer(data){ 
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;要对这个data数据原有属性改成set和get的形式&lt;/span&gt;
        &lt;span&gt;if&lt;/span&gt;(!data || &lt;span&gt;typeof&lt;/span&gt; data !== 'object') &lt;span&gt;return&lt;/span&gt;&lt;span&gt;;
         Object.keys(data).forEach(key &lt;/span&gt;=&amp;gt;&lt;span&gt;{
             &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.defineReactive(data,key,data[key]);
             &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.observer(data[key])
         })         
    }
    defineReactive(obj,key,value){
        let that &lt;/span&gt;= &lt;span&gt;this&lt;/span&gt;&lt;span&gt;;       
        let dep &lt;/span&gt;= &lt;span&gt;new&lt;/span&gt; Dep();  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;每个变化的数据都会对应一个数组，这个数据存放了所有数据的更新&lt;/span&gt;
&lt;span&gt;        Object.defineProperty(obj,key,{
            enumerable:&lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;span&gt;,         
            configurable:&lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;span&gt;,
            get(){                           
               Dep.target &lt;/span&gt;&amp;amp;&amp;amp;&lt;span&gt; dep.addSub(Dep.target);            
                &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; value;
            },
            set(newvalue){
                &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;(value === newvalue) &lt;span&gt;return&lt;/span&gt;&lt;span&gt;;              
                that.observer(newvalue);  &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;如果新值是对象，继续劫持&lt;/span&gt;
                value =&lt;span&gt; newvalue;
                dep.notify(); &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;通知所有人数据更新&lt;/span&gt;
&lt;span&gt;            },
        })
    }
}
class Dep{
    constructor(){
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;订阅的数组&lt;/span&gt;
        &lt;span&gt;this&lt;/span&gt;.subs =&lt;span&gt; []
    }
    addSub(watcher){
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.subs.push(watcher)
    }
    notify(){
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.subs.forEach(watcher =&amp;gt;&lt;span&gt;{
            watcher.update()
        })
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;到这里我们就实现了数据的双向绑定，MVVM作为数据绑定的入口，整合Observer、Compile和Watcher三者，通过Observer来监听自己的model数据变化，通过Compile来解析编译模板指令，最终利用Watcher搭起Observer和Compile之间的通信桥梁，达到数据变化 -&amp;gt; 视图更新；视图交互变化(input) -&amp;gt; 数据model变更的双向绑定效果。&lt;/p&gt;
&lt;p&gt;当然我们还需要数据代理，用vm代理vm.$data，也是通过Object.defineProperty()实现&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;41&quot;&gt;
&lt;p&gt; this.proxyData(this.$data);&lt;/p&gt;
&lt;pre&gt;
&lt;span&gt;proxyData(data){
       Object.keys(data).forEach(key &lt;/span&gt;=&amp;gt;&lt;span&gt;{
           let val &lt;/span&gt;=&lt;span&gt; data[key]
           Object.defineProperty(&lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;,key,{
               enumerable:&lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;span&gt;,
               configurable:&lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;span&gt;,
               get(){                   
                   &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; val
               },
               set(newval){
                   &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;(val ==&lt;span&gt; newval){
                    &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt;;
                   }
                   val &lt;/span&gt;=&lt;span&gt; newval
               }
           })
       })
   }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;5.最终效果&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/900566/201903/900566-20190302151606484-1984744898.gif&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;p&gt;本次学习源码已上传github：&lt;a href=&quot;https://github.com/Tangjj1996/MVVM&quot; target=&quot;_blank&quot;&gt;https://github.com/Tangjj1996/MVVM&lt;/a&gt;，喜欢的朋友可以stars&lt;/p&gt;
&lt;p&gt;参考博客：&lt;a href=&quot;https://www.cnblogs.com/yuliangbin/p/9302721.html#4035761&quot; target=&quot;_blank&quot;&gt;基于vue实现一个简单的MVVM框架（源码分析）&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;PS:MVVM是学习框架非常重要的一步，掌握了这些原理才能更好地运用，知其然更要知其所以然，水平有限有错误的地方烦请多多指教&lt;/p&gt;

</description>
<pubDate>Sat, 02 Mar 2019 07:23:00 +0000</pubDate>
<dc:creator>唐吉sir</dc:creator>
<og:description>前言： 学习前端也有半年多了，个人的学习欲望还比较强烈，很喜欢那种新知识在自己的演练下一点点实现的过程。最近一直在学vue框架，像网上大佬说的，入门容易深究难。不管是跟着开发文档学还是视频教程，按步骤</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/youma/p/10436373.html</dc:identifier>
</item>
<item>
<title>爬虫之requests模块 - W的一天</title>
<link>http://www.cnblogs.com/12345huangchun/p/10461211.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/12345huangchun/p/10461211.html</guid>
<description>&lt;h2&gt;　　一、爬虫&lt;/h2&gt;
&lt;p&gt;　　我所理解的爬虫就是编写程序，模拟浏览器发送请求，然后服务端把数据响应给我，然后我再对响应的数据做解析，拿到我想要的那一小部分，这就是整个爬虫过程。说起来很简单哈，其实不然，门户网站是很不希望他们的数据被爬虫程序拿到，有可能说有些不怀好意的人拿数据干见不得人的勾当，或者说现在大数据时代，有数据才能说明一切，所以门户网站也很珍惜他们的数据，不想那么轻易被别人拿走，于是乎门户网站的程序员就是开始设定很多规则来判断发送请求的是不是一个爬虫程序了，如果是，就直接不给他数据，这就是反爬机制。俗话说“上有政策，下有对策”，难道就你门户网站的人聪明吗？你错了，天外有天，人外有人，你以为你那点小伎俩就能难倒我（确实有很多反爬策略很恶心），就算是大海捞针，我也要通过你的反爬机制，拿到数据，我在找出它的反爬机制和制定相应的对策的过程就叫反反爬。&lt;/p&gt;
&lt;p&gt;　　爬虫总共分为四部分，发送请求，获取响应，解析数据，保存数据，如下图：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/1519076/201903/1519076-20190302102431009-2113704654.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;　　今天要说的就是利用requests模块发送请求的过程，也是这整个过程中最重要的一步，也应该是最困难的一步（纯属一家之言），因为上面所说的反爬和反反爬都在这其中。&lt;/p&gt;
&lt;h2&gt;　　二、requests模块的基础知识&lt;/h2&gt;
&lt;h3&gt;　　1，requests支持的请求方式&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
requests.get(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;http://httpbin.org/get&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)
requests.post(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;http://httpbin.org/post&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)
requests.put(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;http://httpbin.org/put&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)
requests.delete(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;http://httpbin.org/delete&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)
requests.head(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;http://httpbin.org/get&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)
requests.options(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;http://httpbin.org/get&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;)&lt;br/&gt;我们最常用的就是get和post请求，两者的区别就是get请求没有请求体，而post请求有请求体
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;　　2，get请求&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;39&quot;&gt;
&lt;pre&gt;
&lt;span&gt;import&lt;/span&gt;&lt;span&gt; requests&lt;br/&gt;#这是请求的路径，必须有
url&lt;/span&gt;=&lt;span&gt;'&lt;/span&gt;&lt;span&gt;https://dig.chouti.com/&lt;/span&gt;&lt;span&gt;'  &lt;br/&gt;&lt;span&gt;#这是本次访问携带的参数，发送请求时，它会以？name=hh的形式加在路径后面，不是必须要有 &lt;/span&gt;&lt;/span&gt;&lt;span&gt;
params&lt;/span&gt;={&lt;span&gt;'&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;:&lt;span&gt;'&lt;/span&gt;&lt;span&gt;hh&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;}    &lt;br/&gt;#这是请求的请求体，它是以键值对的形式存在的，也不是必须要有
headers&lt;/span&gt;={&lt;span&gt;'&lt;/span&gt;&lt;span&gt;User-Agent&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;:&lt;span&gt;'&lt;/span&gt;&lt;span&gt;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.119 Safari/537.36&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;}
#这是访问携带的cookie数据&lt;br/&gt;cookies&lt;/span&gt;=&lt;span&gt;'&lt;/span&gt;&lt;span&gt;dshdjdsadhsaghgdasjjdasjdhasdashdjkhskad&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;&lt;br/&gt;res &lt;/span&gt;= requests.get(url=url, headers=headers,params=params,cookies=cookies)
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;　　3，post请求&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;40&quot;&gt;
&lt;pre&gt;
&lt;span&gt;post请求和get请求是一样的，只是多了一个请求体数据&lt;br/&gt;#data和json都是请求体数据，data是字典类型的，json发送的是json字符串
data&lt;/span&gt;={&lt;span&gt;'&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;:&lt;span&gt;'&lt;/span&gt;&lt;span&gt;hh&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;pwd&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;:&lt;span&gt;'&lt;/span&gt;&lt;span&gt;12345&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;}      
json&lt;/span&gt;={&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;:&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;hh&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;,&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;pwd&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;:&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;12345&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;}&lt;br/&gt;#请求体是以data形式发的，默认的contentType类型是urlencoded，如果请求体数据是以json形式发的，默认的contentType类型为json
res1&lt;/span&gt;=requests.post(url=&lt;span&gt;'&lt;/span&gt;&lt;span&gt;http://httpbin.org/post&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, data={&lt;span&gt;'&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;:&lt;span&gt;'&lt;/span&gt;&lt;span&gt;yuan&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;})
res2&lt;/span&gt;=requests.post(url=&lt;span&gt;'&lt;/span&gt;&lt;span&gt;http://httpbin.org/post&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,json={&lt;span&gt;'&lt;/span&gt;&lt;span&gt;age&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;:&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;22&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;,})&lt;br/&gt;对于post请求来说，除了比get请求多一个请求体以外，其他用法一模一样，get请求拥有的参数，post都拥有，比如说params参数，&lt;br/&gt;如果在post请求里面加一个params参数，他会和get请求一样，会以?a=1的形式加在请求路径后面
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;　　4，response响应对象&lt;/h3&gt;
&lt;p&gt;　　4.1 常见属性&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;import&lt;/span&gt;&lt;span&gt; requests
respone&lt;/span&gt;=requests.get(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;https://sh.lianjia.com/ershoufang/&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
respone.text     #响应文本，本身是字节类型，但会以一种猜测的编码格式帮你解码成字符串
respone.content  #响应文本，字节类型的文本
respone.status_code  #响应的状态码
respone.headers      #响应头数据
respone.cookies      #响应的cookie
respone.cookies.get_dict()    #响应的字典形式的cookie
respone.cookies.items()       #响应的元祖形式的cookie
respone.url                   
respone.history               #如果请求过程中发生了重定向，这会帮你记录过程
respone.encoding              #指定text的是用哪种方式解码&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;　　4.2 编码问题&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
刚才上面讲了，res.text会以一种猜测的编码帮你解码，但有时是不正确的编码，所以导致拿到数据编码会有问题，其实我们可以给text指定用哪种编码解码&lt;br/&gt;import requests&lt;br/&gt;res=requests.get('http://www.baidu.com')&lt;br/&gt;coding=res.apparent_encoding      #这才是拿到别人的编码方式&lt;br/&gt;res.encoding=coding               #把别人的编码方式赋给text的解码方式&lt;br/&gt;res.text                         #这样解码后的字符串就不会有问题了
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;　　4.3 对于图片、视频等字节类型文件&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;39&quot;&gt;
&lt;pre&gt;
&lt;span&gt;&lt;span&gt;首先我们直接用res.content就行了，其次是由于文件太大，我们不应该一下就全写进文件里，而是应该一段一段的写进去，于是我们就可以for循环res.iter_content(),然后再一次一次的写入&lt;/span&gt;&lt;br/&gt;import&lt;/span&gt;&lt;span&gt; requests
response&lt;/span&gt;=requests.get(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;http://bangimg1.dahe.cn/forum/201612/10/200447p36yk96im76vatyk.jpg&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
with open(&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;res.png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;,&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;wb&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;) as f:
    &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; f.write(response.content) # 比如下载视频时,如果视频100G,用response.content然后一下子写到文件中是不合理的&lt;/span&gt;
    &lt;span&gt;for&lt;/span&gt; line &lt;span&gt;in&lt;/span&gt;&lt;span&gt; response.iter_content():     
        f.write(line)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;　　4.4针对接收json数据&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;import&lt;/span&gt;&lt;span&gt; requests
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; json
response&lt;/span&gt;=requests.get(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;http://httpbin.org/get&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)&lt;br/&gt;#我们是可以用反序列化自己手动处理json数据，其实这样麻烦了
res1&lt;/span&gt;=json.loads(response.text) &lt;br/&gt;#别人已经给我们封装好了一个方法res.json()这样就直接帮你完成了反序列化的过程
res2=response.json() 
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;　　4.5关于重定向&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;在requests的一些列请求方式中，除了head方式，其他的都会自动处理重定向，上面的属性讲了，可以通过res.history可以查看发送了那些重定向
我们还可以通过allow_redirects参数设置不让他重定向
r &lt;/span&gt;= requests.get(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;http://github.com&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, allow_redirects=False)
&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;　　三、反爬机制与反反爬&lt;/h2&gt;
&lt;h3&gt;　　1，UA机制&lt;/h3&gt;
&lt;p&gt;　　User-Agent：请求载体身份标识，通过浏览器发起的请求，请求载体为浏览器；使用爬虫程序发起的请求，请求载体为爬虫程序，所以可以通过判断UA值判断该请求是基于浏览器还是爬虫程序，门户网站对访问的UA进行判断时，如果是爬虫程序，就直接拒接提供数据&lt;/p&gt;
&lt;p&gt;　　反反爬策略就是把我们的UA伪造成浏览器载体标识，我们只需要在请求头加上一个浏览器载体的UA就可以了&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
headers=&lt;span&gt;{
    &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;User-Agent&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;:&lt;span&gt;'&lt;/span&gt;&lt;span&gt;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.119 Safari/537.36&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
}&lt;br/&gt;这样就把请求体载体设置成了Google浏览器的UA标识&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;　　2，用户登录机制和cookie机制&lt;/h3&gt;
&lt;p&gt;　　也就是说，很多网站要求登录才能访问，它的反爬机制是：首先你得访问它的主页面，然后从主页面发送你得用户名密码到服务器，如果验证成功后，它会自动帮你重定向到你得页面，在这个过程，一般情况下，在你第一次访问它的主页面时会返回给你一个cookie，然后你发送用户名和密码的路径不是主页面的路径，而是另外的请求路径，而且他要求的数据结构还不一样。&lt;/p&gt;
&lt;p&gt;　　反反爬策略：首先我们用浏览器去访问主页面，找到登录位置，输入一组错误的数据，然后点‘检查’，再点‘network’，把之前返回的包都清掉，然后点击‘登录’，这时候我们就得去分析下刚才接收的包，看看哪一个是含有我用户名和密码的数据，这个差不多就是我们要的包，再去看这个包请求的路径和数据结构，这是第一步做分析；第二步就是写爬虫程序，一般在发送登录数据的请求体里会包含第一次访问主页面返回的cookie，所以代码第一步是发送主页面请求，获取到返回的cookie，那这个cookie加上数据去访问登录的路径就差不多了。&lt;/p&gt;
&lt;p&gt;　　2.1 页面分析&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/1519076/201903/1519076-20190302140842691-177913852.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;　　点击登录之后：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/1519076/201903/1519076-20190302141422745-110369054.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;　　查看其他数据&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/1519076/201903/1519076-20190302141621381-2035457416.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;　　2.2 书写爬虫代码&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;62&quot;&gt;
&lt;pre&gt;
url1=&lt;span&gt;'&lt;/span&gt;&lt;span&gt;https://www.douban.com/&lt;/span&gt;&lt;span&gt;'        #这是首页的路径&lt;/span&gt;&lt;span&gt;
url2&lt;/span&gt;=&lt;span&gt;'&lt;/span&gt;&lt;span&gt;https://accounts.douban.com/j/mobile/login/basic&lt;/span&gt;&lt;span&gt;'              #这是登录发送请求的路径&lt;/span&gt;&lt;span&gt;
headers&lt;/span&gt;=&lt;span&gt;{
    &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;User-Agent&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;:&lt;span&gt;'&lt;/span&gt;&lt;span&gt;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.119 Safari/537.36&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
}
data&lt;/span&gt;=&lt;span&gt;{                                        #这是请求的数据
    &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;ck&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;''&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;18839124390&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;password&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;:&lt;span&gt;'&lt;/span&gt;&lt;span&gt;huangchun12345&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;remember&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;false&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;ticket&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;''&lt;/span&gt;&lt;span&gt;}
session&lt;/span&gt;=&lt;span&gt;requests.session()                    
session.get(url&lt;/span&gt;=url1,headers=&lt;span&gt;headers)            #这两步就会把我访问主页面的cookie放在session里面，从而我就不用把cookie取出来，下次直接用session发送请求就会自动带上返回的cookie
res&lt;/span&gt;=session.post(url=url2,headers=headers,data=&lt;span&gt;data)       #这是带着返回的cookie向登录路径提交数据
&lt;/span&gt;&lt;span&gt;print&lt;/span&gt;(res.text) &lt;br/&gt;这整个过程就是一般登录程序的爬虫程序，在用session发送post请求时，如有重定向，会自动帮你重定向的，得到的res是最后重定向后的结果&lt;br/&gt;但这个豆瓣网有点不同，我得到的res是一个json字符串，里面有很多信息，&lt;br/&gt;{&quot;status&quot;:&quot;success&quot;,&quot;message&quot;:&quot;success&quot;,&quot;description&quot;:&quot;处理成功&quot;,&quot;payload&quot;:{&quot;account_info&quot;:{&quot;name&quot;:&quot;黄麻口&quot;,&quot;weixin_binded&quot;:true,&quot;phone&quot;:&quot;18839124390&quot;,&lt;br/&gt;&quot;avatar&quot;:{&quot;medium&quot;:&quot;https://img3.doubanio.com\/icon\/up192624730-1.jpg&quot;,&quot;median&quot;:&quot;https://img3.doubanio.com\/icon\/us192624730-1.jpg&quot;,&quot;large&quot;:&quot;https://img3.doubanio.com\/icon\/ul192624730-1.jpg&quot;,&lt;br/&gt;&quot;raw&quot;:&quot;https://img3.doubanio.com\/icon\/ur192624730-1.jpg&quot;,&quot;small&quot;:&quot;https://img3.doubanio.com\/icon\/u192624730-1.jpg&quot;,&quot;icon&quot;:&quot;https://img3.doubanio.com\/icon\/ui192624730-1.jpg&quot;},&quot;id&quot;:&quot;192624730&quot;,&lt;br/&gt;&quot;uid&quot;:&quot;192624730&quot;}}}&lt;br/&gt;我猜测，这个登录请求是用ajax发的，服务端验证用户成功后，返回一个json字符串，包含很多信息，比如第一个键值对‘status’:'success'，ajax根据收到数据，再执行其他操作，比如status等于success时，带着cookie去访问主页面就可以成功了，&lt;br/&gt;但我的爬虫程序不能实现ajax的重定向，所以我们可以用刚才返回的cookie去访问主页面就可以了，代码改变如下：
&lt;/pre&gt;
&lt;pre&gt;
session.post(url=url2,headers=headers,data=data)       #把上面的post请求改成这样就行了&lt;br/&gt;res=session.get(url=url1,headers=headers)
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;　　3，IP限制机制&lt;/h3&gt;
&lt;p&gt;　　有些门户网站会检测某一段时间某个IP的访问次数，如果访问频率太快，比如1分钟访问几百次，这种显然不是人为手动点击访问，肯定是爬虫程序搞得，此时门户网站就会禁止这个IP的访问。&lt;/p&gt;
&lt;p&gt;　　反反爬策略：就是使用代理IP，我每次访问不用自己的IP，就算被封了，下次再换个IP就行了。总共分为两类：一是正向代理，代理客户端获取数据，为了保护客户端，防止被追究责任；而是反向代理，代理服务器提供数据，为了保护服务器。网上的免费代理IP网站：‘快代理’&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;41&quot;&gt;
&lt;pre&gt;
&lt;span&gt;import&lt;/span&gt;&lt;span&gt; requests
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; random
&lt;/span&gt;&lt;span&gt;if&lt;/span&gt; &lt;span&gt;__name__&lt;/span&gt; == &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;__main__&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;:
    &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;不同浏览器的UA&lt;/span&gt;
    header_list =&lt;span&gt; [
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 遨游&lt;/span&gt;
        {&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;user-agent&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Maxthon 2.0)&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;},
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 火狐&lt;/span&gt;
        {&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;user-agent&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;Mozilla/5.0 (Windows NT 6.1; rv:2.0.1) Gecko/20100101 Firefox/4.0.1&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;},
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 谷歌&lt;/span&gt;
&lt;span&gt;        {
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;user-agent&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_0) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.56 Safari/535.11&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;}
    ]
    &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;不同的代理IP&lt;/span&gt;
    proxy_list =&lt;span&gt; [
        {&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;http&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;112.115.57.20:3128&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;},
        {&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;http&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;121.41.171.223:3128&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;}
    ]
    &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;随机获取UA和代理IP&lt;/span&gt;
    header =&lt;span&gt; random.choice(header_list)
    proxy &lt;/span&gt;=&lt;span&gt; random.choice(proxy_list)

    url &lt;/span&gt;= &lt;span&gt;'&lt;/span&gt;&lt;span&gt;http://www.baidu.com/s?ie=UTF-8&amp;amp;wd=ip&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;
    &lt;span&gt;#&lt;/span&gt;&lt;span&gt;参数3：设置代理&lt;/span&gt;
    response = requests.get(url=url,headers=header,proxies=&lt;span&gt;proxy)&lt;/span&gt;&lt;span&gt;
    当没有proxies参数时，就是用的自己的IP&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
</description>
<pubDate>Sat, 02 Mar 2019 07:15:00 +0000</pubDate>
<dc:creator>W的一天</dc:creator>
<og:description>一、爬虫 我所理解的爬虫就是编写程序，模拟浏览器发送请求，然后服务端把数据响应给我，然后我再对响应的数据做解析，拿到我想要的那一小部分，这就是整个爬虫过程。说起来很简单哈，其实不然，门户网站是很不希望</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/12345huangchun/p/10461211.html</dc:identifier>
</item>
<item>
<title>权限管理系统之集成Shiro实现登录、url和页面按钮的访问控制 - 社会主义接班人</title>
<link>http://www.cnblogs.com/5ishare/p/10461073.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/5ishare/p/10461073.html</guid>
<description>&lt;p&gt;用户权限管理一般是对用户页面、按钮的访问权限管理。Shiro框架是一个强大且易用的Java安全框架，执行身份验证、授权、密码和会话管理，对于Shiro的介绍这里就不多说。本篇博客主要是了解Shiro的基础使用方法，在权限管理系统中集成Shiro实现登录、url和页面按钮的访问控制。&lt;/p&gt;
&lt;p&gt;一、引入依赖&lt;/p&gt;
&lt;p&gt;使用SpringBoot集成Shiro时，在pom.xml中可以引入shiro-spring-boot-web-starter。由于使用的是thymeleaf框架，thymeleaf与Shiro结合需要 引入thymeleaf-extras-shiro。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
        &lt;span&gt;&amp;lt;!--&lt;/span&gt;&lt;span&gt; https://mvnrepository.com/artifact/org.apache.shiro/shiro-spring-boot-web-starter &lt;/span&gt;&lt;span&gt;--&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;org.apache.shiro&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;shiro-spring-boot-web-starter&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;1.4.0&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;!--&lt;/span&gt;&lt;span&gt; https://mvnrepository.com/artifact/com.github.theborakompanioni/thymeleaf-extras-shiro &lt;/span&gt;&lt;span&gt;--&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;com.github.theborakompanioni&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;thymeleaf-extras-shiro&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;2.0.0&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;二、增加Shiro配置&lt;/p&gt;
&lt;p&gt;有哪些url是需要拦截的，哪些是不需要拦截的，登录页面、登录成功页面的url、自定义的Realm等这些信息需要设置到Shiro中，所以创建Configuration文件ShiroConfig。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35.5&quot;&gt;&lt;img id=&quot;code_img_closed_44df248c-d721-4f78-87a5-b1efd6651b9d&quot; class=&quot;code_img_closed&quot; src=&quot;http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt;&lt;img id=&quot;code_img_opened_44df248c-d721-4f78-87a5-b1efd6651b9d&quot; class=&quot;code_img_opened&quot; src=&quot;http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; alt=&quot;&quot;/&gt;&lt;div id=&quot;cnblogs_code_open_44df248c-d721-4f78-87a5-b1efd6651b9d&quot; class=&quot;cnblogs_code_hide&quot; readability=&quot;66&quot;&gt;
&lt;pre&gt;
&lt;span&gt;package&lt;/span&gt;&lt;span&gt; com.example.config;


&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.mgt.SecurityManager;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.spring.web.ShiroFilterFactoryBean;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.web.mgt.DefaultWebSecurityManager;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.beans.factory.annotation.Qualifier;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.context.annotation.Bean;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.context.annotation.Configuration;

&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; at.pollux.thymeleaf.shiro.dialect.ShiroDialect;

&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; java.util.LinkedHashMap;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; java.util.Map;


@Configuration
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; ShiroConfig {
    @Bean(&lt;/span&gt;&quot;shiroFilterFactoryBean&quot;&lt;span&gt;)
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; ShiroFilterFactoryBean shiroFilterFactoryBean(SecurityManager securityManager) {
        System.out.println(&lt;/span&gt;&quot;ShiroConfiguration.shirFilter()&quot;&lt;span&gt;);
        ShiroFilterFactoryBean shiroFilterFactoryBean &lt;/span&gt;= &lt;span&gt;new&lt;/span&gt;&lt;span&gt; ShiroFilterFactoryBean();
        shiroFilterFactoryBean.setSecurityManager(securityManager);
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;拦截器.&lt;/span&gt;
        Map&amp;lt;String,String&amp;gt; filterChainDefinitionMap = &lt;span&gt;new&lt;/span&gt; LinkedHashMap&amp;lt;String,String&amp;gt;&lt;span&gt;();
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 配置不会被拦截的链接 顺序判断&lt;/span&gt;
        filterChainDefinitionMap.put(&quot;/static/**&quot;, &quot;anon&quot;&lt;span&gt;);
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;配置退出 过滤器,其中的具体的退出代码Shiro已经替我们实现了&lt;/span&gt;
        filterChainDefinitionMap.put(&quot;/logout&quot;, &quot;logout&quot;&lt;span&gt;);
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;&amp;lt;!-- 过滤链定义，从上向下顺序执行，一般将/**放在最为下边 --&amp;gt;:这是一个坑呢，一不小心代码就不好使了;
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;&amp;lt;!-- authc:所有url都必须认证通过才可以访问; anon:所有url都都可以匿名访问--&amp;gt;&lt;/span&gt;
        filterChainDefinitionMap.put(&quot;/**&quot;, &quot;authc&quot;&lt;span&gt;);
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 如果不设置默认会自动寻找Web工程根目录下的&quot;/login.jsp&quot;页面&lt;/span&gt;
        shiroFilterFactoryBean.setLoginUrl(&quot;/login&quot;&lt;span&gt;);
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 登录成功后要跳转的链接&lt;/span&gt;
        shiroFilterFactoryBean.setSuccessUrl(&quot;/index&quot;&lt;span&gt;);

        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;未授权界面;&lt;/span&gt;
        shiroFilterFactoryBean.setUnauthorizedUrl(&quot;/403&quot;&lt;span&gt;);
        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; shiroFilterFactoryBean;
    }

    @Bean(name&lt;/span&gt;=&quot;defaultWebSecurityManager&quot;)    &lt;span&gt;//&lt;/span&gt;&lt;span&gt;创建DefaultWebSecurityManager    &lt;/span&gt;
    &lt;span&gt;public&lt;/span&gt; DefaultWebSecurityManager getDefaultWebSecurityManager(@Qualifier(&quot;userRealm&quot;&lt;span&gt;)MyShiroRealm userRealm){        
        DefaultWebSecurityManager defaultWebSecurityManager &lt;/span&gt;= &lt;span&gt;new&lt;/span&gt;&lt;span&gt; DefaultWebSecurityManager();        
        defaultWebSecurityManager.setRealm(userRealm);        
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; defaultWebSecurityManager;
        
    }        
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;创建Realm    &lt;/span&gt;
    @Bean(name=&quot;userRealm&quot;&lt;span&gt;)    
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; MyShiroRealm getUserRealm(){        
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt;&lt;span&gt; MyShiroRealm();    
        
    }
    
    @Bean
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; ShiroDialect shiroDialect() {
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt;&lt;span&gt; ShiroDialect();
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;span class=&quot;cnblogs_code_collapse&quot;&gt;View Code&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;ShiroDialect这个bean对象是在thymeleaf与Shiro结合，前端html访问Shiro时使用。&lt;/p&gt;
&lt;p&gt;三、自定义Realm&lt;/p&gt;
&lt;p&gt;在自定义的Realm中继承了AuthorizingRealm抽象类，重写了两个方法：doGetAuthorizationInfo和doGetAuthenticationInfo。doGetAuthorizationInfo主要是用来处理权限配置，doGetAuthenticationInfo主要处理身份认证。这里在doGetAuthorizationInfo中，将role表的id和permission表的code分别设置到SimpleAuthorizationInfo对象中的role和permission中。还有一个地方需要注意：@Component(&quot;authorizer&quot;)，刚开始我没设置，但报错提示需要一个authorizer的bean，查看AuthorizingRealm可以发现它implements了Authorizer，所以在自定义的realm上添加@Component(&quot;authorizer&quot;)就可以了。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33.5&quot;&gt;&lt;img id=&quot;code_img_closed_14e45473-1293-4663-8f50-8e55a5806307&quot; class=&quot;code_img_closed&quot; src=&quot;http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt;&lt;img id=&quot;code_img_opened_14e45473-1293-4663-8f50-8e55a5806307&quot; class=&quot;code_img_opened&quot; src=&quot;http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; alt=&quot;&quot;/&gt;&lt;div id=&quot;cnblogs_code_open_14e45473-1293-4663-8f50-8e55a5806307&quot; class=&quot;cnblogs_code_hide&quot; readability=&quot;62&quot;&gt;
&lt;pre&gt;
&lt;span&gt;package&lt;/span&gt;&lt;span&gt; com.example.config;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.authc.AuthenticationException;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.authc.AuthenticationInfo;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.authc.AuthenticationToken;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.authc.SimpleAuthenticationInfo;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.authz.AuthorizationInfo;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.authz.SimpleAuthorizationInfo;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.realm.AuthorizingRealm;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.subject.PrincipalCollection;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.beans.factory.annotation.Autowired;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.stereotype.Component;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; com.example.pojo.Permission;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; com.example.pojo.Role;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; com.example.pojo.User;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; com.example.service.RoleService;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; com.example.service.UserService;

@Component(&lt;/span&gt;&quot;authorizer&quot;&lt;span&gt;)
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; MyShiroRealm &lt;span&gt;extends&lt;/span&gt;&lt;span&gt; AuthorizingRealm {
    
    @Autowired
    &lt;/span&gt;&lt;span&gt;private&lt;/span&gt;&lt;span&gt; UserService userService;
    
    @Autowired
    &lt;/span&gt;&lt;span&gt;private&lt;/span&gt;&lt;span&gt; RoleService roleService;
    
    @Override
    &lt;/span&gt;&lt;span&gt;protected&lt;/span&gt;&lt;span&gt; AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {
        System.out.println(&lt;/span&gt;&quot;权限配置--&amp;gt;MyShiroRealm.doGetAuthorizationInfo()&quot;&lt;span&gt;);
        SimpleAuthorizationInfo authorizationInfo &lt;/span&gt;= &lt;span&gt;new&lt;/span&gt;&lt;span&gt; SimpleAuthorizationInfo();
        User user  &lt;/span&gt;=&lt;span&gt; (User)principals.getPrimaryPrincipal();
        System.out.println(&lt;/span&gt;&quot;User:&quot;+user.toString()+&quot; roles count:&quot;+&lt;span&gt;user.getRoles().size());
        &lt;/span&gt;&lt;span&gt;for&lt;/span&gt;&lt;span&gt;(Role role:user.getRoles()){
            authorizationInfo.addRole(role.getId());
            role&lt;/span&gt;=&lt;span&gt;roleService.getRoleById(role.getId());
            System.out.println(&lt;/span&gt;&quot;Role:&quot;+&lt;span&gt;role.toString());
            &lt;/span&gt;&lt;span&gt;for&lt;/span&gt;&lt;span&gt;(Permission p:role.getPermissions()){
                System.out.println(&lt;/span&gt;&quot;Permission:&quot;+&lt;span&gt;p.toString());
                authorizationInfo.addStringPermission(p.getCode());
            }
        }
        System.out.println(&lt;/span&gt;&quot;权限配置--&amp;gt;authorizationInfo&quot;+&lt;span&gt;authorizationInfo.toString());
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; authorizationInfo;
    }

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;主要是用来进行身份认证的，也就是说验证用户输入的账号和密码是否正确。&lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;&lt;span&gt;
    @Override
    &lt;/span&gt;&lt;span&gt;protected&lt;/span&gt;&lt;span&gt; AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token)
            &lt;/span&gt;&lt;span&gt;throws&lt;/span&gt;&lt;span&gt; AuthenticationException {
        System.out.println(&lt;/span&gt;&quot;MyShiroRealm.doGetAuthenticationInfo()&quot;&lt;span&gt;);
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;获取用户的输入的账号.&lt;/span&gt;
        String username =&lt;span&gt; (String)token.getPrincipal();
        System.out.println(token.getCredentials());
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;通过username从数据库中查找 User对象，如果找到，没找到.
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法&lt;/span&gt;
        User user =&lt;span&gt; userService.getUserById(username);
        System.out.println(&lt;/span&gt;&quot;-----&amp;gt;&amp;gt;userInfo=&quot;+&lt;span&gt;user);
        &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;(user == &lt;span&gt;null&lt;/span&gt;&lt;span&gt;){
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;
        }
        SimpleAuthenticationInfo authenticationInfo &lt;/span&gt;= &lt;span&gt;new&lt;/span&gt;&lt;span&gt; SimpleAuthenticationInfo(
                user, &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;用户名&lt;/span&gt;
                &quot;123456&quot;, &lt;span&gt;//&lt;/span&gt;&lt;span&gt;密码&lt;/span&gt;
                getName()  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;realm name&lt;/span&gt;
&lt;span&gt;        );
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; authenticationInfo;
    }

}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;span class=&quot;cnblogs_code_collapse&quot;&gt;View Code&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;四、登录认证&lt;/p&gt;
&lt;p&gt;1.登录页面&lt;/p&gt;
&lt;p&gt;这里做了一个非常丑的登录页面，主要是自己懒，不想在网上复制粘贴找登录页面了。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;&lt;img id=&quot;code_img_closed_8e3d1926-f984-4ead-a0ff-918c075e1a4e&quot; class=&quot;code_img_closed&quot; src=&quot;http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt;&lt;img id=&quot;code_img_opened_8e3d1926-f984-4ead-a0ff-918c075e1a4e&quot; class=&quot;code_img_opened&quot; src=&quot;http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; alt=&quot;&quot;/&gt;&lt;div id=&quot;cnblogs_code_open_8e3d1926-f984-4ead-a0ff-918c075e1a4e&quot; class=&quot;cnblogs_code_hide&quot; readability=&quot;63&quot;&gt;
&lt;pre&gt;
&lt;span&gt;&amp;lt;!&lt;/span&gt;&lt;span&gt;DOCTYPE html&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;head&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;meta &lt;/span&gt;&lt;span&gt;charset&lt;/span&gt;&lt;span&gt;=&quot;utf-8&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;title&lt;/span&gt;&lt;span&gt;&amp;gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;title&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;meta &lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;=&quot;renderer&quot;&lt;/span&gt;&lt;span&gt; content&lt;/span&gt;&lt;span&gt;=&quot;webkit&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;meta &lt;/span&gt;&lt;span&gt;http-equiv&lt;/span&gt;&lt;span&gt;=&quot;X-UA-Compatible&quot;&lt;/span&gt;&lt;span&gt; content&lt;/span&gt;&lt;span&gt;=&quot;IE=edge,chrome=1&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;meta &lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;=&quot;viewport&quot;&lt;/span&gt;&lt;span&gt; content&lt;/span&gt;&lt;span&gt;=&quot;width=device-width, initial-scale=1, maximum-scale=1&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;meta &lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;=&quot;apple-mobile-web-app-status-bar-style&quot;&lt;/span&gt;&lt;span&gt; content&lt;/span&gt;&lt;span&gt;=&quot;black&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;meta &lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;=&quot;apple-mobile-web-app-capable&quot;&lt;/span&gt;&lt;span&gt; content&lt;/span&gt;&lt;span&gt;=&quot;yes&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;meta &lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;=&quot;format-detection&quot;&lt;/span&gt;&lt;span&gt; content&lt;/span&gt;&lt;span&gt;=&quot;telephone=no&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;head&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;

&lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;form &lt;/span&gt;&lt;span&gt;action&lt;/span&gt;&lt;span&gt;=&quot;/login&quot;&lt;/span&gt;&lt;span&gt; method&lt;/span&gt;&lt;span&gt;=&quot;post&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt; 
      &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;label&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;用户名：&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;label&lt;/span&gt;&lt;span&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span&gt;input &lt;/span&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;=&quot;text&quot;&lt;/span&gt;&lt;span&gt; name&lt;/span&gt;&lt;span&gt;=&quot;id&quot;&lt;/span&gt;&lt;span&gt;   id&lt;/span&gt;&lt;span&gt;=&quot;id&quot;&lt;/span&gt; &lt;span&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span&gt;br&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
      &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;label &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;密码：&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;label&lt;/span&gt;&lt;span&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span&gt;input &lt;/span&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;=&quot;text&quot;&lt;/span&gt;&lt;span&gt; name&lt;/span&gt;&lt;span&gt;=&quot;pwd&quot;&lt;/span&gt;&lt;span&gt;  id&lt;/span&gt;&lt;span&gt;=&quot;pwd&quot;&lt;/span&gt; &lt;span&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span&gt;br&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
      &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;button &lt;/span&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;=&quot;submit&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;登录&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;button&lt;/span&gt;&lt;span&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span&gt;button &lt;/span&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;=&quot;reset&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;取消&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;button&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;form&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;body&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;html&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;span class=&quot;cnblogs_code_collapse&quot;&gt;View Code&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;2.处理登录请求&lt;/p&gt;
&lt;p&gt;在LoginController中通过登录名、密码获取到token实现登录。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;&lt;img id=&quot;code_img_closed_0be3093d-9134-4571-a8d8-1f16d198b909&quot; class=&quot;code_img_closed&quot; src=&quot;http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt;&lt;img id=&quot;code_img_opened_0be3093d-9134-4571-a8d8-1f16d198b909&quot; class=&quot;code_img_opened&quot; src=&quot;http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; alt=&quot;&quot;/&gt;&lt;div id=&quot;cnblogs_code_open_0be3093d-9134-4571-a8d8-1f16d198b909&quot; class=&quot;cnblogs_code_hide&quot; readability=&quot;67&quot;&gt;
&lt;pre&gt;
&lt;span&gt;package&lt;/span&gt;&lt;span&gt; com.example.controller;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.SecurityUtils;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.authc.IncorrectCredentialsException;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.authc.UnknownAccountException;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.authc.UsernamePasswordToken;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.apache.shiro.subject.Subject;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.stereotype.Controller;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.ui.Model;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.web.bind.annotation.RequestMapping;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.web.bind.annotation.RequestMethod;

@Controller
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; LoginController {

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;退出的时候是get请求，主要是用于退出&lt;/span&gt;
    @RequestMapping(value = &quot;/login&quot;,method =&lt;span&gt; RequestMethod.GET)
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; String login(){
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &quot;login&quot;&lt;span&gt;;
    }

    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;post登录&lt;/span&gt;
    @RequestMapping(value = &quot;/login&quot;,method =&lt;span&gt; RequestMethod.POST)
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; String login(Model model,String id,String pwd){
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;添加用户认证信息&lt;/span&gt;
        Subject subject =&lt;span&gt; SecurityUtils.getSubject();
        UsernamePasswordToken usernamePasswordToken &lt;/span&gt;= &lt;span&gt;new&lt;/span&gt;&lt;span&gt; UsernamePasswordToken(
                id,
                &lt;/span&gt;&quot;123456&quot;&lt;span&gt;);
        &lt;/span&gt;&lt;span&gt;try&lt;/span&gt;&lt;span&gt; {            
                subject.login(usernamePasswordToken);            
                &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &quot;home&quot;&lt;span&gt;;   
            }
        &lt;/span&gt;&lt;span&gt;catch&lt;/span&gt;&lt;span&gt; (UnknownAccountException e) {            
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;用户名不存在            &lt;/span&gt;
            model.addAttribute(&quot;msg&quot;,&quot;用户名不存在&quot;&lt;span&gt;);            
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &quot;login&quot;&lt;span&gt;;        
            }&lt;/span&gt;&lt;span&gt;catch&lt;/span&gt;&lt;span&gt; (IncorrectCredentialsException e) {            
                &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;密码错误            &lt;/span&gt;
                model.addAttribute(&quot;msg&quot;,&quot;密码错误&quot;&lt;span&gt;);            
                &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &quot;login&quot;&lt;span&gt;;        
                }
        
    }
    @RequestMapping(value &lt;/span&gt;= &quot;/index&quot;&lt;span&gt;)
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; String index(){
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &quot;home&quot;&lt;span&gt;;
    }

}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;span class=&quot;cnblogs_code_collapse&quot;&gt;View Code&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;五、Controller层访问控制&lt;/p&gt;
&lt;p&gt;1.首先来数据库的数据，两张图是用户角色、和角色权限的数据。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/733213/201903/733213-20190302144303403-277679183.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/733213/201903/733213-20190302144323904-12162004.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;2.设置权限&lt;/p&gt;
&lt;p&gt;这里在用户页面点击编辑按钮时设置需要有id=002的角色，在点击选择角色按钮时需要有code=002的权限。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
    @RequestMapping(value = &quot;/edit&quot;,method =&lt;span&gt; RequestMethod.GET)
    @RequiresRoles(&lt;/span&gt;&quot;002&quot;)&lt;span&gt;//&lt;/span&gt;&lt;span&gt;权限管理;&lt;/span&gt;
    &lt;span&gt;public&lt;/span&gt; String editGet(Model model,@RequestParam(value=&quot;id&quot;&lt;span&gt;) String id) {
        model.addAttribute(&lt;/span&gt;&quot;id&quot;&lt;span&gt;, id);
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &quot;/user/edit&quot;&lt;span&gt;;
    }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;39&quot;&gt;
&lt;pre&gt;
    @RequestMapping(value = &quot;/selrole&quot;,method =&lt;span&gt; RequestMethod.GET)
    @RequiresPermissions(&lt;/span&gt;&quot;002&quot;)&lt;span&gt;//&lt;/span&gt;&lt;span&gt;权限管理;&lt;/span&gt;
    &lt;span&gt;public&lt;/span&gt; String selctRole(Model model,@RequestParam(&quot;id&quot;) String id,@RequestParam(&quot;type&quot;&lt;span&gt;) Integer type) {
        model.addAttribute(&lt;/span&gt;&quot;id&quot;&lt;span&gt;,id);
        model.addAttribute(&lt;/span&gt;&quot;type&quot;&lt;span&gt;, type);
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &quot;/user/selrole&quot;&lt;span&gt;;
    }
 &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt; 当使用用户001登录时，点击编辑，弹出框如下，提示没有002的角色&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/733213/201903/733213-20190302145243256-417943617.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;点击选择角色按钮时提示没有002的权限。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/733213/201903/733213-20190302145125591-1574401210.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;当使用用户002登录时，点击编辑按钮，显示正常，点击选择角色也是提示没002的权限，因为权限只有001。&lt;/p&gt;
&lt;p&gt;六、前端页面层访问控制&lt;/p&gt;
&lt;p&gt;有时为了不想像上面那样弹出错误页面，需要在按钮显示上进行不可见，这样用户也不会点击到。前面已经引入了依赖并配置了bean，这里测试下在html中使用shiro。&lt;/p&gt;
&lt;p&gt;1.首先设置html标签引入shiro&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;html &lt;/span&gt;&lt;span&gt;xmlns:th&lt;/span&gt;&lt;span&gt;=&quot;http://www.thymeleaf.org&quot;&lt;/span&gt;&lt;span&gt;
      xmlns:shiro&lt;/span&gt;&lt;span&gt;=&quot;http://www.pollix.at/thymeleaf/shiro&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;2.控制按钮可见&lt;/p&gt;
&lt;p&gt;这里使用shiro:hasAnyRoles=&quot;002,003&quot;判断用户角色是否是002或003，是则显示不是则不显示。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;div &lt;/span&gt;&lt;span&gt;class&lt;/span&gt;&lt;span&gt;=&quot;layui-inline&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;a &lt;/span&gt;&lt;span&gt;shiro:hasAnyRoles&lt;/span&gt;&lt;span&gt;=&quot;002,003&quot;&lt;/span&gt;&lt;span&gt; class&lt;/span&gt;&lt;span&gt;=&quot;layui-btn layui-btn-normal newsAdd_btn&quot;&lt;/span&gt;&lt;span&gt; onclick&lt;/span&gt;&lt;span&gt;=&quot;addUser('')&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;添加用户&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;a&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;div&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;div &lt;/span&gt;&lt;span&gt;class&lt;/span&gt;&lt;span&gt;=&quot;layui-inline&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;a &lt;/span&gt;&lt;span&gt;shiro:hasAnyRoles&lt;/span&gt;&lt;span&gt;=&quot;002,003&quot;&lt;/span&gt;&lt;span&gt; class&lt;/span&gt;&lt;span&gt;=&quot;layui-btn layui-btn-danger batchDel&quot;&lt;/span&gt;&lt;span&gt; onclick&lt;/span&gt;&lt;span&gt;=&quot;getDatas();&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;批量删除&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;a&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;div&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;当001用户登录时，添加用户、批量删除按钮都不显示，只显示查询按钮。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/733213/201903/733213-20190302150059483-2067994382.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;当002用户登录时，添加用户、批量删除按钮都显示&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/733213/201903/733213-20190302150211899-1091997402.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;七、小结&lt;/p&gt;
&lt;p&gt;这里只是实现了Shiro的简单的功能，Shiro还有很多很强大的功能，比如session管理等，而且目前权限管理模块还有很多需要优化的功能，左侧导航栏的动态加载和权限控制、Shiro与Redis结合实现session共享、Shiro与Cas结合实现单点登录等。后续可以把项目做为开源项目，慢慢完善集成更多模块例如：Swagger2、Redis、Druid、RabbitMQ等供初学者参考。&lt;/p&gt;
</description>
<pubDate>Sat, 02 Mar 2019 07:09:00 +0000</pubDate>
<dc:creator>社会主义接班人</dc:creator>
<og:description>用户权限管理一般是对用户页面、按钮的访问权限管理。Shiro框架是一个强大且易用的Java安全框架，执行身份验证、授权、密码和会话管理，对于Shiro的介绍这里就不多说。本篇博客主要是了解Shiro的</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/5ishare/p/10461073.html</dc:identifier>
</item>
<item>
<title>大数据技术之_08_Hive学习_05_Hive实战之谷粒影音（ETL+TopN）+常见错误及解决方案 - 黑泽君</title>
<link>http://www.cnblogs.com/chenmingjun/p/10461062.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/chenmingjun/p/10461062.html</guid>
<description>&lt;p id=&quot;tocid_0&quot; class=&quot;toc&quot;&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h10hive&quot;&gt;第10章 Hive实战之谷粒影音&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h101&quot;&gt;10.1 需求描述&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h102&quot;&gt;10.2 项目&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1021&quot;&gt;10.2.1 数据结构&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1022etl&quot;&gt;10.2.2 ETL原始数据&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h103&quot;&gt;10.3 准备工作&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1031&quot;&gt;10.3.1 创建表&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1032etl&quot;&gt;10.3.2 导入ETL后的数据到原始表&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1033orc&quot;&gt;10.3.3 向ORC表插入数据&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h104&quot;&gt;10.4 业务分析&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1041top10&quot;&gt;10.4.1 统计视频观看数Top10&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1042top10&quot;&gt;10.4.2 统计视频类别热度Top10&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h104320&quot;&gt;10.4.3 统计出视频观看数最高的20个视频的所属视频类别以及对应视频类别的个数&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1044top50rank&quot;&gt;10.4.4 统计视频观看数Top50所关联视频的所属类别rank&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1045top10music&quot;&gt;10.4.5 统计每个类别中的视频热度Top10，以Music为例&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1046top10music&quot;&gt;10.4.6 统计每个类别中视频流量Top10，以Music为例&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1047top1020&quot;&gt;10.4.7 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h1048top10&quot;&gt;10.4.8 统计每个类别视频观看数Top10&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;toc_item&quot;&gt;&lt;span class=&quot;toc_left&quot;&gt;&lt;a href=&quot;http://www.cnblogs.com/chenmingjun/p/10461062.html#h11&quot;&gt;第11章 常见错误及解决方案&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;hr/&gt;&lt;h2 id=&quot;h10hive&quot;&gt;&lt;span&gt;&lt;strong&gt;第10章 Hive实战之谷粒影音&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;
&lt;h3 id=&quot;h101&quot;&gt;&lt;span&gt;&lt;strong&gt;10.1 需求描述&lt;/strong&gt;&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;统计硅谷影音视频网站的常规指标，各种TopN指标：&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;span&gt;统计视频观看数Top10&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;统计视频类别热度Top10&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;统计出视频观看数最高的20个视频的所属视频类别以及对应视频类别的个数&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;统计视频观看数Top50所关联视频的所属类别Rank&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;统计每个类别中的视频热度Top10&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;统计每个类别中视频流量Top10&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;统计上传视频最多的用户Top10以及他们上传的视频&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span&gt;统计每个类别视频观看数Top10&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;h3 id=&quot;h102&quot;&gt;&lt;span&gt;&lt;strong&gt;10.2 项目&lt;/strong&gt;&lt;/span&gt;&lt;/h3&gt;
&lt;h4 id=&quot;h1021&quot;&gt;&lt;span&gt;&lt;strong&gt;10.2.1 数据结构&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;1、视频表&lt;/p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;字段&lt;/th&gt;
&lt;th&gt;备注&lt;/th&gt;
&lt;th&gt;详细描述&lt;/th&gt;
&lt;/tr&gt;&lt;/thead&gt;&lt;tbody readability=&quot;7&quot;&gt;&lt;tr&gt;&lt;td&gt;video id&lt;/td&gt;
&lt;td&gt;视频唯一id&lt;/td&gt;
&lt;td&gt;11位字符串&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;uploader&lt;/td&gt;
&lt;td&gt;视频上传者&lt;/td&gt;
&lt;td&gt;上传视频的用户名String&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;age&lt;/td&gt;
&lt;td&gt;视频年龄&lt;/td&gt;
&lt;td&gt;视频在平台上的整数天&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;category&lt;/td&gt;
&lt;td&gt;视频类别&lt;/td&gt;
&lt;td&gt;上传视频指定的视频分类&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;length&lt;/td&gt;
&lt;td&gt;视频长度&lt;/td&gt;
&lt;td&gt;整形数字标识的视频长度&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;views&lt;/td&gt;
&lt;td&gt;观看次数&lt;/td&gt;
&lt;td&gt;视频被浏览的次数&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;rate&lt;/td&gt;
&lt;td&gt;视频评分&lt;/td&gt;
&lt;td&gt;满分5分&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;ratings&lt;/td&gt;
&lt;td&gt;流量&lt;/td&gt;
&lt;td&gt;视频的流量，整型数字&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;conments&lt;/td&gt;
&lt;td&gt;评论数&lt;/td&gt;
&lt;td&gt;一个视频的整数评论数&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;related ids&lt;/td&gt;
&lt;td&gt;相关视频id&lt;/td&gt;
&lt;td&gt;相关视频的id，最多20个&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;2、用户表&lt;/p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;字段&lt;/th&gt;
&lt;th&gt;备注&lt;/th&gt;
&lt;th&gt;字段类型&lt;/th&gt;
&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;uploader&lt;/td&gt;
&lt;td&gt;上传者用户名&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;videos&lt;/td&gt;
&lt;td&gt;上传视频数&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;friends&lt;/td&gt;
&lt;td&gt;朋友数量&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h4 id=&quot;h1022etl&quot;&gt;&lt;span&gt;&lt;strong&gt;10.2.2 ETL原始数据&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;  通过观察原始数据形式，可以发现，视频可以有多个所属分类，每个所属分类用&amp;amp;符号分割，且分割的两边有空格字符，同时相关视频也是可以有多个元素，多个相关视频又用“\t”进行分割。为了分析数据时方便对存在多个子元素的数据进行操作，我们&lt;code&gt;首先进行数据重组清洗操作&lt;/code&gt;。即：将所有的类别用“&amp;amp;”分割，同时去掉两边空格，多个相关视频id也使用“&amp;amp;”进行分割。&lt;br/&gt;0、添加依赖pom.xml&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;xml language-xml hljs&quot;&gt;    &lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;dependencies&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;junit&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;junit&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;RELEASE&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.apache.logging.log4j&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;log4j-core&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;2.8.2&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.apache.hadoop&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;hadoop-common&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;2.7.2&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.apache.hadoop&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;hadoop-client&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;2.7.2&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.apache.hadoop&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;hadoop-hdfs&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;2.7.2&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;dependencies&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;1、ETL之ETLUtil&lt;/p&gt;
&lt;pre readability=&quot;11.5&quot;&gt;
&lt;code class=&quot;java language-java hljs&quot; readability=&quot;17&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;package&lt;/span&gt; com.atguigu;&lt;p&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.yarn.webapp.hamlet.Hamlet;&lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-class&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;ETLUtil&lt;/span&gt; &lt;/span&gt;{&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; String &lt;span class=&quot;hljs-title&quot;&gt;oriString2ETLString&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(String ori)&lt;/span&gt; &lt;/span&gt;{&lt;/p&gt;&lt;p&gt;&lt;br/&gt;String[] fields = ori.split(&lt;span class=&quot;hljs-string&quot;&gt;&quot;\t&quot;&lt;/span&gt;);&lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (fields.length &amp;lt; &lt;span class=&quot;hljs-number&quot;&gt;9&lt;/span&gt;) {&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;null&lt;/span&gt;;&lt;br/&gt;}&lt;/p&gt;&lt;p&gt;&lt;br/&gt;fields[&lt;span class=&quot;hljs-number&quot;&gt;3&lt;/span&gt;] = fields[&lt;span class=&quot;hljs-number&quot;&gt;3&lt;/span&gt;].replace(&lt;span class=&quot;hljs-string&quot;&gt;&quot; &quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&lt;/span&gt;);&lt;/p&gt;&lt;p&gt;&lt;br/&gt;StringBuffer sb = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; StringBuffer();&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;; i &amp;lt; fields.length; i++) {&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (i &amp;lt; &lt;span class=&quot;hljs-number&quot;&gt;9&lt;/span&gt;) {&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (i == fields.length -&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;) {&lt;br/&gt;sb.append(fields[i]);&lt;br/&gt;} &lt;span class=&quot;hljs-keyword&quot;&gt;else&lt;/span&gt; {&lt;br/&gt;sb.append(fields[i] + &lt;span class=&quot;hljs-string&quot;&gt;&quot;\t&quot;&lt;/span&gt;);&lt;br/&gt;}&lt;br/&gt;} &lt;span class=&quot;hljs-keyword&quot;&gt;else&lt;/span&gt; {&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (i == fields.length -&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;) {&lt;br/&gt;sb.append(fields[i]);&lt;br/&gt;} &lt;span class=&quot;hljs-keyword&quot;&gt;else&lt;/span&gt; {&lt;br/&gt;sb.append(fields[i] + &lt;span class=&quot;hljs-string&quot;&gt;&quot;&amp;amp;&quot;&lt;/span&gt;);&lt;br/&gt;}&lt;br/&gt;}&lt;br/&gt;}&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; sb.toString();&lt;br/&gt;}&lt;br/&gt;}&lt;br/&gt;&lt;/p&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;2、ETL之Mapper&lt;/p&gt;
&lt;pre readability=&quot;16.5&quot;&gt;
&lt;code class=&quot;java language-java hljs&quot; readability=&quot;27&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;package&lt;/span&gt; com.atguigu;&lt;p&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.lang.StringUtils;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.io.LongWritable;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.io.NullWritable;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.io.Text;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.mapreduce.Mapper;&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; java.io.IOException;&lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-class&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;VideoETLMapper&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;Mapper&lt;/span&gt;&amp;lt;&lt;span class=&quot;hljs-title&quot;&gt;LongWritable&lt;/span&gt;, &lt;span class=&quot;hljs-title&quot;&gt;Text&lt;/span&gt;, &lt;span class=&quot;hljs-title&quot;&gt;Text&lt;/span&gt;, &lt;span class=&quot;hljs-title&quot;&gt;NullWritable&lt;/span&gt;&amp;gt; &lt;/span&gt;{&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; Text k = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; Text();&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(LongWritable key, Text value, Context context)&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;throws&lt;/span&gt; IOException, InterruptedException &lt;/span&gt;{&lt;/p&gt;&lt;p&gt;&lt;br/&gt;String ori = value.toString();&lt;/p&gt;&lt;p&gt;&lt;br/&gt;String etlString = ETLUtil.oriString2ETLString(ori);&lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (StringUtils.isBlank(etlString)) {&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt;;&lt;br/&gt;}&lt;br/&gt;k.set(etlString);&lt;br/&gt;context.write(k, NullWritable.get().get());&lt;br/&gt;}&lt;br/&gt;}&lt;br/&gt;&lt;/p&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;3、ETL之Runner&lt;/p&gt;
&lt;pre readability=&quot;22&quot;&gt;
&lt;code class=&quot;java language-java hljs&quot; readability=&quot;38&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;package&lt;/span&gt; com.atguigu;&lt;p&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.conf.Configuration;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.fs.Path;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.io.NullWritable;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.io.Text;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.mapreduce.Job;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.mapreduce.lib.input.FileInputFormat;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.util.Tool;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.util.ToolRunner;&lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-class&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;VideoETLRunner&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;Tool&lt;/span&gt; &lt;/span&gt;{&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; Configuration conf = &lt;span class=&quot;hljs-keyword&quot;&gt;null&lt;/span&gt;;&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;setConf&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(Configuration conf)&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;this&lt;/span&gt;.conf = conf;&lt;br/&gt;}&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; Configuration &lt;span class=&quot;hljs-title&quot;&gt;getConf&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;this&lt;/span&gt;.conf;&lt;br/&gt;}&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(String[] args)&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;throws&lt;/span&gt; Exception &lt;/span&gt;{&lt;br/&gt;Job job = Job.getInstance(getConf());&lt;/p&gt;&lt;p&gt;&lt;br/&gt;job.setJarByClass(VideoETLRunner.class);&lt;/p&gt;&lt;p&gt;&lt;br/&gt;job.setMapperClass(VideoETLMapper.class);&lt;br/&gt;&lt;/p&gt;&lt;p&gt;&lt;br/&gt;job.setMapOutputKeyClass(Text.class);&lt;br/&gt;job.setMapOutputValueClass(NullWritable.class);&lt;/p&gt;&lt;p&gt;&lt;br/&gt;job.setOutputKeyClass(Text.class);&lt;br/&gt;job.setOutputValueClass(NullWritable.class);&lt;/p&gt;&lt;p&gt;&lt;br/&gt;FileInputFormat.setInputPaths(job, &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; Path(args[&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;]));&lt;br/&gt;FileOutputFormat.setOutputPath(job, &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; Path(args[&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;]));&lt;/p&gt;&lt;p&gt;&lt;br/&gt;job.setNumReduceTasks(&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;);&lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;boolean&lt;/span&gt; result = job.waitForCompletion(&lt;span class=&quot;hljs-keyword&quot;&gt;true&lt;/span&gt;);&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; result ? &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt; : &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;;&lt;br/&gt;}&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(String[] args)&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; resultCode  = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;try&lt;/span&gt; {&lt;br/&gt;resultCode = ToolRunner.run(&lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; VideoETLRunner(), args);&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (resultCode == &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;) {&lt;br/&gt;System.out.println(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Success!&quot;&lt;/span&gt;);&lt;br/&gt;} &lt;span class=&quot;hljs-keyword&quot;&gt;else&lt;/span&gt; {&lt;br/&gt;System.out.println(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Fail!&quot;&lt;/span&gt;);&lt;br/&gt;}&lt;br/&gt;System.exit(resultCode);&lt;br/&gt;} &lt;span class=&quot;hljs-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {&lt;br/&gt;e.printStackTrace();&lt;br/&gt;System.exit(&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;);&lt;br/&gt;}&lt;br/&gt;}&lt;br/&gt;}&lt;br/&gt;&lt;/p&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;4、打好jar包，修改jar包名称为VideoETL.jar，然后将要清洗的数据和VideoETL.jar从本地上传至Linux系统上，再将要清洗的数据推送至HDFS集群上。操作如下：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;hljs ruby&quot;&gt;[atguigu@hadoop102 datas]$ hadoop fs -put user/ &lt;span class=&quot;hljs-regexp&quot;&gt;/guliData/input&lt;/span&gt;&lt;br/&gt;[atguigu@hadoop102 datas]$ hadoop fs -put video/ &lt;span class=&quot;hljs-regexp&quot;&gt;/guliData/input&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;5、执行ETL&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;hljs ruby&quot;&gt;[atguigu@hadoop102 hadoop-&lt;span class=&quot;hljs-number&quot;&gt;2.7&lt;/span&gt;.&lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;]$ bin/yarn jar /opt/&lt;span class=&quot;hljs-class&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;module&lt;/span&gt;/&lt;span class=&quot;hljs-title&quot;&gt;datas&lt;/span&gt;/&lt;span class=&quot;hljs-title&quot;&gt;VideoETL&lt;/span&gt;.&lt;span class=&quot;hljs-title&quot;&gt;jar&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;com&lt;/span&gt;.&lt;span class=&quot;hljs-title&quot;&gt;atguigu&lt;/span&gt;.&lt;span class=&quot;hljs-title&quot;&gt;VideoETLRunner&lt;/span&gt; /&lt;span class=&quot;hljs-title&quot;&gt;guliData&lt;/span&gt;/&lt;span class=&quot;hljs-title&quot;&gt;input&lt;/span&gt;/&lt;span class=&quot;hljs-title&quot;&gt;video&lt;/span&gt;/2008/0222 /&lt;span class=&quot;hljs-title&quot;&gt;guliData&lt;/span&gt;/&lt;span class=&quot;hljs-title&quot;&gt;output&lt;/span&gt;/&lt;span class=&quot;hljs-title&quot;&gt;video&lt;/span&gt;/2008/0222&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;h3 id=&quot;h103&quot;&gt;&lt;span&gt;&lt;strong&gt;10.3 准备工作&lt;/strong&gt;&lt;/span&gt;&lt;/h3&gt;
&lt;h4 id=&quot;h1031&quot;&gt;&lt;span&gt;&lt;strong&gt;10.3.1 创建表&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;创建原始表：gulivideo_ori，gulivideo_user_ori&lt;br/&gt;创建目标表：gulivideo_orc，gulivideo_user_orc&lt;br/&gt;gulivideo_ori：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; gulivideo_ori(&lt;br/&gt;videoId &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;, &lt;br/&gt;uploader &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;, &lt;br/&gt;age &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;array&lt;/span&gt;&amp;lt;&lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;&amp;gt;, &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;views &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;rate &lt;span class=&quot;hljs-built_in&quot;&gt;float&lt;/span&gt;, &lt;br/&gt;ratings &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;comments &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;,&lt;br/&gt;relatedId &lt;span class=&quot;hljs-built_in&quot;&gt;array&lt;/span&gt;&amp;lt;&lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;br/&gt;)&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;row&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;format&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;delimited&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;fields&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;terminated&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;\t&quot;&lt;/span&gt; &lt;br/&gt;collection items &lt;span class=&quot;hljs-keyword&quot;&gt;terminated&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;&amp;amp;&quot;&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;stored&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; textfile;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;gulivideo_user_ori：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; gulivideo_user_ori(&lt;br/&gt;uploader &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;,&lt;br/&gt;videos &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;,&lt;br/&gt;friends &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;&lt;br/&gt;)&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;row&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;format&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;delimited&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;fields&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;terminated&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;\t&quot;&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;stored&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; textfile;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;gulivideo_orc：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; gulivideo_orc(&lt;br/&gt;videoId &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;, &lt;br/&gt;uploader &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;, &lt;br/&gt;age &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;array&lt;/span&gt;&amp;lt;&lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;&amp;gt;, &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;views &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;rate &lt;span class=&quot;hljs-built_in&quot;&gt;float&lt;/span&gt;, &lt;br/&gt;ratings &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;comments &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;,&lt;br/&gt;relatedId &lt;span class=&quot;hljs-built_in&quot;&gt;array&lt;/span&gt;&amp;lt;&lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;br/&gt;)&lt;br/&gt;clustered &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt;(uploader) &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;8&lt;/span&gt; buckets &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;row&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;format&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;delimited&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;fields&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;terminated&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;\t&quot;&lt;/span&gt; &lt;br/&gt;collection items &lt;span class=&quot;hljs-keyword&quot;&gt;terminated&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;&amp;amp;&quot;&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;stored&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; orc;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;gulivideo_user_orc：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; gulivideo_user_orc(&lt;br/&gt;uploader &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;,&lt;br/&gt;videos &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;,&lt;br/&gt;friends &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;&lt;br/&gt;)&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;row&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;format&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;delimited&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;fields&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;terminated&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;\t&quot;&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;stored&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; orc;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;h4 id=&quot;h1032etl&quot;&gt;&lt;span&gt;&lt;strong&gt;10.3.2 导入ETL后的数据到原始表&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;gulivideo_ori：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;hljs sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;load&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt; inpath &lt;span class=&quot;hljs-string&quot;&gt;'/guliData/output/video/2008/0222'&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; gulivideo_ori;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;gulivideo_user_ori：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;hljs sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;load&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;data&lt;/span&gt; inpath &lt;span class=&quot;hljs-string&quot;&gt;&quot;/guliData/input/user/2008/0903&quot;&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; gulivideo_user_ori;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;h4 id=&quot;h1033orc&quot;&gt;&lt;span&gt;&lt;strong&gt;10.3.3 向ORC表插入数据&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;gulivideo_orc：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;hljs sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; gulivideo_orc &lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; * &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; gulivideo_ori;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;gulivideo_user_orc：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;hljs sql&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; gulivideo_user_orc &lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; * &lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; gulivideo_user_ori;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;h3 id=&quot;h104&quot;&gt;&lt;span&gt;&lt;strong&gt;10.4 业务分析&lt;/strong&gt;&lt;/span&gt;&lt;/h3&gt;
&lt;h4 id=&quot;h1041top10&quot;&gt;&lt;span&gt;&lt;strong&gt;10.4.1 统计视频观看数Top10&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;思路：使用&lt;code&gt;order by&lt;/code&gt;按照 views 字段做一个&lt;code&gt;全局排序&lt;/code&gt;即可，同时我们设置只显示前10条。&lt;code&gt;为了便于显示，我们显示的字段不包含每个视频对应的关联视频字段&lt;/code&gt;。&lt;br/&gt;最终代码：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;videoId, &lt;br/&gt;uploader, &lt;br/&gt;age, &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;, &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;length&lt;/span&gt;, &lt;br/&gt;views, &lt;br/&gt;rate, &lt;br/&gt;ratings, &lt;br/&gt;comments &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;br/&gt;views &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt;;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;h4 id=&quot;h1042top10&quot;&gt;&lt;span&gt;&lt;strong&gt;10.4.2 统计视频类别热度Top10&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;思路：炸开数组【视频类别】字段，然后按照类别分组，最后按照热度(视频个数)排序。&lt;br/&gt;  1) 即统计每个类别有多少个视频，显示出包含视频最多的前10个类别。&lt;br/&gt;  2) 我们需要按照类别 group by 聚合，然后count组内的videoId个数即可。&lt;br/&gt;  3) 因为当前表结构为：一个视频对应一个或多个类别。所以如果要 group by 类别，需要先将类别进行列转行(展开)，然后再进行count即可。&lt;br/&gt;  4) 最后按照热度排序，显示前10条。&lt;br/&gt;最终代码：&lt;/p&gt;
&lt;pre readability=&quot;5&quot;&gt;
&lt;code class=&quot;sql language-sql hljs&quot; readability=&quot;4&quot;&gt;第1步：炸裂视频类别&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;br/&gt;videoId, category_name &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc lateral &lt;span class=&quot;hljs-keyword&quot;&gt;view&lt;/span&gt; explode(&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;) category_t &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; category_name &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;100&lt;/span&gt;; t1&lt;br/&gt;第2步：统计每种视频类别下的视频数&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;category_name, &lt;span class=&quot;hljs-keyword&quot;&gt;count&lt;/span&gt;(*) hot&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;br/&gt;videoId, category_name &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc lateral &lt;span class=&quot;hljs-keyword&quot;&gt;view&lt;/span&gt; explode(&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;) category_t &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; category_name &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;100&lt;/span&gt;) t1&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt;&lt;br/&gt;category_name; t2&lt;br/&gt;第3步：视频类别热度Top10&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;category_name, hot&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;category_name, &lt;span class=&quot;hljs-keyword&quot;&gt;count&lt;/span&gt;(*) hot&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;br/&gt;videoId, category_name &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc lateral &lt;span class=&quot;hljs-keyword&quot;&gt;view&lt;/span&gt; explode(&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;) category_t &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; category_name) t1&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt;&lt;br/&gt;category_name) t2&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt;&lt;br/&gt;hot &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt;;&lt;p&gt;+&lt;br/&gt;| category_name  |   hot   |&lt;br/&gt;+&lt;br/&gt;| Music          | 179049  |&lt;br/&gt;| Entertainment  | 127674  |&lt;br/&gt;| Comedy         | 87818   |&lt;br/&gt;| Animation      | 73293   |&lt;br/&gt;| Film           | 73293   |&lt;br/&gt;| Sports         | 67329   |&lt;br/&gt;| Gadgets        | 59817   |&lt;br/&gt;| Games          | 59817   |&lt;br/&gt;| Blogs          | 48890   |&lt;br/&gt;| People         | 48890   |&lt;br/&gt;+&lt;br/&gt;&lt;/p&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;注意&lt;/code&gt;：第1步和第2步测试先使用100条数据，测试通过后第3步使用全部数据。&lt;/p&gt;
&lt;h4 id=&quot;h104320&quot;&gt;&lt;span&gt;&lt;strong&gt;10.4.3 统计出视频观看数最高的20个视频的所属视频类别以及对应视频类别的个数&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;思路：&lt;br/&gt;  1) 先找到观看数最高的20个视频所属条目的所有信息，降序排列&lt;br/&gt;  2) 把这20条信息中的category分裂出来(列转行)&lt;br/&gt;  3) 最后查询视频分类名称和该分类下有多少个Top20的视频&lt;br/&gt;最终代码：&lt;/p&gt;
&lt;pre readability=&quot;15&quot;&gt;
&lt;code class=&quot;sql language-sql hljs&quot; readability=&quot;24&quot;&gt;统计出视频观看数最高的20个视频的所属类别&lt;p&gt;第1步：统计出视频观看数最高的20个视频&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;*&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;br/&gt;views &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;20&lt;/span&gt;; t1&lt;br/&gt;第2步：把这20条信息中的category分裂出来(列转行)&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;videoId, &lt;br/&gt;category_name&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;*&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;br/&gt;views &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;20&lt;/span&gt;) t1 lateral &lt;span class=&quot;hljs-keyword&quot;&gt;view&lt;/span&gt; explode(&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;) category_t &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; category_name; t2&lt;/p&gt;&lt;p&gt;+&lt;br/&gt;|   videoid    | category_name  |&lt;br/&gt;+&lt;br/&gt;| dMH0bHeiRNg  | Comedy         |&lt;br/&gt;| 0XxI-hvPRRA  | Comedy         |&lt;br/&gt;| 1dmVU08zVpA  | Entertainment  |&lt;br/&gt;| RB-wUgnyGv0  | Entertainment  |&lt;br/&gt;| QjA5faZF1A8  | Music          |&lt;br/&gt;| -_CSo1gOd48  | People         |&lt;br/&gt;| -_CSo1gOd48  | Blogs          |&lt;br/&gt;| 49IDp76kjPw  | Comedy         |&lt;br/&gt;| tYnn51C3X_w  | Music          |&lt;br/&gt;| pv5zWaTEVkI  | Music          |&lt;br/&gt;| D2kJZOfq7zk  | People         |&lt;br/&gt;| D2kJZOfq7zk  | Blogs          |&lt;br/&gt;| vr3x_RRJdd4  | Entertainment  |&lt;br/&gt;| lsO6D1rwrKc  | Entertainment  |&lt;br/&gt;| 5P6UU6m3cqk  | Comedy         |&lt;br/&gt;| 8bbTtPL1jRs  | Music          |&lt;br/&gt;| _BuRwH59oAo  | Comedy         |&lt;br/&gt;| aRNzWyD7C9o  | UNA            |&lt;br/&gt;| UMf40daefsI  | Music          |&lt;br/&gt;| ixsZy2425eY  | Entertainment  |&lt;br/&gt;| MNxwAU_xAMk  | Comedy         |&lt;br/&gt;| RUCZJVJ_M8o  | Entertainment  |&lt;br/&gt;+&lt;br/&gt;第3步：根据视频分类名称进行去重&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;distinct&lt;/span&gt; category_name&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;t2;&lt;br/&gt;完整板&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;distinct&lt;/span&gt; category_name&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;videoId, &lt;br/&gt;category_name&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;*&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;br/&gt;views &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;20&lt;/span&gt;) t1 lateral &lt;span class=&quot;hljs-keyword&quot;&gt;view&lt;/span&gt; explode(&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;) category_t &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; category_name) t2;  &lt;br/&gt;简易版&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;distinct&lt;/span&gt; category_name&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;*&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;br/&gt;views &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;20&lt;/span&gt;) t1 lateral &lt;span class=&quot;hljs-keyword&quot;&gt;view&lt;/span&gt; explode(&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;) category_t &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; category_name;&lt;/p&gt;&lt;p&gt;+&lt;br/&gt;| category_name  |&lt;br/&gt;+&lt;br/&gt;| Blogs          |&lt;br/&gt;| Comedy         |&lt;br/&gt;| Entertainment  |&lt;br/&gt;| Music          |&lt;br/&gt;| People         |&lt;br/&gt;| UNA            |&lt;br/&gt;+&lt;/p&gt;&lt;p&gt;&lt;br/&gt;类别包含Top20视频的个数&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;category_name,&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;count&lt;/span&gt;(t2.videoId) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; hot_with_views&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;videoId, &lt;br/&gt;category_name&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;*&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;br/&gt;views &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;20&lt;/span&gt;) t1 lateral &lt;span class=&quot;hljs-keyword&quot;&gt;view&lt;/span&gt; explode(&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;) category_t &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; category_name) t2&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt;&lt;br/&gt;category_name&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;br/&gt;hot_with_views &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;;&lt;/p&gt;&lt;p&gt;+&lt;br/&gt;| category_name  | hot_with_views  |&lt;br/&gt;+&lt;br/&gt;| Entertainment  | 6               |&lt;br/&gt;| Comedy         | 6               |&lt;br/&gt;| Music          | 5               |&lt;br/&gt;| People         | 2               |&lt;br/&gt;| Blogs          | 2               |&lt;br/&gt;| UNA            | 1               |&lt;br/&gt;+&lt;br/&gt;&lt;/p&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;h4 id=&quot;h1044top50rank&quot;&gt;&lt;span&gt;&lt;strong&gt;10.4.4 统计视频观看数Top50所关联视频的所属类别rank&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;思路分析如下图所示：&lt;/p&gt;
&lt;img title=&quot;&quot; src=&quot;https://s2.ax1x.com/2019/03/02/kbOyeU.png&quot; alt=&quot;&quot;/&gt;&lt;br/&gt;思路：&lt;br/&gt;1) 查询出观看数最多的前50个视频的所有信息(当然&lt;code&gt;包含了每个视频对应的关联视频&lt;/code&gt;)，记为临时表t1&lt;br/&gt;  t1：观看数前50的视频
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;videoId, views, &lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;, relatedId &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;br/&gt;views &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;50&lt;/span&gt;; t1&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;2) 将找到的50条视频信息的相关视频relatedId列转行，记为临时表t2&lt;br/&gt;  t2：将相关视频的id进行列转行操作&lt;/p&gt;
&lt;pre readability=&quot;4&quot;&gt;
&lt;code class=&quot;sql language-sql hljs&quot; readability=&quot;2&quot;&gt;炸裂关联视频id&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;explode(relatedId) &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; videoId&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;t1; t2&lt;p&gt;或者&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;distinct&lt;/span&gt; videoId&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;t1 lateral &lt;span class=&quot;hljs-keyword&quot;&gt;view&lt;/span&gt; explode(relatedId) relatedId_t &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; videoId; t2&lt;br/&gt;&lt;/p&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;3) 将关联视频的id和gulivideo_orc表进行inner join操作，得到每个关联视频id的详细数据&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;*&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;t2&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;inner&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;join&lt;/span&gt;&lt;br/&gt;gulivideo_orc t3 &lt;span class=&quot;hljs-keyword&quot;&gt;on&lt;/span&gt; t2.videoId=t3.videoId; t4&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;4) 炸裂关联视频的类别&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;*&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;t4 lateral &lt;span class=&quot;hljs-keyword&quot;&gt;view&lt;/span&gt; explode(&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;) category_t &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; category_name; t5&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;5) 统计类别个数&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;category_name,&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;count&lt;/span&gt;(*) hot&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;t5&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt;&lt;br/&gt;category_name; t6&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;6) 统计类别的热度排名（即rank）&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;* &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;t6&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt;&lt;br/&gt;hot &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;h4 id=&quot;h1045top10music&quot;&gt;&lt;span&gt;&lt;strong&gt;10.4.5 统计每个类别中的视频热度Top10，以Music为例&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;思路：&lt;br/&gt;  1) 要想统计Music类别中的视频热度Top10，需要先找到Music类别，那么就需要将category展开，所以可以创建一张表用于存放categoryId展开的数据。&lt;br/&gt;  2) 向category展开的表中插入数据。&lt;br/&gt;  3) 统计对应类别（Music）中的视频热度。&lt;br/&gt;最终代码：&lt;br/&gt;创建表--类别表：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; gulivideo_category(&lt;br/&gt;videoId &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;, &lt;br/&gt;uploader &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;, &lt;br/&gt;age &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;categoryId &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;, &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;views &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;rate &lt;span class=&quot;hljs-built_in&quot;&gt;float&lt;/span&gt;, &lt;br/&gt;ratings &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;comments &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;relatedId &lt;span class=&quot;hljs-built_in&quot;&gt;array&lt;/span&gt;&amp;lt;&lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;br/&gt;)&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;row&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;format&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;delimited&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;fields&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;terminated&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;\t&quot;&lt;/span&gt; &lt;br/&gt;collection items &lt;span class=&quot;hljs-keyword&quot;&gt;terminated&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;&amp;amp;&quot;&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;stored&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; orc;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;向类别表中插入数据：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; &lt;br/&gt;gulivideo_category  &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;br/&gt;videoId,&lt;br/&gt;uploader,&lt;br/&gt;age,&lt;br/&gt;categoryId,&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;length&lt;/span&gt;,&lt;br/&gt;views,&lt;br/&gt;rate,&lt;br/&gt;ratings,&lt;br/&gt;comments,&lt;br/&gt;relatedId &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc lateral &lt;span class=&quot;hljs-keyword&quot;&gt;view&lt;/span&gt; explode(&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;) catetory_t &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; categoryId;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;统计Music类别的Top10（也可以统计其他）&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;br/&gt;videoId, &lt;br/&gt;views&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_category &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;where&lt;/span&gt; &lt;br/&gt;categoryId=&lt;span class=&quot;hljs-string&quot;&gt;&quot;Music&quot;&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;br/&gt;views &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt;;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;h4 id=&quot;h1046top10music&quot;&gt;&lt;span&gt;&lt;strong&gt;10.4.6 统计每个类别中视频流量Top10，以Music为例&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;思路：&lt;br/&gt;  1) 创建视频类别展开表（categoryId列转行后的表）&lt;br/&gt;  2) 按照ratings排序即可&lt;br/&gt;最终代码：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;br/&gt;videoId, &lt;br/&gt;views&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_category &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;where&lt;/span&gt; &lt;br/&gt;categoryId=&lt;span class=&quot;hljs-string&quot;&gt;&quot;Music&quot;&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;br/&gt;ratings &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt;;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;h4 id=&quot;h1047top1020&quot;&gt;&lt;span&gt;&lt;strong&gt;10.4.7 统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;思路：&lt;br/&gt;1) 先找到上传视频最多的10个用户的用户信息&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;br/&gt;*&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_user_orc&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;br/&gt;videos &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt;; t1&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;2) 通过uploader字段与gulivideo_orc表进行join，得到的信息按照views观看次数进行排序即可。&lt;br/&gt;最终代码：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;t2.videoId, &lt;br/&gt;t2.views,&lt;br/&gt;t2.ratings,&lt;br/&gt;t1.videos,&lt;br/&gt;t1.friends &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;t1&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;join&lt;/span&gt;&lt;br/&gt;gulivideo_orc t2&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;on&lt;/span&gt; &lt;br/&gt;t1.uploader=t2.uploader&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt;&lt;br/&gt;t2.views &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;limit&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-number&quot;&gt;20&lt;/span&gt;;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;h4 id=&quot;h1048top10&quot;&gt;&lt;span&gt;&lt;strong&gt;10.4.8 统计每个类别视频观看数Top10&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;思路：&lt;br/&gt;  1) 先得到categoryId展开的表数据。&lt;br/&gt;  2) 子查询按照categoryId进行分区，然后分区内排序降序，并生成递增数字，该递增数字这一列起名为rank列。&lt;br/&gt;  3) 通过子查询产生的临时表，查询rank值小于等于10的数据行即可。&lt;br/&gt;最终代码：&lt;br/&gt;创建表--类别表：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; gulivideo_category(&lt;br/&gt;videoId &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;, &lt;br/&gt;uploader &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;, &lt;br/&gt;age &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;categoryId &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;, &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;views &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;rate &lt;span class=&quot;hljs-built_in&quot;&gt;float&lt;/span&gt;, &lt;br/&gt;ratings &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;comments &lt;span class=&quot;hljs-built_in&quot;&gt;int&lt;/span&gt;, &lt;br/&gt;relatedId &lt;span class=&quot;hljs-built_in&quot;&gt;array&lt;/span&gt;&amp;lt;&lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;br/&gt;)&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;row&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;format&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;delimited&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;fields&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;terminated&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;\t&quot;&lt;/span&gt; &lt;br/&gt;collection items &lt;span class=&quot;hljs-keyword&quot;&gt;terminated&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;&amp;amp;&quot;&lt;/span&gt; &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;stored&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; orc;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;向类别表中插入数据：&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;sql language-sql hljs&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;into&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;table&lt;/span&gt; &lt;br/&gt;gulivideo_category  &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt; &lt;br/&gt;videoId,&lt;br/&gt;uploader,&lt;br/&gt;age,&lt;br/&gt;categoryId,&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;length&lt;/span&gt;,&lt;br/&gt;views,&lt;br/&gt;rate,&lt;br/&gt;ratings,&lt;br/&gt;comments,&lt;br/&gt;relatedId &lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt; &lt;br/&gt;gulivideo_orc lateral &lt;span class=&quot;hljs-keyword&quot;&gt;view&lt;/span&gt; explode(&lt;span class=&quot;hljs-keyword&quot;&gt;category&lt;/span&gt;) catetory_t &lt;span class=&quot;hljs-keyword&quot;&gt;as&lt;/span&gt; categoryId;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;代码：&lt;/p&gt;
&lt;pre readability=&quot;4&quot;&gt;
&lt;code class=&quot;sql language-sql hljs&quot; readability=&quot;2&quot;&gt;第1步：&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;videoId,&lt;br/&gt;categoryId,&lt;br/&gt;views,&lt;br/&gt;row_number() &lt;span class=&quot;hljs-keyword&quot;&gt;over&lt;/span&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;partition&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; categoryId &lt;span class=&quot;hljs-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;by&lt;/span&gt; views &lt;span class=&quot;hljs-keyword&quot;&gt;desc&lt;/span&gt;) &lt;span class=&quot;hljs-keyword&quot;&gt;rank&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;gulivideo_category; t1&lt;p&gt;第2步：&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;select&lt;/span&gt;&lt;br/&gt;t1.*&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;from&lt;/span&gt;&lt;br/&gt;t1&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;where&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;rank&lt;/span&gt;&amp;lt;=&lt;span class=&quot;hljs-number&quot;&gt;10&lt;/span&gt;;&lt;br/&gt;&lt;/p&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;h2 id=&quot;h11&quot;&gt;&lt;span&gt;&lt;strong&gt;第11章 常见错误及解决方案&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;1）SecureCRT 7.3 出现乱码或者删除不掉数据，免安装版的 SecureCRT 卸载或者用虚拟机直接操作或者换安装版的SecureCRT。&lt;/p&gt;
&lt;p&gt;2）连接不上mysql数据库&lt;br/&gt;  （1）导错驱动包，应该把 mysql-connector-java-5.1.27-bin.jar 导入 /opt/module/hive/lib 的不是这个包。错把 mysql-connector-java-5.1.27.tar.gz 导入 hive/lib 包下。&lt;br/&gt;  （2）修改user表中的主机名称没有都修改为%，而是修改为 localhost。&lt;/p&gt;
&lt;p&gt;3）hive默认的输入格式处理是 CombineHiveInputFormat，会对小文件进行合并。&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;hljs lua&quot;&gt;hive (default)&amp;gt; set hive.&lt;span class=&quot;hljs-built_in&quot;&gt;input&lt;/span&gt;.&lt;span class=&quot;hljs-built_in&quot;&gt;format&lt;/span&gt;;&lt;br/&gt;hive.&lt;span class=&quot;hljs-built_in&quot;&gt;input&lt;/span&gt;.&lt;span class=&quot;hljs-built_in&quot;&gt;format&lt;/span&gt;=org.apache.hadoop.hive.ql.&lt;span class=&quot;hljs-built_in&quot;&gt;io&lt;/span&gt;.CombineHiveInputFormat&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;可以采用 HiveInputFormat 就会根据分区数输出相应的文件。&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;hljs lua&quot;&gt;hive (default)&amp;gt; set hive.&lt;span class=&quot;hljs-built_in&quot;&gt;input&lt;/span&gt;.&lt;span class=&quot;hljs-built_in&quot;&gt;format&lt;/span&gt;=org.apache.hadoop.hive.ql.&lt;span class=&quot;hljs-built_in&quot;&gt;io&lt;/span&gt;.HiveInputFormat;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;4）不能执行mapreduce程序&lt;br/&gt;  可能是hadoop的yarn没开启。&lt;/p&gt;
&lt;p&gt;5）启动mysql服务时，报 &lt;code&gt;MySQL server PID file could not be found!&lt;/code&gt; 异常。&lt;br/&gt;  在 /var/lock/subsys/mysql 路径下创建 hadoop102.pid，并在文件中添加内容：4396&lt;/p&gt;
&lt;p&gt;6）报 service mysql status MySQL is not running, but lock file (/var/lock/subsys/mysql[失败])异常。&lt;br/&gt;  解决方案：在/var/lib/mysql 目录下创建：&lt;br/&gt;-rw-rw----. 1 mysql mysql 5 12月 22 16:41 hadoop102.pid&lt;br/&gt;文件，并修改权限为 777。&lt;/p&gt;
&lt;p&gt;7）JVM堆内存溢出&lt;/p&gt;
&lt;img title=&quot;&quot; src=&quot;https://s2.ax1x.com/2019/03/02/kbOrLT.png&quot; alt=&quot;&quot;/&gt;&lt;br/&gt;描述：java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;解决：在yarn-site.xml中加入如下代码后，进行分发，重启yarn。
&lt;pre&gt;
&lt;code class=&quot;xml language-xml hljs&quot;&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;property&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;name&lt;/span&gt;&amp;gt;&lt;/span&gt;yarn.scheduler.maximum-allocation-mb&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;name&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;value&lt;/span&gt;&amp;gt;&lt;/span&gt;2048&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;value&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;property&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;property&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;name&lt;/span&gt;&amp;gt;&lt;/span&gt;yarn.scheduler.minimum-allocation-mb&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;name&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;value&lt;/span&gt;&amp;gt;&lt;/span&gt;2048&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;value&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;property&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;property&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;name&lt;/span&gt;&amp;gt;&lt;/span&gt;yarn.nodemanager.vmem-pmem-ratio&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;name&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;value&lt;/span&gt;&amp;gt;&lt;/span&gt;2.1&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;value&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;property&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;property&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;name&lt;/span&gt;&amp;gt;&lt;/span&gt;mapred.child.java.opts&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;name&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;value&lt;/span&gt;&amp;gt;&lt;/span&gt;-Xmx1024m&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;value&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;property&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;
&lt;/pre&gt;</description>
<pubDate>Sat, 02 Mar 2019 06:44:00 +0000</pubDate>
<dc:creator>黑泽君</dc:creator>
<og:description>第10章 Hive实战之谷粒影音10.1 需求描述10.2 项目10.2.1 数据结构10.2.2 ETL原始数据10.3 准备工作10.3.1 创建表10.3.2 导入ETL后的数据到原始表10.3</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/chenmingjun/p/10461062.html</dc:identifier>
</item>
<item>
<title>Qt程序继承QApplication发生崩溃的原因 - 24K纯开源</title>
<link>http://www.cnblogs.com/csuftzzk/p/qapplication_arguments_crash.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/csuftzzk/p/qapplication_arguments_crash.html</guid>
<description>&lt;p&gt;     QApplication是Qt开发中经常用到的一个类，用来管理应用程序的生命周期。跟其相关的类还有QCoreApplication和QGuiApplication，分别用于不同场景下为应用程序的控制流和事件处理提供基础的框架。这三个类的构造函数都接收两个参数（分别是argc和argv），和C/C++程序的main函数的参数差不多。因此，大部分情况下我们是直接将main函数的这两个参数传给QApplication（这里以GUI程序为例）：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;1&lt;/span&gt; #include &amp;lt;QApplication&amp;gt;
&lt;span&gt;2&lt;/span&gt; 
&lt;span&gt;3&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; main(&lt;span&gt;int&lt;/span&gt; argc, &lt;span&gt;char&lt;/span&gt; *&lt;span&gt;argv[])
&lt;/span&gt;&lt;span&gt;4&lt;/span&gt; &lt;span&gt;{ 
&lt;/span&gt;&lt;span&gt;5&lt;/span&gt; &lt;span&gt;    QApplication app( argc, argv );
&lt;/span&gt;&lt;span&gt;6&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; Create main window...&lt;/span&gt;
&lt;span&gt;7&lt;/span&gt; 
&lt;span&gt;8&lt;/span&gt;     &lt;span&gt;return&lt;/span&gt;&lt;span&gt; app.exec();
&lt;/span&gt;&lt;span&gt;9&lt;/span&gt; }
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;    绝大部分情况下这不会有什么问题，程序能够正常运行并结束。但是最近遇到的一个Qt程序崩溃的问题，却不得不让我对QApplication的两个参数提高了警惕。情况是这样的，我们在项目中为了保存一些全局性的数据，从QApplication派生了一个子类，并增加了一些新的方法来保存运行时的数据。编译运行很开心，程序完全满足了我们的要求。但是程序发布出去给用户使用的时候，我们在后台的崩溃上报系统中看到了一个这样的崩溃堆栈：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/214648/201903/214648-20190302134816502-1157871276.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;    很明显程序在QCoreApplication的arguments()方法中崩溃了。这个崩溃堆栈让我们不由得浮想联翩：难道这个是Qt框架本身的Bug？不小心被我给踩到了？因为我们的程序运行起来之后，没有什么地方会和QCoreApplication的arguments方法打交道啊！这么一想心里顿时好受多了，帅锅技能升华！&lt;/p&gt;
&lt;p&gt;     过了一段时间之后，另外一个同事想在mac电脑上来编译工程，却发现编译后的程序死都运行不起来。一运行就报错：EXC_i386_GPFLT QCoreApplication::arguments，又将矛头指向了QCoreApplication的arguments方法，这下我慌了！这下必须要仔细排查下原因，不能假装不知道继续帅锅了！根据关键字EXC_i386_GFLT没用找到什么有用的东西，再一搜Qt QApplication arguments方法崩溃，就找到了一堆的信息，其中Qt bug管理系统上的一个用户吐槽最为详细：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/214648/201903/214648-20190302135806464-1511231646.png&quot; alt=&quot;&quot; width=&quot;1558&quot; height=&quot;481&quot;/&gt;&lt;/p&gt;
&lt;p&gt;    这个用户说的很详细，&lt;strong&gt;QApplication的构造函数中argc必须为引用传值方式&lt;/strong&gt;，否则程序会崩溃！然而Qt官方文档并没有强调这一点，导致很多用户根本没在意到这一点。再去看Qt文档，可以发现QApplication，QCoreApplication和QGuiApplication的构造函数中，argc都是引用传值的方式声明的。确实粗心大意了！&lt;/p&gt;
&lt;p&gt;    &lt;img src=&quot;https://img2018.cnblogs.com/blog/214648/201903/214648-20190302140351551-768966686.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/214648/201903/214648-20190302140402411-1029351300.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/214648/201903/214648-20190302140409773-1390462563.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;p&gt;1. &lt;a href=&quot;https://bugreports.qt.io/browse/QTBUG-5637&quot; target=&quot;_blank&quot;&gt;https://bugreports.qt.io/browse/QTBUG-5637&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;2. &lt;a href=&quot;https://groups.google.com/forum/#!msg/mathgl/CVvVyRnl3X4/EPiRrnqy3moJ&quot; target=&quot;_blank&quot;&gt;https://groups.google.com/forum/#!msg/mathgl/CVvVyRnl3X4/EPiRrnqy3moJ&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;3. &lt;a href=&quot;https://stackoverflow.com/questions/22243674/segmentation-fault-when-qt-qapplication-created-with-new/22245111&quot; target=&quot;_blank&quot;&gt;https://stackoverflow.com/questions/22243674/segmentation-fault-when-qt-qapplication-created-with-new/22245111&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;4. &lt;a href=&quot;https://stackoverflow.com/questions/35566459/segfault-when-accessing-qapplicationarguments&quot; target=&quot;_blank&quot;&gt;https://stackoverflow.com/questions/35566459/segfault-when-accessing-qapplicationarguments&lt;/a&gt;&lt;/p&gt;
</description>
<pubDate>Sat, 02 Mar 2019 06:09:00 +0000</pubDate>
<dc:creator>24K纯开源</dc:creator>
<og:description>一、前情介绍 QApplication是Qt开发中经常用到的一个类，用来管理应用程序的生命周期。跟其相关的类还有QCoreApplication和QGuiApplication，分别用于不同场景下为应</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/csuftzzk/p/qapplication_arguments_crash.html</dc:identifier>
</item>
<item>
<title>AntD框架的upload组件上传图片时遇到的一些坑 - 千古壹号</title>
<link>http://www.cnblogs.com/qianguyihao/p/10460834.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/qianguyihao/p/10460834.html</guid>
<description>&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 &lt;a href=&quot;https://ant.design/components/upload-cn/&quot;&gt;upload&lt;/a&gt; 组件。&lt;/p&gt;
&lt;p&gt;前端做文件上传这个功能，是很有技术难度的。既然框架给我们提供好了，那就直接用呗。结果用的时候，发现 upload 组件的很多bug。下面来列举几个。&lt;/p&gt;
&lt;p&gt;备注：本文写于2019-03-02，使用的 antd 版本是 3.13.6。&lt;/p&gt;
&lt;h2 id=&quot;使用-antd-的-upload-组件做图片的上传&quot;&gt;使用 AntD 的 upload 组件做图片的上传&lt;/h2&gt;
&lt;p&gt;因为需要上传多张图片，所以采用的是照片墙的形式。上传成功后的界面如下：&lt;/p&gt;
&lt;p&gt;（1）上传中：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://img.smyhvae.com/20190302_1335.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;（2）上传成功：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://img.smyhvae.com/20190302_1336.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;（3）图片预览：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://img.smyhvae.com/20190302_1331.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;按照官方提供的实例，特此整理出项目开发中的完整写法，亲测有效。代码如下：&lt;/p&gt;
&lt;pre class=&quot;javascript&quot;&gt;
&lt;code&gt;/* eslint-disable */

import { Upload, Icon, Modal, Form } from 'antd';

const FormItem = Form.Item;

class PicturesWall extends PureComponent {
  state = {
    previewVisible: false,
    previewImage: '',
    imgList: [],
  };


  handleChange = ({ file, fileList }) =&amp;gt; {
    console.log(JSON.stringify(file)); // file 是当前正在上传的 单个 img
    console.log(JSON.stringify(fileList)); // fileList 是已上传的全部 img 列表

    this.setState({
      imgList: fileList,
    });
  };


  handleCancel = () =&amp;gt; this.setState({ previewVisible: false });

  handlePreview = file =&amp;gt; {
    this.setState({
      previewImage: file.url || file.thumbUrl,
      previewVisible: true,
    });
  };


  // 参考链接：https://www.jianshu.com/p/f356f050b3c9
  handleBeforeUpload = file =&amp;gt; {
    //限制图片 格式、size、分辨率
    const isJPG = file.type === 'image/jpeg';
    const isJPEG = file.type === 'image/jpeg';
    const isGIF = file.type === 'image/gif';
    const isPNG = file.type === 'image/png';
    if (!(isJPG || isJPEG || isGIF || isPNG)) {
      Modal.error({
        title: '只能上传JPG 、JPEG 、GIF、 PNG格式的图片~',
      });
      return;
    }
    const isLt2M = file.size / 1024 / 1024 &amp;lt; 2;
    if (!isLt2M) {
      Modal.error({
        title: '超过2M限制 不允许上传~',
      });
      return;
    }
    return (isJPG || isJPEG || isGIF || isPNG) &amp;amp;&amp;amp; isLt2M &amp;amp;&amp;amp; this.checkImageWH(file);
  };

  //返回一个 promise：检测通过则返回resolve；失败则返回reject，并阻止图片上传
  checkImageWH(file) {
    let self = this;
    return new Promise(function(resolve, reject) {
      let filereader = new FileReader();
      filereader.onload = e =&amp;gt; {
        let src = e.target.result;
        const image = new Image();
        image.onload = function() {
          // 获取图片的宽高，并存放到file对象中
          console.log('file width :' + this.width);
          console.log('file height :' + this.height);
          file.width = this.width;
          file.height = this.height;
          resolve();
        };
        image.onerror = reject;
        image.src = src;
      };
      filereader.readAsDataURL(file);
    });
  }

  handleSubmit = e =&amp;gt; {
    const { dispatch, form } = this.props;
    e.preventDefault();
    form.validateFieldsAndScroll((err, values) =&amp;gt; {// values 是form表单里的参数
      // 点击按钮后，将表单提交给后台
      dispatch({
        type: 'mymodel/submitFormData',
        payload: values,
      });
    });
  };

  render() {
    const { previewVisible, previewImage, imgList } = this.state; //  从 state 中拿数据
    const uploadButton = (
      &amp;lt;div&amp;gt;
        &amp;lt;Icon type=&quot;plus&quot; /&amp;gt;
        &amp;lt;div className=&quot;ant-upload-text&quot;&amp;gt;Upload&amp;lt;/div&amp;gt;
      &amp;lt;/div&amp;gt;
    );
    return (
      &amp;lt;div className=&quot;clearfix&quot;&amp;gt;
        &amp;lt;Form onSubmit={this.handleSubmit} hideRequiredMark style={{ marginTop: 8 }}&amp;gt;
          &amp;lt;FormItem label=&quot;图片图片&quot; {...formItemLayout}&amp;gt;
            {getFieldDecorator('myImg')(
              &amp;lt;Upload
                action=&quot;//jsonplaceholder.typicode.com/posts/&quot; // 这个是接口请求
                data={file =&amp;gt; ({ // data里存放的是接口的请求参数
                  param1: myParam1,
                  param2: myParam2,
                  photoCotent: file, // file 是当前正在上传的图片
                  photoWidth: file.height, // 通过  handleBeforeUpload 获取 图片的宽高
                  photoHeight: file.width,
                })}
                listType=&quot;picture-card&quot;
                fileList={this.state.imgList}
                onPreview={this.handlePreview} // 点击图片缩略图，进行预览
                beforeUpload={this.handleBeforeUpload} // 上传之前，对图片的格式做校验，并获取图片的宽高
                onChange={this.handleChange} // 每次上传图片时，都会触发这个方法
              &amp;gt;
                {this.state.imgList.length &amp;gt;= 9 ? null : uploadButton}
              &amp;lt;/Upload&amp;gt;
            )}
          &amp;lt;/FormItem&amp;gt;
        &amp;lt;/Form&amp;gt;
        &amp;lt;Modal visible={previewVisible} footer={null} onCancel={this.handleCancel}&amp;gt;
          &amp;lt;img alt=&quot;example&quot; style={{ width: '100%' }} src={previewImage} /&amp;gt;
        &amp;lt;/Modal&amp;gt;
      &amp;lt;/div&amp;gt;
    );
  }
}

export default PicturesWall;
&lt;/code&gt;
&lt;/pre&gt;
&lt;h2 id=&quot;上传后点击图片预览浏览器卡死的问题&quot;&gt;上传后，点击图片预览，浏览器卡死的问题&lt;/h2&gt;
&lt;p&gt;依据上方的代码，通过 Antd 的 upload 组件将图片上传成功后，点击图片的缩略图，理应可以在当前页面弹出 Modal，预览图片。但实际的结果是，浏览器一定会卡死。&lt;/p&gt;
&lt;p&gt;定位问题发现，原因竟然是：图片上传成功后， upload 会将其转为 base64编码。base64这个字符串太大了，点击图片预览的时候，浏览器在解析一大串字符串，然后就卡死了。详细过程描述如下。&lt;/p&gt;
&lt;p&gt;上方代码中，我们可以把 handleChange(file, fileList)方法中的 &lt;code&gt;file&lt;/code&gt;、以及 &lt;code&gt;fileList&lt;/code&gt;打印出来看看。 &lt;code&gt;file&lt;/code&gt;指的是当前正在上传的 单个 img，&lt;code&gt;fileList&lt;/code&gt;是已上传的全部 img 列表。 当我上传完 两张图片后， 打印结果如下：&lt;/p&gt;
&lt;p&gt;file的打印的结果如下：&lt;/p&gt;
&lt;pre class=&quot;json&quot;&gt;
&lt;code&gt;    {
        &quot;uid&quot;: &quot;rc-upload-1551084269812-5&quot;,
        &quot;width&quot;: 600,
        &quot;height&quot;: 354,
        &quot;lastModified&quot;: 1546701318000,
        &quot;lastModifiedDate&quot;: &quot;2019-01-05T15:15:18.000Z&quot;,
        &quot;name&quot;: &quot;e30e7b9680634b2c888c8bb513cc595d.jpg&quot;,
        &quot;size&quot;: 31731,
        &quot;type&quot;: &quot;image/jpeg&quot;,
        &quot;percent&quot;: 100,
        &quot;originFileObj&quot;: {
            &quot;uid&quot;: &quot;rc-upload-1551084269812-5&quot;,
            &quot;width&quot;: 600,
            &quot;height&quot;: 354
        },
        &quot;status&quot;: &quot;done&quot;,
        &quot;thumbUrl&quot;: &quot;data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAHQ9qKKlbimcXrIH9o2vH/AC2T+ddPj98v+9RRWsuhnHdk0ar9qb5R0Pb6VPB/qh9aKKiRr0Irnt/vUDr+NFFJCRqWxJik5Pb+dLJ938aKK06mYSdKKKKBH//Z&quot;,
        &quot;response&quot;: {
            &quot;retCode&quot;: 0,
            &quot;imgUrl&quot;: &quot;http://qianguyihao.com/opfewfwj098902kpkpkkj976fe.jpg&quot;,
            &quot;photoid&quot;: 271850
        }
    }&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;fileList 的打印结果：&lt;/p&gt;
&lt;pre class=&quot;json&quot;&gt;
&lt;code&gt;[
    {
        &quot;uid&quot;: &quot;rc-upload-1551084269812-3&quot;,
        &quot;width&quot;: 1000,
        &quot;height&quot;: 667,
        &quot;lastModified&quot;: 1501414799000,
        &quot;lastModifiedDate&quot;: &quot;2017-07-30T11:39:59.000Z&quot;,
        &quot;name&quot;: &quot;29381f30e924b89914e91b33.jpg&quot;,
        &quot;size&quot;: 135204,
        &quot;type&quot;: &quot;image/jpeg&quot;,
        &quot;percent&quot;: 100,
        &quot;originFileObj&quot;: {
            &quot;uid&quot;: &quot;rc-upload-1551084269812-3&quot;,
            &quot;width&quot;: 1000,
            &quot;height&quot;: 667
        },
        &quot;status&quot;: &quot;done&quot;,
        &quot;thumbUrl&quot;: &quot;data:image/jpeg;base64,/E3ju1tlaK1fzJOnHQU3LsLV7HO6Zrk11MZJ7luT0A4FZuRagi9quvzQQ4iuEJ7ZpqTG4djDsPFl2Lg733f8C4q+YhQ8zoYfGSqoMmfwo5huLL0HjiyPDSYPvxRdC1XQvxeLrB8fvl/OnoLmL9vrdvvYS3NGFVe2YsASOh71JfQyrqV2mXLHOcccVSIYEnDyZO9XXB9KYH//Z&quot;,
        &quot;response&quot;: {
            &quot;retCode&quot;: 0,
            &quot;msg&quot;: &quot;success&quot;,
            &quot;imgUrl&quot;: &quot;http://qianguyihao.com/hfwpjouiurewnmbhepr689.jpg&quot;,
        }
    },
    {
        &quot;uid&quot;: &quot;rc-upload-1551084269812-5&quot;,
        &quot;width&quot;: 600,
        &quot;height&quot;: 354,
        &quot;lastModified&quot;: 1546701318000,
        &quot;lastModifiedDate&quot;: &quot;2019-01-05T15:15:18.000Z&quot;,
        &quot;name&quot;: &quot;e30e7b9680634b2c888c8bb513cc595d.jpg&quot;,
        &quot;size&quot;: 31731,
        &quot;type&quot;: &quot;image/jpeg&quot;,
        &quot;percent&quot;: 100,
        &quot;originFileObj&quot;: {
            &quot;uid&quot;: &quot;rc-upload-1551084269812-5&quot;,
            &quot;width&quot;: 600,
            &quot;height&quot;: 354
        },
        &quot;status&quot;: &quot;done&quot;,
        &quot;thumbUrl&quot;: &quot;data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAHQ9qKKlbimcXrIH9o2vH/AC2T+ddPj98v+9RRWsuhnHdk0ar9qb5R0Pb6VPB/qh9aKKiRr0Irnt/vUDr+NFFJCRqWxJik5Pb+dLJ938aKK06mYSdKKKKBH//Z&quot;,
        &quot;response&quot;: {
            &quot;retCode&quot;: 0,
            &quot;imgUrl&quot;: &quot;http://qianguyihao.com/opfewfwj098902kpkpkkj976fe.jpg&quot;,
            &quot;photoid&quot;: 271850
        }
    }
]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;上方的json数据中，需要做几点解释：&lt;/p&gt;
&lt;p&gt;（1）&lt;code&gt;response&lt;/code&gt; 字段里面的数据，就是请求接口后，后台返回给前端的数据，里面包含了图片的url链接。&lt;/p&gt;
&lt;p&gt;（2）&lt;code&gt;status&lt;/code&gt; 字段里存放的是图片上传的实时状态，包括上传中、上传完成、上传失败。&lt;/p&gt;
&lt;p&gt;（3）&lt;code&gt;thumbUrl&lt;/code&gt;字段里面存放的是图片的base64编码。&lt;/p&gt;
&lt;p&gt;这个base64编码非常非常长。当点击图片预览的时候，其实就是加载的 thumbUrl 这个字段里的资源，难怪浏览器会卡死。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解决办法&lt;/strong&gt;：在 handleChange方法里，图片上传成功后，将 thumbUrl 字段里面的 base64 编码改为真实的图片url。代码实现如下：&lt;/p&gt;
&lt;pre class=&quot;javascript&quot;&gt;
&lt;code&gt;  handleChange = ({ file, fileList }) =&amp;gt; {
    console.log(JSON.stringify(file)); // file 是当前正在上传的 单个 img
    console.log(JSON.stringify(fileList)); // fileList 是已上传的全部 img 列表

    if (file &amp;amp;&amp;amp; file.response &amp;amp;&amp;amp; file.response.retCode == 0) {
      console.log('图片上传成功');
      fileList.forEach(item =&amp;gt; {
        // 【重要】将 图片的base64替换为图片的url。 这一行一定不会能少。
        // 图片上传成功后，fileList数组中的 thumbUrl 中保存的是图片的base64字符串，这种情况，导致的问题是：图片上传成功后，点击图片缩略图，浏览器会会卡死。而下面这行代码，可以解决该bug。
        item.thumbUrl = item.response.imgUrl;
      });
    }

    this.setState({
      imgList: fileList,
    });
  };&lt;/code&gt;
&lt;/pre&gt;
&lt;h2 id=&quot;新需求编辑现有页面&quot;&gt;新需求：编辑现有页面&lt;/h2&gt;
&lt;p&gt;上面一段的代码中，我们是在新建的页面中，从零开始上传图片。&lt;/p&gt;
&lt;p&gt;现在有个新的需求：如何编辑现有的页面呢？也就是说说，现有的页面中，是默认有几张图片的。当我编辑这个页面时，可以对现有的图片做增删，也能增加新的图片。&lt;/p&gt;
&lt;p&gt;我看到upload 组件有提供 &lt;code&gt;defaultFileList&lt;/code&gt; 的属性。我试了下，这个&lt;code&gt;defaultFileList&lt;/code&gt; 的属性根本没法儿用。&lt;/p&gt;
&lt;p&gt;那就只要手动实现了。我的model层代码，是用 redux 写的。实现思路如下：&lt;/p&gt;
&lt;p&gt;（1）PicturesWall.js：&lt;/p&gt;
&lt;pre class=&quot;javascript&quot;&gt;
&lt;code&gt;/* eslint-disable */

import { Upload, Icon, Modal, Form } from 'antd';

const FormItem = Form.Item;

class PicturesWall extends PureComponent {
  state = {
    previewVisible: false,
    previewImage: '',
  };

  // 页面初始化的时候，从接口拉取默认的图片数据
  componentDidMount() {
    const { dispatch } = this.props;
    dispatch({
      type: 'mymodel/getAllInfo',
      payload: { params: xxx },
    });
  }

  handleChange = ({ file, fileList }) =&amp;gt; {
    const { dispatch } = this.props;
    if (file &amp;amp;&amp;amp; file.response &amp;amp;&amp;amp; file.response.retCode == 0) {
      console.log('图片上传成功');
      fileList.forEach(item =&amp;gt; {
        // 【重要】将 图片的base64替换为图片的url。 这一行一定不会能少。
        // 图片上传成功后，fileList数组中的 thumbUrl 中保存的是图片的base64字符串，这种情况，导致的问题是：图片上传成功后，点击图片缩略图，浏览器会会卡死。而下面这行代码，可以解决该bug。
        item.thumbUrl = item.response.imgUrl;
      });
    }

    dispatch({
      type: 'mymodel/setImgList',
      payload: fileList,
    });
  };

  handleCancel = () =&amp;gt; this.setState({ previewVisible: false });

  handlePreview = file =&amp;gt; {
    this.setState({
      previewImage: file.url || file.thumbUrl,
      previewVisible: true,
    });
  };

  // 参考链接：https://www.jianshu.com/p/f356f050b3c9
  handleBeforeUpload = file =&amp;gt; {
    //限制图片 格式、size、分辨率
    const isJPG = file.type === 'image/jpeg';
    const isJPEG = file.type === 'image/jpeg';
    const isGIF = file.type === 'image/gif';
    const isPNG = file.type === 'image/png';
    if (!(isJPG || isJPEG || isGIF || isPNG)) {
      Modal.error({
        title: '只能上传JPG 、JPEG 、GIF、 PNG格式的图片~',
      });
      return;
    }
    const isLt2M = file.size / 1024 / 1024 &amp;lt; 2;
    if (!isLt2M) {
      Modal.error({
        title: '超过2M限制 不允许上传~',
      });
      return;
    }
    return (isJPG || isJPEG || isGIF || isPNG) &amp;amp;&amp;amp; isLt2M &amp;amp;&amp;amp; this.checkImageWH(file);
  };

  //返回一个 promise：检测通过则返回resolve；失败则返回reject，并阻止图片上传
  checkImageWH(file) {
    let self = this;
    return new Promise(function(resolve, reject) {
      let filereader = new FileReader();
      filereader.onload = e =&amp;gt; {
        let src = e.target.result;
        const image = new Image();
        image.onload = function() {
          // 获取图片的宽高，并存放到file对象中
          console.log('file width :' + this.width);
          console.log('file height :' + this.height);
          file.width = this.width;
          file.height = this.height;
          resolve();
        };
        image.onerror = reject;
        image.src = src;
      };
      filereader.readAsDataURL(file);
    });
  }

  handleSubmit = e =&amp;gt; {
    const { dispatch, form } = this.props;
    e.preventDefault();
    form.validateFieldsAndScroll((err, values) =&amp;gt; {
      // values 是form表单里的参数
      // 点击按钮后，将表单提交给后台
      dispatch({
        type: 'mymodel/submitFormData',
        payload: values,
      });
    });
  };

  render() {
    const { previewVisible, previewImage } = this.state; //  从 state 中拿数据

    const {
      mymodel: { imgList }, // 从props中拿到的图片数据
    } = this.props;

    const uploadButton = (
      &amp;lt;div&amp;gt;
        &amp;lt;Icon type=&quot;plus&quot; /&amp;gt;
        &amp;lt;div className=&quot;ant-upload-text&quot;&amp;gt;Upload&amp;lt;/div&amp;gt;
      &amp;lt;/div&amp;gt;
    );
    return (
      &amp;lt;div className=&quot;clearfix&quot;&amp;gt;
        &amp;lt;Form onSubmit={this.handleSubmit} hideRequiredMark style={{ marginTop: 8 }}&amp;gt;
          &amp;lt;FormItem label=&quot;图片上传&quot; {...formItemLayout}&amp;gt;
            {getFieldDecorator('myImg')(
              &amp;lt;Upload
                action=&quot;//jsonplaceholder.typicode.com/posts/&quot; // 这个是接口请求
                data={file =&amp;gt; ({
                  // data里存放的是接口的请求参数
                  param1: myParam1,
                  param2: myParam2,
                  photoCotent: file, // file 是当前正在上传的图片
                  photoWidth: file.height, // 通过  handleBeforeUpload 获取 图片的宽高
                  photoHeight: file.width,
                })}
                listType=&quot;picture-card&quot;
                fileList={imgList}  // 改为从 props 里拿图片数据，而不是从 state
                onPreview={this.handlePreview} // 点击图片缩略图，进行预览
                beforeUpload={this.handleBeforeUpload} // 上传之前，对图片的格式做校验，并获取图片的宽高
                onChange={this.handleChange} // 每次上传图片时，都会触发这个方法
              &amp;gt;
                {this.state.imgList.length &amp;gt;= 9 ? null : uploadButton}
              &amp;lt;/Upload&amp;gt;
            )}
          &amp;lt;/FormItem&amp;gt;
        &amp;lt;/Form&amp;gt;
        &amp;lt;Modal visible={previewVisible} footer={null} onCancel={this.handleCancel}&amp;gt;
          &amp;lt;img alt=&quot;example&quot; style={{ width: '100%' }} src={previewImage} /&amp;gt;
        &amp;lt;/Modal&amp;gt;
      &amp;lt;/div&amp;gt;
    );
  }
}

export default PicturesWall;
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;（2）mymodel.js:&lt;/p&gt;
&lt;pre class=&quot;javascript&quot;&gt;
&lt;code&gt;/* eslint-disable */

import { routerRedux } from 'dva/router';
import { message, Modal } from 'antd';
import {
  getGoodsInfo,
  getAllGoods,
} from '../services/api';
import { trim, getCookie } from '../utils/utils';

export default {
  namespace: 'mymodel',

  state: {
    form: {},
    list: [],
    listDetail: [],
    goodsList: [],
    goodsListDetail: [],
    pagination: {
      pageSize: 10,
      total: 0,
      current: 1,
    },
    imgList: [], //图片
  },
  subscriptions: {
    setup({ dispatch, history }) {
      history.listen(location =&amp;gt; {
        if (location.pathname !== '/xx/xxx') return;
        if (!location.state || !location.state.xxxId) return;
        dispatch({
          type: 'fetch',
          payload: location.state,
        });
      });
    },
  },

  effects: {
    // 接口。获取所有工厂店的列表 (步骤02)
    *getAllInfo({ payload }, { select, call, put }) {
      yield put({
        type: 'form',
        payload,
      });
      console.log('params:' + JSON.stringify(payload));

      let params = {};
      params = payload;

      const response = yield call(getGoodsInfo, params);

      console.log('smyhvae response:' + JSON.stringify(response));
      if (response.error) return;
      yield put({
        type: 'allInfo',
        payload:
          (response.data &amp;amp;&amp;amp;
            response.data.map(item =&amp;gt; ({
              xx1: item.yy1,
              xx2: item.yy2,
            }))) ||
          [],
      });

      // response 里包含了接口返回给前端的默认图片数据
      if (response &amp;amp;&amp;amp; response.data &amp;amp;&amp;amp; response.data[0] &amp;amp;&amp;amp; response.data[0].my_jpg) {
        let tempImgList = response.data[0].my_jpg.split(',');
        let imgList = [];

        if (tempImgList.length &amp;gt; 0) {
          tempImgList.forEach(item =&amp;gt; {
            imgList.push({
              uid: item,
              name: 'xxx.png',
              status: 'done',
              thumbUrl: item,
            });
          });
        }

        // 通过  redux的方式 将 默认图片 传给 imgList
        console.log('smyhvae payload imgList:' + JSON.stringify(imgList));
        yield put({
          type: 'setImgList',
          payload: imgList,
        });
      }
    },

    *setImgList({ payload }, { call, put }) {
      console.log('model setImgList');
      yield put({
        type: 'getImgList',
        payload,
      });
    },
  },

  reducers: {
    allInfo(state, action) {
      return {
        ...state,
        list: action.payload,
      };
    },
    getImgList(state, action) {
      return {
        ...state,
        imgList: action.payload,
      };
    },
  },
};
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;大功告成。&lt;/p&gt;
&lt;p&gt;本文感谢 ld 同学的支持。&lt;/p&gt;
&lt;h2 id=&quot;最后一段&quot;&gt;最后一段&lt;/h2&gt;
&lt;p&gt;有人说，前端开发，连卖菜的都会。可如果真的遇到技术难题，还是得找个靠谱的前端同学才行。这不，来看看前端码农日常：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://img.smyhvae.com/20190302_1339.png&quot;/&gt;&lt;/p&gt;
</description>
<pubDate>Sat, 02 Mar 2019 05:49:00 +0000</pubDate>
<dc:creator>千古壹号</dc:creator>
<og:description>前言 本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 'upload' 组件。 前端做文件上传这个功能，是很有技术难度的。既然框架给我们提供好了，那就直接用呗。结果用</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/qianguyihao/p/10460834.html</dc:identifier>
</item>
<item>
<title>cocos creator主程入门教程（十）—— A*寻路 - 五邑隐侠</title>
<link>http://www.cnblogs.com/niudanshui/p/10460815.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/niudanshui/p/10460815.html</guid>
<description>&lt;p&gt;&lt;span&gt;摘要: 五邑隐侠，本名关健昌，10年游戏生涯，现隐居五邑。本系列文章以TypeScript为介绍语言。&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;这一篇介绍A*寻路算法。在RPG、SLG、模拟经营类游戏，有需要给角色寻路的需求，一般寻路我们采用A*寻路算法，A*寻路算法是一种广度优先启发性算法。&lt;/p&gt;
&lt;p&gt;先说说什么叫广度优先。搜索分为广度优先和深度优先，主要体现在对节点的展开上。深度优先一直往一个方向查找，如果没办法查找下去，在当前节点改变方向继续查找，直到找到终点。如果无法继续查找，就回退上一格重复操作。广度优先把当前节点放入待探索列表，循环从待探索列表里取出节点进行展开，直到找到终点。如果待探索列表为空，说明没有路可走。&lt;/p&gt;
&lt;p&gt;启发性指算法在待探索列表里取节点时，先预测哪个节点的路径可能会最短，优先对该节点展开，A*算法基于对未探索路径的假设和预测，假设所有路都能通行前提下总路径最短值。在图论里，介绍过有一种寻找最短路径的算法叫Dijkstra算法，该算法基于贪心算法，即当前选择探索的节点，为尚未确定最短路径，当前源点能到达且路径最短的节点。Dijkstra算法基于已知距离源点最短。为了便于理解这两种算法的区别，先介绍下Dijkstra算法。&lt;/p&gt;

&lt;p&gt;Dijkstra算法知道所有可能的节点，如下图，知道总共有ABCDE5个节点，寻找从A点出发到各点的最短路径。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/137210/201903/137210-20190302120720157-500551263.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;1）算法有两个数组，一个维护当前已知最终最短路径的节点数组S，找到为路径字符串和长度，否则为空字符串，初始只有起点A点标记为“A”。另一个数组V，维护各个节点“目前所知”从源点出发最短的路径长度（不一定是最终的最短路径，初始B标记为6，D为7），已经找到最终最短路径的标记为0（初始时起点A标记为0），目前无法到达的标记为无穷大。&lt;/p&gt;
&lt;p&gt;2）循环从数组V中获取标记非0，非无穷大，路径最短的节点，在数组S中标记为1，修正V中其他节点的最短路径。直到数组S中所有节点都标记为1&lt;/p&gt;
&lt;p&gt;如上图，寻路的过程为：&lt;/p&gt;
&lt;p&gt; V：（A，0），（B：6），（C：无穷大），（D：7），（E：无穷大），S：（A，“A”），（B：“”），（C：“”），（D：“”），（E：“”）&lt;/p&gt;
&lt;p&gt; V：（A，0），（B：0），（C：11），（D：7），（E：18），S：（A，“A”），（B：“AB”），（C：“”），（D：“”），（E：“”）&lt;/p&gt;
&lt;p&gt; V：（A，0），（B：0），（C：10），（D：0），（E：18），S：（A，“A”），（B：“AB”），（C：“”），（D：“AD”），（E：“”）&lt;/p&gt;
&lt;p&gt; V：（A，0），（B：0），（C：0），（D：0），（E：18），S：（A，“A”），（B：“AB”），（C：“ADC”），（D：“AD”），（E：“”）&lt;/p&gt;
&lt;p&gt; V：（A，0），（B：0），（C：0），（D：0），（E：0），S：（A，“A”），（B：“AB”），（C：“ADC”），（D：“AD”），（E：“ABE”）&lt;/p&gt;
&lt;p&gt;这里，Dijkstra算法基于知道所有可能的节点，目标节点也有多个，每个节点可以直接到达的节点数没有限制。&lt;/p&gt;

&lt;p&gt;游戏里的寻路是目标节点只有一个，中间节点可能有多个，每个节点可以直接到达的节点数最多4个（如果是8个方向是8）&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/137210/201903/137210-20190302131201094-2103671258.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;将数组改成列表会更灵活，现在将数组V改成open队列，将数组S改成close队列。如上图，要找到A到E的路径，仍然按照Dijkstra算法思路，&lt;/p&gt;
&lt;p&gt;1）先将A放入open队列，路径长度为0&lt;/p&gt;
&lt;p&gt;2）循环从open列表里拿出路径长度最短的节点，将其放入close队列并记录上一节点，对其4个方向进行展开，如果已经在open、close队列，修正其最短路径长度；如果不可走，忽略；否则放入open队列并计算其路径长度。&lt;/p&gt;
&lt;p&gt;3）如果找到E点，通过E点的上一节点，上一节点的上一节点...一直反推到A点，形成反推路径，从而找到A到E的最短路径。&lt;/p&gt;
&lt;p&gt;4）如果还没找到E点，open 队列为空，A到E路不通。&lt;/p&gt;
&lt;p&gt;如上图，从Dijkstra算法修改过来的寻路算法，按照红色、绿色、蓝色、黄色节点，逐步展开寻找才找到A到E的最短路径，很多没用的分支，效率低。&lt;/p&gt;
&lt;p&gt;A*的优化思路主要在挑选节点展开时，假设找到一个中间节点B后，中间节点B到E的路都是可走的。这时候最短路径长度是计算经过B点A到E的最短路径（AB）+（BE）。在RPG游戏中，最简单的情况是，A到B的路径长度等于从A走到B经过的格子数，B到E的路径长度等于假设B到E的路都相通情况下B走到E经过的格子数。A*算法每次展开节点时都尽可能的往可能最短的路径去展开寻找，减少没必要的分支，提高寻路效率。&lt;/p&gt;

&lt;p&gt;下面是A*寻路算法过程&lt;/p&gt;
&lt;p&gt;1）先将A放入open队列，记录其上一节点为空&lt;/p&gt;
&lt;p&gt;2）循环从open列表里拿出节点N，N为经过该点N，A到E路径预测长度最短的节点，将其放入close队列；对其4个方向进行展开，如果已经在open、close队列，修正其上一节点；如果不可走，忽略；否则放入open队列并记录其上一节点为N。&lt;/p&gt;
&lt;p&gt;3）如果找到E点，通过E点的上一节点，上一节点的上一节点...一直反推到A点，形成反推路径，从而找到A到E的最短路径。&lt;/p&gt;
&lt;p&gt;4）如果还没找到E点，open 队列为空，A到E路不通。&lt;/p&gt;

&lt;p&gt;A*寻路算法先说到这里，下一篇我们将介绍行为树。&lt;/p&gt;
</description>
<pubDate>Sat, 02 Mar 2019 05:43:00 +0000</pubDate>
<dc:creator>五邑隐侠</dc:creator>
<og:description>摘要: 五邑隐侠，本名关健昌，10年游戏生涯，现隐居五邑。本系列文章以TypeScript为介绍语言。 这一篇介绍A*寻路算法。在RPG、SLG、模拟经营类游戏，有需要给角色寻路的需求，一般寻路我们采</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/niudanshui/p/10460815.html</dc:identifier>
</item>
<item>
<title>SpringBoot 下 mybatis 的缓存 - 水目沾</title>
<link>http://www.cnblogs.com/zhuwbox/p/10460765.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/zhuwbox/p/10460765.html</guid>
<description>&lt;p&gt;&lt;strong&gt;背景：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;　　说起 mybatis，作为 Java 程序员应该是无人不知，它是常用的数据库访问框架。与 Spring 和 Struts 组成了 Java Web 开发的三剑客--- SSM。当然随着 Spring Boot 的发展，现在越来越多的企业采用的是 SpringBoot + mybatis 的模式开发，我们公司也不例外。而 mybatis 对于我也仅仅停留在会用而已，没想过怎么去了解它，更不知道它的缓存机制了，直到那个生死难忘的 BUG。故事的背景比较长，但并不是啰嗦，只是让读者知道这个 BUG 触发的场景，加深记忆。在遇到类似问题时，可以迅速定位。&lt;/p&gt;
&lt;p&gt;　　先说下故事的前提，为了防止用户在动态中输入特殊字符，用户的动态都是编码后发到后台，而后台在存入到 DB 表之前会解码以方便在 DB 中查看以及上报到搜索引擎。而在查询用户动态的时候先从 DB 表中读取并在后台做一次编码再传到前端，前端再解码既可以正常展示了。流程如下图：&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption&quot; data-cke-widget-wrapper=&quot;1&quot; data-cke-filter=&quot;off&quot; data-cke-display-name=&quot;图像&quot; data-cke-widget-id=&quot;17&quot;&gt;&lt;img class=&quot;has cke_widget_element&quot; src=&quot;http://note.youdao.com/yws/res/5704/WEBRESOURCEfcf1851bccff6028657eca2ce944c273&quot; alt=&quot;&quot; width=&quot;713&quot; height=&quot;268&quot; data-cke-saved-src=&quot;http://note.youdao.com/yws/res/5704/WEBRESOURCEfcf1851bccff6028657eca2ce944c273&quot; data-cke-widget-data=&quot;{&amp;amp;quot;hasCaption&amp;amp;quot;:false,&amp;amp;quot;src&amp;amp;quot;:&amp;amp;quot;http://note.youdao.com/yws/res/5704/WEBRESOURCEfcf1851bccff6028657eca2ce944c273&amp;amp;quot;,&amp;amp;quot;alt&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;width&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;height&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;lock&amp;amp;quot;:true,&amp;amp;quot;align&amp;amp;quot;:&amp;amp;quot;none&amp;amp;quot;,&amp;amp;quot;classes&amp;amp;quot;:{&amp;amp;quot;has&amp;amp;quot;:1}}&quot; data-cke-widget-upcasted=&quot;1&quot; data-cke-widget-keep-attr=&quot;0&quot; data-widget=&quot;image&quot;/&gt;&lt;span class=&quot;cke_reset cke_widget_drag_handler_container&quot;&gt;&lt;img class=&quot;cke_reset cke_widget_drag_handler&quot; title=&quot;点击并拖拽以移动&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot; alt=&quot;&quot; width=&quot;15&quot; height=&quot;15&quot; data-cke-widget-drag-handler=&quot;1&quot;/&gt;&lt;span class=&quot;cke_image_resizer&quot; title=&quot;点击并拖拽以改变尺寸&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;　　有一天后端预发环境发布完毕后，用户的动态页面有的动态显示正常，而有的动态却是被编码过的。看到现象后的第一个反应就是部分被编码了两次，但是编码操作只会在 service 层的 findById 中有。理论不会在上层犯这种低级错误，于是开始排查新增加的代码。发现只要进入了新增加代码中的某个 if 分支则被编码了两次。分支中除了再次调用 findById（必要性不讨论），也无其他特殊代码了。百思不得其解后请教了旁边的老司机，老司机说可能是 mybatis 缓存。于是看了下我代码，将编码的操作从 findById 中移出来后再次发布到预发，正常了，心想老司机不愧是老司机。本次 BUG 触发的有两个条件需要注意：&lt;/p&gt;
&lt;ul&gt;&lt;li&gt; 整个操作过程都在一个函数中，而函数上面加了 @Transactional 的注解（对 mybatis 来说是在同一个 SESSION 中）&lt;/li&gt;
&lt;li&gt; 一般只会调用 findByIdy 一次，如果进入分支则会调用两次 （第一次调用后做了编码后被缓存，第二次从缓存读后继续被编码）&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;　　于是，便开始谷歌 mybatis 的缓存机制，搜到了一篇非常不错的文章《聊聊 mybatis 的缓存机制》，推荐大家看一下，特别是里面的流程图。同时关注下美团技术官方公众号，上面有很多干货（这不是广告）。但是这篇文章讲到了源码，涉及的比较深。而且并没讲 SpringBoot 下 mybatis 下的一些缓存知识点，遂作此篇，以作补充。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;缓存的配置&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;　　SpringBoot + mybatis 环境搭建很简单而且网上一堆教程，这里不班门弄斧了，记得在项目中将 mytatis 的源码下载下来即可。mybaits 一共有两级缓存：一级缓存的配置 key 是 localCacheScope，而二级缓存的配置 key 是 cacheEnabled，从名字上可以得出以下信息：&lt;/p&gt;
&lt;ul&gt;&lt;li&gt; 一级缓存是本地或者说局部缓存，它不能被关闭，只能配置缓存范围。SESSION 或者 STATEMENT。&lt;/li&gt;
&lt;li&gt; 二级缓存才是 mybatis 的正统，功能应该会更强大些。&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;　　先来看下在 SpringBoot中 如何配置 mybatis 缓存的相关信息。默认情况下 SpringBoot 下的 mybatis 一级缓存为 SESSION 级别，二级缓存也是打开的，可以在 mybatis 源码中的 org.apache.ibatis.session.Configuration.class 文件中看到（idea中打开），如下图：&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption&quot; data-cke-widget-wrapper=&quot;1&quot; data-cke-filter=&quot;off&quot; data-cke-display-name=&quot;图像&quot; data-cke-widget-id=&quot;16&quot;&gt;&lt;img class=&quot;has cke_widget_element&quot; src=&quot;http://note.youdao.com/yws/res/5706/WEBRESOURCEfd6afc26ade189d6179d24f321d9a356&quot; alt=&quot;&quot; width=&quot;815&quot; height=&quot;214&quot; data-cke-saved-src=&quot;http://note.youdao.com/yws/res/5706/WEBRESOURCEfd6afc26ade189d6179d24f321d9a356&quot; data-cke-widget-data=&quot;{&amp;amp;quot;hasCaption&amp;amp;quot;:false,&amp;amp;quot;src&amp;amp;quot;:&amp;amp;quot;http://note.youdao.com/yws/res/5706/WEBRESOURCEfd6afc26ade189d6179d24f321d9a356&amp;amp;quot;,&amp;amp;quot;alt&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;width&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;height&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;lock&amp;amp;quot;:true,&amp;amp;quot;align&amp;amp;quot;:&amp;amp;quot;none&amp;amp;quot;,&amp;amp;quot;classes&amp;amp;quot;:{&amp;amp;quot;has&amp;amp;quot;:1}}&quot; data-cke-widget-upcasted=&quot;1&quot; data-cke-widget-keep-attr=&quot;0&quot; data-widget=&quot;image&quot;/&gt;&lt;span class=&quot;cke_reset cke_widget_drag_handler_container&quot;&gt;&lt;img class=&quot;cke_reset cke_widget_drag_handler&quot; title=&quot;点击并拖拽以移动&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot; alt=&quot;&quot; width=&quot;15&quot; height=&quot;15&quot; data-cke-widget-drag-handler=&quot;1&quot;/&gt;&lt;span class=&quot;cke_image_resizer&quot; title=&quot;点击并拖拽以改变尺寸&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;　　也可以通过以下测试程序查看缓存开启情况&lt;/p&gt;


&lt;ul&gt;&lt;li&gt; 映射文件中所有的select语句将被缓存&lt;/li&gt;
&lt;li&gt; 映射文件中所有的insert、update和delete语句将刷新缓存 &lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;　　一二级缓存同时开启的情况下，数据的查询顺序是 二级缓存 -&amp;gt; 一级缓存 -&amp;gt; 数据库。一级缓存比较简单，而二级缓存可以设置更多的属性，只需要在 mapper 的 xml 文件中的 &amp;lt;cache /&amp;gt; 配置即可，具体如下：&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;36&quot;&gt;
&lt;pre class=&quot;brush:java;gutter:true;&quot;&gt;
&amp;lt;cache
        type = &quot;org.mybatis.caches.ehcache.LoggingEhcache&quot;  //指定使用的缓存类，mybatis默认使用HashMap进行缓存,可以指定第三方缓存
        eviction = &quot;LRU&quot;  //默认是 LRU 淘汰缓存的算法，有如下几种：
                          //1.LRU – 最近最少使用的:移除最长时间不被使用的对象。 
                          //2.FIFO – 先进先出:按对象进入缓存的顺序来移除它们。  
                          //3.SOFT – 软引用:移除基于垃圾回收器状态和软引用规则的对象。  
                          //4.WEAK – 弱引用:更积极地移除基于垃圾收集器状态和弱引用规则的对象
        flushInterval = &quot;1000&quot;  //清空缓存的时间间隔，单位毫秒，可以被设置为任意的正整数。  默认情况是不设置，也就是没有刷新间隔，缓存仅仅调用语句时刷新。
        size = &quot;100&quot;      //缓存对象的个数，任意正整数，默认值是1024。
       readOnly  = &quot;true&quot;  //缓存是否只读，提高读取效率
       blocking = &quot;true&quot;   //是否使用阻塞缓存，默认为false，当指定为true时将采用BlockingCache进行封装，blocking，
                           //阻塞的意思，使用BlockingCache会在查询缓存时锁住对应的Key，如果缓存命中了则会释放对应的锁，
                           //否则会在查询数据库以后再释放锁这样可以阻止并发情况下多个线程同时查询数据，详情可参考BlockingCache的源码。  
/&amp;gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;触发 mybatis 缓存&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;　　（1）配置一级缓存为 SESSION 级别&lt;/p&gt;
&lt;p&gt;　　Controller 中做两次调用，代码如下：&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption&quot; data-cke-widget-wrapper=&quot;1&quot; data-cke-filter=&quot;off&quot; data-cke-display-name=&quot;图像&quot; data-cke-widget-id=&quot;11&quot;&gt;&lt;img class=&quot;has cke_widget_element&quot; src=&quot;http://note.youdao.com/yws/res/5557/WEBRESOURCE2f865a88cc72ab1ab251aa0073f9f6b2&quot; alt=&quot;&quot; width=&quot;716&quot; height=&quot;215&quot; data-cke-saved-src=&quot;http://note.youdao.com/yws/res/5557/WEBRESOURCE2f865a88cc72ab1ab251aa0073f9f6b2&quot; data-cke-widget-data=&quot;{&amp;amp;quot;hasCaption&amp;amp;quot;:false,&amp;amp;quot;src&amp;amp;quot;:&amp;amp;quot;http://note.youdao.com/yws/res/5557/WEBRESOURCE2f865a88cc72ab1ab251aa0073f9f6b2&amp;amp;quot;,&amp;amp;quot;alt&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;width&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;height&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;lock&amp;amp;quot;:true,&amp;amp;quot;align&amp;amp;quot;:&amp;amp;quot;none&amp;amp;quot;,&amp;amp;quot;classes&amp;amp;quot;:{&amp;amp;quot;has&amp;amp;quot;:1}}&quot; data-cke-widget-upcasted=&quot;1&quot; data-cke-widget-keep-attr=&quot;0&quot; data-widget=&quot;image&quot;/&gt;&lt;span class=&quot;cke_reset cke_widget_drag_handler_container&quot;&gt;&lt;img class=&quot;cke_reset cke_widget_drag_handler&quot; title=&quot;点击并拖拽以移动&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot; alt=&quot;&quot; width=&quot;15&quot; height=&quot;15&quot; data-cke-widget-drag-handler=&quot;1&quot;/&gt;&lt;span class=&quot;cke_image_resizer&quot; title=&quot;点击并拖拽以改变尺寸&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;　　从图中的 1/2/3/4 可以看出每次 mapper 层的一次接口调用如 getOne 就会创建一个 session，并且在执行完毕后关闭 session。所以两次调用并不在一个 session 中，一级缓存并没有发生作用。开启事务，Controller 层代码如下：&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;34&quot;&gt;
&lt;pre class=&quot;brush:java;gutter:true;&quot;&gt;
@RequestMapping(&quot;/getUser&quot;)
@Transactional(rollbackFor = Throwable.class)
public UserEntity getUser(Long id) {
    //第一次调用
    UserEntity user1=userMapper.getOne(id);
    //第二次调用
    UserEntity user2=userMapper.getOne(id);
    return user1;
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;　　打印结果如下：&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption&quot; data-cke-widget-wrapper=&quot;1&quot; data-cke-filter=&quot;off&quot; data-cke-display-name=&quot;图像&quot; data-cke-widget-id=&quot;9&quot;&gt;&lt;span class=&quot;cke_reset cke_widget_drag_handler_container&quot;&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/566545/201903/566545-20190302142109460-169723721.png&quot; alt=&quot;&quot; width=&quot;671&quot; height=&quot;212&quot;/&gt;&lt;img class=&quot;cke_reset cke_widget_drag_handler&quot; title=&quot;点击并拖拽以移动&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot; alt=&quot;&quot; width=&quot;15&quot; height=&quot;15&quot; data-cke-widget-drag-handler=&quot;1&quot;/&gt;&lt;span class=&quot;cke_image_resizer&quot; title=&quot;点击并拖拽以改变尺寸&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;　　由于在同一个事务中，虽然调用了 select 操作两次但是只执行了一次 sql ，缓存发挥了作用。这就跟一开始我遇到的那个 BUG 场景一样：同一 session 且 select 调用 &amp;gt; 1 次。如果在两次调用中间插入 update 操作，缓存会立即失效。只要 session 中有 insert、update 和 delete 语句，该 session 中的缓存会立即被刷新。但是注意这只是在同一 session 之间。不同 session 之间如 session1 和 session2，session1 里的 insert/update/delete 并不会影响 session 2 下的缓存，这在高并发或者分布式的情况下会产生脏数据。所以建议将一级缓存级别调成 statement。&lt;/p&gt;
&lt;p&gt;　　（2）配置一级缓存为 STATEMENT 级别&lt;/p&gt;
&lt;p&gt;　　再次将（1）中的无事务和有事务的代码分别执行一遍，打印结果始终如下：&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption&quot; data-cke-widget-wrapper=&quot;1&quot; data-cke-filter=&quot;off&quot; data-cke-display-name=&quot;图像&quot; data-cke-widget-id=&quot;8&quot;&gt;&lt;span class=&quot;cke_reset cke_widget_drag_handler_container&quot;&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/566545/201903/566545-20190302142300829-1294730714.png&quot; alt=&quot;&quot; width=&quot;742&quot; height=&quot;241&quot;/&gt;&lt;img class=&quot;cke_reset cke_widget_drag_handler&quot; title=&quot;点击并拖拽以移动&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot; alt=&quot;&quot; width=&quot;15&quot; height=&quot;15&quot; data-cke-widget-drag-handler=&quot;1&quot;/&gt;&lt;span class=&quot;cke_image_resizer&quot; title=&quot;点击并拖拽以改变尺寸&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;　　配置成 SATEMENT 后，一级缓存相当于被关闭了。STATEMENT 级别暂时不好模拟，但是我猜测 STATEMENT 级别即在同一执行 sql 的接口中（如上面的 getOne 中）缓存，出了 getOne 缓存即失效。&lt;/p&gt;
&lt;p&gt;　　（3）二级缓存，同时为了避免一级缓存的干扰，将一级缓存设置为 STATEMENT&lt;/p&gt;
&lt;p&gt;　　Controller 中去掉 @Transactional 注解代码如下：&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption&quot; data-cke-widget-wrapper=&quot;1&quot; data-cke-filter=&quot;off&quot; data-cke-display-name=&quot;图像&quot; data-cke-widget-id=&quot;5&quot;&gt;&lt;span class=&quot;cke_reset cke_widget_drag_handler_container&quot;&gt;&lt;img class=&quot;has cke_widget_element&quot; src=&quot;http://note.youdao.com/yws/res/5710/WEBRESOURCEe5799ad21733220b95e273292ea29013&quot; alt=&quot;&quot; width=&quot;836&quot; height=&quot;294&quot; data-cke-saved-src=&quot;http://note.youdao.com/yws/res/5710/WEBRESOURCEe5799ad21733220b95e273292ea29013&quot; data-cke-widget-data=&quot;{&amp;amp;quot;hasCaption&amp;amp;quot;:false,&amp;amp;quot;src&amp;amp;quot;:&amp;amp;quot;http://note.youdao.com/yws/res/5710/WEBRESOURCEe5799ad21733220b95e273292ea29013&amp;amp;quot;,&amp;amp;quot;alt&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;width&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;height&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;lock&amp;amp;quot;:true,&amp;amp;quot;align&amp;amp;quot;:&amp;amp;quot;none&amp;amp;quot;,&amp;amp;quot;classes&amp;amp;quot;:{&amp;amp;quot;has&amp;amp;quot;:1}}&quot; data-cke-widget-upcasted=&quot;1&quot; data-cke-widget-keep-attr=&quot;0&quot; data-widget=&quot;image&quot;/&gt;&lt;img class=&quot;cke_reset cke_widget_drag_handler&quot; title=&quot;点击并拖拽以移动&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot; alt=&quot;&quot; width=&quot;15&quot; height=&quot;15&quot; data-cke-widget-drag-handler=&quot;1&quot;/&gt;&lt;span class=&quot;cke_image_resizer&quot; title=&quot;点击并拖拽以改变尺寸&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;　　从图中红框可以看出第二次查询命中缓存，0.5 是命中率，&lt;/p&gt;
&lt;p&gt;　　再次执行 &lt;a href=&quot;http://localhost:8080/getUser?id=1&quot; data-cke-saved-href=&quot;http://localhost:8080/getUser?id=1&quot;&gt;http://localhost:8080/getUser?id=1&lt;/a&gt; 打印结果如下：&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;has cke_widget_element&quot; src=&quot;http://note.youdao.com/yws/res/5705/WEBRESOURCEcd9e5cc459aa57d322387b97d9868c10&quot; alt=&quot;&quot; width=&quot;836&quot; height=&quot;156&quot; data-cke-saved-src=&quot;http://note.youdao.com/yws/res/5705/WEBRESOURCEcd9e5cc459aa57d322387b97d9868c10&quot; data-cke-widget-data=&quot;{&amp;amp;quot;hasCaption&amp;amp;quot;:false,&amp;amp;quot;src&amp;amp;quot;:&amp;amp;quot;http://note.youdao.com/yws/res/5705/WEBRESOURCEcd9e5cc459aa57d322387b97d9868c10&amp;amp;quot;,&amp;amp;quot;alt&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;width&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;height&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;lock&amp;amp;quot;:true,&amp;amp;quot;align&amp;amp;quot;:&amp;amp;quot;none&amp;amp;quot;,&amp;amp;quot;classes&amp;amp;quot;:{&amp;amp;quot;has&amp;amp;quot;:1}}&quot; data-cke-widget-upcasted=&quot;1&quot; data-cke-widget-keep-attr=&quot;0&quot; data-widget=&quot;image&quot;/&gt;&lt;img class=&quot;cke_reset cke_widget_drag_handler&quot; title=&quot;点击并拖拽以移动&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot; alt=&quot;&quot; width=&quot;15&quot; height=&quot;15&quot; data-cke-widget-drag-handler=&quot;1&quot;/&gt;&lt;span class=&quot;cke_image_resizer&quot; title=&quot;点击并拖拽以改变尺寸&quot;&gt;​&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;　　这次一次 sql 也没执行了，所以说二级缓存全局缓存。但它的缓存范围也是有限的，一级缓存在同一个 session 中。二级缓存可以跨 session 但也只能在同一 namespace 中，所谓 namespace 即 mapper xml 文件中。具体实验请看《聊聊 mybatis 的缓存机制》中的关于二级缓存的实验 4 和 5。再看下二级缓存配置对二级缓存的影响，为了明显的看出效果，只改如下配置：&lt;/p&gt;

&lt;p&gt;　　controller 代码：&lt;/p&gt;

&lt;p&gt;　　&lt;a href=&quot;http://localhost:8080/getUser?id=1&amp;amp;id2=2&quot; target=&quot;_blank&quot;&gt;http://localhost:8080/getUser?id=1&amp;amp;id2=2&lt;/a&gt; 最后打印的结果如下：&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption&quot; data-cke-widget-wrapper=&quot;1&quot; data-cke-filter=&quot;off&quot; data-cke-display-name=&quot;图像&quot; data-cke-widget-id=&quot;1&quot;&gt;&lt;img class=&quot;has cke_widget_element&quot; src=&quot;https://note.youdao.com/yws/res/5719/WEBRESOURCE5bae449a79b1914e49f117ccfba0f86d&quot; alt=&quot;&quot; width=&quot;844&quot; height=&quot;502&quot; data-cke-saved-src=&quot;https://note.youdao.com/yws/res/5719/WEBRESOURCE5bae449a79b1914e49f117ccfba0f86d&quot; data-cke-widget-data=&quot;{&amp;amp;quot;hasCaption&amp;amp;quot;:false,&amp;amp;quot;src&amp;amp;quot;:&amp;amp;quot;https://note.youdao.com/yws/res/5719/WEBRESOURCE5bae449a79b1914e49f117ccfba0f86d&amp;amp;quot;,&amp;amp;quot;alt&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;width&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;height&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;lock&amp;amp;quot;:true,&amp;amp;quot;align&amp;amp;quot;:&amp;amp;quot;none&amp;amp;quot;,&amp;amp;quot;classes&amp;amp;quot;:{&amp;amp;quot;has&amp;amp;quot;:1}}&quot; data-cke-widget-upcasted=&quot;1&quot; data-cke-widget-keep-attr=&quot;0&quot; data-widget=&quot;image&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;　　太长了，拼接下：&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption&quot; data-cke-widget-wrapper=&quot;1&quot; data-cke-filter=&quot;off&quot; data-cke-display-name=&quot;图像&quot; data-cke-widget-id=&quot;0&quot;&gt;&lt;img class=&quot;has cke_widget_element&quot; src=&quot;http://note.youdao.com/yws/res/5684/WEBRESOURCEbef1c2f138847714544355e90152c85b&quot; alt=&quot;&quot; width=&quot;849&quot; height=&quot;162&quot; data-cke-saved-src=&quot;http://note.youdao.com/yws/res/5684/WEBRESOURCEbef1c2f138847714544355e90152c85b&quot; data-cke-widget-data=&quot;{&amp;amp;quot;hasCaption&amp;amp;quot;:false,&amp;amp;quot;src&amp;amp;quot;:&amp;amp;quot;http://note.youdao.com/yws/res/5684/WEBRESOURCEbef1c2f138847714544355e90152c85b&amp;amp;quot;,&amp;amp;quot;alt&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;width&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;height&amp;amp;quot;:&amp;amp;quot;&amp;amp;quot;,&amp;amp;quot;lock&amp;amp;quot;:true,&amp;amp;quot;align&amp;amp;quot;:&amp;amp;quot;none&amp;amp;quot;,&amp;amp;quot;classes&amp;amp;quot;:{&amp;amp;quot;has&amp;amp;quot;:1}}&quot; data-cke-widget-upcasted=&quot;1&quot; data-cke-widget-keep-attr=&quot;0&quot; data-widget=&quot;image&quot;/&gt;&lt;span class=&quot;cke_reset cke_widget_drag_handler_container&quot;&gt;&lt;img class=&quot;cke_reset cke_widget_drag_handler&quot; title=&quot;点击并拖拽以移动&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot; alt=&quot;&quot; width=&quot;15&quot; height=&quot;15&quot; data-cke-widget-drag-handler=&quot;1&quot;/&gt;&lt;span class=&quot;cke_image_resizer&quot; title=&quot;点击并拖拽以改变尺寸&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;　　可以看出二级缓存只能缓存一个对象且 5s 后就失效了，缓存失效。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;总结：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;　　我推荐的文章中总结的已经非常好了，直接引用下：&lt;/p&gt;
&lt;blockquote readability=&quot;26&quot;&gt;
&lt;p&gt;1、MyBatis一级缓存的生命周期和SqlSession一致。&lt;/p&gt;
&lt;p&gt;2、MyBatis一级缓存内部设计简单，只是一个没有容量限定的HashMap，在缓存的功能性上有所欠缺。&lt;/p&gt;
&lt;p&gt;3、MyBatis的一级缓存最大范围是SqlSession内部，有多个SqlSession或者分布式的环境下，数据库写操作会引起脏数据，建议设定缓存级别为Statement。&lt;/p&gt;
&lt;p&gt;4、MyBatis的二级缓存相对于一级缓存来说，实现了SqlSession之间缓存数据的共享，同时粒度更加的细，能够到namespace级别，通过Cache接口实现类不同的组合，对Cache的可控性也更强。&lt;/p&gt;
&lt;p&gt;5、MyBatis在多表查询时，极大可能会出现脏数据，有设计上的缺陷，安全使用二级缓存的条件比较苛刻。&lt;/p&gt;
&lt;p&gt;6、在分布式环境下，由于默认的MyBatis Cache实现都是基于本地的，分布式环境下必然会出现读取到脏数据，需要使用集中式缓存将MyBatis的Cache接口实现，有一定的开发成本，直接使用Redis、Memcached等分布式缓存可能成本更低，安全性也更高。&lt;/p&gt;
&lt;p&gt;7. 个人建议MyBatis缓存特性在生产环境中进行关闭，单纯作为一个ORM框架使用可能更为合适。&lt;/p&gt;
&lt;/blockquote&gt;


</description>
<pubDate>Sat, 02 Mar 2019 05:30:00 +0000</pubDate>
<dc:creator>水目沾</dc:creator>
<og:description>背景： 说起 mybatis，作为 Java 程序员应该是无人不知，它是常用的数据库访问框架。与 Spring 和 Struts 组成了 Java Web 开发的三剑客 SSM。当然随着 Spring</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/zhuwbox/p/10460765.html</dc:identifier>
</item>
<item>
<title>2.第一个ASP.NET MVC 5.0应用程序 - 灰太狼的梦想</title>
<link>http://www.cnblogs.com/caofangsheng/p/10460620.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/caofangsheng/p/10460620.html</guid>
<description>&lt;p&gt;&lt;span&gt;       大家好，上一篇对ASP.NET MVC 有了一个基本的认识之后，这一篇，我们来看下怎么从头到尾创建一个ASP.NET MVC 应用程序吧。【PS：返回上一篇文章：&lt;a href=&quot;https://www.cnblogs.com/caofangsheng/p/10440900.html&quot; target=&quot;_blank&quot;&gt;1.开始学习ASP.NET MVC&lt;/a&gt;】&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;第一步：开打VS2017，选择【文件】--&amp;gt;【新建】--&amp;gt;【项目】，然后在弹出来的方框中，按照下面的截图操作，第一步选择Visual C#,接着Web，然后选择ASP.NET Web 应用程序（.NET Framework）,最后&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;输入项目名称，点击确定。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302122926949-688880499.jpg&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;然后按照下面的截图选择：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302123359831-988928887.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;点击确定，我们的第一个ASP.NET MVC 5.0应用程序就创建好了。我们来看看项目结构：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302123633415-1149385555.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;可以看到，VS2017，为我们生成了三个文件夹Controller、Model、Views。其中Controller文件夹放默认约定的控制器类，Model文件夹放模型类，Views文件夹放视图页面，我们还注意到有一个App_Start文件夹，里面有一个RouteConfig类，这个类文件是用来配置MVC路由规则的。打开RouteConfig文件：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302124226343-2123555468.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;p&gt; 默认路由配置是Home控制器，Index方法，你可以根据需要进行定制。现在我们来创建一个控制器，在Controllers文件夹上，右键【添加】--&amp;gt;【控制器】，然后选择第一个空模板。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302124500891-1842833681.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;输入控制器的名字，记住：控制器根据约定大于配置原则，都要求以&lt;strong&gt;Controller&lt;/strong&gt;结尾。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302124637691-1477601908.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;可以看到，控制器默认都有一个返回值为ActionResult 的Index方法。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302124748503-1394673034.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;创建完控制器之后，我们接着来创建Index视图：创建视图的方法有两种。第一种是：右键选择控制器的Index方法，选择【添加视图】；第二种是在Views文件夹下，找到相对应的控制器对应的文件夹，这里是Home文件夹，然后右键Home，选择添加视图。记住视图的名字一般和Action名字一样，也可以不一样，如果一样，就直接写Return View();如果不一样，就必须写出路径。这里我们选择第一种方式创建Index视图。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302125453481-494609862.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;p&gt; &lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302125550559-450308187.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; 在视图中添加如下代码，然后运行程序：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt; &lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302125707632-567401068.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;运行的结果如下图：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302125857372-35965924.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;记住,这里我们是创建了和Action方法同名的Index视图，如果我们创建不一样的视图呢，并且不在一个对应的Home文件夹下，创建这个视图呢。会是什么效果？？?我们来看看。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1.我们在Views文件夹下，创建一个Test文件夹，在Test文件夹下面，创建一个Test视图页面;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302130412306-1598811686.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;在Test视图中，添加如下代码：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302130446857-101564799.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt; 然后修改Home控制器Index方法的代码，运行程序：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302130624879-1272085712.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;结果如下图：&lt;strong&gt;可以看到页面加载了Test文件夹下的Test.cshtml视图页面了&lt;/strong&gt;。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/745221/201903/745221-20190302130717611-1913507781.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;好了，这就是，这篇教大家怎么从零开始创建一个新的ASP.NET MVC 5.0应用程序了，大家有什么疑问，可以留言评论，我会一一回复。谢谢！&lt;/span&gt;&lt;/p&gt;

</description>
<pubDate>Sat, 02 Mar 2019 05:11:00 +0000</pubDate>
<dc:creator>灰太狼的梦想</dc:creator>
<og:description>大家好，上一篇对ASP.NET MVC 有了一个基本的认识之后，这一篇，我们来看下怎么从头到尾创建一个ASP.NET MVC 应用程序吧。【PS：返回上一篇文章：1.开始学习ASP.NET MVC】</og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/caofangsheng/p/10460620.html</dc:identifier>
</item>
<item>
<title>SVD的基础详解 - XieMay</title>
<link>http://www.cnblogs.com/xiemaycherry/p/10460464.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/xiemaycherry/p/10460464.html</guid>
<description>&lt;p&gt;1️⃣ &lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#1&quot;&gt;简单说一下特征值、特征向量与特征分解&lt;/a&gt;&lt;br/&gt;   I. &lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#1.1&quot;&gt;特征值、特征向量与特征分解&lt;/a&gt;&lt;br/&gt;   II. &lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#1.2&quot;&gt;几何意义&lt;/a&gt;&lt;br/&gt;   III. &lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#1.3&quot;&gt;如何实现通过Matlab、Python实现&lt;/a&gt;&lt;br/&gt;2️⃣&lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#2&quot;&gt;详细解说SVD&lt;/a&gt;&lt;br/&gt;   I. &lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#2.1&quot;&gt;几何意义&lt;/a&gt;&lt;br/&gt;   I. &lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#2.2&quot;&gt;奇异值分解的推导过程&lt;/a&gt;&lt;br/&gt;   I. &lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#2.3&quot;&gt;SVD算例&lt;/a&gt;&lt;br/&gt;   I. &lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#2.4&quot;&gt;如何通过Matlab和Python&lt;/a&gt;&lt;br/&gt;3️⃣&lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#3&quot;&gt;应用举例&lt;/a&gt;&lt;br/&gt;   I. &lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#3.1&quot;&gt;特征值、特征向量与特征分解&lt;/a&gt;&lt;br/&gt;4️⃣&lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#4&quot;&gt;特征分解、奇异值分解的区别&lt;/a&gt;&lt;br/&gt;   I. &lt;a href=&quot;http://www.cnblogs.com/xiemaycherry/p/10460464.html#4&quot;&gt;特征分解、奇异值分解的区别&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;特征值特征向量与特征分解&quot;&gt;&lt;span&gt;特征值、特征向量与特征分解&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;&lt;span&gt;Theory:&lt;/span&gt;&lt;br/&gt;对于一个正阵&lt;span class=&quot;math inline&quot;&gt;\(M\)&lt;/span&gt;，满足如下：&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[Mx=\lambda x \]&lt;/span&gt;&lt;br/&gt;其中&lt;span class=&quot;math inline&quot;&gt;\(\lambda\)&lt;/span&gt;被成为特征值，满足&lt;span class=&quot;math inline&quot;&gt;\(||M-\lambda E||=0\)&lt;/span&gt;再有&lt;span class=&quot;math inline&quot;&gt;\((M-\lambda E)x=0\)&lt;/span&gt;，可计算其特征向量。&lt;br/&gt;如果有了特征值和特征向量后呢，则可以将矩阵&lt;span class=&quot;math inline&quot;&gt;\(M\)&lt;/span&gt;用特征分解：&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ M=W\sum W^{-1}\]&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;math inline&quot;&gt;\(W={w_1,w_2,...,w_n}\)&lt;/span&gt;分别是特征值&lt;span class=&quot;math inline&quot;&gt;\(\lambda_1,\lambda_2,...,\lambda_n\)&lt;/span&gt;对应的特征向量构成的方阵&lt;/p&gt;
&lt;h2 id=&quot;几何意义&quot;&gt;&lt;span&gt;几何意义&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;对应矩阵M,其对应的线性变化&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[Mx = x'\]&lt;/span&gt;&lt;br/&gt;上面这个式子，&lt;span class=&quot;math inline&quot;&gt;\(Mx，x'\)&lt;/span&gt;是一个向量，&lt;span class=&quot;math inline&quot;&gt;\(x,x'\)&lt;/span&gt;可能是不共线的(如图(b))，如果向量&lt;span class=&quot;math inline&quot;&gt;\(Mx,x'\)&lt;/span&gt;满足&lt;span class=&quot;math inline&quot;&gt;\(Mx=x'=\lambda x\)&lt;/span&gt;,则如图(b)，这说明了这个变换就是对向量x做一个拉伸或者压缩。&lt;br/&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/963294/201903/963294-20190302130244361-454592431.png&quot;/&gt;&lt;/p&gt;
&lt;h2 id=&quot;如何实现通过matlabpython实现&quot;&gt;&lt;span&gt;如何实现通过Matlab、Python实现&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;数学推导：&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ Mx = \lambda x\]&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ Mx-\lambda x=(M-\lambda E)x=0\]&lt;/span&gt;&lt;br/&gt;齐次线性方程组有非零解，则&lt;span class=&quot;math display&quot;&gt;\[||M-\lambda E||=0\]&lt;/span&gt;可求得特征向量&lt;br/&gt;再带回，可得特征向量。&lt;br/&gt;Matlab:&lt;/p&gt;
&lt;pre class=&quot;matlab&quot;&gt;
&lt;code&gt;d = eig(M) % 求取矩阵M的特征值，向量形式存储
[V,D] = eig(M) % 计算M的特征值对角阵D和特征向量V，使得MV = VD成立
[V,D] = eig(M,'nobalance')   %当矩阵M中有与截断误差数量级相差不远的值时，该指令可能更精确。'nobalance'起误差调节作用&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Python&lt;br/&gt;numpy科学计算库提供相应的方法&lt;/p&gt;
&lt;pre class=&quot;python&quot;&gt;
&lt;code&gt;import numpy as np

x = np.diag((1,2,3)) # 这是你想要求取特征值的数组
a,b = numpy.linalg.elg(x) # 特征值赋值给a,对应的特征向量赋值给b&lt;/code&gt;
&lt;/pre&gt;

&lt;p&gt;SVD的英文全称： Singular Value Decomposition，中文名字：奇异值分解&lt;/p&gt;
&lt;h2 id=&quot;几何意义-1&quot;&gt;&lt;span&gt;几何意义&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;http://www.ams.org/publicoutreach/feature-column/fcarc-svd&quot;&gt;图来源&lt;/a&gt;&lt;br/&gt;以二维空间为例&lt;br/&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/963294/201903/963294-20190302130316961-962587537.png&quot;/&gt;&lt;br/&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/963294/201903/963294-20190302130330350-684549907.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;几何意义就是把一个单位正交的网格，转换为另外一个单位正交的网格&lt;br/&gt;假如选取了一组单位正交基{&lt;span class=&quot;math inline&quot;&gt;\(\vec{v}_1,\vec{v}_2\)&lt;/span&gt;},刚好矩阵M的线性变化(&lt;span class=&quot;math inline&quot;&gt;\(M\vec{v}_1\)&lt;/span&gt;,&lt;span class=&quot;math inline&quot;&gt;\(M\vec{v}_2\)&lt;/span&gt;)也正交，用&lt;span class=&quot;math inline&quot;&gt;\(\vec{u}_1,\vec{u}_2\)&lt;/span&gt;分别表示&lt;span class=&quot;math inline&quot;&gt;\(M\vec{v}_1\)&lt;/span&gt;,&lt;span class=&quot;math inline&quot;&gt;\(M\vec{v}_2\)&lt;/span&gt;的单位向量，用&lt;span class=&quot;math inline&quot;&gt;\(\lambda_1,\lambda_2\)&lt;/span&gt;表示&lt;span class=&quot;math inline&quot;&gt;\(M\vec{v}_1\)&lt;/span&gt;,&lt;span class=&quot;math inline&quot;&gt;\(M\vec{v}_2\)&lt;/span&gt;的长度，描述网格在这些特定方向上的拉伸量，也被称作矩阵M的奇异值。&lt;br/&gt;&lt;span class=&quot;math inline&quot;&gt;\(M\vec{v}_1 =\lambda_1\vec{u}_1\)&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;math inline&quot;&gt;\(M\vec{v}_2 =\lambda_2\vec{u}_2\)&lt;/span&gt;&lt;br/&gt;对任意给定的向量&lt;span class=&quot;math inline&quot;&gt;\(\vec{x}\)&lt;/span&gt;,则有&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ \mathbf{x}=\left(\mathbf{v}_{1} \cdot \mathbf{x}\right) \mathbf{v}_{1}+\left(\mathbf{v}_{2} \cdot \mathbf{x}\right) \mathbf{v}_{2} \]&lt;/span&gt;&lt;br/&gt;再将M的线性变换&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ \begin{aligned} M \mathbf{x} &amp;amp;=\left(\mathbf{v}_{1} \cdot \mathbf{x}\right) M \mathbf{N}_{1}+\left(\mathbf{v}_{2} \cdot \mathbf{x}\right) M \mathbf{v}_{2} \\ M \mathbf{x} &amp;amp;=\left(\mathbf{v}_{1} \cdot \mathbf{x}\right) \sigma_{1} \mathbf{u}_{1}+\left(\mathbf{v}_{2} \cdot \mathbf{x}\right) \sigma_{2} \mathbf{u}_{2} \end{aligned} \]&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ \begin{array}{c}{M \mathbf{x}=\mathbf{u}_{1} \sigma_{1} \mathbf{v}_{1}^{\top} \mathbf{x}+\mathbf{u}_{2} \sigma_{2} \mathbf{v}_{2}^{\top} \mathbf{x}} \\ {M=\mathbf{u}_{1} \sigma_{1} \mathbf{v}_{1}^{\top}+\mathbf{u}_{2} \sigma_{2} \mathbf{v}_{2}^{\top}}\end{array} \]&lt;/span&gt;&lt;br/&gt;so&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ M=U \Sigma V^{T} \]&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;奇异值分解的推导过程&quot;&gt;&lt;span&gt;奇异值分解的推导过程&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;&lt;span class=&quot;math inline&quot;&gt;\(u=(u_1,u_2,...,u_m)\)&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;math inline&quot;&gt;\(v=(v_1,v_2,...,v_n)\)&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;math inline&quot;&gt;\(u,v\)&lt;/span&gt;都是空间的基,是正交矩阵 &lt;span class=&quot;math inline&quot;&gt;\(u^Tu=E,v^Tv = E\)&lt;/span&gt;&lt;br/&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/963294/201903/963294-20190302130351823-2067844008.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;任何一个矩阵&lt;span class=&quot;math inline&quot;&gt;\(M_{m*n}\)&lt;/span&gt;，&lt;span class=&quot;math inline&quot;&gt;\(rank(M)=k\)&lt;/span&gt;，一定存在ＳＶＤ,换句话说，M可以将一组单位正交基映射到另一组单位正交基。答案是肯定的&lt;br/&gt;证明如下：&lt;br/&gt;再n为空间中，有一组单位正交基{&lt;span class=&quot;math inline&quot;&gt;\(\vec{v}_1,\vec{v}_2,...,\vec{v}_n\)&lt;/span&gt;},线性变化作用以后&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ {M\vec{v}_1,M\vec{v}_2,...,M\vec{v}_n} \]&lt;/span&gt;&lt;br/&gt;也是正交的，则有&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[(M\vec{v}_i,M\vec{v}_j) = (M\vec{x}_i)^TM\vec{v}_j=\vec{v}_i^TM^TM\vec{v}_j=0 \]&lt;/span&gt;&lt;br/&gt;注意喔，&lt;span class=&quot;math inline&quot;&gt;\(M^TM\)&lt;/span&gt;是矩阵喔，则会有&lt;span class=&quot;math inline&quot;&gt;\(M^TM\vec{v}_j=\lambda \vec{v}_j\)&lt;/span&gt;&lt;br/&gt;接下去，&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ \begin{aligned} v_{i}^{T} M^{T} \mathrm{M} v_{j}=&amp;amp; v_{i}^{T} \lambda_{j} v_{j} \\ &amp;amp;=\lambda_{j} v_{i}^{T} v_{j} \\ &amp;amp;=\lambda_{j} v_{i}\dot v_{j}=0 \end{aligned} \]&lt;/span&gt;&lt;br/&gt;上述就证明了是有的：任何一个矩阵，都可以将一组单位正交基转换成另外一组正交基。&lt;br/&gt;当&lt;span class=&quot;math inline&quot;&gt;\(i=j\)&lt;/span&gt;,&lt;span class=&quot;math inline&quot;&gt;\(&amp;lt;M\vec{v}_i,M \vec{v}_i&amp;gt;=\lambda_i \vec{v}_i \vec{v}_i =\lambda_i\)&lt;/span&gt;&lt;br/&gt;进行一些单位化，记&lt;span class=&quot;math inline&quot;&gt;\(u_i=\frac{A\vec{v}_i}{|M\vec{v}_i|}=\frac{1}{\sqrt{\lambda_i}}M\vec{v}_i\)&lt;/span&gt;&lt;br/&gt;则&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ A v_{i}=\sigma_{i} u_{i}, \sigma_{i}(\operatorname{奇异值})=\sqrt{\lambda_{i}}, 0 \leq i \leq \mathrm{k}, \mathrm{k}=\operatorname{Rank}(\mathrm{A}) \]&lt;/span&gt;&lt;br/&gt;当&lt;span class=&quot;math inline&quot;&gt;\(k &amp;lt; i &amp;lt;= m\)&lt;/span&gt;时，对&lt;span class=&quot;math inline&quot;&gt;\(u1，u2，...，uk\)&lt;/span&gt;进行扩展&lt;span class=&quot;math inline&quot;&gt;\(u(k+1),...,um\)&lt;/span&gt;，使得&lt;span class=&quot;math inline&quot;&gt;\(u1，u2，...，um\)&lt;/span&gt;为&lt;span class=&quot;math inline&quot;&gt;\(m\)&lt;/span&gt;维空间中的一组正交基.也可对&lt;span class=&quot;math inline&quot;&gt;\(\vec{v}_1,\vec{v}_2,...,\vec{v}_k\)&lt;/span&gt;进行扩展，扩展的&lt;span class=&quot;math inline&quot;&gt;\(\vec{v}_{k+1},...,\vec{v}_{n}\)&lt;/span&gt;存在零子空间里面。&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ M\left[ \begin{array}{lll}{\vec{v}_{1}} &amp;amp; {\cdots} &amp;amp; {\vec{v}_{k}}\end{array}\right| \vec{v}_{k+1} \quad \cdots \quad \vec{v}_{m} ]= \left[ \begin{array}{c}{\vec{u}_{1}^{T}} \\ {\vdots} \\ {\frac{\vec{u}_{k}^{T}}{\vec{u}_{k+1}}} \\ {\vdots} \\ {\vec{u}_{n}^{T}}\end{array}\right] \left[ \begin{array}{ccc|c}\sigma_{1} &amp;amp; &amp;amp; 0 &amp;amp; 0\\ &amp;amp; {\ddots} &amp;amp; \sigma_{k} &amp;amp; 0 \\ \hline 0 &amp;amp; &amp;amp; 0 &amp;amp;0\end{array}\right] \]&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ M=\left[ \begin{array}{lll}{\vec{u}_{1}} &amp;amp; {\cdots} &amp;amp; {\vec{u}_{k}}\end{array}\right] \left [ \begin{array}{ccc}\sigma_{1} &amp;amp; &amp;amp; \\ &amp;amp; {\ddots} &amp;amp; \\ &amp;amp; &amp;amp; {\sigma_{k}}\end{array}\right] \left[ \begin{array}{c}{\vec{v}_{1}^{T}} \\ {\vdots} \\ {\vec{v}_{k}^{T}}\end{array}\right]+ \left[ \begin{array}{ccc}{\vec{u}_{k+1}} &amp;amp; {\cdots} &amp;amp; {\vec{u}_{m}}\end{array}\right] \left[\begin{array}{c} 0 \end{array} \right] \left[ \begin{array}{c}{\vec{v}_{k+1}^{T}} \\ {\vdots} \\ {\vec{v}_{n}^{T}}\end{array}\right] \]&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;svd算例&quot;&gt;&lt;span&gt;SVD算例&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;U：&lt;span class=&quot;math inline&quot;&gt;\(AA^T\)&lt;/span&gt;的特征值和特征向量，用单位化的特征向量构成 U&lt;br/&gt;V: &lt;span class=&quot;math inline&quot;&gt;\(A^TA\)&lt;/span&gt; 的特征值和特征向量，用单位化的特征向量构成 V&lt;br/&gt;$\sum_{mn} $ :将$ AA^{T} &lt;span class=&quot;math inline&quot;&gt;\(或者 A^{T}A 的特征值求平方根，然后构成 Σ 以矩阵\)&lt;/span&gt;A = \left[\begin{matrix} 1 &amp;amp; 1\1 &amp;amp;1\ 0 &amp;amp;0\\end{matrix} \right]$&lt;br/&gt;第一步 U ，下面是一种计算方法&lt;br/&gt;对矩阵&lt;span class=&quot;math display&quot;&gt;\[ A A^{T}=\left[ \begin{array}{lll}{2} &amp;amp; {2} &amp;amp; {0} \\ {2} &amp;amp; {2} &amp;amp; {0} \\ {0} &amp;amp; {0} &amp;amp; {0}\end{array}\right] \]&lt;/span&gt;特征分解，&lt;br/&gt;特征是4，0，0&lt;br/&gt;特征向量是$&lt;br/&gt;\left[\frac{1}{\sqrt{2}}, \frac{1}{\sqrt{2}}, 0\right]^{T},\left[-\frac{1}{\sqrt{2}}, \frac{1}{\sqrt{2}}, 0\right]^{T},[0,0,1]^{T}$,可得到&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ U=\left[ \begin{array}{ccc}{\frac{1}{\sqrt{2}}} &amp;amp; {-\frac{1}{\sqrt{2}}} &amp;amp; {0} \\ {\frac{1}{\sqrt{2}}} &amp;amp; {\frac{1}{\sqrt{2}}} &amp;amp; {0} \\ {0} &amp;amp; {0} &amp;amp; {1}\end{array}\right] \]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;第二步&lt;br/&gt;计算矩阵&lt;span class=&quot;math inline&quot;&gt;\(A^TA\)&lt;/span&gt;的特征分解，可得&lt;br/&gt;特征值4，0，&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ V=\left[ \begin{array}{cc}{\frac{1}{\sqrt{2}}} &amp;amp; {-\frac{1}{\sqrt{2}}} \\ {\frac{1}{\sqrt{2}}} &amp;amp; {\frac{1}{\sqrt{2}}}\end{array}\right] \]&lt;/span&gt;&lt;br/&gt;第三步&lt;br/&gt;计算&lt;span class=&quot;math inline&quot;&gt;\(\sum_{mn}\)&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ \Sigma=\left[ \begin{array}{ll}{2} &amp;amp; {0} \\ {0} &amp;amp; {0} \\ {0} &amp;amp; {0}\end{array}\right] \]&lt;/span&gt;&lt;br/&gt;最后，&lt;br/&gt;&lt;span class=&quot;math display&quot;&gt;\[ A=U \Sigma V^{T}=\left[ \begin{array}{ccc}{\frac{1}{\sqrt{2}}} &amp;amp; {-\frac{1}{\sqrt{2}}} &amp;amp; {0} \\ {\frac{1}{\sqrt{2}}} &amp;amp; {\frac{1}{\sqrt{2}}} &amp;amp; {0} \\ {0} &amp;amp; {0} &amp;amp; {1}\end{array}\right] \left[ \begin{array}{ll}{2} &amp;amp; {0} \\ {0} &amp;amp; {0} \\ {0} &amp;amp; {0}\end{array}\right] \left[ \begin{array}{cc}{\frac{1}{\sqrt{2}}} &amp;amp; {-\frac{1}{\sqrt{2}}} \\ {\frac{1}{\sqrt{2}}} &amp;amp; {\frac{1}{\sqrt{2}}}\end{array}\right]^{T}=\left[ \begin{array}{cc}{1} &amp;amp; {1} \\ {1} &amp;amp; {1} \\ {0} &amp;amp; {0}\end{array}\right] \]&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;如何通过matlab和python&quot;&gt;&lt;span&gt;如何通过Matlab和Python&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Matlab：&lt;/p&gt;
&lt;pre class=&quot;matlab&quot;&gt;
&lt;code&gt;s = svd(A)
[U,S,V] = svd(A)
[U,S,V] = svd(A,'econ')
[U,S,V] = svd(A,0)
input: A 矩阵
output:
        s:奇异值，以列向量形式返回。奇异值是以降序顺序列出的非负实数
        S：
        U:左奇异向量，以矩阵的列形式返回。
        V:奇异值，以对角矩阵形式返回。S 的对角元素是以降序排列的非负奇异值。
        右奇异向量，以矩阵的列形式返回。
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Python&lt;/p&gt;
&lt;pre class=&quot;python&quot;&gt;
&lt;code&gt;import numpy as np
M = np.array([ [1,1,2],[0,0,1]])
U,S,V  = np.linalg.svd(M)&lt;/code&gt;
&lt;/pre&gt;

&lt;p&gt;## &lt;span&gt;应用&lt;/span&gt;&lt;br/&gt;2.1 信息检索&lt;br/&gt;2.2 推荐系统&lt;br/&gt;2.3 基于协同过滤的推荐系统&lt;br/&gt;2.4 图像压缩&lt;/p&gt;

&lt;ol&gt;&lt;li&gt;特征值分解只能是方阵，而奇异值分解是矩阵就可以&lt;/li&gt;
&lt;li&gt;特征值分解只考虑了对矩阵缩放效果，奇异值分解对矩阵有选择、收缩、投影的效果&lt;br/&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/963294/201903/963294-20190302130414644-1695667060.png&quot;/&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/963294/201903/963294-20190302130422747-74369657.png&quot;/&gt;&lt;img src=&quot;https://img2018.cnblogs.com/blog/963294/201903/963294-20190302130426759-1554449396.png&quot;/&gt;&lt;/li&gt;
&lt;/ol&gt;</description>
<pubDate>Sat, 02 Mar 2019 04:12:00 +0000</pubDate>
<dc:creator>XieMay</dc:creator>
<og:description>目录 :smile: :one: '简单说一下特征值、特征向量与特征分解'    I. '特征值、特征向量与特征分解'    II. '几何意义'  </og:description>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/xiemaycherry/p/10460464.html</dc:identifier>
</item>
</channel>
</rss>